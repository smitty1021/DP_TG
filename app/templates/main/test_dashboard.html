{% extends "base.html" %}

{% block title %}Trading Analytics Center{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    .dashboard-container { padding: 1.5rem; }
    .debug-info { background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .kpi-card { background: white; border: 1px solid #e0e6ed; padding: 1rem; border-radius: 0.5rem; }
    .kpi-value { font-size: 1.5rem; font-weight: bold; color: #0066cc; }
    .kpi-label { font-size: 0.9rem; color: #6c757d; }
</style>
{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="container-fluid">
        <h1 class="executive-title">
            <i class="fas fa-chart-line executive-icon"></i>
            Trading Analytics Center - API Test
        </h1>
        <p class="executive-subtitle">Testing API Data Loading</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- Debug Info -->
    <div class="debug-info">
        <h5>Debug Information</h5>
        <div id="debugInfo">Loading...</div>
    </div>
    
    <!-- Simple KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">Total P&L</div>
                <div class="kpi-value" id="totalPnl">$0.00</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">Total Trades</div>
                <div class="kpi-value" id="totalTrades">0</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">Win Rate</div>
                <div class="kpi-value" id="winRate">0%</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">Profit Factor</div>
                <div class="kpi-value" id="profitFactor">0.00</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">Expectancy</div>
                <div class="kpi-value" id="expectancy">$0.00</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-label">SQN Score</div>
                <div class="kpi-value" id="sqnScore">0.0</div>
            </div>
        </div>
    </div>
    
    <!-- Trade Data -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Trades</h5>
                </div>
                <div class="card-body">
                    <div id="tradesData">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Loading simple dashboard test...');
    
    // Test API call
    fetch('/api/dashboard-data')
        .then(response => {
            console.log('üì° API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä API Data received:', data);
            
            // Update debug info
            document.getElementById('debugInfo').innerHTML = `
                <strong>API Status:</strong> ‚úÖ Success<br>
                <strong>Trades Count:</strong> ${data.trades_data ? data.trades_data.length : 0}<br>
                <strong>Calendar Days:</strong> ${data.calendar_data ? Object.keys(data.calendar_data).length : 0}<br>
                <strong>Chart Data:</strong> ${data.chart_data ? 'Available' : 'Not Available'}<br>
                <strong>Stats:</strong> ${data.stats ? 'Available' : 'Not Available'}
            `;
            
            // Update KPI cards
            if (data.stats) {
                const stats = data.stats;
                
                document.getElementById('totalPnl').textContent = `$${(stats.total_pnl || 0).toFixed(2)}`;
                document.getElementById('totalTrades').textContent = stats.total_trades || 0;
                document.getElementById('winRate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
                document.getElementById('profitFactor').textContent = (stats.profit_factor || 0).toFixed(2);
                document.getElementById('expectancy').textContent = `$${(stats.expectancy || 0).toFixed(2)}`;
                document.getElementById('sqnScore').textContent = (stats.sqn || 0).toFixed(1);
                
                // Color code total P&L
                const totalPnlElement = document.getElementById('totalPnl');
                if (stats.total_pnl > 0) {
                    totalPnlElement.style.color = '#28a745';
                } else if (stats.total_pnl < 0) {
                    totalPnlElement.style.color = '#dc3545';
                }
            }
            
            // Show recent trades
            if (data.trades_data && data.trades_data.length > 0) {
                const tradesHtml = data.trades_data.slice(0, 10).map(trade => 
                    `<div class="border-bottom py-2">
                        <strong>${trade.instrument}</strong> ${trade.direction} - 
                        ${trade.trade_date} - 
                        P&L: $${(trade.pnl || 0).toFixed(2)}
                    </div>`
                ).join('');
                
                document.getElementById('tradesData').innerHTML = tradesHtml;
            } else {
                document.getElementById('tradesData').innerHTML = '<em>No trades found</em>';
            }
            
        })
        .catch(error => {
            console.error('‚ùå API Error:', error);
            document.getElementById('debugInfo').innerHTML = `
                <strong>API Status:</strong> ‚ùå Error<br>
                <strong>Error:</strong> ${error.message}
            `;
        });
});
</script>
{% endblock %}