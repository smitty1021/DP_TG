{% extends "base.html" %}

{% block title %}Executive Trading Command Center{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">

<!-- Optional: Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Chart.js for enterprise analytics -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}

{% block content %}
<!-- Executive Header (Required on all pages) -->
<div class="executive-header">
    <div class="enterprise-container">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-tachometer-alt executive-icon"></i>
                    Executive Trading Command Center
                </h1>
                <div class="executive-subtitle">
                    Real-Time Performance Intelligence & Strategic Risk Management Platform
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Return to Overview">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Analytics">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('analytics.tag_usage_analytics') }}'"
                        title="Advanced Analytics Center">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button type="button" class="btn btn-primary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                        title="Create New Trade Configuration">
                    <i class="fas fa-plus"></i>
                    New Trade
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="exportStrategicReport()" title="Export Strategic Analytics">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Wrapper -->
<div class="enterprise-container-fluid" style="width: 100%; max-width: none; padding-left: 2rem; padding-right: 2rem;">

    <!-- Executive KPI Performance Dashboard -->
    <div class="enterprise-module mb-4 mt-3">
        <div class="module-header">
            <div class="module-title">
                <i class="fas fa-chart-line module-icon"></i>
                Executive Performance Metrics
            </div>
            <div class="module-meta">Live Trading Intelligence Dashboard</div>
        </div>
        <div class="module-content">
            <div class="grid grid-cols-6 gap-4">
                <!-- Total Portfolio P&L -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-chart-line kpi-icon text-success"></i>
                                <span class="kpi-label">Portfolio P&L</span>
                            </div>
                            <div class="kpi-value text-success" id="totalPnl">$0.00</div>
                            <div class="kpi-meta"><span id="totalTrades">0</span> Total Positions</div>
                        </div>
                    </div>
                </div>
                
                <!-- Success Rate -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-bullseye kpi-icon text-primary"></i>
                                <span class="kpi-label">Success Rate</span>
                            </div>
                            <div class="kpi-value text-primary" id="winRate">0.0%</div>
                            <div class="kpi-meta"><span id="winLoss">0W / 0L</span> Positions</div>
                        </div>
                    </div>
                </div>
                
                <!-- Profit Factor -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-balance-scale kpi-icon text-warning"></i>
                                <span class="kpi-label">Profit Factor</span>
                            </div>
                            <div class="kpi-value text-warning" id="profitFactor">0.00</div>
                            <div class="kpi-meta">Gross: <span id="grossProfitLoss">$0/$0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Expectancy -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-target kpi-icon text-info"></i>
                                <span class="kpi-label">Trade Expectancy</span>
                            </div>
                            <div class="kpi-value text-info" id="expectancy">$0.00</div>
                            <div class="kpi-meta">Per Position Edge</div>
                        </div>
                    </div>
                </div>
                
                <!-- Average Trade -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-calculator kpi-icon text-secondary"></i>
                                <span class="kpi-label">Avg Position</span>
                            </div>
                            <div class="kpi-value text-secondary" id="avgTrade">$0.00</div>
                            <div class="kpi-meta">Mean Performance</div>
                        </div>
                    </div>
                </div>
                
                <!-- System Quality -->
                <div class="col-span-1">
                    <div class="kpi-card">
                        <div class="kpi-content">
                            <div class="kpi-header">
                                <i class="fas fa-award kpi-icon text-success"></i>
                                <span class="kpi-label">SQN Rating</span>
                            </div>
                            <div class="kpi-value text-success" id="sqnScore">0.0</div>
                            <div class="kpi-meta">System Quality</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategic Intelligence Grid -->
    <div class="grid grid-cols-12 gap-4 mb-4">
        
        <!-- Trading Calendar Intelligence -->
        <div class="col-span-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-calendar-alt module-icon"></i>
                        Trading Calendar Intelligence
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="module-meta" id="currentMonth">Loading...</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content p-0">
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Dynamic calendar content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- P12 Scenario Intelligence Center -->
        <div class="col-span-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-brain module-icon"></i>
                        P12 Scenario Intelligence
                    </div>
                    <div class="module-meta">Random's Four Steps Framework</div>
                </div>
                <div class="module-content">
                    <div class="p12-dashboard">
                        <div class="scenario-current mb-3">
                            <div class="scenario-badge-container">
                                <span class="scenario-label">Active Scenario:</span>
                                <span class="scenario-badge" id="currentScenario">Analyzing Market Structure...</span>
                            </div>
                        </div>
                        
                        <div class="p12-levels">
                            <div class="level-row">
                                <span class="level-label">P12 High:</span>
                                <span class="level-value" id="p12High">-</span>
                            </div>
                            <div class="level-row">
                                <span class="level-label">P12 Mid:</span>
                                <span class="level-value" id="p12Mid">-</span>
                            </div>
                            <div class="level-row">
                                <span class="level-label">P12 Low:</span>
                                <span class="level-value" id="p12Low">-</span>
                            </div>
                        </div>
                        
                        <div class="directional-bias mt-3">
                            <span class="bias-label">Market Bias:</span>
                            <span class="bias-indicator" id="directionalBias">Neutral Assessment</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Management Framework -->
        <div class="col-span-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-shield-alt module-icon"></i>
                        Risk Management Framework
                    </div>
                    <div class="module-meta">Live Risk Monitoring</div>
                </div>
                <div class="module-content">
                    <div class="risk-metrics-grid">
                        <div class="risk-metric">
                            <div class="metric-label">Maximum Drawdown</div>
                            <div class="metric-value text-danger" id="maxDrawdown">-$0.00</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-danger" id="drawdownProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="risk-metric">
                            <div class="metric-label">Kelly Fraction</div>
                            <div class="metric-value" id="kellyFraction">0.000</div>
                            <div class="metric-detail">Optimal Position Size</div>
                        </div>
                        
                        <div class="risk-metric">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value" id="sharpeRatio">0.00</div>
                            <div class="metric-detail">Risk-Adjusted Returns</div>
                        </div>
                        
                        <div class="risk-metric">
                            <div class="metric-label">Calmar Ratio</div>
                            <div class="metric-value" id="calmarRatio">0.00</div>
                            <div class="metric-detail">Return/Drawdown Ratio</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analytics Dashboard -->
    <div class="grid grid-cols-3 gap-4 mb-4">
        <!-- Equity Curve Performance -->
        <div class="col-span-1">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-line module-icon"></i>
                        Equity Curve Analysis
                    </div>
                    <div class="module-meta">Portfolio Growth Trajectory</div>
                </div>
                <div class="module-content">
                    <div class="chart-container">
                        <canvas id="equityChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily P&L Distribution -->
        <div class="col-span-1">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-bar module-icon"></i>
                        Daily P&L Distribution
                    </div>
                    <div class="module-meta">Session Performance Analysis</div>
                </div>
                <div class="module-content">
                    <div class="chart-container">
                        <canvas id="dailyPnlChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Summary -->
        <div class="col-span-1">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-pie module-icon"></i>
                        Performance Summary
                    </div>
                    <div class="module-meta">Key Performance Indicators</div>
                </div>
                <div class="module-content">
                    <div class="performance-summary">
                        <div class="summary-metric">
                            <div class="metric-label">Profitable Sessions</div>
                            <div class="metric-value text-success" id="winDays">0</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-label">Loss Sessions</div>
                            <div class="metric-value text-danger" id="lossDays">0</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-label">Session Success Rate</div>
                            <div class="metric-value" id="dailyWinRate">0.0%</div>
                        </div>
                        <div class="summary-metric">
                            <div class="metric-label">Average Daily Expectancy</div>
                            <div class="metric-value" id="dailyExpectancy">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Model Performance Matrix -->
    <div class="enterprise-module mb-4">
        <div class="module-header">
            <div class="module-title">
                <i class="fas fa-trophy module-icon"></i>
                Trading Model Performance Matrix
            </div>
            <div class="module-meta">Random's Six Model Performance Comparison</div>
        </div>
        <div class="module-content">
            <div class="table-responsive">
                <table class="table table-striped table-hover enterprise-table">
                    <thead>
                        <tr>
                            <th>Model Configuration</th>
                            <th>Trade Count</th>
                            <th>Success Rate</th>
                            <th>Avg R-Multiple</th>
                            <th>Total P&L</th>
                            <th>Operational Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="modelComparisonBody">
                        <!-- Dynamic model performance data -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Health & Operational Status -->
    <div class="grid grid-cols-4 gap-4 mb-4">
        <!-- System Health Monitor -->
        <div class="col-span-1">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-heartbeat module-icon"></i>
                        System Health Monitor
                    </div>
                    <div class="module-meta">Operational Status</div>
                </div>
                <div class="module-content">
                    <div class="system-status-grid">
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-info">
                                <div class="status-label">Trading Engine</div>
                                <div class="status-value">Operational</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-info">
                                <div class="status-label">Data Feed</div>
                                <div class="status-value">Connected</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator status-warning"></div>
                            <div class="status-info">
                                <div class="status-label">Risk Limits</div>
                                <div class="status-value" id="riskStatus">Monitor</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-indicator status-online"></div>
                            <div class="status-info">
                                <div class="status-label">Journal Sync</div>
                                <div class="status-value">Current</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Trading Activity -->
        <div class="col-span-3">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-clock module-icon"></i>
                        Today's Trading Activity
                    </div>
                    <div class="module-meta">Current Session Overview</div>
                </div>
                <div class="module-content">
                    <div class="activity-summary-grid">
                        <div class="activity-metric">
                            <div class="metric-label">Positions Today</div>
                            <div class="metric-value" id="todayTrades">0</div>
                        </div>
                        <div class="activity-metric">
                            <div class="metric-label">Session P&L</div>
                            <div class="metric-value" id="todayPnl">$0.00</div>
                        </div>
                        <div class="activity-metric">
                            <div class="metric-label">Active Models</div>
                            <div class="metric-value" id="activeModels">0</div>
                        </div>
                        <div class="activity-metric">
                            <div class="metric-label">Last Update</div>
                            <div class="metric-value" id="lastUpdate">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Trade Execution Records -->
    <div class="enterprise-module">
        <div class="module-header">
            <div class="module-title">
                <i class="fas fa-database module-icon"></i>
                Recent Trade Execution Records
            </div>
            <div class="module-meta">Latest Transaction Activity</div>
        </div>
        <div class="module-content">
            <div class="table-responsive">
                <table class="table table-striped table-hover enterprise-table">
                    <thead>
                        <tr>
                            <th>Execution Date</th>
                            <th>Instrument</th>
                            <th>Strategy Model</th>
                            <th>Position Direction</th>
                            <th>Contract Volume</th>
                            <th>P&L Result</th>
                            <th>Configuration Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- Dynamic trade records -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="pagination-summary">
                        <strong>Displaying <span id="showingRecords">0</span> recent trade executions</strong>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                onclick="window.location.href='{{ url_for('trades.view_trades_list') }}'">
                            View All Configurations
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                onclick="exportTradeData()">
                            Export Configuration Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts_extra %}
<script>
// ============================================================================
// ENTERPRISE DASHBOARD INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing Executive Trading Command Center...');
    
    // Initialize unsaved changes detection (required by Claude_instructions)
    if (typeof window.initEnterpriseUnsavedChanges === 'function') {
        window.initEnterpriseUnsavedChanges();
    }
    
    // Initialize dashboard animations
    initializeEnterpriseAnimations();
    
    // Initialize calendar system
    initializeCalendarSystem();
    
    // Load dashboard data
    loadDashboardIntelligence();
});

// ============================================================================
// ENTERPRISE ANIMATION SYSTEM
// ============================================================================

function initializeEnterpriseAnimations() {
    // Staggered KPI card animations
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Module slide-in animations
    const modules = document.querySelectorAll('.enterprise-module');
    modules.forEach((module, index) => {
        module.style.opacity = '0';
        module.style.transform = 'translateX(30px)';
        module.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
            module.style.opacity = '1';
            module.style.transform = 'translateX(0)';
        }, 300 + (index * 100));
    });
    
    console.log('✅ Enterprise animations initialized');
}

// ============================================================================
// CALENDAR SYSTEM
// ============================================================================

let currentCalendarYear = new Date().getFullYear();
let currentCalendarMonth = new Date().getMonth() + 1;
let calendarData = {};

function initializeCalendarSystem() {
    const today = new Date();
    currentCalendarYear = today.getFullYear();
    currentCalendarMonth = today.getMonth() + 1;
    
    updateMonthDisplay();
}

function changeMonth(direction) {
    currentCalendarMonth += direction;
    
    if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    }
    
    updateMonthDisplay();
    updateCalendarGrid();
}

function updateMonthDisplay() {
    const monthDisplay = document.getElementById('currentMonth');
    if (monthDisplay) {
        monthDisplay.textContent = new Date(currentCalendarYear, currentCalendarMonth - 1).toLocaleDateString('en-US', {
            month: 'long',
            year: 'numeric'
        });
    }
}

function updateCalendarGrid() {
    const grid = document.getElementById('calendarGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Add calendar days
    const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth, 0).getDate();
    const firstDayOfWeek = new Date(currentCalendarYear, currentCalendarMonth - 1, 1).getDay();
    
    // Empty cells before month starts
    for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        grid.appendChild(emptyDay);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = calendarData[dateStr];
        
        if (dayData && dayData.trades > 0) {
            dayElement.classList.add('has-trades');
            dayElement.innerHTML = `
                <div class="calendar-day-number">${day}</div>
                <div class="calendar-pnl ${dayData.pnl >= 0 ? 'positive' : 'negative'}">
                    $${dayData.pnl.toFixed(0)}
                </div>
                <div class="calendar-trades">${dayData.trades} trades</div>
            `;
            
            dayElement.addEventListener('click', () => {
                window.location.href = `/journal/daily/${dateStr}`;
            });
        } else {
            dayElement.innerHTML = `<div class="calendar-day-number">${day}</div>`;
        }
        
        grid.appendChild(dayElement);
    }
}

// ============================================================================
// DATA LOADING & UPDATES
// ============================================================================

function loadDashboardIntelligence() {
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Dashboard intelligence loaded:', data);
            
            // Update all dashboard components
            updateKPIMetrics(data.stats || {});
            updateP12Intelligence(data.p12_intelligence || {});
            updateRiskMetrics(data.risk_metrics || {});
            updatePerformanceCharts(data.chart_data || {});
            updateModelPerformanceMatrix(data.model_analytics || {});
            updateTradeRecords(data.trades_data || []);
            updateTodayActivity(data.today_activity || {});
            
            // Update calendar data
            if (data.calendar_data) {
                calendarData = data.calendar_data;
                updateCalendarGrid();
            }
            
            console.log('✅ Executive Trading Command Center loaded successfully');
        })
        .catch(error => {
            console.error('❌ Error loading dashboard intelligence:', error);
            showError('Configuration Update Failed - Unable to load dashboard intelligence');
        });
}

// ============================================================================
// UPDATE FUNCTIONS
// ============================================================================

function updateKPIMetrics(stats) {
    const totalPnl = stats.total_pnl || 0;
    animateValueUpdate('totalPnl', `$${totalPnl.toFixed(2)}`, totalPnl >= 0 ? 'text-success' : 'text-danger');
    animateValueUpdate('totalTrades', stats.total_trades || 0);
    animateValueUpdate('winRate', `${(stats.win_rate || 0).toFixed(1)}%`);
    animateValueUpdate('winLoss', `${stats.winning_trades || 0}W / ${stats.losing_trades || 0}L`);
    animateValueUpdate('profitFactor', (stats.profit_factor || 0).toFixed(2));
    animateValueUpdate('grossProfitLoss', `$${(stats.gross_profit || 0).toFixed(0)}/$${Math.abs(stats.gross_loss || 0).toFixed(0)}`);
    animateValueUpdate('expectancy', `$${(stats.expectancy || 0).toFixed(2)}`);
    animateValueUpdate('avgTrade', `$${(stats.average_trade || 0).toFixed(2)}`);
    animateValueUpdate('sqnScore', (stats.sqn || 0).toFixed(1));
}

function updateP12Intelligence(p12Data) {
    animateValueUpdate('currentScenario', p12Data.scenario || 'Analyzing Market Structure...');
    animateValueUpdate('p12High', p12Data.p12_high ? p12Data.p12_high.toFixed(2) : '-');
    animateValueUpdate('p12Mid', p12Data.p12_mid ? p12Data.p12_mid.toFixed(2) : '-');
    animateValueUpdate('p12Low', p12Data.p12_low ? p12Data.p12_low.toFixed(2) : '-');
    animateValueUpdate('directionalBias', p12Data.directional_bias || 'Neutral Assessment');
}

function updateRiskMetrics(riskData) {
    animateValueUpdate('maxDrawdown', `-$${Math.abs(riskData.max_drawdown || 0).toFixed(2)}`);
    animateValueUpdate('kellyFraction', (riskData.kelly_fraction || 0).toFixed(3));
    animateValueUpdate('sharpeRatio', (riskData.sharpe_ratio || 0).toFixed(2));
    animateValueUpdate('calmarRatio', (riskData.calmar_ratio || 0).toFixed(2));
    
    // Update drawdown progress bar
    const drawdownProgress = document.getElementById('drawdownProgress');
    if (drawdownProgress && riskData.drawdown_percentage) {
        const percentage = Math.min(Math.abs(riskData.drawdown_percentage), 100);
        drawdownProgress.style.width = `${percentage}%`;
    }
}

function updatePerformanceCharts(chartData) {
    // Equity curve chart
    const equityCtx = document.getElementById('equityChart');
    if (equityCtx && chartData.equity_data) {
        new Chart(equityCtx, {
            type: 'line',
            data: {
                labels: chartData.equity_labels || [],
                datasets: [{
                    label: 'Portfolio Equity',
                    data: chartData.equity_data || [],
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(0,0,0,0.1)' } },
                    x: { grid: { color: 'rgba(0,0,0,0.1)' } }
                }
            }
        });
    }
    
    // Daily P&L chart
    const dailyCtx = document.getElementById('dailyPnlChart');
    if (dailyCtx && chartData.daily_pnl) {
        const colors = chartData.daily_pnl.map(val => 
            val >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'
        );
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: chartData.daily_labels || [],
                datasets: [{
                    label: 'Daily P&L',
                    data: chartData.daily_pnl || [],
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(0,0,0,0.1)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
}

function updateModelPerformanceMatrix(modelsData) {
    const tbody = document.getElementById('modelComparisonBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!modelsData || Object.keys(modelsData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No model performance data available</td></tr>';
        return;
    }
    
    Object.entries(modelsData).forEach(([modelName, stats]) => {
        const successRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
        const avgR = stats.trades > 0 ? (stats.total_r / stats.trades).toFixed(2) : 0;
        const statusClass = stats.active ? 'status-online' : 'status-offline';
        const statusText = stats.active ? 'Active' : 'Inactive';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="model-name-display">
                    <strong>${modelName}</strong>
                    <div class="text-muted small">Version ${stats.version || '1.0'}</div>
                </div>
            </td>
            <td class="text-center">${stats.trades || 0}</td>
            <td class="text-center">
                <span class="badge ${successRate >= 60 ? 'bg-success' : successRate >= 40 ? 'bg-warning' : 'bg-danger'}">
                    ${successRate}%
                </span>
            </td>
            <td class="text-center">${avgR}R</td>
            <td class="text-end">
                <span class="badge ${stats.total_pnl >= 0 ? 'bg-success' : 'bg-danger'}">
                    $${(stats.total_pnl || 0).toFixed(2)}
                </span>
            </td>
            <td class="text-center">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="status-indicator ${statusClass}"></div>
                    <span class="ms-2">${statusText}</span>
                </div>
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="viewModelConfiguration('${modelName}')" title="Review Model Configuration">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="editModelConfiguration('${modelName}')" title="Modify Configuration">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateTradeRecords(tradesData) {
    const tbody = document.getElementById('tradesTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const recentTrades = tradesData.slice(-10).reverse();
    
    recentTrades.forEach(trade => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(trade.trade_date).toLocaleDateString()}</td>
            <td><span class="badge bg-secondary">${trade.instrument || 'N/A'}</span></td>
            <td><span class="text-muted">${trade.trading_model || 'Manual'}</span></td>
            <td>
                <span class="badge ${trade.direction === 'Long' ? 'bg-success' : 'bg-danger'}">
                    ${trade.direction || 'N/A'}
                </span>
            </td>
            <td class="text-center">${trade.total_contracts_entered || 0}</td>
            <td class="text-end">
                <span class="badge ${(trade.pnl || 0) >= 0 ? 'bg-success' : 'bg-danger'}">
                    $${(trade.pnl || 0).toFixed(2)}
                </span>
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="reviewTradeConfiguration(${trade.id})" title="Review Configuration">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="modifyTradeConfiguration(${trade.id})" title="Modify Configuration">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('showingRecords').textContent = recentTrades.length;
}

function updateTodayActivity(activityData) {
    animateValueUpdate('todayTrades', activityData.trades_today || 0);
    animateValueUpdate('todayPnl', `$${(activityData.pnl_today || 0).toFixed(2)}`);
    animateValueUpdate('activeModels', activityData.active_models || 0);
    animateValueUpdate('lastUpdate', new Date().toLocaleTimeString());
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function animateValueUpdate(elementId, newValue, additionalClass = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.style.transform = 'scale(1.05)';
    element.style.transition = 'all 0.3s ease';
    
    setTimeout(() => {
        element.textContent = newValue;
        if (additionalClass) {
            element.className = element.className.split(' ').filter(c => !c.startsWith('text-')).join(' ');
            element.classList.add(additionalClass);
        }
        element.style.transform = 'scale(1)';
    }, 150);
}

// ============================================================================
// ACTION FUNCTIONS (Required by Claude_instructions)
// ============================================================================

function exportStrategicReport() {
    showCustomConfirmation(
        'Confirm Strategic Analytics Export',
        'Generate comprehensive performance analytics report?',
        'btn-primary',
        'download'
    ).then(confirmed => {
        if (confirmed) {
            showSuccess('Strategic Analytics Export Processing Successfully');
            window.location.href = '/api/export/strategic-report';
        }
    });
}

function exportTradeData() {
    showCustomConfirmation(
        'Confirm Configuration Data Export',
        'Export trade configuration data to CSV format?',
        'btn-primary',
        'download'
    ).then(confirmed => {
        if (confirmed) {
            showSuccess('Configuration Data Export Processing Successfully');
            window.location.href = '/api/export/trades';
        }
    });
}

function reviewTradeConfiguration(tradeId) {
    window.location.href = `/trades/view/${tradeId}`;
}

function modifyTradeConfiguration(tradeId) {
    showCustomConfirmation(
        'Confirm Configuration Modification',
        'Access trade configuration modification interface?',
        'btn-warning',
        'edit'
    ).then(confirmed => {
        if (confirmed) {
            window.location.href = `/trades/edit/${tradeId}`;
        }
    });
}

function viewModelConfiguration(modelName) {
    window.location.href = `/models/view/${encodeURIComponent(modelName)}`;
}

function editModelConfiguration(modelName) {
    showCustomConfirmation(
        'Confirm Model Configuration Modification',
        'Access model configuration modification interface?',
        'btn-warning',
        'cog'
    ).then(confirmed => {
        if (confirmed) {
            window.location.href = `/models/edit/${encodeURIComponent(modelName)}`;
        }
    });
}
</script>
{% endblock %}