{% extends "base.html" %}

{% block title %}Trading Analytics Center{% endblock %}

{% block head_extra %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    .dashboard-container {
        padding: 1.5rem;
        min-height: calc(100vh - 120px);
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: var(--enterprise-border);
        border: 1px solid var(--enterprise-border);
    }
    .calendar-day-header {
        background: var(--enterprise-gray-100);
        padding: 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: var(--enterprise-text-secondary);
        text-transform: uppercase;
    }
    .calendar-day {
        background: var(--enterprise-white);
        padding: 0.5rem;
        min-height: 60px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .calendar-day:hover {
        background: var(--enterprise-gray-50);
    }
    .calendar-day.has-trades {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f9ff 100%);
        border-left: 3px solid var(--enterprise-primary);
    }
    .calendar-day.other-month {
        background: var(--enterprise-gray-50);
        color: var(--enterprise-text-light);
    }
    .calendar-pnl {
        font-size: 0.65rem;
        font-weight: 600;
        margin-top: 2px;
    }
    .calendar-pnl.positive {
        color: var(--enterprise-success);
    }
    .calendar-pnl.negative {
        color: var(--enterprise-danger);
    }
    .calendar-trades {
        font-size: 0.6rem;
        color: var(--enterprise-text-muted);
    }
    .metric-item {
        text-align: center;
        padding: 0.75rem;
        border: 1px solid var(--enterprise-border);
        border-radius: var(--enterprise-radius);
        background: var(--enterprise-white);
    }
    .metric-label {
        font-size: 0.75rem;
        color: var(--enterprise-text-secondary);
        font-weight: 500;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--enterprise-text-primary);
    }
    .model-performance-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid var(--enterprise-border);
        transition: background-color 0.2s ease;
    }
    .model-performance-item:hover {
        background: var(--enterprise-gray-50);
    }
    .model-performance-item:last-child {
        border-bottom: none;
    }
    .model-name {
        font-weight: 600;
        color: var(--enterprise-text-primary);
    }
    .model-stats {
        font-size: 0.8rem;
        color: var(--enterprise-text-secondary);
    }
    .model-pnl {
        font-weight: 700;
        text-align: right;
    }
    .enterprise-table .sortable {
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }
    .enterprise-table .sortable:hover {
        background: var(--enterprise-gray-50);
    }
</style>
{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="executive-title">
                    <i class="fas fa-chart-line executive-icon"></i>
                    Trading Analytics Center
                </h1>
                <p class="executive-subtitle">
                    Comprehensive Performance Intelligence & Risk Analytics
                    <span class="user-context">• {{ current_user.username }} • Real-time Data Feed</span>
                </p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>Export Report
                    </button>
                    <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>Log Trade
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- Executive KPI Dashboard -->
    <div class="row mb-0">
        <div class="col-12">
            <div class="kpi-section">
                <div class="row g-0">
                    <!-- Total P&L -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Total P&L</span>
                                <i class="fas fa-chart-line kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="totalPnl">$+0.00</div>
                            <div class="kpi-meta"><span id="totalTrades">0</span> total trades</div>
                        </div>
                    </div>
                    <!-- Win Rate -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Win Rate</span>
                                <i class="fas fa-percentage kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="winRate">0.0%</div>
                            <div class="kpi-meta"><span id="winLoss">0W / 0L</span></div>
                        </div>
                    </div>
                    <!-- Profit Factor -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Profit Factor</span>
                                <i class="fas fa-balance-scale kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="profitFactor">0.00</div>
                            <div class="kpi-meta">Gross <span id="grossProfitLoss">$0/$0</span></div>
                        </div>
                    </div>
                    <!-- Expectancy -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Expectancy</span>
                                <i class="fas fa-target kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="expectancy">$0.00</div>
                            <div class="kpi-meta">Per trade edge</div>
                        </div>
                    </div>
                    <!-- Average Trade -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">Avg Trade</span>
                                <i class="fas fa-calculator kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="avgTrade">$+0.00</div>
                            <div class="kpi-meta">Per position</div>
                        </div>
                    </div>
                    <!-- System Quality -->
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                        <div class="kpi-card">
                            <div class="kpi-header">
                                <span class="kpi-label">SQN Score</span>
                                <i class="fas fa-award kpi-icon"></i>
                            </div>
                            <div class="kpi-value" id="sqnScore">0.1</div>
                            <div class="kpi-meta">System quality</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analytics Row -->
    <div class="row g-3 mb-3">

        <!-- Trading Calendar -->
        <div class="col-lg-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-calendar-alt module-icon"></i>
                        Trading Calendar
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="module-meta" id="currentMonth">July 2025</span>
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content p-0">
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Performance Metrics -->
        <div class="col-lg-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-bar module-icon"></i>
                        Daily Performance
                    </div>
                    <div class="module-meta">Session Analytics</div>
                </div>
                <div class="module-content">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-label">Win Days</div>
                                <div class="metric-value text-success" id="winDays">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-label">Loss Days</div>
                                <div class="metric-value text-danger" id="lossDays">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-label">Daily Win Rate</div>
                                <div class="metric-value" id="dailyWinRate">0.0%</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-item">
                                <div class="metric-label">Avg Wins/Day</div>
                                <div class="metric-value" id="avgWinsPerDay">0.0</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="metric-item">
                                <div class="metric-label">Daily Expectancy</div>
                                <div class="metric-value" id="dailyExpectancy">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance -->
        <div class="col-lg-4">
            <div class="enterprise-module h-100">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cogs module-icon"></i>
                        Model Analytics
                    </div>
                    <div class="module-meta">Strategy Performance</div>
                </div>
                <div class="module-content">
                    <div class="model-performance-list" id="modelPerformance">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-3">
        <div class="col-lg-4">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-line module-icon"></i>
                        Equity Curve
                    </div>
                </div>
                <div class="module-content">
                    <canvas id="equityChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-bar module-icon"></i>
                        Daily P&L Distribution
                    </div>
                </div>
                <div class="module-content">
                    <canvas id="dailyPnlChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-pie module-icon"></i>
                        Monthly Performance
                    </div>
                </div>
                <div class="module-content">
                    <canvas id="monthlyChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Execution Records -->
    <div class="row">
        <div class="col-12">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-database module-icon"></i>
                        Trade Execution Records
                    </div>
                </div>
                <div class="module-content">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 enterprise-table">
                            <thead class="table-header">
                                <tr>
                                    <th>Date</th>
                                    <th>Symbol</th>
                                    <th>Model</th>
                                    <th>Position</th>
                                    <th>Contracts</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-center">
                        <div class="pagination-summary">
                            <strong>Showing <span id="showingRecords">0</span> recent trades</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Loading Trading Analytics Center...');

    // Load dashboard data from API
    fetch('/api/dashboard-data')
        .then(response => response.json())
        .then(data => {
            console.log('📊 Dashboard data loaded:', data);

            // Update KPI cards
            if (data.stats) {
                updateKPICards(data.stats);
            }

            // Update daily metrics
            if (data.stats) {
                updateDailyMetrics(data.stats);
            }

            // Update model performance
            if (data.model_analytics) {
                updateModelPerformance(data.model_analytics);
            }

            // Update calendar
            if (data.calendar_data) {
                updateCalendar(data.calendar_data, data.current_year, data.current_month_num);
            }

            // Update charts
            if (data.chart_data) {
                updateCharts(data.chart_data);
            }

            // Update trade table
            if (data.trades_data) {
                updateTradeTable(data.trades_data);
            }

            console.log('✅ Dashboard loaded successfully!');
        })
        .catch(error => {
            console.error('❌ Error loading dashboard:', error);
        });
});

function updateKPICards(stats) {
    // Total P&L
    const totalPnl = stats.total_pnl || 0;
    document.getElementById('totalPnl').textContent = `$${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)}`;
    document.getElementById('totalPnl').className = totalPnl >= 0 ? 'kpi-value text-success' : 'kpi-value text-danger';

    // Total Trades
    document.getElementById('totalTrades').textContent = stats.total_trades || 0;

    // Win Rate
    document.getElementById('winRate').textContent = `${(stats.win_rate || 0).toFixed(1)}%`;
    document.getElementById('winLoss').textContent = `${stats.winning_trades || 0}W / ${stats.losing_trades || 0}L`;

    // Profit Factor
    document.getElementById('profitFactor').textContent = (stats.profit_factor || 0).toFixed(2);
    document.getElementById('grossProfitLoss').textContent = `$${(stats.gross_profit || 0).toFixed(0)}/$${(stats.gross_loss || 0).toFixed(0)}`;

    // Expectancy
    document.getElementById('expectancy').textContent = `$${(stats.expectancy || 0).toFixed(2)}`;

    // Average Trade
    const avgTrade = stats.average_trade || 0;
    document.getElementById('avgTrade').textContent = `$${avgTrade >= 0 ? '+' : ''}${avgTrade.toFixed(2)}`;

    // SQN Score
    document.getElementById('sqnScore').textContent = (stats.sqn || 0).toFixed(1);
}

function updateDailyMetrics(stats) {
    document.getElementById('winDays').textContent = stats.win_days || 0;
    document.getElementById('lossDays').textContent = stats.loss_days || 0;
    document.getElementById('dailyWinRate').textContent = `${(stats.daily_win_rate || 0).toFixed(1)}%`;
    document.getElementById('avgWinsPerDay').textContent = (stats.avg_wins_per_day || 0).toFixed(1);
    document.getElementById('dailyExpectancy').textContent = `$${(stats.daily_expectancy || 0).toFixed(2)}`;
}

function updateModelPerformance(models) {
    const container = document.getElementById('modelPerformance');
    if (!models || Object.keys(models).length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-muted">No model data available</div>';
        return;
    }

    container.innerHTML = '';
    Object.entries(models).forEach(([model, stats]) => {
        const winRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
        const avgPnl = stats.trades > 0 ? (stats.total_pnl / stats.trades).toFixed(2) : 0;

        const item = document.createElement('div');
        item.className = 'model-performance-item';
        item.innerHTML = `
            <div>
                <div class="model-name">${model}</div>
                <div class="model-stats">${stats.trades} trades • ${winRate}% WR</div>
            </div>
            <div>
                <div class="model-pnl ${stats.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                    $${stats.total_pnl >= 0 ? '+' : ''}${stats.total_pnl.toFixed(2)}
                </div>
                <div class="model-stats">Avg: $${avgPnl}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

function updateCalendar(calendarData, year, month) {
    const grid = document.getElementById('calendarGrid');
    const currentDate = new Date(year, month - 1, 1);

    grid.innerHTML = '';

    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });

    // Add calendar days
    const daysInMonth = new Date(year, month, 0).getDate();
    const firstDayOfWeek = new Date(year, month - 1, 1).getDay();

    // Empty cells before month starts
    for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        grid.appendChild(emptyDay);
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';

        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = calendarData[dateStr];

        if (dayData && dayData.trades > 0) {
            dayElement.classList.add('has-trades');
            dayElement.innerHTML = `
                <div style="font-weight: 600;">${day}</div>
                <div class="calendar-pnl ${dayData.pnl >= 0 ? 'positive' : 'negative'}">
                    $${dayData.pnl >= 0 ? '+' : ''}${dayData.pnl.toFixed(0)}
                </div>
                <div class="calendar-trades">${dayData.trades} trades</div>
            `;

            dayElement.addEventListener('click', () => {
                window.location.href = `/journal/daily/${dateStr}`;
            });
        } else {
            dayElement.innerHTML = `<div style="font-weight: 600;">${day}</div>`;
        }

        grid.appendChild(dayElement);
    }

    // Update month display
    document.getElementById('currentMonth').textContent =
        new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

function updateCharts(chartData) {
    // Simple chart setup - equity curve
    const ctx = document.getElementById('equityChart');
    if (ctx && chartData.equity_data) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.equity_labels || [],
                datasets: [{
                    label: 'Equity',
                    data: chartData.equity_data || [],
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // Daily P&L chart
    const dailyCtx = document.getElementById('dailyPnlChart');
    if (dailyCtx && chartData.daily_pnl) {
        const colors = chartData.daily_pnl.map(val => val >= 0 ? '#28a745' : '#dc3545');
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: chartData.daily_labels || [],
                datasets: [{
                    label: 'Daily P&L',
                    data: chartData.daily_pnl || [],
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // Monthly P&L chart
    const monthlyCtx = document.getElementById('monthlyChart');
    if (monthlyCtx && chartData.monthly_pnl) {
        const colors = chartData.monthly_pnl.map(val => val >= 0 ? '#28a745' : '#dc3545');
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: chartData.monthly_labels || [],
                datasets: [{
                    label: 'Monthly P&L',
                    data: chartData.monthly_pnl || [],
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }
}

function updateTradeTable(tradesData) {
    const tbody = document.getElementById('tradesTableBody');
    tbody.innerHTML = '';

    // Show last 20 trades
    const recentTrades = tradesData.slice(-20).reverse();

    recentTrades.forEach(trade => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(trade.trade_date).toLocaleDateString()}</td>
            <td><span class="badge bg-secondary">${trade.instrument || 'N/A'}</span></td>
            <td><span class="text-muted small">${trade.trading_model || 'N/A'}</span></td>
            <td><span class="badge ${trade.direction === 'Long' ? 'bg-success' : 'bg-danger'}">${trade.direction || 'N/A'}</span></td>
            <td class="text-center">${trade.total_contracts_entered || 0}</td>
            <td class="text-end">
                <span class="badge ${(trade.pnl || 0) >= 0 ? 'bg-success' : 'bg-danger'}">
                    $${(trade.pnl || 0) >= 0 ? '+' : ''}${(trade.pnl || 0).toFixed(2)}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.getElementById('showingRecords').textContent = recentTrades.length;
}

// Calendar navigation
let currentCalendarDate = new Date();
function changeMonth(direction) {
    // Simple month navigation - will be enhanced with API call
    console.log('Month navigation clicked:', direction);
}
</script>
{% endblock %}