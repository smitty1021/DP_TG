{% extends "base.html" %}
{% import "macros/_form_helpers.html" as forms %}

{% block title %}
    Update Trade Configuration: {{ trade.instrument }} ({{ trade.direction }}) on {{ trade.trade_date.strftime('%d-%b-%Y') }} - Trading Journal
{% endblock %}

{% block head_extra %}
{{ super() }}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
{% endblock %}

{% block page_header %}
    <div class="executive-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-edit executive-icon"></i>
                    Update Trade Configuration
                </h1>
                <div class="executive-subtitle">
                    Modify strategic parameters: {{ trade.instrument }} ({{ trade.direction }}) on {{ trade.trade_date.strftime('%d-%b-%Y') }}
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}'"
                        title="View Trade Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.view_trades_list') }}'"
                        title="Back to Trading Operations">
                    <i class="fas fa-list"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid" style="width: 100%; max-width: none; padding-left: 2rem; padding-right: 2rem;">
    <!-- Unsaved Changes Indicator -->
    <div id="unsaved-changes-indicator" class="unsaved-changes-indicator">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Configuration changes pending
    </div>

    <!-- Trade Stats Dashboard (Auto-calculated) -->
    <div id="trade-stats-dashboard" class="enterprise-module mb-4">
        <div class="module-header">
            <div class="module-title">
                <i class="fas fa-calculator module-icon"></i>
                Strategic Performance Metrics
            </div>
        </div>
        <div class="module-content">
            <div class="metrics-bar">
                <div class="kpi-card">
                    <div class="kpi-label">Risk:Reward</div>
                    <div id="risk-reward-display" class="kpi-value">--:--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Duration</div>
                    <div id="time-in-trade-display" class="kpi-value">--:--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Points Risked</div>
                    <div id="points-risked-display" class="kpi-value">--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">$ Risked</div>
                    <div id="dollar-risk-display" class="kpi-value">$--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Gross P&L</div>
                    <div id="gross-pnl-display" class="kpi-value">$--</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Overall Rating</div>
                    <div id="overall-rating-display" class="kpi-value">--/5</div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" id="tradeForm" novalidate enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- 1. TRADE DETAILS (Combined with Risk/Reward) -->
        <div class="enterprise-module">
            <div class="module-header">
                <div class="module-title">
                    <i class="fas fa-cog module-icon"></i>
                    Strategic Configuration Parameters
                </div>
            </div>
            <div class="module-content">
                <div class="grid-9-col">
                    {{ forms.render_field(form.trade_date, input_class="form-control", type="date") }}
                    {{ forms.render_field(form.instrument, input_class="form-select") }}
                    {{ forms.render_field(form.direction, input_class="form-select") }}
                    {{ forms.render_field(form.initial_stop_loss, input_class="form-control", type="number", step="any", placeholder="SL Price") }}
                    {{ forms.render_field(form.terminus_target, input_class="form-control", type="number", step="any", placeholder="Final TP price level") }}
                    {{ forms.render_field(form.trading_model_id, input_class="form-select") }}
                    {{ forms.render_field(form.how_closed, input_class="form-select") }}
                    {{ forms.render_field(form.mae, input_class="form-control", type="number", step="any", placeholder="Ticks Against You") }}
                    {{ forms.render_field(form.mfe, input_class="form-control", type="number", step="any", placeholder="Ticks In Your Favor") }}
                </div>

                <!-- ENTRY/EXIT POINTS -->
                <div class="grid grid-cols-2">
                    <div class="enterprise-module">
                        <div class="module-header">
                            <div class="module-title">Execution Entry Points</div>
                        </div>
                        <div class="module-content">
                            <div class="entry-exit-headers">
                                <div>Entry Time</div>
                                <div># of Contracts</div>
                                <div>Price Level</div>
                                <div></div>
                            </div>
                            <div id="entry-points-container">
                                {% for entry_form_field in form.entries %}
                                <div class="entry-exit-item">
                                    {{ entry_form_field.id }} {# Renders the hidden ID field for existing entries #}
                                    <div class="entry-exit-row">
                                        {{ forms.render_field(entry_form_field.entry_time, input_class="form-control form-control-sm", type="time", label_visible=False) }}
                                        {{ forms.render_field(entry_form_field.contracts, input_class="form-control form-control-sm", type="number", label_visible=False) }}
                                        {{ forms.render_field(entry_form_field.entry_price, input_class="form-control form-control-sm", type="number", step="any", label_visible=False) }}
                                        <div>
                                        {% if loop.index > form.entries.min_entries %}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry"><i class="fas fa-trash-alt"></i></button>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-entry-button" title="Add Entry"><i class="fas fa-plus"></i> Add Entry</button>
                        </div>
                    </div>

                    <div class="enterprise-module">
                        <div class="module-header">
                            <div class="module-title">Execution Exit Points</div>
                        </div>
                        <div class="module-content">
                            <div class="entry-exit-headers">
                                <div>Exit Time</div>
                                <div># of Contracts</div>
                                <div>Price Level</div>
                                <div></div>
                            </div>
                            <div id="exit-points-container">
                                 {% for exit_form_field in form.exits %}
                                 <div class="entry-exit-item">
                                     {{ exit_form_field.id }} {# Renders the hidden ID field for existing exits #}
                                    <div class="entry-exit-row">
                                        {{ forms.render_field(exit_form_field.exit_time, input_class="form-control form-control-sm", type="time", label_visible=False) }}
                                        {{ forms.render_field(exit_form_field.contracts, input_class="form-control form-control-sm", type="number", label_visible=False) }}
                                        {{ forms.render_field(exit_form_field.exit_price, input_class="form-control form-control-sm", type="number", step="any", label_visible=False) }}
                                        <div>
                                        {% if loop.index > 1 or form.exits|length > 1 %} {# Allow removing exits unless it's the very last one #}
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit"><i class="fas fa-trash-alt"></i></button>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-exit-button" title="Add Exit"><i class="fas fa-plus"></i> Add Exit</button>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    {{ forms.render_checkbox(form.is_dca) }}
                </div>
            </div>
        </div>

        <!-- 2. TRADE ANALYSIS -->
        <div class="enterprise-module">
            <div class="module-header">
                <div class="module-title">
                    <i class="fas fa-chart-line module-icon"></i>
                    Strategic Analysis Framework
                </div>
            </div>
            <div class="module-content">
                <div class="form-group mb-3">
                    {{ form.trade_notes.label(class="form-label") }}
                    <div id="trade_notes_editor" class="quill-editor-container"></div>
                    {{ form.trade_notes(class="d-none") }}
                    {% if form.trade_notes.errors %}<div class="invalid-feedback d-block">{% for error in form.trade_notes.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                    {% if form.trade_notes.description %}<small class="form-text text-muted">{{ form.trade_notes.description }}</small>{% endif %}
                </div>

                <div class="form-group mb-3">
                    {{ form.overall_analysis_notes.label(class="form-label") }}
                    <div id="overall_analysis_notes_editor" class="quill-editor-container"></div>
                    {{ form.overall_analysis_notes(class="d-none") }}
                    {% if form.overall_analysis_notes.errors %}<div class="invalid-feedback d-block">{% for error in form.overall_analysis_notes.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                    {% if form.overall_analysis_notes.description %}<small class="form-text text-muted">{{ form.overall_analysis_notes.description }}</small>{% endif %}
                </div>

                <!-- Three-column layout for management, errors, and improvements -->
                <div class="grid grid-cols-3">
                    <div>
                        <h5>Execution Management</h5>
                        {{ forms.render_field(form.trade_management_notes, input_class="form-control", rows="4", placeholder="Trade management decisions, scaling in/out, adjustments, etc.", label_visible=false) }}
                    </div>
                    <div>
                        <h5>Execution Issues</h5>
                        {{ forms.render_field(form.errors_notes, input_class="form-control", rows="4", placeholder="Any mistakes made during this trade?", label_visible=false) }}
                    </div>
                    <div>
                        <h5>Enhancement Opportunities</h5>
                        {{ forms.render_field(form.improvements_notes, input_class="form-control", rows="4", placeholder="What could be improved for the next trade?", label_visible=false) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. PSYCHOLOGICAL REVIEW -->
        <div class="enterprise-module">
            <div class="module-header">
                <div class="module-title">
                    <i class="fas fa-user-check module-icon"></i>
                    Performance Assessment & Review
                </div>
            </div>
            <div class="module-content">
                <div class="grid grid-cols-2">
                    <div>
                        <h6>Rate execution effectiveness across key performance criteria:</h6>
                        <div class="grid-5-col">
                            {{ forms.render_field(form.preparation_rating, input_class="form-select rating-selector") }}
                            {{ forms.render_field(form.rules_rating, input_class="form-select rating-selector") }}
                            {{ forms.render_field(form.management_rating, input_class="form-select rating-selector") }}
                            {{ forms.render_field(form.entry_rating, input_class="form-select rating-selector") }}
                            {{ forms.render_field(form.target_rating, input_class="form-select rating-selector") }}
                        </div>
                        {{ forms.render_field(form.psych_scored_highest, input_class="form-control", rows="2", placeholder="What execution strengths were demonstrated?") }}
                        {{ forms.render_field(form.psych_scored_lowest, input_class="form-control", rows="2", placeholder="Which areas require performance improvement?") }}
                    </div>
                    <div>
                        <div style="max-width: 350px; margin: auto;">
                            <canvas id="psychRadarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. IMAGES, LINKS, & TAGS -->
        <div class="enterprise-module">
            <div class="module-header">
                <div class="module-title">
                    <i class="fas fa-folder-open module-icon"></i>
                    Documentation & Classification
                </div>
            </div>
            <div class="module-content">
                <!-- Display existing images with delete option -->
                {% if trade.images.count() > 0 %}
                <div class="mb-4">
                    <h5>Current Documentation</h5>
                    {% for image in trade.images %}
                    <div class="image-delete-item">
                        <img src="{{ url_for('static', filename=current_app.config['UPLOAD_FOLDER'].split('/')[-1] + '/' + image.filepath if '/' in current_app.config['UPLOAD_FOLDER'] else current_app.config['UPLOAD_FOLDER'] + '/' + image.filepath) }}" alt="{{ image.filename }}" class="existing-image-preview img-thumbnail">
                        <span class="me-2">{{ image.filename }}</span>
                        <input type="checkbox" name="delete_image_{{ image.id }}" id="delete_image_{{ image.id }}" value="{{ image.id }}" class="form-check-input ms-2">
                        <label for="delete_image_{{ image.id }}" class="form-check-label ms-1">Remove Configuration</label>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="grid grid-cols-3">
                    <div>
                        {{ forms.render_field(form.trade_images, input_class="form-control") }}
                        <small class="form-text text-muted">Upload new strategic documentation or relevant analysis images. Check the box next to existing documentation to remove it.</small>
                    </div>
                    <div>
                        {{ forms.render_field(form.screenshot_link, input_class="form-control", type="url", placeholder="https://www.tradingview.com/chart/...") }}
                        <small class="form-text text-muted">External documentation links from trading platform analysis.</small>
                    </div>
                    <div>
                        <div class="mb-3">
                            <label for="tags-select" class="form-label">{{ form.tags.label.text }}</label>
                            <select multiple class="form-select" id="tags-select" name="{{ form.tags.name }}">
                                {% for category_name, tag_options in form.tags.choices %}
                                    <optgroup label="{{ category_name }}">
                                        {% for tag_id, tag_name, tag_color in tag_options %}
                                            <option value="{{ tag_id }}"
                                                    data-color="{{ tag_color or 'neutral' }}"
                                                    class="tag-{{ tag_color or 'neutral' }}"
                                                    {% if tag_id in (form.tags.data or []) %}selected{% endif %}>
                                                {{ tag_name }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                            {% if form.tags.errors %}
                                {% for error in form.tags.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <small class="form-text text-muted">Select appropriate classification tags for this strategic execution.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-buttons-container">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Update Configuration</button>
            <button type="button" class="btn btn-outline-secondary" onclick="handleCancelAction()"><i class="fas fa-times me-1"></i> Cancel</button>
        </div>
    </form>
</div>

{# Hidden templates for dynamic entries/exits - use raw HTML #}
<div id="entry-template" style="display: none;">
    <div class="entry-exit-item">
        <div class="entry-exit-row">
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-entry_time" name="entries-INDEX-entry_time" type="time" placeholder="HH:MM">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-contracts" name="entries-INDEX-contracts" type="number" placeholder="Contracts">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-entry_price" name="entries-INDEX-entry_price" type="number" step="any" placeholder="Price">
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="exit-template" style="display: none;">
    <div class="entry-exit-item">
        <div class="entry-exit-row">
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-exit_time" name="exits-INDEX-exit_time" type="time" placeholder="HH:MM">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-contracts" name="exits-INDEX-contracts" type="number" placeholder="Contracts">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-exit_price" name="exits-INDEX-exit_price" type="number" step="any" placeholder="Price">
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
// Unsaved changes detection
let hasUnsavedChanges = false;
const unsavedIndicator = document.getElementById('unsaved-changes-indicator');

function markUnsaved() {
    hasUnsavedChanges = true;
    if (unsavedIndicator) {
        unsavedIndicator.style.display = 'block';
    }
}

function markSaved() {
    hasUnsavedChanges = false;
    if (unsavedIndicator) {
        unsavedIndicator.style.display = 'none';
    }
}

function handleCancelAction() {
    if (hasUnsavedChanges) {
        showCustomConfirmation(
            'Unsaved Changes Detected',
            'Configuration changes have been made but not saved. Are you sure you want to leave without saving?',
            'btn-warning',
            'exclamation-triangle',
            function() {
                window.location.href = '{{ url_for("trades.view_trade_detail", trade_id=trade.id) }}';
            }
        );
    } else {
        window.location.href = '{{ url_for("trades.view_trade_detail", trade_id=trade.id) }}';
    }
}

// Warn before page unload if there are unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        const message = 'Configuration changes pending. Are you sure you want to leave?';
        e.returnValue = message;
        return message;
    }
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('Enterprise edit trade page JavaScript initializing...');

    // Create tag color mapping from the backend data
    const tagColors = {};
    {% for category_name, tag_options in form.tags.choices %}
        {% for tag_id, tag_name, tag_color in tag_options %}
            tagColors['{{ tag_id }}'] = '{{ tag_color or "neutral" }}';
        {% endfor %}
    {% endfor %}

    // --- INITIALIZE TAGS SELECT (ONLY ONCE) ---
    const tagsSelect = document.getElementById('tags-select');
    if (tagsSelect) {
        new TomSelect(tagsSelect, {
            plugins: ['remove_button'],
            placeholder: 'Select or search for classification tags...',
            render: {
                option: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="option ${colorClass}">${escape(data.text)}</div>`;
                },
                item: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="item ${colorClass}">${escape(data.text)}</div>`;
                }
            }
        });
        console.log('TomSelect initialized for tags with colors');
    }

    // Monitor form changes
    const form = document.getElementById('tradeForm');
    if (form) {
        form.addEventListener('input', markUnsaved);
        form.addEventListener('change', markUnsaved);

        form.addEventListener('submit', function() {
            markSaved(); // Clear the flag on form submission
            showSuccess('Configuration Updated Successfully');
        });
    }

    // --- TRADE STATS DASHBOARD CALCULATIONS ---
    const dashboard = document.getElementById('trade-stats-dashboard');

    // Use the dynamic point values passed from backend
    const instrumentPointValues = {{ instrument_point_values|tojson|safe }};
    console.log('Available instruments and point values:', instrumentPointValues);

    // COMPREHENSIVE field watching for P&L updates
    function addCalculationListeners() {
        console.log('Adding calculation listeners...');

        // Watch all form fields that affect calculations
        const fieldsToWatch = [
            '[name="instrument"]',
            '[name="direction"]',
            '[name="initial_stop_loss"]',
            '[name="terminus_target"]',
            '[name^="entries-"][name$="-entry_time"]',
            '[name^="entries-"][name$="-contracts"]',
            '[name^="entries-"][name$="-entry_price"]',
            '[name^="exits-"][name$="-exit_time"]',
            '[name^="exits-"][name$="-contracts"]',
            '[name^="exits-"][name$="-exit_price"]',
            '[name$="_rating"]'
        ];

        fieldsToWatch.forEach(selector => {
            document.querySelectorAll(selector).forEach(field => {
                // Remove existing listeners to avoid duplicates
                field.removeEventListener('input', calculateStats);
                field.removeEventListener('change', calculateStats);

                // Add listeners
                field.addEventListener('input', calculateStats);
                field.addEventListener('change', calculateStats);
            });
        });
    }

    // Also watch for dynamically added entry/exit fields
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('entries-') || e.target.name.includes('exits-'))) {
            calculateStats();
        }
    });

    // Also watch for change events on select fields
    document.addEventListener('change', function(e) {
        if (e.target.name && (
            e.target.name === 'instrument' ||
            e.target.name === 'direction' ||
            e.target.name.includes('entries-') ||
            e.target.name.includes('exits-') ||
            e.target.name.includes('_rating')
        )) {
            calculateStats();
        }
    });

    function calculateStats() {
        console.log('=== Calculating Stats ===');

        try {
            const instrumentSelectElement = document.querySelector('[name="instrument"]');
            const instrumentId = instrumentSelectElement?.value || '';
            const direction = document.querySelector('[name="direction"]')?.value || '';
            const stopLoss = parseFloat(document.querySelector('[name="initial_stop_loss"]')?.value || '0');
            const target = parseFloat(document.querySelector('[name="terminus_target"]')?.value || '0');

            // FIXED: Get point value by looking up the instrument symbol from the select option text
            let pointValue = 1.0; // Default fallback

            if (instrumentId && instrumentSelectElement) {
                // Find the selected option and extract the symbol from its text
                const selectedOption = instrumentSelectElement.querySelector(`option[value="${instrumentId}"]`);
                if (selectedOption) {
                    const optionText = selectedOption.textContent; // e.g., "NQ (E-mini NASDAQ-100)"
                    // Extract symbol (everything before the first space or parenthesis)
                    const symbolMatch = optionText.match(/^([A-Z]+)/);
                    if (symbolMatch) {
                        const symbol = symbolMatch[1];
                        console.log(`Found symbol: ${symbol} for instrument ID: ${instrumentId}`);

                        // Now look up the point value by symbol
                        if (instrumentPointValues[symbol]) {
                            pointValue = instrumentPointValues[symbol];
                            console.log(`Point value for ${symbol}: ${pointValue}`);
                        } else {
                            console.warn(`No point value found for symbol: ${symbol}`);
                            // Fallback to common values
                            const fallbackValues = {
                                'NQ': 20.0, 'ES': 50.0, 'YM': 5.0,
                                'MNQ': 2.0, 'MES': 5.0, 'MYM': 0.5
                            };
                            pointValue = fallbackValues[symbol] || 1.0;
                        }
                    }
                }
            }

            console.log(`Using point value: ${pointValue} for calculation`);

            // Get ALL entry data
            const entryFields = document.querySelectorAll('[name^="entries-"][name$="-entry_price"]');
            const entryContractFields = document.querySelectorAll('[name^="entries-"][name$="-contracts"]');
            const entryTimeFields = document.querySelectorAll('[name^="entries-"][name$="-entry_time"]');

            let totalEntryContracts = 0;
            let weightedEntryPrice = 0;
            let firstEntryTime = '';

            // Calculate weighted average entry price
            for (let i = 0; i < entryFields.length; i++) {
                const price = parseFloat(entryFields[i].value || '0');
                const contracts = parseInt(entryContractFields[i]?.value || '0');
                const time = entryTimeFields[i]?.value || '';

                if (price > 0 && contracts > 0) {
                    weightedEntryPrice += price * contracts;
                    totalEntryContracts += contracts;
                    if (!firstEntryTime) firstEntryTime = time;
                }
            }

            const avgEntryPrice = totalEntryContracts > 0 ? weightedEntryPrice / totalEntryContracts : 0;

            // Get ALL exit data
            const exitFields = document.querySelectorAll('[name^="exits-"][name$="-exit_price"]');
            const exitContractFields = document.querySelectorAll('[name^="exits-"][name$="-contracts"]');
            const exitTimeFields = document.querySelectorAll('[name^="exits-"][name$="-exit_time"]');

            let totalExitContracts = 0;
            let weightedExitPrice = 0;
            let lastExitTime = '';

            // Calculate weighted average exit price
            for (let i = 0; i < exitFields.length; i++) {
                const price = parseFloat(exitFields[i].value || '0');
                const contracts = parseInt(exitContractFields[i]?.value || '0');
                const time = exitTimeFields[i]?.value || '';

                if (price > 0 && contracts > 0) {
                    weightedExitPrice += price * contracts;
                    totalExitContracts += contracts;
                    lastExitTime = time;
                }
            }

            const avgExitPrice = totalExitContracts > 0 ? weightedExitPrice / totalExitContracts : 0;

            // Show dashboard - it's always visible in edit mode
            dashboard.style.display = 'block';

            // Calculate Risk:Reward
            let riskRewardText = '--:--';
            if (avgEntryPrice > 0 && stopLoss > 0 && target > 0) {
                let risk, reward;
                if (direction === 'Long') {
                    risk = Math.abs(avgEntryPrice - stopLoss);
                    reward = Math.abs(target - avgEntryPrice);
                } else if (direction === 'Short') {
                    risk = Math.abs(stopLoss - avgEntryPrice);
                    reward = Math.abs(avgEntryPrice - target);
                }

                if (risk > 0) {
                    const ratio = reward / risk;
                    riskRewardText = `1:${ratio.toFixed(2)}`;
                }
            }

            // Calculate Time in Trade
            let timeInTradeText = '--:--';
            if (firstEntryTime && lastExitTime) {
                const [entryHour, entryMin] = firstEntryTime.split(':').map(Number);
                const [exitHour, exitMin] = lastExitTime.split(':').map(Number);

                const entryMinutes = entryHour * 60 + entryMin;
                const exitMinutes = exitHour * 60 + exitMin;

                let diffMinutes = exitMinutes - entryMinutes;
                if (diffMinutes < 0) diffMinutes += 24 * 60;

                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                timeInTradeText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }

            // Calculate Points Risked
            let pointsRiskedText = '--';
            let dollarRiskText = '$--';
            if (avgEntryPrice > 0 && stopLoss > 0 && totalEntryContracts > 0) {
                let pointsRisk;
                if (direction === 'Long') {
                    pointsRisk = Math.abs(avgEntryPrice - stopLoss);
                } else if (direction === 'Short') {
                    pointsRisk = Math.abs(stopLoss - avgEntryPrice);
                }

                if (pointsRisk > 0) {
                    pointsRiskedText = pointsRisk.toFixed(2);
                    const dollarRisk = pointsRisk * totalEntryContracts * pointValue;
                    dollarRiskText = `${dollarRisk.toFixed(2)}`;
                }
            }

            // Calculate Gross P&L - FIXED WITH CORRECT POINT VALUE
            let grossPnlText = '$--';
            let pnlClass = '';
            if (avgEntryPrice > 0 && avgExitPrice > 0 && totalExitContracts > 0) {
                let pnlPerContract;
                if (direction === 'Long') {
                    pnlPerContract = avgExitPrice - avgEntryPrice;
                } else if (direction === 'Short') {
                    pnlPerContract = avgEntryPrice - avgExitPrice;
                }

                const grossPnl = pnlPerContract * totalExitContracts * pointValue;
                grossPnlText = `${grossPnl.toFixed(2)}`;

                console.log(`P&L Calculation: ${pnlPerContract} * ${totalExitContracts} * ${pointValue} = ${grossPnl}`);

                if (grossPnl > 0) {
                    pnlClass = 'text-profit';
                } else if (grossPnl < 0) {
                    pnlClass = 'text-loss';
                } else {
                    pnlClass = 'text-breakeven';
                }
            }

            // Calculate Overall Trade Rating
            let overallRatingText = '--/5';
            const ratings = [
                'preparation_rating', 'rules_rating', 'management_rating',
                'target_rating', 'entry_rating'
            ];

            const ratingValues = ratings.map(name => {
                const value = parseInt(document.querySelector(`[name="${name}"]`)?.value || '0');
                return value > 0 ? value : null;
            }).filter(v => v !== null);

            if (ratingValues.length > 0) {
                const avgRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
                overallRatingText = `${avgRating.toFixed(1)}/5`;
            }

            // Update display
            document.getElementById('risk-reward-display').textContent = riskRewardText;
            document.getElementById('time-in-trade-display').textContent = timeInTradeText;
            document.getElementById('points-risked-display').textContent = pointsRiskedText;
            document.getElementById('dollar-risk-display').textContent = dollarRiskText;

            const pnlElement = document.getElementById('gross-pnl-display');
            pnlElement.textContent = grossPnlText;
            pnlElement.className = `kpi-value ${pnlClass}`;

            document.getElementById('overall-rating-display').textContent = overallRatingText;

        } catch (error) {
            console.error('Error calculating trade stats:', error);
        }
    }

    // --- DYNAMIC FIELDS LOGIC ---
    function initializeDynamicFields(containerId, addButtonId, templateId, itemClass, removeButtonClass, fieldListName, minEntries) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const addButton = document.getElementById(addButtonId);
        const templateElement = document.getElementById(templateId);
        if (!templateElement) return;

        const templateHtml = templateElement.innerHTML;

        function addRemoveButtonListeners(scope = document) {
            scope.querySelectorAll('.' + removeButtonClass).forEach(button => {
                button.removeEventListener('click', handleRemoveItem);
                button.addEventListener('click', handleRemoveItem);
            });
        }

        function handleRemoveItem(event) {
            const min = parseInt(minEntries, 10);
            if (container.querySelectorAll('.' + itemClass).length > min) {
                showCustomConfirmation(
                    'Confirm Configuration Change',
                    'Are you sure you want to remove this entry/exit point?',
                    'btn-warning',
                    'question-circle',
                    function() {
                        event.target.closest('.' + itemClass).remove();
                        addCalculationListeners();
                        calculateStats();
                        markUnsaved();
                    }
                );
            } else {
                showError(`At least ${min} ${fieldListName.slice(0, -1)}(s) must remain.`);
            }
        }

        if (addButton) {
            addButton.addEventListener('click', function() {
                const newIndex = container.querySelectorAll('.' + itemClass).length;
                let newItemHtml = templateHtml.replace(/INDEX/g, newIndex);

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newItemHtml;
                const newItemElement = tempDiv.firstElementChild;

                if (newItemElement) {
                    container.appendChild(newItemElement);
                    addRemoveButtonListeners(newItemElement);
                    addCalculationListeners();
                    calculateStats();
                    markUnsaved();
                }
            });
        }
        addRemoveButtonListeners(container);
    }

    // Initialize dynamic fields
    initializeDynamicFields('entry-points-container', 'add-entry-button', 'entry-template', 'entry-exit-item', 'remove-entry-btn', 'entries', parseInt('{{ form.entries.min_entries|default(1) }}', 10));
    initializeDynamicFields('exit-points-container', 'add-exit-button', 'exit-template', 'entry-exit-item', 'remove-exit-btn', 'exits', 1);

    // --- QUILL INITIALIZATION ---
    const quillToolbarOptions = [
        [{ 'header': [1, 2, 3, 4, false] }], ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }], [{ 'direction': 'rtl' }],
        [{ 'color': [] }, { 'background': [] }], [{ 'align': [] }],
        ['link', 'image'], ['clean']
    ];

    let quillInstances = {};

    function initializeQuill(editorDivId, hiddenTextareaId, placeholderText) {
        const editorDiv = document.getElementById(editorDivId);
        const hiddenTextarea = document.getElementById(hiddenTextareaId);
        if (editorDiv && hiddenTextarea) {
            quillInstances[hiddenTextareaId] = new Quill(editorDiv, {
                theme: 'snow',
                modules: { toolbar: quillToolbarOptions },
                placeholder: placeholderText || 'Enter strategic analysis...'
            });

            // MODIFIED: Populate Quill with existing data from the hidden textarea
            const existingContent = hiddenTextarea.value;
            if (existingContent) {
                try {
                    quillInstances[hiddenTextareaId].clipboard.dangerouslyPasteHTML(existingContent);
                } catch (e) {
                    quillInstances[hiddenTextareaId].setText(existingContent);
                }
            }

            // Track changes
            quillInstances[hiddenTextareaId].on('text-change', markUnsaved);
        }
    }

    // Initialize Quill editors
    initializeQuill('trade_notes_editor', '{{ form.trade_notes.id }}', 'Enter your pre-execution analysis, strategic setup, reasoning, chart analysis...');
    initializeQuill('overall_analysis_notes_editor', '{{ form.overall_analysis_notes.id }}', 'Enter your post-execution analysis, outcomes, lessons learned...');

    // Form submission handler for Quill
    const tradeForm = document.getElementById('tradeForm');
    if (tradeForm) {
        tradeForm.addEventListener('submit', function() {
            for (const textareaId in quillInstances) {
                if (quillInstances.hasOwnProperty(textareaId) && document.getElementById(textareaId)) {
                     document.getElementById(textareaId).value = quillInstances[textareaId].root.innerHTML;
                }
            }
        });
    }

    // --- RADAR CHART INITIALIZATION ---
    const ratingSelectors = document.querySelectorAll('.rating-selector');
    const psychRadarCtx = document.getElementById('psychRadarChart');

    if (psychRadarCtx && ratingSelectors.length === 5) {
        console.log('Initializing radar chart...');

        const chartLabels = ['Prep', 'Rules', 'Mgmt', 'Entry', 'Targets'];
        const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
        const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = currentTheme === 'dark' ? '#ced4da' : '#666';
        const pointLabelColor = currentTheme === 'dark' ? '#e9ecef' : '#333';

        const radarChart = new Chart(psychRadarCtx, {
            type: 'radar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Performance Assessment',
                    data: [0, 0, 0, 0, 0],
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: gridColor },
                        grid: { color: gridColor },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: { color: pointLabelColor, font: { size: 14 } },
                        ticks: { stepSize: 1, color: textColor, backdropColor: 'rgba(0, 0, 0, 0)' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        function updateRadarChart() {
            const newData = [];
            ratingSelectors.forEach(selector => {
                newData.push(parseInt(selector.value) || 0);
            });
            radarChart.data.datasets[0].data = newData;
            radarChart.update();
        }

        ratingSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                updateRadarChart();
                calculateStats();
                markUnsaved();
            });
        });

        updateRadarChart();
        console.log('Radar chart initialized successfully');
    } else {
        console.log('Radar chart not initialized - missing elements:', {
            psychRadarCtx: !!psychRadarCtx,
            ratingSelectorsCount: ratingSelectors.length
        });
    }

    // --- INITIAL SETUP ---
    console.log('Running initial setup...');
    addCalculationListeners();
    calculateStats();

    // Scroll to top to show the trade statistics dashboard
    window.scrollTo(0, 0);

    console.log('Enterprise edit trade page JavaScript initialization complete');
});
</script>
{% endblock %}