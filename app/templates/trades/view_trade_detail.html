{% extends "base.html" %}

{% block title %}{{ title }} - {{ trade.instrument }} {{ trade.direction }} Trade{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid">
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-chart-area executive-icon"></i>
                    Trade Analysis: {{ trade.instrument }} {{ trade.direction }}
                </h1>
                <div class="executive-subtitle">
                    Strategic Trading Performance Review: {{ trade.trade_date.strftime('%A, %B %d, %Y') }}
                    {% if trade.trading_model %}
                        | {{ trade.trading_model.name }} Model
                    {% endif %}
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportTradeToPDF()" 
                        title="Export Trade Analysis to PDF">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.edit_trade', trade_id=trade.id) }}'"
                        title="Edit Trade Configuration">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('journal.manage_daily_journal', date_str=trade.trade_date.strftime('%Y-%m-%d')) }}'"
                        title="Daily Journal for {{ trade.trade_date.strftime('%m/%d/%Y') }}">
                    <i class="fas fa-journal-whills"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.view_trades_list') }}'"
                        title="Back to Trading Operations">
                    <i class="fas fa-list"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Analysis">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();" title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Performance KPI Section -->
    <div class="kpi-section mt-3" id="trade-kpi-section">
        <div class="grid grid-cols-6 gap-4">
            <!-- Trade P&L -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Trade P&L</span>
                            <i class="fas fa-dollar-sign kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if trade.pnl is not none %}
                                ${{ "{:,.2f}".format(trade.pnl) }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                {% if trade.pnl is not none %}
                                    {% if trade.pnl > 0 %}
                                        <i class="fas fa-arrow-up"></i> Profitable
                                    {% elif trade.pnl < 0 %}
                                        <i class="fas fa-arrow-down"></i> Loss
                                    {% else %}
                                        <i class="fas fa-minus"></i> Breakeven
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-clock"></i> Open Position
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk:Reward Ratio -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Risk:Reward</span>
                            <i class="fas fa-balance-scale kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if trade.risk_reward_ratio %}
                                1:{{ "{:.2f}".format(trade.risk_reward_ratio) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Planned Ratio
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time in Trade -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Duration</span>
                            <i class="fas fa-clock kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ trade.time_in_trade }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Time Held
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Position Size -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Position Size</span>
                            <i class="fas fa-layer-group kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ trade.total_contracts_entered or 0 }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Contracts
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall Rating -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Quality Score</span>
                            <i class="fas fa-star kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% set ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                            {% set valid_ratings = ratings|select('ne', none)|list %}
                            {% if valid_ratings %}
                                {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                                {{ "%.1f"|format(avg_rating) }}/5.0
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Execution Quality
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L in R -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">P&L in R</span>
                            <i class="fas fa-chart-line kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if trade.pnl_in_r %}
                                {{ "{:.2f}".format(trade.pnl_in_r) }}R
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Risk Units
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-12 gap-4 align-items-start mt-3">
        <!-- Left Column: Trade Details -->
        <div class="col-span-8">
            <!-- Trade Configuration Module -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cog module-icon"></i>
                        Trade Configuration & Execution
                    </div>
                    <div class="module-meta">
                        Strategic Trade Setup Details
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Basic Trade Information -->
                        <div class="enterprise-module">
                            <div class="module-header">
                                <div class="module-title">
                                    <i class="fas fa-info-circle module-icon"></i>
                                    Trade Information
                                </div>
                            </div>
                            <div class="module-content">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">Instrument</div>
                                            <div>
                                                {{ trade.instrument }}
                                                {% if trade.instrument_obj %}
                                                    <small class="text-muted">({{ trade.instrument_obj.name }})</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">Trade Date</div>
                                            {{ trade.trade_date.strftime('%A, %B %d, %Y') }}
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">Direction</div>
                                            <span class="badge-transparent {% if trade.direction == 'Long' %}text-success{% else %}text-danger{% endif %}">
                                                {{ trade.direction }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">Trading Model</div>
                                            {{ trade.trading_model.name if trade.trading_model else 'N/A' }}
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">Exit Method</div>
                                            {{ trade.how_closed if trade.how_closed else 'N/A' }}
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">DCA Trade</div>
                                            <span class="badge-transparent {% if trade.is_dca %}text-primary{% else %}text-muted{% endif %}">
                                                {{ 'Yes' if trade.is_dca else 'No' }}
                                            </span>
                                        </div>
                                    </div>
                                    {% if trade.news_event %}
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                            <div class="fw-semibold text-muted">News Event</div>
                                            {{ trade.news_event }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Entry & Exit Details -->
                        <div class="enterprise-module">
                            <div class="module-header">
                                <div class="module-title">
                                    <i class="fas fa-exchange-alt module-icon"></i>
                                    Execution Details
                                </div>
                            </div>
                            <div class="module-content">
                                <!-- Entries -->
                                {% if trade.entries %}
                                <div class="mb-3">
                                    <h6 class="text-success fw-semibold mb-2">
                                        Entry Points
                                        <span class="text-muted fw-normal">
                                            ({{ trade.total_contracts_entered or 0 }} total @ avg {{ "{:.2f}".format(trade.average_entry_price) if trade.average_entry_price else 'N/A' }})
                                        </span>
                                    </h6>
                                    {% for entry in trade.entries %}
                                    <div class="mb-1 pt-1 pb-1 px-3" style="background-color: var(--enterprise-bg-primary); border-radius: 6px;">
                                        <span class="fw-normal">
                                            #{{ loop.index }}: {{ entry.contracts or 0 }} @ {{ "{:.2f}".format(entry.entry_price) if entry.entry_price else 'N/A' }}
                                            ({{ entry.entry_time.strftime('%H:%M') if entry.entry_time else 'N/A' }})
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Exits -->
                                {% if trade.exits %}
                                <div class="mb-3">
                                    <h6 class="text-danger fw-semibold mb-2">
                                        Exit Points
                                        <span class="text-muted fw-normal">
                                            ({{ trade.total_contracts_exited or 0 }} total @ avg {{ "{:.2f}".format(trade.average_exit_price) if trade.average_exit_price else 'N/A' }})
                                        </span>
                                    </h6>
                                    {% for exit in trade.exits %}
                                    <div class="mb-1 pt-1 pb-1 px-3" style="background-color: var(--enterprise-bg-primary); border-radius: 6px;">
                                        <span class="fw-normal">
                                            #{{ loop.index }}: {{ exit.contracts or 0 }} @ {{ "{:.2f}".format(exit.exit_price) if exit.exit_price else 'N/A' }}
                                            ({{ exit.exit_time.strftime('%H:%M') if exit.exit_time else 'N/A' }})
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Risk Management -->
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center p-2" style="background-color: var(--enterprise-bg-danger); border-radius: 6px;">
                                            <small class="text-muted d-block">Initial Stop</small>
                                            <strong>{{ "{:.2f}".format(trade.initial_stop_loss) if trade.initial_stop_loss else 'N/A' }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2" style="background-color: var(--enterprise-bg-success); border-radius: 6px;">
                                            <small class="text-muted d-block">Target</small>
                                            <strong>{{ "{:.2f}".format(trade.terminus_target) if trade.terminus_target else 'N/A' }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics Module -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-line module-icon"></i>
                        Performance Analytics
                    </div>
                    <div class="module-meta">
                        Risk-Adjusted Performance Metrics
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Financial Metrics -->
                        <div>
                            <h6 class="text-primary fw-semibold mb-3">Financial Performance</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">Gross P&L</div>
                                        <span class="{% if trade.pnl %}{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% endif %}{% endif %}">
                                            {% if trade.pnl is not none %}
                                                ${{ "{:,.2f}".format(trade.pnl) }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">Dollar Risk</div>
                                        {% if trade.dollar_risk %}
                                            ${{ "{:,.2f}".format(trade.dollar_risk) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">P&L per Contract</div>
                                        {% if trade.pnl and trade.total_contracts_exited and trade.total_contracts_exited > 0 %}
                                            ${{ "{:,.2f}".format(trade.pnl / trade.total_contracts_exited) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Metrics -->
                        <div>
                            <h6 class="text-primary fw-semibold mb-3">Risk Analytics</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">MAE (Max Adverse)</div>
                                        <div class="text-end">
                                            {% if trade.mae is not none %}
                                                <div class="text-danger fw-semibold">{{ "{:.1f}".format(trade.mae|abs) }} pts</div>
                                                {% if trade.instrument_obj %}
                                                    {% set multiplier = trade.instrument_obj.point_value or 25 %}
                                                    <small class="text-muted">${{ "{:,.0f}".format((trade.mae|abs) * multiplier) }}</small>
                                                {% endif %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">MFE (Max Favorable)</div>
                                        <div class="text-end">
                                            {% if trade.mfe is not none %}
                                                <div class="text-success fw-semibold">{{ "{:.1f}".format(trade.mfe) }} pts</div>
                                                {% if trade.instrument_obj %}
                                                    {% set multiplier = trade.instrument_obj.point_value or 25 %}
                                                    <small class="text-muted">${{ "{:,.0f}".format(trade.mfe * multiplier) }}</small>
                                                {% endif %}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                        <div class="fw-semibold text-muted">Efficiency Ratio</div>
                                        {% if trade.pnl is not none and trade.mfe is not none and trade.mfe != 0 %}
                                            {% set multiplier = trade.instrument_obj.point_value if trade.instrument_obj else 25 %}
                                            {% set efficiency = (trade.pnl / (trade.mfe * multiplier)) * 100 %}
                                            <span class="{% if efficiency >= 50 %}text-success{% elif efficiency >= 25 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ "{:.1f}".format(efficiency) }}%
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="mt-4">
                        <h6 class="text-primary fw-semibold mb-3">Trade Performance Visualization</h6>
                        <div class="position-relative" style="height: 300px;">
                            <canvas id="performanceChart" width="100%" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Notes & Analysis -->
            {% if trade.trade_notes or trade.overall_analysis_notes or trade.trade_management_notes or trade.errors_notes or trade.improvements_notes or trade.psych_scored_highest or trade.psych_scored_lowest %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-clipboard-list module-icon"></i>
                        Trade Analysis & Notes
                    </div>
                    <div class="module-meta">
                        Detailed Trade Review and Learning Points
                    </div>
                </div>
                <div class="module-content">
                    <div class="row g-3">
                        {% if trade.trade_notes %}
                        <div class="col-12">
                            <div class="mb-3">
                                <h6 class="text-primary fw-semibold mb-2">
                                    <i class="fas fa-sticky-note me-2"></i>Trade Notes
                                </h6>
                                <div class="p-3" style="background-color: var(--enterprise-bg-primary); border-radius: 8px;">
                                    {{ trade.trade_notes|nl2br }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if trade.overall_analysis_notes %}
                        <div class="col-12">
                            <div class="mb-3">
                                <h6 class="text-primary fw-semibold mb-2">
                                    <i class="fas fa-chart-bar me-2"></i>Overall Analysis
                                </h6>
                                <div class="p-3" style="background-color: var(--enterprise-bg-primary); border-radius: 8px;">
                                    {{ trade.overall_analysis_notes|nl2br }}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-md-6">
                            {% if trade.trade_management_notes %}
                            <div class="mb-3">
                                <h6 class="text-success fw-semibold mb-2">
                                    <i class="fas fa-cogs me-2"></i>Management Notes
                                </h6>
                                <div class="p-3" style="background-color: var(--enterprise-bg-success); border-radius: 8px;">
                                    {{ trade.trade_management_notes|nl2br }}
                                </div>
                            </div>
                            {% endif %}

                            {% if trade.improvements_notes %}
                            <div class="mb-3">
                                <h6 class="text-primary fw-semibold mb-2">
                                    <i class="fas fa-lightbulb me-2"></i>Improvements
                                </h6>
                                <div class="p-3" style="background-color: var(--enterprise-bg-primary); border-radius: 8px;">
                                    {{ trade.improvements_notes|nl2br }}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            {% if trade.errors_notes %}
                            <div class="mb-3">
                                <h6 class="text-danger fw-semibold mb-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Errors & Lessons
                                </h6>
                                <div class="p-3" style="background-color: var(--enterprise-bg-danger); border-radius: 8px;">
                                    {{ trade.errors_notes|nl2br }}
                                </div>
                            </div>
                            {% endif %}

                            {% if trade.psych_scored_highest or trade.psych_scored_lowest %}
                            <div class="mb-3">
                                <h6 class="text-info fw-semibold mb-2">
                                    <i class="fas fa-brain me-2"></i>Psychology Notes
                                </h6>
                                {% if trade.psych_scored_highest %}
                                <div class="mb-2 p-2" style="background-color: var(--enterprise-bg-success); border-radius: 6px;">
                                    <small class="text-muted fw-semibold d-block">Highest Scored:</small>
                                    {{ trade.psych_scored_highest|nl2br }}
                                </div>
                                {% endif %}
                                {% if trade.psych_scored_lowest %}
                                <div class="p-2" style="background-color: var(--enterprise-bg-warning); border-radius: 6px;">
                                    <small class="text-muted fw-semibold d-block">Lowest Scored:</small>
                                    {{ trade.psych_scored_lowest|nl2br }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tags and Chart Link -->
            {% if trade.tags or trade.screenshot_link %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-tags module-icon"></i>
                        Additional Information
                    </div>
                </div>
                <div class="module-content">
                    <div class="row g-3">
                        {% if trade.tags %}
                        <div class="col-12">
                            <div class="mb-2">
                                <h6 class="text-primary fw-semibold mb-2">Trade Tags</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for tag in trade.tags %}
                                        <span class="tag-item
                                            {% if tag.color_category == 'good' %} tag-good
                                            {% elif tag.color_category == 'bad' %} tag-bad
                                            {% else %}tag-neutral{% endif %}"
                                            style="font-size: 0.8rem;">
                                            {{ tag.name }}
                                        </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if trade.screenshot_link %}
                        <div class="col-12">
                            <div class="mb-2">
                                <h6 class="text-primary fw-semibold mb-2">Chart Analysis</h6>
                                <a href="{{ trade.screenshot_link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-camera me-2"></i>View Trading Chart
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Quality Assessment -->
        <div class="col-span-4">
            <!-- Execution Quality Assessment -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-star module-icon"></i>
                        Execution Quality Assessment
                    </div>
                    <div class="module-meta">
                        5-Point Rating System Analysis
                    </div>
                </div>
                <div class="module-content">
                    <div class="d-flex gap-4">
                        <!-- Rating List -->
                        <div style="flex: 1;">
                            <div class="d-flex flex-column gap-1" style="text-align: left">
                                {% set ratings = [
                                    ('Preparation', trade.preparation_rating, 'clipboard-check'),
                                    ('Rules Adherence', trade.rules_rating, 'gavel'),
                                    ('Risk Management', trade.management_rating, 'shield-alt'),
                                    ('Target Placement', trade.target_rating, 'bullseye'),
                                    ('Entry Execution', trade.entry_rating, 'crosshairs')
                                ] %}

                                {% for rating_name, rating_value, icon in ratings %}
                                <div class="d-flex align-items-center gap-1 p-2 rounded hover-highlight"
                                     data-rating-category="{{ rating_name.lower().replace(' ', '_') }}"
                                     data-rating-value="{{ rating_value or 0 }}">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">{{ rating_name }}</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1">
                                            {% for i in range(1, 6) %}
                                            <div class="rating-dot" style="
                                                width: 12px;
                                                height: 12px;
                                                border-radius: 50%;
                                                border: 1px solid var(--enterprise-gray-300);
                                                {% if rating_value and i <= rating_value %}
                                                    {% if rating_value >= 4 %}
                                                        background-color: var(--enterprise-success);
                                                        border-color: var(--enterprise-success);
                                                    {% elif rating_value >= 3 %}
                                                        background-color: var(--enterprise-warning);
                                                        border-color: var(--enterprise-warning);
                                                    {% else %}
                                                        background-color: var(--enterprise-danger);
                                                        border-color: var(--enterprise-danger);
                                                    {% endif %}
                                                {% else %}
                                                    background-color: var(--enterprise-gray-100);
                                                {% endif %}
                                            "></div>
                                            {% endfor %}
                                        </div>
                                        <span class="ms-2 fw-semibold">{{ rating_value or 0 }}/5</span>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Average Rating -->
                                {% set all_ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                                {% set valid_ratings = all_ratings|select('ne', none)|list %}
                                {% if valid_ratings %}
                                    {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                                    <div class="border-top mt-3 pt-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-semibold text-primary">Overall Score:</span>
                                            <span class="badge {% if avg_rating >= 4 %}bg-success{% elif avg_rating >= 2.5 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                                {{ "%.1f"|format(avg_rating) }}/5.0
                                            </span>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Radar Chart -->
                    <div class="mt-4">
                        <h6 class="text-primary fw-semibold mb-3">Performance Radar</h6>
                        <div class="d-flex justify-content-center">
                            <div class="position-relative" style="width: 250px; height: 250px;">
                                <canvas id="radarChart" width="250" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Analysis Chart -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-area module-icon"></i>
                        Risk Analysis
                    </div>
                    <div class="module-meta">
                        MAE vs MFE Analysis
                    </div>
                </div>
                <div class="module-content">
                    <div class="position-relative" style="height: 200px;">
                        <canvas id="riskChart" width="100%" height="200"></canvas>
                    </div>
                    
                    <!-- Risk Summary -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row g-2 text-center">
                            <div class="col-6">
                                <div class="p-2" style="background-color: var(--enterprise-bg-danger); border-radius: 6px;">
                                    <small class="text-muted d-block">Max Risk</small>
                                    <strong class="text-danger">
                                        {% if trade.mae %}
                                            {{ "{:.1f}".format(trade.mae|abs) }} pts
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2" style="background-color: var(--enterprise-bg-success); border-radius: 6px;">
                                    <small class="text-muted d-block">Max Reward</small>
                                    <strong class="text-success">
                                        {% if trade.mfe %}
                                            {{ "{:.1f}".format(trade.mfe) }} pts
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeTooltips();
});

function initializeCharts() {
    // Radar Chart for Quality Assessment
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    new Chart(radarCtx, {
        type: 'radar',
        data: {
            labels: ['Preparation', 'Rules', 'Management', 'Target', 'Entry'],
            datasets: [{
                label: 'Quality Scores',
                data: [
                    {{ trade.preparation_rating or 0 }},
                    {{ trade.rules_rating or 0 }},
                    {{ trade.management_rating or 0 }},
                    {{ trade.target_rating or 0 }},
                    {{ trade.entry_rating or 0 }}
                ],
                backgroundColor: 'rgba(0, 102, 204, 0.2)',
                borderColor: 'rgba(0, 102, 204, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(0, 102, 204, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(0, 102, 204, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    pointLabels: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Performance Chart
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    const tradeData = {
        entry: {{ trade.average_entry_price if trade.average_entry_price else 'null' }},
        exit: {{ trade.average_exit_price if trade.average_exit_price else 'null' }},
        stop: {{ trade.initial_stop_loss if trade.initial_stop_loss else 'null' }},
        target: {{ trade.terminus_target if trade.terminus_target else 'null' }},
        mae: {{ trade.mae if trade.mae else 'null' }},
        mfe: {{ trade.mfe if trade.mfe else 'null' }}
    };

    const perfData = [];
    const labels = [];
    const colors = [];
    
    if (tradeData.entry !== null) {
        labels.push('Entry');
        perfData.push(tradeData.entry);
        colors.push('rgba(0, 102, 204, 0.8)');
    }
    
    if (tradeData.exit !== null) {
        labels.push('Exit');
        perfData.push(tradeData.exit);
        colors.push('{{ trade.pnl > 0 if trade.pnl else False }}' === 'True' ? 
                    'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)');
    }
    
    if (tradeData.stop !== null) {
        labels.push('Stop Loss');
        perfData.push(tradeData.stop);
        colors.push('rgba(220, 53, 69, 0.6)');
    }
    
    if (tradeData.target !== null) {
        labels.push('Target');
        perfData.push(tradeData.target);
        colors.push('rgba(40, 167, 69, 0.6)');
    }

    new Chart(perfCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Price Levels',
                data: perfData,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1').replace('0.6', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Price Level'
                    }
                }
            }
        }
    });

    // Risk Chart (MAE vs MFE)
    const riskCtx = document.getElementById('riskChart').getContext('2d');
    new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Max Adverse (MAE)', 'Max Favorable (MFE)'],
            datasets: [{
                data: [
                    {{ (trade.mae|abs) if trade.mae else 0 }},
                    {{ trade.mfe if trade.mfe else 0 }}
                ],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(40, 167, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(40, 167, 69, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(1) + ' pts';
                        }
                    }
                }
            }
        }
    });
}

function initializeTooltips() {
    // Add tooltips for rating dots
    const ratingDots = document.querySelectorAll('.rating-dot');
    ratingDots.forEach(dot => {
        dot.setAttribute('title', 'Rating indicator');
    });
}

function exportTradeToPDF() {
    const exportBtn = document.querySelector('button[onclick="exportTradeToPDF()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;

    // Get the main content area for PDF export
    const element = document.getElementById('trade-kpi-section').parentElement;
    
    const opt = {
        margin: 1,
        filename: 'Trade_Analysis_{{ trade.instrument }}_{{ trade.trade_date.strftime("%Y%m%d") }}.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
            scale: 2,
            useCORS: true,
            allowTaint: true
        },
        jsPDF: { 
            unit: 'in', 
            format: 'letter', 
            orientation: 'portrait' 
        }
    };

    html2pdf().set(opt).from(element).save().then(() => {
        if (typeof showSuccess === 'function') {
            showSuccess('Trade analysis exported to PDF successfully.', 'PDF Export Complete');
        } else {
            alert('PDF export completed successfully.');
        }
    }).catch((error) => {
        console.error('PDF Export error:', error);
        if (typeof showErrorMessage === 'function') {
            showErrorMessage('PDF export failed. Please try again.');
        } else {
            alert('PDF export failed. Please try again.');
        }
    }).finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

// Add custom filter for nl2br in Jinja2 (if not already available)
function nl2br(str) {
    return str.replace(/\n/g, '<br>');
}
</script>
{% endblock %}