{% extends "base.html" %}

{% block title %}Create New Strategic Trade Configuration - Trading Journal{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
// Global validation variables
let hasUnsavedChanges = false;
let originalFormData = {};
let isSubmitting = false;
let entryExitValidation = {
    entries: 0,
    exits: 0
};

// Initialize form change tracking
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('tradeForm');
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        
        // Store original values
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                originalFormData[input.name] = input.checked;
            } else {
                originalFormData[input.name] = input.value || '';
            }
        });
        
        // Monitor changes
        inputs.forEach(input => {
            input.addEventListener('change', checkForChanges);
            input.addEventListener('input', checkForChanges);
        });
    }
    
    function checkForChanges() {
        const inputs = form.querySelectorAll('input, select, textarea');
        hasUnsavedChanges = false;
        
        inputs.forEach(input => {
            let currentValue = (input.type === 'checkbox') ? input.checked : input.value;
            let originalValue = (input.type === 'checkbox') ? originalFormData[input.name] : originalFormData[input.name] || '';
            if (currentValue !== originalValue) {
                hasUnsavedChanges = true;
            }
        });
        
        const indicator = document.getElementById('unsaved-indicator');
        if (indicator) {
            indicator.style.display = hasUnsavedChanges ? 'block' : 'none';
        }
    }
    
    // Prevent navigation when there are unsaved changes
    function beforeUnloadHandler(e) {
        if (hasUnsavedChanges && !isSubmitting) {
            const message = 'You have unsaved trade configuration data. Changes will be lost if you navigate away.';
            e.preventDefault();
            e.returnValue = message;
            return message;
        }
    }
    window.addEventListener('beforeunload', beforeUnloadHandler);
});
</script>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid">
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-plus-circle executive-icon"></i>
                    Create Strategic Trade Configuration
                </h1>
                <div class="executive-subtitle">
                    Configure new strategic trading execution parameters and comprehensive analysis framework
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.import_trades') }}'"
                        title="Import Trade Configurations">
                    <i class="fas fa-upload"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.view_trades_list') }}'"
                        title="Back to Trading Operations">
                    <i class="fas fa-list"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="handleCancelAction();" title="Cancel Configuration">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Unsaved Changes Indicator -->
    <div id="unsaved-indicator" class="alert alert-warning alert-dismissible fade show mb-3" role="alert" style="display: none;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Unsaved Changes:</strong> You have entered trade configuration data that has not been saved yet.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Trade Stats Dashboard (Auto-calculated) -->
    <div id="trade-stats-dashboard" class="kpi-section mt-3" style="display: none;">
        <div class="grid grid-cols-6 gap-4">
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Risk:Reward</span>
                            <i class="fas fa-balance-scale kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="risk-reward-display">--:--</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Planned Ratio</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Duration</span>
                            <i class="fas fa-clock kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="time-in-trade-display">--:--</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Time Held</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Points Risk</span>
                            <i class="fas fa-chart-line kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="points-risked-display">--</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Risk Points</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Dollar Risk</span>
                            <i class="fas fa-dollar-sign kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="dollar-risk-display">$--</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Risk Amount</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Gross P&L</span>
                            <i class="fas fa-chart-area kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="gross-pnl-display">$--</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Total Return</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Quality Score</span>
                            <i class="fas fa-star kpi-icon"></i>
                        </div>
                        <div class="kpi-value" id="overall-rating-display">--/5</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">Execution Rating</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('trades.add_trade') }}" id="tradeForm" novalidate enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Main Content Grid -->
        <div class="grid grid-cols-12 gap-4 align-items-start mt-3">
            <!-- Left Column: Trade Configuration -->
            <div class="col-span-8">
                <!-- Basic Trade Configuration -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-cog module-icon"></i>
                            Basic Trade Configuration
                        </div>
                        <div class="module-meta">
                            Core strategic trading parameters
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                {{ form.trade_date.label(class="form-label") }}
                                {{ form.trade_date(class="form-control" + (" is-invalid" if form.trade_date.errors else ""), type="date") }}
                                {% if form.trade_date.errors %}
                                    {% for error in form.trade_date.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.instrument.label(class="form-label") }}
                                {{ form.instrument(class="form-select" + (" is-invalid" if form.instrument.errors else "")) }}
                                {% if form.instrument.errors %}
                                    {% for error in form.instrument.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.direction.label(class="form-label") }}
                                {{ form.direction(class="form-select" + (" is-invalid" if form.direction.errors else "")) }}
                                {% if form.direction.errors %}
                                    {% for error in form.direction.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.trading_model_id.label(class="form-label") }}
                                {{ form.trading_model_id(class="form-select" + (" is-invalid" if form.trading_model_id.errors else "")) }}
                                {% if form.trading_model_id.errors %}
                                    {% for error in form.trading_model_id.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.initial_stop_loss.label(class="form-label") }}
                                {{ form.initial_stop_loss(class="form-control" + (" is-invalid" if form.initial_stop_loss.errors else ""), type="number", step="any", placeholder="Stop Loss Price") }}
                                {% if form.initial_stop_loss.errors %}
                                    {% for error in form.initial_stop_loss.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.terminus_target.label(class="form-label") }}
                                {{ form.terminus_target(class="form-control" + (" is-invalid" if form.terminus_target.errors else ""), type="number", step="any", placeholder="Target Price") }}
                                {% if form.terminus_target.errors %}
                                    {% for error in form.terminus_target.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.how_closed.label(class="form-label") }}
                                {{ form.how_closed(class="form-select" + (" is-invalid" if form.how_closed.errors else "")) }}
                                {% if form.how_closed.errors %}
                                    {% for error in form.how_closed.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.mae.label(class="form-label") }}
                                {{ form.mae(class="form-control" + (" is-invalid" if form.mae.errors else ""), type="number", step="any", placeholder="Maximum Adverse Excursion") }}
                                {% if form.mae.errors %}
                                    {% for error in form.mae.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                {{ form.mfe.label(class="form-label") }}
                                {{ form.mfe(class="form-control" + (" is-invalid" if form.mfe.errors else ""), type="number", step="any", placeholder="Maximum Favorable Excursion") }}
                                {% if form.mfe.errors %}
                                    {% for error in form.mfe.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- DCA Toggle -->
                        <div class="mt-3">
                            <div class="form-check">
                                {{ form.is_dca(class="form-check-input" + (" is-invalid" if form.is_dca.errors else "")) }}
                                {{ form.is_dca.label(class="form-check-label") }}
                                {% if form.is_dca.errors %}
                                    {% for error in form.is_dca.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entry & Exit Points Management -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-exchange-alt module-icon"></i>
                            Execution Entry & Exit Points
                        </div>
                        <div class="module-meta">
                            Configure multiple entry and exit execution levels
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Entry Points -->
                            <div class="enterprise-module">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-arrow-right module-icon text-success"></i>
                                        Entry Points
                                        <span id="entry-count" class="badge bg-success ms-2">1</span>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-2">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%;">Time</th>
                                                    <th style="width: 25%;">Contracts</th>
                                                    <th style="width: 35%;">Price</th>
                                                    <th style="width: 10%;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="entry-points-container">
                                                {% for entry_form_field in form.entries %}
                                                <tr class="entry-exit-item">
                                                    <td>
                                                        {{ entry_form_field.entry_time(class="form-control form-control-sm", type="time") }}
                                                    </td>
                                                    <td>
                                                        {{ entry_form_field.contracts(class="form-control form-control-sm", type="number", min="1") }}
                                                    </td>
                                                    <td>
                                                        {{ entry_form_field.entry_price(class="form-control form-control-sm", type="number", step="any") }}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if loop.index > 1 %}
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-success w-100" id="add-entry-button">
                                        <i class="fas fa-plus me-1"></i>Add Entry Point
                                    </button>
                                </div>
                            </div>

                            <!-- Exit Points -->
                            <div class="enterprise-module">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-arrow-left module-icon text-danger"></i>
                                        Exit Points
                                        <span id="exit-count" class="badge bg-danger ms-2">0</span>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-2">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%;">Time</th>
                                                    <th style="width: 25%;">Contracts</th>
                                                    <th style="width: 35%;">Price</th>
                                                    <th style="width: 10%;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="exit-points-container">
                                                {% for exit_form_field in form.exits %}
                                                <tr class="entry-exit-item">
                                                    <td>
                                                        {{ exit_form_field.exit_time(class="form-control form-control-sm", type="time") }}
                                                    </td>
                                                    <td>
                                                        {{ exit_form_field.contracts(class="form-control form-control-sm", type="number", min="1") }}
                                                    </td>
                                                    <td>
                                                        {{ exit_form_field.exit_price(class="form-control form-control-sm", type="number", step="any") }}
                                                    </td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-success w-100" id="add-exit-button">
                                        <i class="fas fa-plus me-1"></i>Add Exit Point
                                    </button>
                                    <div id="exit-validation-warning" class="alert alert-warning mt-2" style="display: none;">
                                        <small><i class="fas fa-exclamation-triangle me-1"></i>Cannot add more exits than total entry contracts.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade Analysis & Notes -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-chart-line module-icon"></i>
                            Strategic Analysis Framework
                        </div>
                        <div class="module-meta">
                            Comprehensive trade analysis and documentation
                        </div>
                    </div>
                    <div class="module-content">
                        <!-- Rich Text Editors -->
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">{{ form.trade_notes.label.text }}</label>
                                <div id="trade_notes_editor" class="quill-editor-container" style="height: 150px;"></div>
                                {{ form.trade_notes(class="d-none") }}
                                {% if form.trade_notes.errors %}
                                    {% for error in form.trade_notes.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label">{{ form.overall_analysis_notes.label.text }}</label>
                                <div id="overall_analysis_notes_editor" class="quill-editor-container" style="height: 150px;"></div>
                                {{ form.overall_analysis_notes(class="d-none") }}
                                {% if form.overall_analysis_notes.errors %}
                                    {% for error in form.overall_analysis_notes.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Three-column layout for detailed notes -->
                        <div class="grid grid-cols-3 gap-4 mt-3">
                            <div>
                                <label class="form-label">Trade Management</label>
                                {{ form.trade_management_notes(class="form-control textarea-4" + (" is-invalid" if form.trade_management_notes.errors else ""), placeholder="Trade management decisions, scaling in/out, adjustments, etc.") }}
                                {% if form.trade_management_notes.errors %}
                                    {% for error in form.trade_management_notes.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="form-label">Execution Issues</label>
                                {{ form.errors_notes(class="form-control textarea-4" + (" is-invalid" if form.errors_notes.errors else ""), placeholder="Any mistakes made during this trade?") }}
                                {% if form.errors_notes.errors %}
                                    {% for error in form.errors_notes.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="form-label">Enhancement Opportunities</label>
                                {{ form.improvements_notes(class="form-control textarea-4" + (" is-invalid" if form.improvements_notes.errors else ""), placeholder="What could be improved for the next trade?") }}
                                {% if form.improvements_notes.errors %}
                                    {% for error in form.improvements_notes.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentation & Media -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-folder-open module-icon"></i>
                            Documentation & Media
                        </div>
                        <div class="module-meta">
                            Charts, screenshots, and external links
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                {{ form.trade_images.label(class="form-label") }}
                                {{ form.trade_images(class="form-control" + (" is-invalid" if form.trade_images.errors else "")) }}
                                {% if form.trade_images.errors %}
                                    {% for error in form.trade_images.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                                <small class="form-text text-muted">Upload strategic documentation or relevant analysis images.</small>
                            </div>
                            
                            <div>
                                {{ form.screenshot_link.label(class="form-label") }}
                                {{ form.screenshot_link(class="form-control" + (" is-invalid" if form.screenshot_link.errors else ""), type="url", placeholder="https://www.tradingview.com/chart/...") }}
                                {% if form.screenshot_link.errors %}
                                    {% for error in form.screenshot_link.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                                <small class="form-text text-muted">External documentation links from trading platform analysis.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Assessment & Tags -->
            <div class="col-span-4">
                <!-- Performance Assessment -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-star module-icon"></i>
                            Performance Assessment
                        </div>
                        <div class="module-meta">
                            5-Point Execution Quality Rating
                        </div>
                    </div>
                    <div class="module-content">
                        <h6 class="text-primary mb-3">Rate execution effectiveness across key criteria:</h6>
                        
                        <!-- Rating Controls -->
                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                {{ form.preparation_rating.label(class="form-label") }}
                                {{ form.preparation_rating(class="form-select form-select-sm rating-selector" + (" is-invalid" if form.preparation_rating.errors else "")) }}
                                {% if form.preparation_rating.errors %}
                                    {% for error in form.preparation_rating.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="col-6">
                                {{ form.rules_rating.label(class="form-label") }}
                                {{ form.rules_rating(class="form-select form-select-sm rating-selector" + (" is-invalid" if form.rules_rating.errors else "")) }}
                                {% if form.rules_rating.errors %}
                                    {% for error in form.rules_rating.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="col-6">
                                {{ form.management_rating.label(class="form-label") }}
                                {{ form.management_rating(class="form-select form-select-sm rating-selector" + (" is-invalid" if form.management_rating.errors else "")) }}
                                {% if form.management_rating.errors %}
                                    {% for error in form.management_rating.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="col-6">
                                {{ form.entry_rating.label(class="form-label") }}
                                {{ form.entry_rating(class="form-select form-select-sm rating-selector" + (" is-invalid" if form.entry_rating.errors else "")) }}
                                {% if form.entry_rating.errors %}
                                    {% for error in form.entry_rating.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                {{ form.target_rating.label(class="form-label") }}
                                {{ form.target_rating(class="form-select form-select-sm rating-selector" + (" is-invalid" if form.target_rating.errors else "")) }}
                                {% if form.target_rating.errors %}
                                    {% for error in form.target_rating.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Radar Chart -->
                        <div class="text-center mb-3">
                            <div style="width: 250px; height: 250px; margin: 0 auto;">
                                <canvas id="psychRadarChart"></canvas>
                            </div>
                        </div>

                        <!-- Psychology Notes -->
                        <div class="row g-3">
                            <div class="col-12">
                                {{ form.psych_scored_highest.label(class="form-label") }}
                                {{ form.psych_scored_highest(class="form-control textarea-1" + (" is-invalid" if form.psych_scored_highest.errors else ""), placeholder="What execution strengths were demonstrated?") }}
                                {% if form.psych_scored_highest.errors %}
                                    {% for error in form.psych_scored_highest.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                {{ form.psych_scored_lowest.label(class="form-label") }}
                                {{ form.psych_scored_lowest(class="form-control textarea-1" + (" is-invalid" if form.psych_scored_lowest.errors else ""), placeholder="Which areas require performance improvement?") }}
                                {% if form.psych_scored_lowest.errors %}
                                    {% for error in form.psych_scored_lowest.errors %}
                                        <div class="invalid-feedback">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tags & Classification -->
                <div class="enterprise-module mb-3">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-tags module-icon"></i>
                            Trade Classification
                        </div>
                        <div class="module-meta">
                            Categorized Tag System
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="mb-3">
                            <label for="tags-select" class="form-label">{{ form.tags.label.text }}</label>
                            <select multiple class="form-select" id="tags-select" name="{{ form.tags.name }}">
                                {% for category_name, tag_options in form.tags.choices %}
                                    <optgroup label="{{ category_name }}">
                                        {% for tag_id, tag_name, tag_color in tag_options %}
                                            <option value="{{ tag_id }}"
                                                    data-color="{{ tag_color or 'neutral' }}"
                                                    class="tag-{{ tag_color or 'neutral' }}"
                                                    {% if tag_id in (form.tags.data or []) %}selected{% endif %}>
                                                {{ tag_name }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                            {% if form.tags.errors %}
                                {% for error in form.tags.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <small class="form-text text-muted">Select appropriate classification tags for this strategic execution.</small>
                        </div>

                        <!-- Custom Tag Creation -->
                        <div class="border-top pt-3">
                            <h6 class="text-primary mb-2">Create Custom Tag</h6>
                            <div class="row g-2">
                                <div class="col-8">
                                    <input type="text" id="custom-tag-name" class="form-control form-control-sm" placeholder="Enter custom tag name" maxlength="50">
                                </div>
                                <div class="col-4">
                                    <select id="custom-tag-color" class="form-select form-select-sm">
                                        <option value="neutral">Neutral</option>
                                        <option value="good">Good</option>
                                        <option value="bad">Bad</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100" id="add-custom-tag">
                                        <i class="fas fa-plus me-1"></i>Add Custom Tag
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between align-items-center mt-4 p-3" style="background-color: var(--enterprise-bg-primary); border-radius: 8px;">
            <div>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    All fields with comprehensive data will provide better analysis and insights.
                </small>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary" onclick="handleCancelAction()">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save Trade Configuration
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Hidden Templates for Dynamic Entry/Exit Points -->
<div id="entry-template" style="display: none;">
    <tr class="entry-exit-item">
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-entry_time" type="time" placeholder="HH:MM">
        </td>
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-contracts" type="number" min="1" placeholder="Contracts">
        </td>
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-entry_price" type="number" step="any" placeholder="Price">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    </tr>
</div>

<div id="exit-template" style="display: none;">
    <tr class="entry-exit-item">
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-exit_time" type="time" placeholder="HH:MM">
        </td>
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-contracts" type="number" min="1" placeholder="Contracts">
        </td>
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-exit_price" type="number" step="any" placeholder="Price">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    </tr>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enterprise add trade page JavaScript initializing...');

    // Global variables
    let quillInstances = {};
    let tagsSelect = null;

    // Set default date
    const tradeDateInput = document.getElementById('{{ form.trade_date.id }}');
    if (tradeDateInput && !tradeDateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = ('0' + (today.getMonth() + 1)).slice(-2);
        const day = ('0' + today.getDate()).slice(-2);
        tradeDateInput.value = `${year}-${month}-${day}`;
    }

    // Create tag color mapping
    const tagColors = {};
    {% for category_name, tag_options in form.tags.choices %}
        {% for tag_id, tag_name, tag_color in tag_options %}
            tagColors['{{ tag_id }}'] = '{{ tag_color or "neutral" }}';
        {% endfor %}
    {% endfor %}

    // Initialize TomSelect for tags
    const tagsSelectElement = document.getElementById('tags-select');
    if (tagsSelectElement) {
        tagsSelect = new TomSelect(tagsSelectElement, {
            plugins: ['remove_button'],
            placeholder: 'Select or search for classification tags...',
            create: false,
            render: {
                option: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="option ${colorClass}">${escape(data.text)}</div>`;
                },
                item: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="item ${colorClass}">${escape(data.text)}</div>`;
                }
            }
        });
        console.log('TomSelect initialized for tags with colors');
    }

    // Custom Tag Creation
    document.getElementById('add-custom-tag').addEventListener('click', function() {
        const tagName = document.getElementById('custom-tag-name').value.trim();
        const tagColor = document.getElementById('custom-tag-color').value;

        if (!tagName) {
            showErrorMessage('Please enter a tag name.');
            return;
        }

        // Create custom tag via AJAX
        fetch('{{ url_for("settings.create_tag") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                name: tagName,
                category: 'SETUP_STRATEGY',  // Default category for custom tags
                color_category: tagColor
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new tag to TomSelect
                tagsSelect.addOption({
                    value: data.tag.id.toString(),
                    text: data.tag.name
                });
                tagsSelect.addItem(data.tag.id.toString());
                
                // Update color mapping
                tagColors[data.tag.id.toString()] = data.tag.color_category || 'neutral';
                
                // Clear form
                document.getElementById('custom-tag-name').value = '';
                document.getElementById('custom-tag-color').value = 'neutral';
                
                showSuccess(`Custom tag "${tagName}" created successfully.`);
            } else {
                showErrorMessage(data.message || 'Failed to create custom tag.');
            }
        })
        .catch(error => {
            console.error('Error creating custom tag:', error);
            showErrorMessage('Failed to create custom tag. Please try again.');
        });
    });

    // Dynamic Entry/Exit Management
    let entryCount = {{ form.entries|length }};
    let exitCount = {{ form.exits|length }};

    function updateCounts() {
        document.getElementById('entry-count').textContent = entryCount;
        document.getElementById('exit-count').textContent = exitCount;
        
        // Validate exit count vs entry contracts
        validateExitContracts();
    }

    function validateExitContracts() {
        const entryRows = document.querySelectorAll('#entry-points-container tr');
        const exitRows = document.querySelectorAll('#exit-points-container tr');
        
        let totalEntryContracts = 0;
        let totalExitContracts = 0;

        entryRows.forEach(row => {
            const contractsInput = row.querySelector('input[name*="contracts"]');
            if (contractsInput && contractsInput.value) {
                totalEntryContracts += parseInt(contractsInput.value) || 0;
            }
        });

        exitRows.forEach(row => {
            const contractsInput = row.querySelector('input[name*="contracts"]');
            if (contractsInput && contractsInput.value) {
                totalExitContracts += parseInt(contractsInput.value) || 0;
            }
        });

        const warningElement = document.getElementById('exit-validation-warning');
        const addExitButton = document.getElementById('add-exit-button');
        
        if (totalExitContracts > totalEntryContracts) {
            warningElement.style.display = 'block';
            addExitButton.disabled = true;
        } else {
            warningElement.style.display = 'none';
            addExitButton.disabled = false;
        }

        calculateStats();
    }

    // Add Entry Point
    document.getElementById('add-entry-button').addEventListener('click', function() {
        const container = document.getElementById('entry-points-container');
        const template = document.getElementById('entry-template');
        const newRow = template.innerHTML.replace(/INDEX/g, entryCount);
        
        container.insertAdjacentHTML('beforeend', newRow);
        entryCount++;
        updateCounts();
        
        // Add event listeners to new row
        const newRowElement = container.lastElementChild;
        addRowEventListeners(newRowElement);
    });

    // Add Exit Point
    document.getElementById('add-exit-button').addEventListener('click', function() {
        const container = document.getElementById('exit-points-container');
        const template = document.getElementById('exit-template');
        const newRow = template.innerHTML.replace(/INDEX/g, exitCount);
        
        container.insertAdjacentHTML('beforeend', newRow);
        exitCount++;
        updateCounts();
        
        // Add event listeners to new row
        const newRowElement = container.lastElementChild;
        addRowEventListeners(newRowElement);
    });

    // Remove Entry/Exit handlers
    function addRowEventListeners(row) {
        const removeEntryBtn = row.querySelector('.remove-entry-btn');
        const removeExitBtn = row.querySelector('.remove-exit-btn');
        const inputs = row.querySelectorAll('input');

        if (removeEntryBtn) {
            removeEntryBtn.addEventListener('click', function() {
                showCustomConfirmation(
                    'Remove Entry Point',
                    'Are you sure you want to remove this entry point?',
                    'btn-warning',
                    'question-circle',
                    function() {
                        row.remove();
                        entryCount--;
                        updateCounts();
                    }
                );
            });
        }

        if (removeExitBtn) {
            removeExitBtn.addEventListener('click', function() {
                showCustomConfirmation(
                    'Remove Exit Point',
                    'Are you sure you want to remove this exit point?',
                    'btn-warning',
                    'question-circle',
                    function() {
                        row.remove();
                        exitCount--;
                        updateCounts();
                    }
                );
            });
        }

        // Add change listeners to inputs for validation
        inputs.forEach(input => {
            input.addEventListener('input', validateExitContracts);
            input.addEventListener('change', validateExitContracts);
        });
    }

    // Add event listeners to existing rows
    document.querySelectorAll('#entry-points-container tr, #exit-points-container tr').forEach(addRowEventListeners);

    // Initialize Quill editors
    const quillToolbarOptions = [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'clean']
    ];

    function initializeQuill(editorDivId, hiddenTextareaId, placeholderText) {
        const editorDiv = document.getElementById(editorDivId);
        const hiddenTextarea = document.getElementById(hiddenTextareaId);
        
        if (editorDiv && hiddenTextarea) {
            quillInstances[hiddenTextareaId] = new Quill(editorDiv, {
                theme: 'snow',
                modules: { toolbar: quillToolbarOptions },
                placeholder: placeholderText || 'Enter strategic analysis...'
            });

            const existingContent = hiddenTextarea.value;
            if (existingContent) {
                try {
                    quillInstances[hiddenTextareaId].clipboard.dangerouslyPasteHTML(existingContent);
                } catch (e) {
                    quillInstances[hiddenTextareaId].setText(existingContent);
                }
            }
        }
    }

    initializeQuill('trade_notes_editor', '{{ form.trade_notes.id }}', 'Enter your pre-execution analysis, strategic setup, reasoning, chart analysis...');
    initializeQuill('overall_analysis_notes_editor', '{{ form.overall_analysis_notes.id }}', 'Enter your post-execution analysis, outcomes, lessons learned...');

    // Initialize Radar Chart
    const ratingSelectors = document.querySelectorAll('.rating-selector');
    const psychRadarCtx = document.getElementById('psychRadarChart');

    if (psychRadarCtx && ratingSelectors.length === 5) {
        const chartLabels = ['Prep', 'Rules', 'Mgmt', 'Entry', 'Target'];
        
        const radarChart = new Chart(psychRadarCtx, {
            type: 'radar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Performance Assessment',
                    data: [0, 0, 0, 0, 0],
                    fill: true,
                    backgroundColor: 'rgba(0, 102, 204, 0.2)',
                    borderColor: 'rgba(0, 102, 204, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(0, 102, 204, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(0, 102, 204, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        pointLabels: { font: { size: 11 } },
                        ticks: { 
                            stepSize: 1, 
                            color: '#666', 
                            backdropColor: 'rgba(0, 0, 0, 0)' 
                        }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        function updateRadarChart() {
            const newData = [];
            ratingSelectors.forEach(selector => {
                newData.push(parseInt(selector.value) || 0);
            });
            radarChart.data.datasets[0].data = newData;
            radarChart.update();
            calculateStats();
        }

        ratingSelectors.forEach(selector => {
            selector.addEventListener('change', updateRadarChart);
        });

        updateRadarChart();
    }

    // Stats calculation
    const instrumentPointValues = {{ instrument_point_values|tojson|safe }};
    
    function calculateStats() {
        const dashboard = document.getElementById('trade-stats-dashboard');
        const instrumentSelect = document.querySelector('[name="instrument"]');
        const direction = document.querySelector('[name="direction"]')?.value;
        const stopLoss = parseFloat(document.querySelector('[name="initial_stop_loss"]')?.value || '0');
        const target = parseFloat(document.querySelector('[name="terminus_target"]')?.value || '0');

        // Get point value
        let pointValue = 1.0;
        if (instrumentSelect?.value) {
            const selectedOption = instrumentSelect.querySelector(`option[value="${instrumentSelect.value}"]`);
            if (selectedOption) {
                const symbolMatch = selectedOption.textContent.match(/^([A-Z]+)/);
                if (symbolMatch) {
                    const symbol = symbolMatch[1];
                    pointValue = instrumentPointValues[symbol] || 1.0;
                }
            }
        }

        // Calculate entry/exit data
        const entryRows = document.querySelectorAll('#entry-points-container tr');
        const exitRows = document.querySelectorAll('#exit-points-container tr');

        let totalEntryContracts = 0, weightedEntryPrice = 0, firstEntryTime = '';
        let totalExitContracts = 0, weightedExitPrice = 0, lastExitTime = '';

        entryRows.forEach(row => {
            const priceInput = row.querySelector('input[name*="entry_price"]');
            const contractsInput = row.querySelector('input[name*="contracts"]');
            const timeInput = row.querySelector('input[name*="entry_time"]');
            
            const price = parseFloat(priceInput?.value || '0');
            const contracts = parseInt(contractsInput?.value || '0');
            const time = timeInput?.value || '';

            if (price > 0 && contracts > 0) {
                weightedEntryPrice += price * contracts;
                totalEntryContracts += contracts;
                if (!firstEntryTime) firstEntryTime = time;
            }
        });

        exitRows.forEach(row => {
            const priceInput = row.querySelector('input[name*="exit_price"]');
            const contractsInput = row.querySelector('input[name*="contracts"]');
            const timeInput = row.querySelector('input[name*="exit_time"]');
            
            const price = parseFloat(priceInput?.value || '0');
            const contracts = parseInt(contractsInput?.value || '0');
            const time = timeInput?.value || '';

            if (price > 0 && contracts > 0) {
                weightedExitPrice += price * contracts;
                totalExitContracts += contracts;
                lastExitTime = time;
            }
        });

        const avgEntryPrice = totalEntryContracts > 0 ? weightedEntryPrice / totalEntryContracts : 0;
        const avgExitPrice = totalExitContracts > 0 ? weightedExitPrice / totalExitContracts : 0;

        // Show dashboard when we have data
        if (avgEntryPrice > 0 || avgExitPrice > 0 || stopLoss > 0 || target > 0) {
            dashboard.style.display = 'block';
        } else {
            dashboard.style.display = 'none';
        }

        // Calculate Risk:Reward
        let riskRewardText = '--:--';
        if (avgEntryPrice > 0 && stopLoss > 0 && target > 0) {
            let risk, reward;
            if (direction === 'Long') {
                risk = Math.abs(avgEntryPrice - stopLoss);
                reward = Math.abs(target - avgEntryPrice);
            } else if (direction === 'Short') {
                risk = Math.abs(stopLoss - avgEntryPrice);
                reward = Math.abs(avgEntryPrice - target);
            }

            if (risk > 0) {
                riskRewardText = `1:${(reward / risk).toFixed(2)}`;
            }
        }

        // Calculate time in trade
        let timeInTradeText = '--:--';
        if (firstEntryTime && lastExitTime) {
            const [entryHour, entryMin] = firstEntryTime.split(':').map(Number);
            const [exitHour, exitMin] = lastExitTime.split(':').map(Number);
            const entryMinutes = entryHour * 60 + entryMin;
            const exitMinutes = exitHour * 60 + exitMin;
            let diffMinutes = exitMinutes - entryMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            timeInTradeText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Calculate points risked and dollar risk
        let pointsRiskedText = '--';
        let dollarRiskText = '$--';
        if (avgEntryPrice > 0 && stopLoss > 0 && totalEntryContracts > 0) {
            let pointsRisk;
            if (direction === 'Long') {
                pointsRisk = Math.abs(avgEntryPrice - stopLoss);
            } else if (direction === 'Short') {
                pointsRisk = Math.abs(stopLoss - avgEntryPrice);
            }

            if (pointsRisk > 0) {
                pointsRiskedText = pointsRisk.toFixed(2);
                const dollarRisk = pointsRisk * totalEntryContracts * pointValue;
                dollarRiskText = `$${dollarRisk.toFixed(2)}`;
            }
        }

        // Calculate Gross P&L
        let grossPnlText = '$--';
        let pnlClass = '';
        if (avgEntryPrice > 0 && avgExitPrice > 0 && totalExitContracts > 0) {
            let pnlPerContract;
            if (direction === 'Long') {
                pnlPerContract = avgExitPrice - avgEntryPrice;
            } else if (direction === 'Short') {
                pnlPerContract = avgEntryPrice - avgExitPrice;
            }

            const grossPnl = pnlPerContract * totalExitContracts * pointValue;
            grossPnlText = `$${grossPnl.toFixed(2)}`;

            if (grossPnl > 0) {
                pnlClass = 'text-success';
            } else if (grossPnl < 0) {
                pnlClass = 'text-danger';
            }
        }

        // Calculate overall rating
        let overallRatingText = '--/5';
        const ratings = ['preparation_rating', 'rules_rating', 'management_rating', 'target_rating', 'entry_rating'];
        const ratingValues = ratings.map(name => {
            const value = parseInt(document.querySelector(`[name="${name}"]`)?.value || '0');
            return value > 0 ? value : null;
        }).filter(v => v !== null);

        if (ratingValues.length > 0) {
            const avgRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
            overallRatingText = `${avgRating.toFixed(1)}/5`;
        }

        // Update display
        document.getElementById('risk-reward-display').textContent = riskRewardText;
        document.getElementById('time-in-trade-display').textContent = timeInTradeText;
        document.getElementById('points-risked-display').textContent = pointsRiskedText;
        document.getElementById('dollar-risk-display').textContent = dollarRiskText;
        document.getElementById('overall-rating-display').textContent = overallRatingText;

        const pnlElement = document.getElementById('gross-pnl-display');
        pnlElement.textContent = grossPnlText;
        pnlElement.className = `kpi-value ${pnlClass}`;
    }

    // Add calculation listeners
    function addCalculationListeners() {
        const fieldsToWatch = [
            '[name="instrument"]', '[name="direction"]', '[name="initial_stop_loss"]', '[name="terminus_target"]',
            '[name^="entries-"]', '[name^="exits-"]', '[name$="_rating"]'
        ];

        fieldsToWatch.forEach(selector => {
            document.querySelectorAll(selector).forEach(field => {
                field.removeEventListener('input', calculateStats);
                field.removeEventListener('change', calculateStats);
                field.addEventListener('input', calculateStats);
                field.addEventListener('change', calculateStats);
            });
        });
    }

    // Form submission
    const tradeForm = document.getElementById('tradeForm');
    if (tradeForm) {
        tradeForm.addEventListener('submit', function(e) {
            isSubmitting = true;
            
            // Update Quill content
            for (const textareaId in quillInstances) {
                if (quillInstances.hasOwnProperty(textareaId) && document.getElementById(textareaId)) {
                    document.getElementById(textareaId).value = quillInstances[textareaId].root.innerHTML;
                }
            }
        });
    }

    // Initialize everything
    addCalculationListeners();
    calculateStats();
    updateCounts();
    
    console.log('Enterprise add trade page JavaScript initialization complete');
});

// Cancel action handler
function handleCancelAction() {
    if (hasUnsavedChanges) {
        showCustomConfirmation(
            'Confirm Operational Change',
            'Are you sure you want to cancel this strategic configuration? All entered data will be lost.',
            'btn-warning',
            'exclamation-triangle',
            function() {
                window.location.href = '{{ url_for("trades.view_trades_list") }}';
            }
        );
    } else {
        window.location.href = '{{ url_for("trades.view_trades_list") }}';
    }
}

// CSRF token helper
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
           document.querySelector('#js-csrf-token')?.value || '';
}
</script>
{% endblock %}