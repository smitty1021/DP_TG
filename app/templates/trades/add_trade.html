{% extends "base.html" %}

{% block title %}
    {% if trade %}
        Update Trade Configuration: {{ trade.instrument }} ({{ trade.direction }}) on {{ trade.trade_date.strftime('%d-%b-%Y') }} - Trading Journal
    {% else %}
        Create New Trade Configuration - Trading Journal
    {% endif %}
{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
// Global validation variables for entry/exit tracking only
let entryExitValidation = {
    entries: 0,
    exits: 0
};

// Function to trigger enterprise unsaved changes
function triggerEnterpriseUnsavedChanges(fieldType = 'unknown') {
    if (window.enterpriseUnsavedChanges) {
        // Set hasUnsavedChanges directly 
        window.enterpriseUnsavedChanges.hasUnsavedChanges = true;
        
        // Store custom fields in a separate property to avoid interference
        if (!window.enterpriseUnsavedChanges.customFieldChanges) {
            window.enterpriseUnsavedChanges.customFieldChanges = [];
        }
        
        // Determine the field name based on type
        let fieldName = '';
        if (fieldType === 'tags') {
            fieldName = 'Trade Tags';
        } else if (fieldType === 'quill-pre') {
            fieldName = 'Pre-Trade Analysis';
        } else if (fieldType === 'quill-post') {
            fieldName = 'Post-Trade Analysis';
        } else if (fieldType === 'quill-management') {
            fieldName = 'Trade Management';
        } else if (fieldType === 'quill-errors') {
            fieldName = 'Execution Errors';
        } else if (fieldType === 'quill-improvements') {
            fieldName = 'Enhancement Opportunities';
        } else if (fieldType === 'quill-overall') {
            fieldName = 'Overall Analysis';
        } else {
            fieldName = 'Custom Field';
        }
        
        // Add to custom field changes if not already present
        if (!window.enterpriseUnsavedChanges.customFieldChanges.includes(fieldName)) {
            window.enterpriseUnsavedChanges.customFieldChanges.push(fieldName);
        }
        
        // Show unsaved indicators
        const indicators = document.querySelectorAll('[class*="unsaved"], [id*="unsaved"]');
        indicators.forEach(indicator => {
            indicator.style.display = 'block';
        });
        
        return;
    }
    
    // Fallback: Trigger change event on a form field
    const form = document.getElementById('tradeForm');
    if (form) {
        const firstInput = form.querySelector('input[name="instrument"], input[name="trading_model"], select, textarea');
        if (firstInput) {
            firstInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
}

// Make function globally accessible
window.triggerEnterpriseUnsavedChanges = triggerEnterpriseUnsavedChanges;

// Functions to disable/enable main form buttons during tag modal
function disableMainFormButtons() {
    console.log('üîí Disabling main form buttons for tag modal');
    
    // Find and disable the main form submit and cancel buttons
    const submitBtn = document.querySelector('button[type="submit"]');
    const cancelBtns = document.querySelectorAll('button[onclick*="handleCancelAction"]');
    
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.6';
        submitBtn.style.cursor = 'not-allowed';
        submitBtn.setAttribute('data-disabled-by-modal', 'true');
    }
    
    cancelBtns.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.6';
        btn.style.cursor = 'not-allowed';
        btn.setAttribute('data-disabled-by-modal', 'true');
    });
}

function enableMainFormButtons() {
    console.log('üîì Re-enabling main form buttons after tag modal');
    
    // Find and re-enable all buttons that were disabled by modal
    const disabledButtons = document.querySelectorAll('button[data-disabled-by-modal="true"]');
    
    disabledButtons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '';
        btn.style.cursor = '';
        btn.removeAttribute('data-disabled-by-modal');
    });
}

// Function to show image in the existing base.html modal
function showTradeImageModal(imageSrc, imageTitle) {
    console.log('üì∑ Opening image modal:', imageTitle);
    
    // Use the existing imageModal from base.html
    const imageModal = document.getElementById('imageModal');
    const imageModalImg = document.getElementById('imageModalImg');
    const imageModalTitle = document.getElementById('imageModalTitle');
    
    if (imageModal && imageModalImg && imageModalTitle) {
        imageModalImg.src = imageSrc;
        imageModalTitle.textContent = imageTitle || 'Trade Image';
        
        // Show the modal using Bootstrap
        const modal = new bootstrap.Modal(imageModal);
        modal.show();
    } else {
        console.error('Image modal elements not found');
    }
}

// Function to delete existing trade images
function deleteExistingImage(imageId) {
    console.log('üóëÔ∏è Deleting existing image:', imageId);
    
    showCustomConfirmation({
        title: 'Delete Image',
        message: 'Are you sure you want to delete this image? This action cannot be undone.',
        confirmText: 'Delete Image',
        confirmClass: 'btn-danger',
        icon: 'trash',
        onConfirm: function() {
            // Get CSRF token
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            const csrfInput = document.querySelector('#js-csrf-token');
            const csrfToken = csrfMeta?.getAttribute('content') || csrfInput?.value || '';
            
            // Show loading state
            const imageContainer = document.getElementById(`existing-image-${imageId}`);
            if (imageContainer) {
                imageContainer.style.opacity = '0.6';
                imageContainer.style.pointerEvents = 'none';
                
                // Add loading overlay
                const overlay = document.createElement('div');
                overlay.className = 'position-absolute w-100 h-100 d-flex align-items-center justify-content-center';
                overlay.style.cssText = 'top: 0; left: 0; background: rgba(0, 0, 0, 0.7); color: white; font-weight: bold; z-index: 10;';
                overlay.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>DELETING...';
                overlay.id = `overlay-${imageId}`;
                
                const cardElement = imageContainer.querySelector('.card');
                if (cardElement) {
                    cardElement.style.position = 'relative';
                    cardElement.appendChild(overlay);
                }
            }
            
            // Make API call to delete image
            const deleteUrl = `/trades/image/${imageId}/delete`;
            
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        throw new Error('Expected JSON response but got: ' + text);
                    });
                }
            })
            .then(data => {
                if (data.success) {
                    // Remove the image container with animation
                    if (imageContainer) {
                        imageContainer.style.transition = 'all 0.3s ease';
                        imageContainer.style.transform = 'scale(0)';
                        imageContainer.style.opacity = '0';
                        
                        setTimeout(() => {
                            imageContainer.remove();
                            
                            // Check if any images are left
                            const remainingImages = document.querySelectorAll('[id^="existing-image-"]');
                            const newPreviews = document.querySelectorAll('[id^="new-preview-"]');
                            
                            if (remainingImages.length === 0 && newPreviews.length === 0) {
                                const previewSection = document.getElementById('image-preview-section');
                                if (previewSection) {
                                    previewSection.style.display = 'none';
                                }
                            }
                        }, 300);
                    }
                    
                    // Show success notification
                    if (window.showNotification) {
                        showNotification('success', 'Image deleted successfully');
                    }
                } else {
                    // Show error and restore image
                    if (imageContainer) {
                        imageContainer.style.opacity = '1';
                        imageContainer.style.pointerEvents = 'auto';
                        const overlay = document.getElementById(`overlay-${imageId}`);
                        if (overlay) {
                            overlay.remove();
                        }
                    }
                    
                    if (window.showNotification) {
                        showNotification('error', data.error || 'Failed to delete image');
                    }
                }
            })
            .catch(error => {
                // Restore image on error
                if (imageContainer) {
                    imageContainer.style.opacity = '1';
                    imageContainer.style.pointerEvents = 'auto';
                    const overlay = document.getElementById(`overlay-${imageId}`);
                    if (overlay) {
                        overlay.remove();
                    }
                }
                
                if (window.showNotification) {
                    showNotification('error', 'Failed to delete image');
                }
            });
        }
    });
}

// Function to handle image preview for trade images
function setupImagePreviews() {
    console.log('üñºÔ∏è Setting up image previews');
    
    const imageInput = document.querySelector('input[name="trade_images"]');
    const previewSection = document.getElementById('image-preview-section');
    const previewContainer = document.getElementById('image-preview-container');
    
    if (!imageInput || !previewSection || !previewContainer) {
        console.warn('Image preview elements not found');
        return;
    }
    
    // Check if there are existing images and ensure section is visible
    const existingImages = previewContainer.querySelectorAll('[id^="existing-image-"]');
    if (existingImages.length > 0) {
        previewSection.style.display = 'block';
        console.log(`üì∑ Found ${existingImages.length} existing images`);
    }
    
    imageInput.addEventListener('change', function(event) {
        const files = event.target.files;
        console.log(`üìÅ ${files.length} files selected for preview`);
        
        // Clear only new previews, keep existing images
        const newPreviews = previewContainer.querySelectorAll('[id^="new-preview-"]');
        newPreviews.forEach(preview => preview.remove());
        
        if (files.length === 0) {
            // Only hide if no existing images
            if (existingImages.length === 0) {
                previewSection.style.display = 'none';
            }
            return;
        }
        
        // Show preview section
        previewSection.style.display = 'block';
        
        // Create preview for each file
        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-4 col-6';
                    col.id = `new-preview-${index}`;
                    
                    const imageCard = document.createElement('div');
                    imageCard.className = 'card h-100';
                    imageCard.style.cursor = 'pointer';
                    
                    imageCard.innerHTML = `
                        <img src="${e.target.result}" 
                             class="card-img-top mt-3" 
                             style="height: 120px; object-fit: contain; background: #f8f9fa;"
                             alt="Trade Image ${index + 1}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">${file.name}</small>
                                    <br>
                                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.col-md-3').remove()" title="Remove Preview">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler to show full image in modal
                    imageCard.addEventListener('click', function() {
                        showTradeImageModal(e.target.result, file.name);
                    });
                    
                    col.appendChild(imageCard);
                    previewContainer.appendChild(col);
                };
                
                reader.readAsDataURL(file);
            }
        });
    });
}

// Function to register new dynamic inputs with enterprise unsaved changes system
function registerNewInputsWithEnterprise() {
    console.log('üîÑ Registering new dynamic inputs with enterprise system');
    
    if (window.enterpriseUnsavedChanges) {
        // Get all current inputs including new ones
        const newInputs = window.enterpriseUnsavedChanges.getAllFormInputs();
        
        // Update the allInputs array
        window.enterpriseUnsavedChanges.allInputs = newInputs;
        
        // Capture original state for new inputs that don't have it yet
        newInputs.forEach(input => {
            if (!window.enterpriseUnsavedChanges.isExcludedInput(input)) {
                const key = window.enterpriseUnsavedChanges.getInputKey(input);
                if (key && !window.enterpriseUnsavedChanges.originalFormData.has(key)) {
                    // Capture initial state for new input
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        window.enterpriseUnsavedChanges.originalFormData.set(key, input.checked);
                    } else if (input.type === 'file') {
                        window.enterpriseUnsavedChanges.originalFormData.set(key, input.files ? input.files.length : 0);
                    } else {
                        window.enterpriseUnsavedChanges.originalFormData.set(key, input.value);
                    }
                    
                    // Add event listeners for the new input
                    input.addEventListener('input', () => window.enterpriseUnsavedChanges.checkForChanges());
                    input.addEventListener('change', () => window.enterpriseUnsavedChanges.checkForChanges());
                    
                    console.log(`üìù Registered new input: ${key} = ${window.enterpriseUnsavedChanges.originalFormData.get(key)}`);
                }
            }
        });
        
        console.log(`‚úÖ Enterprise system now monitoring ${window.enterpriseUnsavedChanges.originalFormData.size} total fields`);
    }
}

// Override the enterprise system's getChangedFields method to include our custom fields
document.addEventListener('DOMContentLoaded', function() {
    // Wait for enterprise system to initialize
    setTimeout(function() {
        if (window.enterpriseUnsavedChanges && typeof window.enterpriseUnsavedChanges.getChangedFields === 'function') {
            // Store the original methods
            const originalGetChangedFields = window.enterpriseUnsavedChanges.getChangedFields.bind(window.enterpriseUnsavedChanges);
            const originalGetDetailedChangedFieldsMessage = window.enterpriseUnsavedChanges.getDetailedChangedFieldsMessage;
            
            // Override with our enhanced version
            window.enterpriseUnsavedChanges.getChangedFields = function() {
                console.log('üîç Custom getChangedFields called');
                
                // Debug: Check the enterprise system state
                console.log('üîç Enterprise form:', this.form);
                console.log('üîç Enterprise originalFormData size:', this.originalFormData ? this.originalFormData.size : 'undefined');
                console.log('üîç Enterprise allInputs length:', this.allInputs ? this.allInputs.length : 'undefined');
                console.log('üîç Enterprise hasUnsavedChanges:', this.hasUnsavedChanges);
                
                // Get standard form changes using the original method
                console.log('üîç About to call originalGetChangedFields...');
                const standardChanges = originalGetChangedFields.call(this);
                console.log('üìã Standard changes:', standardChanges);
                
                // Get our custom field changes
                const customChanges = this.customFieldChanges || [];
                console.log('üè∑Ô∏è Custom changes:', customChanges);
                
                // Merge both arrays and remove duplicates
                const allChanges = [...new Set([...standardChanges, ...customChanges])];
                console.log('üîÑ Merged changes:', allChanges);
                
                return allChanges;
            };
            
            // Also override getDetailedChangedFieldsMessage which is what actually generates the popup text
            if (originalGetDetailedChangedFieldsMessage) {
                window.enterpriseUnsavedChanges.getDetailedChangedFieldsMessage = function() {
                    console.log('üîç Custom getDetailedChangedFieldsMessage called');
                    
                    // Get our clean custom changes from the separate property
                    const customChanges = this.customFieldChanges || [];
                    console.log('üîç Custom field changes:', customChanges);
                    
                    // Create a field name mapping for user-friendly names
                    const fieldNameMap = {
                        'instrument': 'Instrument',
                        'direction': 'Direction',
                        'trading_model_id': 'Trading Model',
                        'initial_stop_loss': 'Initial Stop Loss',
                        'how_closed': 'How Closed',
                        'psych_scored_highest': 'Highest Psychology Score',
                        'psych_scored_lowest': 'Lowest Psychology Score',
                        'trade_management_notes': 'Trade Management Notes',
                        'errors_notes': 'Execution Errors',
                        'improvements_notes': 'Enhancement Opportunities',
                        'preparation_rating': 'Preparation Rating',
                        'rules_rating': 'Rules Adherence Rating',
                        'management_rating': 'Risk Management Rating',
                        'target_rating': 'Target Placement Rating',
                        'timing_rating': 'Timing Rating'
                    };
                    
                    // Get standard form changes using original getChangedFields method
                    // First, temporarily clear any interference from the customFieldChanges property
                    const tempCustomFieldChanges = this.customFieldChanges;
                    this.customFieldChanges = undefined; // Clear completely to get pure standard changes
                    
                    const standardChangedFields = originalGetChangedFields();
                    console.log('üîç Standard changed fields:', standardChangedFields);
                    
                    // Restore the customFieldChanges property
                    this.customFieldChanges = tempCustomFieldChanges;
                    
                    // Convert standard field names to user-friendly names
                    const beautifiedStandardFields = standardChangedFields.map(fieldName => {
                        // Handle entry/exit field patterns
                        if (fieldName.includes('entries-') && fieldName.includes('-contracts')) {
                            return 'Entry Contracts';
                        } else if (fieldName.includes('entries-') && fieldName.includes('-price')) {
                            return 'Entry Price';
                        } else if (fieldName.includes('exits-') && fieldName.includes('-contracts')) {
                            return 'Exit Contracts';
                        } else if (fieldName.includes('exits-') && fieldName.includes('-price')) {
                            return 'Exit Price';
                        }
                        
                        // Use mapping or beautify the field name
                        return fieldNameMap[fieldName] || this.beautifyFieldName(fieldName);
                    });
                    
                    console.log('üîç Beautified standard fields:', beautifiedStandardFields);
                    
                    // Combine standard and custom changes
                    const allFields = [...beautifiedStandardFields, ...customChanges];
                    console.log('üîç All combined fields:', allFields);
                    
                    if (allFields.length > 0) {
                        let message = 'You have made changes to the following fields that have not been saved yet:\n\n';
                        
                        if (allFields.length <= 5) {
                            message += `‚Ä¢ ${allFields.join('\n‚Ä¢ ')}`;
                        } else {
                            message += `‚Ä¢ ${allFields.slice(0, 5).join('\n‚Ä¢ ')}\n‚Ä¢ ... and ${allFields.length - 5} more fields`;
                        }
                        
                        console.log('üîç Final message:', message);
                        return message;
                    }
                    
                    // Fallback to original method
                    return originalGetDetailedChangedFieldsMessage.call(this);
                };
            }
            
            console.log('‚úÖ Successfully overrode enterprise getChangedFields method');
        }
    }, 1000); // Wait 1 second for enterprise system to fully initialize
});
</script>
{% endblock %}

{% block content %}
<!-- Executive Header -->
<div class="executive-header">
    <div class="d-flex justify-content-between align-items-center">
        <div class="header-content">
            <h1 class="executive-title">
                {% if trade %}
                <i class="fas fa-edit executive-icon"></i>
                Update Trade Configuration
                {% else %}
                <i class="fas fa-plus-circle executive-icon"></i>
                Create Strategic Trade Configuration
                {% endif %}
            </h1>
            <div class="executive-subtitle">
                {% if trade %}
                Modify Trade Parameters: {{ trade.instrument }} ({{ trade.direction }}) on {{ trade.trade_date.strftime('%A, %B %d, %Y') }}
                {% else %}
                Configure new strategic trading execution parameters and comprehensive analysis framework
                {% endif %}
            </div>
        </div>
        <div class="btn-group">
            {% if trade %}
            <button type="button" class="btn btn-outline-secondary"
                    onclick="window.location.href='{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}'"
                    title="View Trade Details">
                <i class="fas fa-eye"></i>
            </button>
            {% else %}
            <button type="button" class="btn btn-outline-secondary"
                    onclick="window.location.href='{{ url_for('trades.import_trades') }}'"
                    title="Import Trade Configurations">
                <i class="fas fa-upload"></i>
            </button>
            {% endif %}
            <button type="button" class="btn btn-outline-secondary"
                    onclick="window.location.href='{{ url_for('main.index') }}'"
                    title="Go to Main Dashboard">
                <i class="fas fa-home"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary"
                    onclick="window.location.href='{{ url_for('trades.view_trades_list') }}'"
                    title="Back to Trading Operations">
                <i class="fas fa-list"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary"
                    onclick="location.reload()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary"
                    onclick="handleCancelAction();" title="Cancel Configuration">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>



<!-- Trade Stats Dashboard (Auto-calculated) -->
<div id="trade-stats-dashboard" class="kpi-section mt-3" style="display: none;">
    <div class="grid grid-cols-7 gap-4">
        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-balance-scale kpi-icon me-2"></i>
                        <span class="kpi-label">Risk:Reward</span>
                    </div>
                    <div class="kpi-value" id="risk-reward-display">--:--</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Planned Ratio</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-clock kpi-icon me-2"></i>
                        <span class="kpi-label">Duration</span>
                    </div>
                    <div class="kpi-value" id="time-in-trade-display">--h --m</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Time Held</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-chart-line kpi-icon me-2"></i>
                        <span class="kpi-label">Points Risk</span>
                    </div>
                    <div class="kpi-value" id="points-risked-display">--</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Risk Points</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-dollar-sign kpi-icon me-2"></i>
                        <span class="kpi-label">Dollar Risk</span>
                    </div>
                    <div class="kpi-value" id="dollar-risk-display">$--</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Risk Amount</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-chart-area kpi-icon me-2"></i>
                        <span class="kpi-label">Gross P&L</span>
                    </div>
                    <div class="kpi-value" id="gross-pnl-display">$--</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Total Return</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-star kpi-icon me-2"></i>
                        <span class="kpi-label">Quality Score</span>

                    </div>
                    <div class="kpi-value" id="overall-rating-display">--/5</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Execution Rating</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-span-1">
            <div class="kpi-card">
                <div class="kpi-content">
                    <div class="kpi-header">
                        <i class="fas fa-percentage kpi-icon me-2"></i>
                        <span class="kpi-label">Efficiency</span>
                    </div>
                    <div class="kpi-value" id="efficiency-display">--%</div>
                    <div class="kpi-trend">
                        <span class="trend-indicator">Profit Capture</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{% if trade %}{{ url_for('trades.edit_trade', trade_id=trade.id) }}{% else %}{{ url_for('trades.add_trade') }}{% endif %}" id="tradeForm" novalidate enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <!-- Basic Trade Configuration -->
    <div class="grid grid-cols-15 gap-4 align-items-start mt-3">
        <div class="col-span-4">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cog module-icon"></i>
                        Basic Trade Configuration
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            {{ form.trade_date.label(class="form-label") }}
                            {{ form.trade_date(class="form-control" + (" is-invalid" if form.trade_date.errors else ""), type="date") }}
                            {% if form.trade_date.errors %}
                            {% for error in form.trade_date.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.instrument.label(class="form-label") }}
                            {{ form.instrument(class="form-select" + (" is-invalid" if form.instrument.errors else "")) }}
                            {% if form.instrument.errors %}
                            {% for error in form.instrument.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.direction.label(class="form-label") }}
                            {{ form.direction(class="form-select" + (" is-invalid" if form.direction.errors else "")) }}
                            {% if form.direction.errors %}
                            {% for error in form.direction.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div>
                            {{ form.trading_model_id.label(class="form-label") }}
                            {{ form.trading_model_id(class="form-select" + (" is-invalid" if form.trading_model_id.errors else "")) }}
                            {% if form.trading_model_id.errors %}
                            {% for error in form.trading_model_id.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.initial_stop_loss.label(class="form-label") }}
                            {{ form.initial_stop_loss(class="form-control" + (" is-invalid" if form.initial_stop_loss.errors else ""), type="number", step="any", placeholder="Stop Loss Price") }}
                            {% if form.initial_stop_loss.errors %}
                            {% for error in form.initial_stop_loss.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.terminus_target.label(class="form-label") }}
                            {{ form.terminus_target(class="form-control" + (" is-invalid" if form.terminus_target.errors else ""), type="number", step="any", placeholder="Target Price") }}
                            {% if form.terminus_target.errors %}
                            {% for error in form.terminus_target.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- DCA Toggle -->
                    <div class="mt-3">
                        <div class="form-check">
                            {{ form.is_dca(class="form-check-input" + (" is-invalid" if form.is_dca.errors else "")) }}
                            {{ form.is_dca.label(class="form-check-label") }}
                            {% if form.is_dca.errors %}
                            {% for error in form.is_dca.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-span-5">
            <!-- Entry & Exit Points Management -->
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-exchange-alt module-icon"></i>
                        Execution Entry & Exit Points
                    </div>
                </div>
                <div class="module-content">
                    <div class="table-responsive">
                        <table class="table table-sm table-dark mb-0">
                            <thead>
                            <tr>
                                <th width="15%">Type</th>
                                <th width="25%">Time</th>
                                <th width="19%">Contracts</th>
                                <th width="38%">Price</th>
                                <th width="3%"></th>
                            </tr>
                            </thead>
                            <tbody id="unified-points-container">
                            <!-- Existing Entry Points -->
                            {% for entry_form_field in form.entries %}
                            <tr class="entry-exit-item entry-point" data-type="entry">
                                <td>
                                            <span class="badge bg-success">
                                                </i>ENTRY
                                            </span>
                                </td>
                                <td>
                                    {{ entry_form_field.entry_time(class="form-control form-control-sm text-center", type="time") }}
                                </td>
                                <td>
                                    {{ entry_form_field.contracts(class="form-control form-control-sm text-center", type="number", min="1") }}
                                </td>
                                <td>
                                    {{ entry_form_field.entry_price(class="form-control form-control-sm text-center", type="number", step="any") }}
                                </td>
                                <td class="text-center">
                                    {% if loop.index > 1 %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Existing Exit Points -->
                            {% for exit_form_field in form.exits %}
                            <tr class="entry-exit-item exit-point" data-type="exit">
                                <td>
                                            <span class="badge bg-danger">
                                                </i>EXIT
                                            </span>
                                </td>
                                <td>
                                    {{ exit_form_field.exit_time(class="form-control form-control-sm text-center", type="time") }}
                                </td>
                                <td>
                                    {{ exit_form_field.contracts(class="form-control form-control-sm text-center", type="number", min="1") }}
                                </td>
                                <td>
                                    {{ exit_form_field.exit_price(class="form-control form-control-sm text-center", type="number", step="any") }}
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-success" id="add-entry-button">
                                <i class="fas fa-plus me-1"></i>Add Entry
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="add-exit-button">
                                <i class="fas fa-plus me-1"></i>Add Exit
                            </button>
                        </div>
                    </div>

                    <div id="exit-validation-warning" class="alert alert-warning mt-3" style="display: none;">
                        <small><i class="fas fa-exclamation-triangle me-1"></i>Cannot add more exits than total entry contracts.</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-span-3">
            <!-- Trade Closure & Performance -->
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-bar module-icon"></i>
                        Trade Closure, MAE & MFE
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            {{ form.how_closed.label(class="form-label") }}
                            {{ form.how_closed(class="form-select" + (" is-invalid" if form.how_closed.errors else "")) }}
                            {% if form.how_closed.errors %}
                            {% for error in form.how_closed.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.mae_price.label(class="form-label") }}
                            {{ form.mae_price(class="form-control" + (" is-invalid" if form.mae_price.errors else ""), type="number", step="any", placeholder="Worst price reached before closing") }}
                            {% if form.mae_price.errors %}
                            {% for error in form.mae_price.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div>
                            {{ form.mfe_price.label(class="form-label") }}
                            {{ form.mfe_price(class="form-control" + (" is-invalid" if form.mfe_price.errors else ""), type="number", step="any", placeholder="Best price reached before closing") }}
                            {% if form.mfe_price.errors %}
                            {% for error in form.mfe_price.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-span-3">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-tag module-icon"></i>
                        Trade Tags
                    </div>
                </div>
                <div class="module-content">
                    <!-- Hidden input for form submission -->
                    <div id="tags-hidden-input-add-trade"></div>

                    <!-- Display existing tags if in edit mode -->
                    {% if trade and trade.tags %}
                    <div id="selected-tags-display-add-trade" class="d-flex flex-wrap gap-2 mb-3">
                        {% for tag in trade.tags %}
                        <span class="tag-item {% if tag.color_category == 'good' %}tag-good{% elif tag.color_category == 'bad' %}tag-bad{% else %}tag-neutral{% endif %} selected-tag" data-tag-id="{{ tag.id }}">
                                {{ tag.name }}
                                <button type="button" class="tag-remove-btn" data-tag-id="{{ tag.id }}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <!-- Selected Tags Display for new trades -->
                    <div id="selected-tags-display-add-trade" class="d-flex flex-wrap gap-2">
                        <span class="text-muted" id="no-tags-message-add-trade">No tags selected</span>
                    </div>
                    {% endif %}

                    {% if form.tags.errors %}
                    {% for error in form.tags.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                    {% endif %}

                    <!-- Separator line and Add Tags button -->
                    <hr class="my-3" style="border-color: rgba(255, 255, 255, 0.2);">
                    <div class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="open-tags-modal">
                            <i class="fas fa-plus me-1"></i>Add Tags
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="grid grid-cols-12 gap-4 align-items-start mt-3">
        <!-- Left Column: Trade Configuration -->
        <div class="col-span-12">
            <!-- Trade Analysis & Notes -->
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-line module-icon"></i>
                        Strategic Analysis Framework and Tagging
                    </div>
                </div>
                <div class="module-content">
                    <!-- Rich Text Editors -->
                    <div class="grid grid-cols-6 gap-4">
                        <div class="col-span-3">
                            <label class="form-label">{{ form.trade_notes.label.text }}</label>
                            <div id="trade_notes_editor" class="quill-editor-container" style="height: 350px;"></div>
                            {{ form.trade_notes(class="d-none") }}
                            {% if form.trade_notes.errors %}
                            {% for error in form.trade_notes.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                        <div class="col-span-3">
                            <label class="form-label">{{ form.overall_analysis_notes.label.text }}</label>
                            <div id="overall_analysis_notes_editor" class="quill-editor-container" style="height: 350px;"></div>
                            {{ form.overall_analysis_notes(class="d-none") }}
                            {% if form.overall_analysis_notes.errors %}
                            {% for error in form.overall_analysis_notes.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tags Selection Modal -->
    <div class="modal fade" id="tagsModal" tabindex="-1" aria-labelledby="tagsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tagsModalLabel">
                        <i class="fas fa-tags me-2 module-icon" )></i>Select Trade Classification Tags
                    </h5>
                </div>
                <div class="modal-body">

                    <!-- Add Tag Section - Centered Box -->
                    <div class="text-right mb-3">
                        <button type="button" class="btn btn-success" id="toggle-create-tag">
                            <i class="fas fa-plus me-1"></i>Add New Tag
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="apply-tags-selection">
                            <i class="fas fa-check me-1"></i>Apply Selection
                        </button>
                    </div>

                    <!-- Create Tag Form (hidden by default) - Centered Box -->
                    <div id="create-tag-form" class="d-flex justify-content-center mb-4" style="display: none !important;">
                        <div class="enterprise-module" style="max-width: 1000px; width: 100%;">
                            <div class="module-header text-center">
                                <div class="module-title">
                                    <i class="fas fa-plus-circle module-icon"></i>
                                    Create New Personal Tag
                                </div>
                                <div class="module-meta">
                                    Add a custom tag for your trading analysis
                                </div>
                            </div>
                            <div class="module-content">
                                <div class="grid grid-cols-10 gap-3 align-items-end">
                                    <div class="col-span-3">
                                        <label for="new-tag-name" class="form-label fw-semibold">Tag Name</label>
                                        <input type="text" class="form-control" id="new-tag-name" placeholder="Enter descriptive tag name..." maxlength="50">
                                    </div>
                                    <div class="col-span-3">
                                        <label for="new-tag-category" class="form-label fw-semibold">Category</label>
                                        <select class="form-select" id="new-tag-category">
                                            <option value="">-- Select Category --</option>
                                            <option value="SETUP_STRATEGY">Setup & Strategy</option>
                                            <option value="MARKET_CONDITIONS">Market Conditions</option>
                                            <option value="EXECUTION_MANAGEMENT">Execution & Management</option>
                                            <option value="PSYCHOLOGICAL_EMOTIONAL">Psychological & Emotional Factors</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label for="new-tag-color" class="form-label fw-semibold">Impact</label>
                                        <select class="form-select" id="new-tag-color">
                                            <option value="">-- Select Impact --</option>
                                            <option value="neutral">Neutral</option>
                                            <option value="good">Positive</option>
                                            <option value="bad">Negative</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-success" id="create-tag-submit">
                                                <i class="fas fa-save me-1"></i>Save
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="create-tag-cancel">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Tags organized by category like personal_tags.html -->
                    {% for category_name, category_data in tags_by_category.items() %}
                    <div class="tag-category-section mb-3">
                        <div class="tag-category-header">
                                <span>
                                    {% if category_name == 'Setup & Strategy' %}
                                        <i class="fas fa-cog me-2 module-icon"></i>
                                    {% elif category_name == 'Market Conditions' %}
                                        <i class="fas fa-chart-line me-2 module-icon"></i>
                                    {% elif category_name == 'Execution & Management' %}
                                        <i class="fas fa-play me-2 module-icon"></i>
                                    {% elif category_name == 'Psychological & Emotional Factors' %}
                                        <i class="fas fa-brain me-2 module-icon"></i>
                                    {% else %}
                                        <i class="fas fa-tag me-2 module-icon"></i>
                                    {% endif %}
                                    {{ category_name }}
                                </span>
                            <span class="badge bg-info">{{ category_data.tags|length }} tags</span>
                        </div>
                        <div class="tag-category-body">
                            {% set impact_groups = category_data.impact_groups %}
                            <div class="tag-impact-group">
                                <div class="tag-impact-body">
                                    {% for tag in impact_groups.neutral %}
                                    <div class="tag-item {{ tag|tag_color }} tag-selectable"
                                         data-tag-id="{{ tag.id }}"
                                         data-tag-name="{{ tag.name }}"
                                         data-tag-color="{{ tag.color_category or 'neutral' }}"
                                         role="button"
                                         tabindex="0"
                                         style="cursor: pointer; user-select: none;">
                                        <span class="tag-name">{{ tag.name }}</span>
                                    </div>
                                    {% endfor %}
                                    {% for tag in impact_groups.good %}
                                    <div class="tag-item {{ tag|tag_color }} tag-selectable"
                                         data-tag-id="{{ tag.id }}"
                                         data-tag-name="{{ tag.name }}"
                                         data-tag-color="{{ tag.color_category or 'neutral' }}"
                                         role="button"
                                         tabindex="0"
                                         style="cursor: pointer; user-select: none;">
                                        <span class="tag-name">{{ tag.name }}</span>
                                    </div>
                                    {% endfor %}
                                    {% for tag in impact_groups.bad %}
                                    <div class="tag-item {{ tag|tag_color }} tag-selectable"
                                         data-tag-id="{{ tag.id }}"
                                         data-tag-name="{{ tag.name }}"
                                         data-tag-color="{{ tag.color_category or 'neutral' }}"
                                         role="button"
                                         tabindex="0"
                                         style="cursor: pointer; user-select: none;">
                                        <span class="tag-name">{{ tag.name }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% if category_data.tags|length == 0 %}
                            <p class="text-muted fst-italic">No tags in this category yet.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-4 align-items-start mt-3">
        <!-- Left Column: Execution Quality Assessment -->
        <div class="col-span-9">
            <!-- Performance Assessment -->
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-star module-icon"></i>
                        Execution Quality Assessment
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-15 gap-4 align-items-start">
                        <!-- Rating List -->
                        <div class="col-span-3">
                            <div class="d-flex flex-column gap-1" style="text-align: left">
                                <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight rating-row"
                                     data-rating-category="preparation"
                                     data-rating-field="preparation_rating">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">Preparation</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1 rating-dots-container" data-rating="preparation_rating">
                                            <div class="rating-dot rating-dot-clickable" data-value="1" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="2" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="3" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="4" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="5" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight rating-row"
                                     data-rating-category="rules_adherence"
                                     data-rating-field="rules_rating">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">Rules Adherence</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1 rating-dots-container" data-rating="rules_rating">
                                            <div class="rating-dot rating-dot-clickable" data-value="1" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="2" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="3" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="4" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="5" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight rating-row"
                                     data-rating-category="risk_management"
                                     data-rating-field="management_rating">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">Risk Management</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1 rating-dots-container" data-rating="management_rating">
                                            <div class="rating-dot rating-dot-clickable" data-value="1" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="2" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="3" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="4" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="5" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight rating-row"
                                     data-rating-category="target_placement"
                                     data-rating-field="target_rating">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">Target Placement</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1 rating-dots-container" data-rating="target_rating">
                                            <div class="rating-dot rating-dot-clickable" data-value="1" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="2" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="3" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="4" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="5" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight rating-row"
                                     data-rating-category="entry_execution"
                                     data-rating-field="entry_rating">
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold text-muted">Entry Execution</div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="d-flex gap-1 rating-dots-container" data-rating="entry_rating">
                                            <div class="rating-dot rating-dot-clickable" data-value="1" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="2" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="3" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="4" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                            <div class="rating-dot rating-dot-clickable" data-value="5" style="
                                                    width: 10px;
                                                    height: 10px;
                                                    border-radius: 50%;
                                                    border: 1px solid var(--enterprise-gray-300);
                                                    background-color: var(--enterprise-gray-100);
                                                    cursor: pointer;
                                                "></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Average Rating -->
                                <div class="border-top mt-2 pt-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold text-primary">Overall Score:</span>
                                        <span class="badge bg-secondary fs-6" id="overall-score-badge">0.0/5.0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden form fields -->
                            {{ form.preparation_rating(class="d-none rating-selector") }}
                            {{ form.rules_rating(class="d-none rating-selector") }}
                            {{ form.management_rating(class="d-none rating-selector") }}
                            {{ form.target_rating(class="d-none rating-selector") }}
                            {{ form.entry_rating(class="d-none rating-selector") }}
                        </div>

                        <!-- Radar Chart -->
                        <div class="col-span-3 d-flex align-items-center justify-content-center">
                            <div class="position-relative" style="width: 200px; height: 200px;">
                                <canvas id="psychRadarChart" width="200" height="200"></canvas>
                            </div>
                        </div>

                        <!-- Psychology Notes placed to the right of radar chart -->
                        <div class="col-span-9">
                            <div class="mb-3">
                                {{ form.psych_scored_highest.label(class="form-label") }}
                                {{ form.psych_scored_highest(class="form-control textarea-3" + (" is-invalid" if form.psych_scored_highest.errors else ""), placeholder="What execution strengths were demonstrated?") }}
                                {% if form.psych_scored_highest.errors %}
                                {% for error in form.psych_scored_highest.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ form.psych_scored_lowest.label(class="form-label") }}
                                {{ form.psych_scored_lowest(class="form-control textarea-3" + (" is-invalid" if form.psych_scored_lowest.errors else ""), placeholder="Which areas require performance improvement?") }}
                                {% if form.psych_scored_lowest.errors %}
                                {% for error in form.psych_scored_lowest.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Charts & Images -->
            <div class="enterprise-module mt-3">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-brain module-icon"></i>
                            Comprehensive Trade Review
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-6 gap-4">
                            <div class="col-span-2">
                                <!-- Trade Management, Execution Errors, Enhancement Opportunities Row -->
                                <label class="form-label">Trade Management</label>
                                {{ form.trade_management_notes(class="form-control textarea-6" + (" is-invalid" if form.trade_management_notes.errors else ""), placeholder="Trade management decisions, scaling in/out, adjustments, etc.") }}
                                {% if form.trade_management_notes.errors %}
                                {% for error in form.trade_management_notes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-span-2">
                                <label class="form-label">Execution Errors</label>
                                {{ form.errors_notes(class="form-control textarea-6" + (" is-invalid" if form.errors_notes.errors else ""), placeholder="Any mistakes made during this trade?") }}
                                {% if form.errors_notes.errors %}
                                {% for error in form.errors_notes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-span-2">
                                <label class="form-label">Enhancement Opportunities</label>
                                {{ form.improvements_notes(class="form-control textarea-6" + (" is-invalid" if form.improvements_notes.errors else ""), placeholder="What could be improved for the next trade?") }}
                                {% if form.improvements_notes.errors %}
                                {% for error in form.improvements_notes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div class="text-muted mt-3">
                    <i class="fas fa-info-circle me-1"></i>
                    All fields with comprehensive data will provide better analysis and insights.
                </div>
            </div>
        </div>
        <div class="col-span-3">
            <!-- Charts & Images -->
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-exchange-alt module-icon"></i>
                        Charts and Images
                    </div>
                </div>
                <div class="module-content">
                    <div class="grid grid-cols-1">
                        <div
                                {{ form.screenshot_link.label(class="form-label") }}
                                {{ form.screenshot_link(class="form-control" + (" is-invalid" if form.screenshot_link.errors else ""), type="url", placeholder="https://www.tradingview.com/chart/...") }}
                        {% if form.screenshot_link.errors %}
                        {% for error in form.screenshot_link.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div>
                        {{ form.trade_images.label(class="form-label") }}

                        {{ form.trade_images(class="form-control" + (" is-invalid" if form.trade_images.errors else ""), accept="image/*") }}
                        {% if form.trade_images.errors %}
                        {% for error in form.trade_images.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    <!-- Image Preview Section -->
                    <div id="image-preview-section" {% if not trade or not trade_images %}style="display: none;"{% endif %}>
                        <div class="row g-3" id="image-preview-container">
                            <!-- Show existing images if in edit mode -->
                            {% if trade and trade_images %}
                            {% for image in trade_images %}
                            <div class="col-md-3 col-sm-4 col-6 mt-3" id="existing-image-{{ image.id }}">
                                <div class="card h-100">
                                    <img src="{{ url_for('images.serve_trade_image', image_id=image.id) }}"
                                         class="card-img-top mt-3"
                                         style="height: 200px; object-fit: contain; cursor: pointer;"
                                         alt="Trade Image"
                                         onclick="showTradeImageModal('{{ url_for('images.serve_trade_image', image_id=image.id) }}', '{{ image.filename }}')">

                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted">{{ image.filename }}</small>
                                                <small class="text-muted">
                                                    {% if image.filesize %}
                                                    ({{ "%.1f"|format(image.filesize / 1024) }} KB)
                                                    {% else %}
                                                    Unknown size
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <!-- Delete button inline with filename -->
                                            <button type="button"
                                                    class="btn btn-outline-danger btn-sm" 
                                                    onclick="deleteExistingImage({{ image.id }})"
                                                    title="Delete Image">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Hidden input for deletion -->
                                    <input type="hidden"
                                           name="delete_image_{{ image.id }}"
                                           id="delete_image_{{ image.id }}"
                                           value="false">
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <!-- User Instructions for Multiple Image Selection -->
                    <div class="alert alert-info py-2 px-3" style="border-left: 4px solid #0066cc; background-color: rgba(0, 102, 204, 0.05);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            <small class="mb-0">
                                <strong>Multiple Images:</strong> Hold <kbd>Ctrl</kbd> (Windows) or <kbd>Cmd</kbd> (Mac) while clicking to select multiple images, or <kbd>Shift</kbd> to select a range of images.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Form Actions -->
    <div class="sticky-action-buttons">
        <div class="btn-group">
            <button type="submit" class="btn btn-primary">
                {% if trade %}
                    <i class="fas fa-save me-1"></i>Update Trade
                {% else %}
                    <i class="fas fa-save me-1"></i>Save Trade
                {% endif %}
            </button>
            <button type="button" class="btn btn-secondary" onclick="handleCancelAction()">
                <i class="fas fa-times me-1"></i>Cancel
            </button>

        </div>
    </div>
</form>


<!-- Hidden Templates for Dynamic Entry/Exit Points -->
<div id="entry-template" style="display: none;">
    <tr class="entry-exit-item">
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-entry_time" type="time" placeholder="HH:MM">
        </td>
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-contracts" type="number" min="1" placeholder="Contracts">
        </td>
        <td>
            <input class="form-control form-control-sm" name="entries-INDEX-entry_price" type="number" step="any" placeholder="Price">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    </tr>
</div>

<div id="exit-template" style="display: none;">
    <tr class="entry-exit-item">
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-exit_time" type="time" placeholder="HH:MM">
        </td>
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-contracts" type="number" min="1" placeholder="Contracts">
        </td>
        <td>
            <input class="form-control form-control-sm" name="exits-INDEX-exit_price" type="number" step="any" placeholder="Price">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    </tr>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize script

document.addEventListener('DOMContentLoaded', function() {

    // Global variables
    let quillInstances = {};
    let tagsSelect = null;

    // Initialize instrument point values early
    const instrumentPointValues = {{ instrument_point_values|tojson|safe }};

    // Set default date
    const tradeDateInput = document.getElementById('{{ form.trade_date.id }}');
    if (tradeDateInput && !tradeDateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = ('0' + (today.getMonth() + 1)).slice(-2);
        const day = ('0' + today.getDate()).slice(-2);
        tradeDateInput.value = `${year}-${month}-${day}`;
    }

    // Create tag color mapping
    const tagColors = {};
    {% for category_name, tag_options in form.tags.choices %}
        {% for tag_id, tag_name, tag_color in tag_options %}
            tagColors['{{ tag_id }}'] = '{{ tag_color or "neutral" }}';
        {% endfor %}
    {% endfor %}

    // Initialize Hybrid Tags System (Input + Dropdown)
    const selectedTagsDisplay = document.getElementById('selected-tags-display-add-trade');
    const noTagsMessage = document.getElementById('no-tags-message-add-trade');
    const hiddenInput = document.getElementById('tags-hidden-input-add-trade');
    const tagItems = document.querySelectorAll('.tag-selectable-add-trade');
    const hybridInput = document.getElementById('tags-hybrid-input');
    const dropdownToggle = document.getElementById('tags-dropdown-toggle');
    const selectedTagIds = new Set();

    // Function to update the hidden input value
    function updateHiddenInput() {
        if (hiddenInput) {
            hiddenInput.value = Array.from(selectedTagIds).join(',');
        }
    }

    // Function to create a selected tag display element
    function createSelectedTag(id, name, color) {
        const selectedTag = document.createElement('div');
        selectedTag.className = `tag-item tag-${color} selected-tag`;
        selectedTag.dataset.tagId = id;
        selectedTag.style.cssText = 'cursor: pointer; user-select: none; opacity: 0.8; position: relative;';

        selectedTag.innerHTML = `
            <span class="tag-name">${name}</span>
            <i class="fas fa-times ms-2" style="font-size: 0.75rem; opacity: 0.7;"></i>
        `;

        selectedTag.addEventListener('click', function() {
            toggleTagSelection(id, name, color);
        });

        return selectedTag;
    }

    // Function to update the selected tags display
    function updateSelectedTagsDisplay() {
        if (!selectedTagsDisplay) return;

        selectedTagsDisplay.innerHTML = '';

        if (selectedTagIds.size === 0) {
            selectedTagsDisplay.appendChild(noTagsMessage);
        } else {
            selectedTagIds.forEach(tagId => {
                const tagItem = Array.from(tagItems).find(item => item.dataset.tagId === tagId);
                if (tagItem) {
                    const selectedTag = createSelectedTag(
                        tagId,
                        tagItem.dataset.tagName,
                        tagItem.dataset.tagColor
                    );
                    selectedTagsDisplay.appendChild(selectedTag);
                }
            });
        }
    }

    // Function to filter tags based on search input
    function filterTags(searchTerm) {
        const categorySections = document.querySelectorAll('.tag-category-section');
        let hasVisibleTags = false;

        categorySections.forEach(categorySection => {
            categorySection.style.display = 'block';
            let hasVisibleTagsInCategory = false;

            const tagItems = categorySection.querySelectorAll('.tag-selectable-add-trade');
            tagItems.forEach(tag => {
                const tagName = tag.dataset.tagName.toLowerCase();
                if (tagName.includes(searchTerm.toLowerCase()) || searchTerm === '') {
                    tag.style.display = 'inline-block';
                    hasVisibleTagsInCategory = true;
                    hasVisibleTags = true;
                } else {
                    tag.style.display = 'none';
                }
            });

            // Hide category if no tags match
            if (!hasVisibleTagsInCategory && searchTerm !== '') {
                categorySection.style.display = 'none';
            }
        });
    }

    // Function to handle tag selection/deselection
    function toggleTagSelection(id, name, color) {
        if (selectedTagIds.has(id)) {
            selectedTagIds.delete(id);
        } else {
            selectedTagIds.add(id);
        }

        updateSelectedTagsDisplay();
        updateTagItemsState();
        updateHiddenInput();

        // Clear search input after selection
        if (hybridInput) {
            hybridInput.value = '';
            filterTags(''); // Show all tags again
        }
    }

    // Function to update visual state of tag items
    function updateTagItemsState() {
        tagItems.forEach(item => {
            const tagId = item.dataset.tagId;
            if (selectedTagIds.has(tagId)) {
                item.style.opacity = '0.5';
                item.style.transform = 'scale(0.95)';
                item.classList.add('selected');
            } else {
                item.style.opacity = '1';
                item.style.transform = 'scale(1)';
                item.classList.remove('selected');
            }
        });
    }

    // Add event listeners for hybrid input functionality
    if (hybridInput) {
        // Search functionality as user types
        hybridInput.addEventListener('input', function() {
            const searchTerm = this.value;
            filterTags(searchTerm);
        });

        // Show dropdown when input is focused and has content
        hybridInput.addEventListener('focus', function() {
            if (!dropdownToggle.getAttribute('aria-expanded') || dropdownToggle.getAttribute('aria-expanded') === 'false') {
                dropdownToggle.click(); // Open dropdown
            }
        });
    }

    // Add click listeners to tag items
    tagItems.forEach(item => {
        item.addEventListener('click', function() {
            const { tagId, tagName, tagColor } = this.dataset;
            toggleTagSelection(tagId, tagName, tagColor);
        });

        // Add hover effects
        item.addEventListener('mouseenter', function() {
            if (!selectedTagIds.has(this.dataset.tagId)) {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
            }
        });

        item.addEventListener('mouseleave', function() {
            if (!selectedTagIds.has(this.dataset.tagId)) {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            }
        });
    });

    // Rating Dots Implementation (matching view_trades_list.html pattern)
    function initializeRatingDots() {
        document.querySelectorAll('.rating-dots-container').forEach(function(ratingGroup) {
            const fieldName = ratingGroup.getAttribute('data-rating');
            const hiddenSelect = document.querySelector(`[name="${fieldName}"]`);
            const dots = ratingGroup.querySelectorAll('.rating-dot-clickable');

            // Set initial state based on form value
            if (hiddenSelect && hiddenSelect.value) {
                const currentValue = parseInt(hiddenSelect.value);
                updateDotsVisual(dots, currentValue);
            }

            dots.forEach(function(dot) {
                dot.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));

                    // Update visual state
                    updateDotsVisual(dots, value);

                    // Update hidden select
                    if (hiddenSelect) {
                        hiddenSelect.value = value;
                        hiddenSelect.dispatchEvent(new Event('change'));
                    }

                    // Update overall score
                    updateOverallScore();

                });
            });
        });

        function updateDotsVisual(dots, rating) {
            dots.forEach(function(dot, index) {
                const dotValue = index + 1;
                if (dotValue <= rating) {
                    // Set color based on rating level
                    if (rating >= 4) {
                        dot.style.backgroundColor = 'var(--enterprise-success)';
                        dot.style.borderColor = 'var(--enterprise-success)';
                    } else if (rating >= 3) {
                        dot.style.backgroundColor = 'var(--enterprise-warning)';
                        dot.style.borderColor = 'var(--enterprise-warning)';
                    } else {
                        dot.style.backgroundColor = 'var(--enterprise-danger)';
                        dot.style.borderColor = 'var(--enterprise-danger)';
                    }
                } else {
                    dot.style.backgroundColor = 'var(--enterprise-gray-100)';
                    dot.style.borderColor = 'var(--enterprise-gray-300)';
                }
            });
        }

        function updateOverallScore() {
            const ratingSelectors = document.querySelectorAll('.rating-selector');
            const ratingValues = [];

            ratingSelectors.forEach(selector => {
                const value = parseInt(selector.value) || 0;
                if (value > 0) {
                    ratingValues.push(value);
                }
            });

            const overallBadge = document.getElementById('overall-score-badge');
            if (overallBadge && ratingValues.length > 0) {
                const avgRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
                overallBadge.textContent = `${avgRating.toFixed(1)}/5.0`;

                // Update badge color
                overallBadge.className = 'badge fs-6';
                if (avgRating >= 4) {
                    overallBadge.classList.add('bg-success');
                } else if (avgRating >= 2.5) {
                    overallBadge.classList.add('bg-warning');
                } else {
                    overallBadge.classList.add('bg-danger');
                }
            }
        }
    }

    // Updated JavaScript functions for unified table layout

    // Dynamic Entry/Exit Management
    let entryCount = {{ form.entries|length }};
    let exitCount = {{ form.exits|length }};

    function updateCounts() {
        const entryCountEl = document.getElementById('entry-count');
        const exitCountEl = document.getElementById('exit-count');
        
        if (entryCountEl) {
            entryCountEl.textContent = entryCount;
        }
        if (exitCountEl) {
            exitCountEl.textContent = exitCount;
        }

        // Validate exit count vs entry contracts
        validateExitContracts();
    }

    function validateExitContracts() {
        const entryRows = document.querySelectorAll('#unified-points-container tr[data-type="entry"]');
        const exitRows = document.querySelectorAll('#unified-points-container tr[data-type="exit"]');

        let totalEntryContracts = 0;
        let totalExitContracts = 0;

        entryRows.forEach(row => {
            const contractsInput = row.querySelector('input[name*="contracts"]');
            if (contractsInput && contractsInput.value) {
                totalEntryContracts += parseInt(contractsInput.value) || 0;
            }
        });

        exitRows.forEach(row => {
            const contractsInput = row.querySelector('input[name*="contracts"]');
            if (contractsInput && contractsInput.value) {
                totalExitContracts += parseInt(contractsInput.value) || 0;
            }
        });

        const warningElement = document.getElementById('exit-validation-warning');
        const addExitButton = document.getElementById('add-exit-button');

        if (totalExitContracts > totalEntryContracts) {
            warningElement.style.display = 'block';
            addExitButton.disabled = true;
        } else {
            warningElement.style.display = 'none';
            addExitButton.disabled = false;
        }

        calculateStats();
    }

    // Add Entry Point
    document.getElementById('add-entry-button').addEventListener('click', function() {
        const container = document.getElementById('unified-points-container');
        const newRow = document.createElement('tr');
        newRow.className = 'entry-exit-item entry-point';
        newRow.setAttribute('data-type', 'entry');

        newRow.innerHTML = `
            <td>
                <span class="badge bg-success">ENTRY</span>
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="entries-${entryCount}-entry_time" type="time" placeholder="HH:MM">
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="entries-${entryCount}-contracts" type="number" min="1" placeholder="Contracts">
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="entries-${entryCount}-entry_price" type="number" step="any" placeholder="Price">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;

        container.appendChild(newRow);
        entryCount++;
        updateCounts();

        // Add event listeners to new row
        addRowEventListeners(newRow);
        // Register new inputs with enterprise unsaved changes system
        registerNewInputsWithEnterprise();
    });

    // Add Exit Point
    document.getElementById('add-exit-button').addEventListener('click', function() {
        const container = document.getElementById('unified-points-container');
        const newRow = document.createElement('tr');
        newRow.className = 'entry-exit-item exit-point';
        newRow.setAttribute('data-type', 'exit');

        newRow.innerHTML = `
            <td>
                <span class="badge bg-danger">EXIT</span>
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="exits-${exitCount}-exit_time" type="time" placeholder="HH:MM">
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="exits-${exitCount}-contracts" type="number" min="1" placeholder="Contracts">
            </td>
            <td>
                <input class="form-control form-control-sm text-center" name="exits-${exitCount}-exit_price" type="number" step="any" placeholder="Price">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;

        container.appendChild(newRow);
        exitCount++;
        updateCounts();

        // Add event listeners to new row
        addRowEventListeners(newRow);
        // Register new inputs with enterprise unsaved changes system
        registerNewInputsWithEnterprise();
    });

    // Remove Entry/Exit handlers
    function addRowEventListeners(row) {
        const removeEntryBtn = row.querySelector('.remove-entry-btn');
        const removeExitBtn = row.querySelector('.remove-exit-btn');
        const inputs = row.querySelectorAll('input');

        if (removeEntryBtn) {
            removeEntryBtn.addEventListener('click', function() {
                showCustomConfirmation({
                    title: 'Remove Entry Point',
                    message: 'Are you sure you want to remove this entry point?',
                    confirmText: 'Remove',
                    confirmClass: 'btn-warning',
                    icon: 'question-circle',
                    onConfirm: function() {
                        row.remove();
                        entryCount--;
                        updateCounts();
                        // Trigger unsaved changes detection for removed entry
                        if (window.enterpriseUnsavedChanges) {
                            window.enterpriseUnsavedChanges.checkForChanges();
                        }
                    }
                });
            });
        }

        if (removeExitBtn) {
            removeExitBtn.addEventListener('click', function() {
                showCustomConfirmation({
                    title: 'Remove Exit Point',
                    message: 'Are you sure you want to remove this exit point?',
                    confirmText: 'Remove',
                    confirmClass: 'btn-warning',
                    icon: 'question-circle',
                    onConfirm: function() {
                        row.remove();
                        exitCount--;
                        updateCounts();
                        // Trigger unsaved changes detection for removed exit
                        if (window.enterpriseUnsavedChanges) {
                            window.enterpriseUnsavedChanges.checkForChanges();
                        }
                    }
                });
            });
        }

        // Add change listeners to inputs for validation
        inputs.forEach(input => {
            input.addEventListener('input', validateExitContracts);
            input.addEventListener('change', validateExitContracts);
        });
    }

    // Add event listeners to existing rows
    document.querySelectorAll('#unified-points-container tr.entry-exit-item').forEach(addRowEventListeners);

    // Initialize Quill editors
    const quillToolbarOptions = [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'clean']
    ];

    function initializeQuill(editorDivId, hiddenTextareaId, placeholderText, fieldType = 'quill') {
        const editorDiv = document.getElementById(editorDivId);
        const hiddenTextarea = document.getElementById(hiddenTextareaId);

        if (editorDiv && hiddenTextarea) {
            quillInstances[hiddenTextareaId] = new Quill(editorDiv, {
                theme: 'snow',
                modules: { toolbar: quillToolbarOptions },
                placeholder: placeholderText || 'Enter strategic analysis...'
            });

            const existingContent = hiddenTextarea.value;
            if (existingContent) {
                try {
                    quillInstances[hiddenTextareaId].clipboard.dangerouslyPasteHTML(existingContent);
                } catch (e) {
                    quillInstances[hiddenTextareaId].setText(existingContent);
                }
            }

            // Add change listener to trigger enterprise unsaved changes
            quillInstances[hiddenTextareaId].on('text-change', function(delta, oldDelta, source) {
                // Update the hidden textarea
                hiddenTextarea.value = quillInstances[hiddenTextareaId].root.innerHTML;
                
                // Trigger enterprise unsaved changes check  
                if (source === 'user' && window.triggerEnterpriseUnsavedChanges) {
                    window.triggerEnterpriseUnsavedChanges(fieldType);
                }
            });
        }
    }

    initializeQuill('trade_notes_editor', '{{ form.trade_notes.id }}', 'Enter your pre-execution analysis, strategic setup, reasoning, chart analysis...', 'quill-pre');
    initializeQuill('overall_analysis_notes_editor', '{{ form.overall_analysis_notes.id }}', 'Enter your post-execution analysis, outcomes, lessons learned...', 'quill-post');

    // Initialize Radar Chart (matching view_trades_list.html pattern exactly)
    const ratingSelectors = document.querySelectorAll('.rating-selector');
    const psychRadarCanvas = document.getElementById('psychRadarChart');

    function getCurrentRatings() {
        return {
            'preparation': parseInt(document.querySelector('[name="preparation_rating"]')?.value) || 0,
            'rules_adherence': parseInt(document.querySelector('[name="rules_rating"]')?.value) || 0,
            'risk_management': parseInt(document.querySelector('[name="management_rating"]')?.value) || 0,
            'target_placement': parseInt(document.querySelector('[name="target_rating"]')?.value) || 0,
            'entry_execution': parseInt(document.querySelector('[name="entry_rating"]')?.value) || 0
        };
    }

    function renderRadarChart(canvas, ratings) {
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 25;

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const categories = Object.keys(ratings);
        const values = Object.values(ratings);
        const maxValue = 5;

        if (categories.length === 0) {
            renderEmptyRadarChart(canvas);
            return;
        }

        // Chart colors - matching the trades list exactly
        const gridColor = '#444';
        const axisColor = '#666';
        const dataColor = '#0d6efd';
        const fillColor = 'rgba(13, 110, 253, 0.2)';

        // Draw grid circles
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;

        for (let i = 1; i <= maxValue; i++) {
            const gridRadius = (radius * i) / maxValue;
            ctx.beginPath();
            ctx.arc(centerX, centerY, gridRadius, 0, 2 * Math.PI);
            ctx.stroke();
        }

        // Draw grid lines and labels
        const angleStep = (2 * Math.PI) / categories.length;
        const labels = {
            'preparation': 'Prep',
            'rules_adherence': 'Rules',
            'risk_management': 'Risk',
            'target_placement': 'Target',
            'entry_execution': 'Entry'
        };

        categories.forEach((category, index) => {
            const angle = index * angleStep - Math.PI / 2;
            const x = centerX + Math.cos(angle) * radius;
            const y = centerY + Math.sin(angle) * radius;

            // Grid line
            ctx.strokeStyle = axisColor;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();

            // Label
            ctx.fillStyle = '#aaa';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const labelX = centerX + Math.cos(angle) * (radius + 15);
            const labelY = centerY + Math.sin(angle) * (radius + 15);
            const labelText = labels[category] || category.substring(0, 5);

            ctx.fillText(labelText, labelX, labelY);
        });

        // Draw data polygon
        if (values.length > 0) {
            const points = values.map((value, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const distance = (radius * value) / maxValue;
                return {
                    x: centerX + Math.cos(angle) * distance,
                    y: centerY + Math.sin(angle) * distance
                };
            });

            // Fill area
            ctx.fillStyle = fillColor;
            ctx.beginPath();
            points.forEach((point, i) => {
                if (i === 0) ctx.moveTo(point.x, point.y);
                else ctx.lineTo(point.x, point.y);
            });
            ctx.closePath();
            ctx.fill();

            // Draw outline
            ctx.strokeStyle = dataColor;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw data points
            ctx.fillStyle = dataColor;
            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
        }

        // Add center point
        ctx.fillStyle = '#666';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 2, 0, 2 * Math.PI);
        ctx.fill();
    }

    function renderEmptyRadarChart(canvas) {
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw "No Ratings" message
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No Ratings', centerX, centerY);
    }

    function updateRadarChart() {
        if (!psychRadarCanvas) return;

        const ratings = getCurrentRatings();
        const hasRatings = Object.values(ratings).some(value => value > 0);

        if (hasRatings) {
            renderRadarChart(psychRadarCanvas, ratings);
        } else {
            renderEmptyRadarChart(psychRadarCanvas);
        }

        calculateStats();
    }

    // Add change listeners to rating selectors
    ratingSelectors.forEach(selector => {
        selector.addEventListener('change', updateRadarChart);
    });

    // Initial update
    if (psychRadarCanvas) {
        updateRadarChart();
    }

    // Stats calculation
    // Updated stats calculation for unified table
    function calculateStats() {
        if (typeof instrumentPointValues === 'undefined') {
            return;
        }

        const dashboard = document.getElementById('trade-stats-dashboard');
        const instrumentSelect = document.querySelector('[name="instrument"]');
        const direction = document.querySelector('[name="direction"]')?.value;
        const stopLoss = parseFloat(document.querySelector('[name="initial_stop_loss"]')?.value || '0');
        const target = parseFloat(document.querySelector('[name="terminus_target"]')?.value || '0');

        // Get point value
        let pointValue = 1.0;
        if (instrumentSelect?.value) {
            const selectedOption = instrumentSelect.querySelector(`option[value="${instrumentSelect.value}"]`);
            if (selectedOption) {
                const symbolMatch = selectedOption.textContent.match(/^([A-Z]+)/);
                if (symbolMatch) {
                    const symbol = symbolMatch[1];
                    pointValue = instrumentPointValues[symbol] || 1.0;
                }
            }
        }

        // Calculate entry/exit data from unified table
        const entryRows = document.querySelectorAll('#unified-points-container tr[data-type="entry"]');
        const exitRows = document.querySelectorAll('#unified-points-container tr[data-type="exit"]');

        let totalEntryContracts = 0, weightedEntryPrice = 0, firstEntryTime = '';
        let totalExitContracts = 0, weightedExitPrice = 0, lastExitTime = '';

        entryRows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const timeInput = inputs[0]; // time input
            const contractsInput = inputs[1]; // contracts input
            const priceInput = inputs[2]; // price input

            const time = timeInput?.value || '';
            const contracts = parseInt(contractsInput?.value || '0');
            const price = parseFloat(priceInput?.value || '0');

            if (price > 0 && contracts > 0) {
                weightedEntryPrice += price * contracts;
                totalEntryContracts += contracts;
                if (!firstEntryTime) firstEntryTime = time;
            }
        });

        exitRows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const timeInput = inputs[0]; // time input
            const contractsInput = inputs[1]; // contracts input
            const priceInput = inputs[2]; // price input

            const time = timeInput?.value || '';
            const contracts = parseInt(contractsInput?.value || '0');
            const price = parseFloat(priceInput?.value || '0');

            if (price > 0 && contracts > 0) {
                weightedExitPrice += price * contracts;
                totalExitContracts += contracts;
                lastExitTime = time;
            }
        });

        const avgEntryPrice = totalEntryContracts > 0 ? weightedEntryPrice / totalEntryContracts : 0;
        const avgExitPrice = totalExitContracts > 0 ? weightedExitPrice / totalExitContracts : 0;

        // Show dashboard when we have data
        if (avgEntryPrice > 0 || avgExitPrice > 0 || stopLoss > 0 || target > 0) {
            dashboard.style.display = 'block';
        } else {
            dashboard.style.display = 'none';
        }

        // Calculate Risk:Reward
        let riskRewardText = '--:--';
        if (avgEntryPrice > 0 && stopLoss > 0 && target > 0) {
            let risk, reward;
            if (direction === 'Long') {
                risk = Math.abs(avgEntryPrice - stopLoss);
                reward = Math.abs(target - avgEntryPrice);
            } else if (direction === 'Short') {
                risk = Math.abs(stopLoss - avgEntryPrice);
                reward = Math.abs(avgEntryPrice - target);
            }

            if (risk > 0) {
                riskRewardText = `1:${(reward / risk).toFixed(2)}`;
            }
        }

        // Calculate time in trade
        let timeInTradeText = '--h --m';
        if (firstEntryTime && lastExitTime) {
            const [entryHour, entryMin] = firstEntryTime.split(':').map(Number);
            const [exitHour, exitMin] = lastExitTime.split(':').map(Number);
            const entryMinutes = entryHour * 60 + entryMin;
            const exitMinutes = exitHour * 60 + exitMin;
            let diffMinutes = exitMinutes - entryMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            timeInTradeText = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
        }

        // Calculate points risked and dollar risk
        let pointsRiskedText = '--';
        let dollarRiskText = '$--';
        if (avgEntryPrice > 0 && stopLoss > 0 && totalEntryContracts > 0) {
            let pointsRisk;
            if (direction === 'Long') {
                pointsRisk = Math.abs(avgEntryPrice - stopLoss);
            } else if (direction === 'Short') {
                pointsRisk = Math.abs(stopLoss - avgEntryPrice);
            }

            if (pointsRisk > 0) {
                pointsRiskedText = pointsRisk.toFixed(2);
                const dollarRisk = pointsRisk * totalEntryContracts * pointValue;
                dollarRiskText = `$${dollarRisk.toFixed(2)}`;
            }
        }

        // Calculate Gross P&L
        let grossPnlText = '$--';
        let pnlClass = '';
        if (avgEntryPrice > 0 && avgExitPrice > 0 && totalExitContracts > 0) {
            let pnlPerContract;
            if (direction === 'Long') {
                pnlPerContract = avgExitPrice - avgEntryPrice;
            } else if (direction === 'Short') {
                pnlPerContract = avgEntryPrice - avgExitPrice;
            }

            const grossPnl = pnlPerContract * totalExitContracts * pointValue;
            grossPnlText = `$${grossPnl.toFixed(2)}`;

            if (grossPnl > 0) {
                pnlClass = 'text-success';
            } else if (grossPnl < 0) {
                pnlClass = 'text-danger';
            }
        }

        // Calculate efficiency
        let efficiencyText = '--%';
        const mfePrice = parseFloat(document.querySelector('[name="mfe_price"]')?.value);
        if (avgEntryPrice > 0 && avgExitPrice > 0 && mfePrice > 0) {
            let mfePoints, actualPoints;
            if (direction === 'Long') {
                mfePoints = mfePrice - avgEntryPrice;
                actualPoints = avgExitPrice - avgEntryPrice;
            } else if (direction === 'Short') {
                mfePoints = avgEntryPrice - mfePrice;
                actualPoints = avgEntryPrice - avgExitPrice;
            }
            if (mfePoints > 0) {
                const efficiency = (actualPoints / mfePoints) * 100;
                efficiencyText = `${Math.max(0, efficiency).toFixed(1)}%`;
            }
        }

        // Calculate overall rating
        let overallRatingText = '--/5';
        const ratings = ['preparation_rating', 'rules_rating', 'management_rating', 'target_rating', 'entry_rating'];
        const ratingValues = ratings.map(name => {
            const value = parseInt(document.querySelector(`[name="${name}"]`)?.value || '0');
            return value > 0 ? value : null;
        }).filter(v => v !== null);

        if (ratingValues.length > 0) {
            const avgRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
            overallRatingText = `${avgRating.toFixed(1)}`;
        }

        // Update display
        document.getElementById('risk-reward-display').textContent = riskRewardText;
        document.getElementById('time-in-trade-display').textContent = timeInTradeText;
        document.getElementById('points-risked-display').textContent = pointsRiskedText;
        document.getElementById('dollar-risk-display').textContent = dollarRiskText;
        document.getElementById('overall-rating-display').textContent = overallRatingText;
        
        // Update efficiency with color coding
        const efficiencyElement = document.getElementById('efficiency-display');
        efficiencyElement.textContent = efficiencyText;
        
        // Apply color coding based on efficiency value
        efficiencyElement.className = 'kpi-value';
        if (efficiencyText !== '--%') {
            const efficiencyValue = parseFloat(efficiencyText.replace('%', ''));
            if (efficiencyValue >= 70) {
                efficiencyElement.classList.add('text-success');
            } else if (efficiencyValue >= 40) {
                efficiencyElement.classList.add('text-warning');
            } else {
                efficiencyElement.classList.add('text-danger');
            }
        }

        const pnlElement = document.getElementById('gross-pnl-display');
        pnlElement.textContent = grossPnlText;
        pnlElement.className = `kpi-value ${pnlClass}`;
    }

    // Add calculation listeners
    function addCalculationListeners() {
        const fieldsToWatch = [
            '[name="instrument"]', '[name="direction"]', '[name="initial_stop_loss"]', '[name="terminus_target"]',
            '[name^="entries-"]', '[name^="exits-"]', '[name$="_rating"]'
        ];

        fieldsToWatch.forEach(selector => {
            document.querySelectorAll(selector).forEach(field => {
                field.removeEventListener('input', calculateStats);
                field.removeEventListener('change', calculateStats);
                field.addEventListener('input', calculateStats);
                field.addEventListener('change', calculateStats);
            });
        });
    }

    // Form submission
    const tradeForm = document.getElementById('tradeForm');
    if (tradeForm) {
        tradeForm.addEventListener('submit', function(e) {
            isSubmitting = true;

            // Update Quill content
            for (const textareaId in quillInstances) {
                if (quillInstances.hasOwnProperty(textareaId) && document.getElementById(textareaId)) {
                    document.getElementById(textareaId).value = quillInstances[textareaId].root.innerHTML;
                }
            }
        });
    }

    // Initialize tags modal functionality
    function initializeTagsModal() {

        const openModalBtn = document.getElementById('open-tags-modal');
        const modalElement = document.getElementById('tagsModal');
        const applyBtn = document.getElementById('apply-tags-selection');
        const selectedTagsContainer = document.getElementById('selected-tags-display-add-trade');
        const hiddenTagsContainer = document.getElementById('tags-hidden-input-add-trade');
        const noTagsMessage = document.getElementById('no-tags-message-add-trade');

        if (!openModalBtn) {
            return;
        }

        if (!modalElement) {
            return;
        }

        // Ensure Bootstrap is loaded before creating modal
        if (typeof bootstrap === 'undefined') {
            return;
        }

        let tagsModal;
        try {
            tagsModal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Add event listeners to disable/enable main form buttons
            modalElement.addEventListener('show.bs.modal', function() {
                disableMainFormButtons();
            });
            
            modalElement.addEventListener('hide.bs.modal', function() {
                enableMainFormButtons();
            });
            
        } catch (error) {
            console.error('Error creating modal:', error);
            return;
        }

        // Global selectedTags set to persist across modal opens/closes
        if (!window.selectedTagsSet) {
            window.selectedTagsSet = new Set();
        }

        // Open modal and restore previous selections
        openModalBtn.addEventListener('click', function(e) {
            e.preventDefault();

            try {
                // Wait a bit for the modal to fully render, then restore selections
                setTimeout(() => {
                    restoreTagSelections();
                }, 100);

                tagsModal.show();
            } catch (error) {
                // Fallback: Try direct Bootstrap method
                try {
                    modalElement.classList.add('show');
                    modalElement.style.display = 'block';
                    modalElement.setAttribute('aria-modal', 'true');
                    modalElement.removeAttribute('aria-hidden');
                    document.body.classList.add('modal-open');
                } catch (fallbackError) {
                    // Fallback failed, modal won't open
                }
            }
        });

        // Initialize tag click handlers
        initializeTagClickHandlers();

        // Add Bootstrap modal event listeners
        modalElement.addEventListener('shown.bs.modal', function() {
            restoreTagSelections();
        });

        // Clean up when modal is hidden
        modalElement.addEventListener('hidden.bs.modal', function() {
            // Remove any lingering backdrop elements
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Ensure body classes are cleaned up
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        });

        // Apply selection - close modal and update main page
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                updateMainPageTagsDisplay();
                updateHiddenInput();
                
                // Trigger enterprise unsaved changes
                if (window.triggerEnterpriseUnsavedChanges) {
                    window.triggerEnterpriseUnsavedChanges('tags');
                }
                
                tagsModal.hide();
            });
        }

        // Update main page tags display
        function updateMainPageTagsDisplay() {
            // Re-query elements to ensure they exist (for global access)
            const currentSelectedTagsContainer = document.getElementById('selected-tags-display-add-trade');
            const currentNoTagsMessage = document.getElementById('no-tags-message-add-trade');

            if (!currentSelectedTagsContainer) {
                return;
            }

            currentSelectedTagsContainer.innerHTML = '';

            if (window.selectedTagsSet.size === 0) {
                if (currentNoTagsMessage) {
                    currentNoTagsMessage.style.display = 'block';
                }
                return;
            }

            if (currentNoTagsMessage) {
                currentNoTagsMessage.style.display = 'none';
            }

            window.selectedTagsSet.forEach(tagId => {
                const sourceTag = document.querySelector(`[data-tag-id="${tagId}"]`);

                if (sourceTag) {
                    const tagName = sourceTag.dataset.tagName;
                    const tagColor = sourceTag.dataset.tagColor || 'neutral';

                    const mainTag = document.createElement('div');
                    mainTag.className = `tag-item tag-${tagColor}`;
                    mainTag.innerHTML = `
                        <span class="tag-name">${tagName}</span>
                        <button type="button" class="tag-remove-btn" data-tag-id="${tagId}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    currentSelectedTagsContainer.appendChild(mainTag);
                }
            });
        }

        function updateHiddenInput() {
            // Get the form element
            const form = document.getElementById('tradeForm');
            if (!form) {
                return;
            }

            // Clear existing dynamic tag inputs (but preserve the main tags input)
            const existingInputs = form.querySelectorAll('input[name="tags"]:not(#tags-hidden-input-add-trade)');
            existingInputs.forEach(input => input.remove());

            // Create hidden inputs for each selected tag
            window.selectedTagsSet.forEach(tagId => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'tags';
                hiddenInput.value = tagId;
                hiddenInput.setAttribute('data-dynamic-tag', 'true');
                form.appendChild(hiddenInput);
            });

            // Trigger change event on the tags container to notify enterprise system
            const tagsContainer = document.getElementById('tags-hidden-input-add-trade');
            if (tagsContainer) {
                tagsContainer.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }

        // Make functions globally accessible
        window.updateMainPageTagsDisplay = updateMainPageTagsDisplay;
        window.updateHiddenInput = updateHiddenInput;

        // Initialize create tag functionality
        initializeCreateTagForm();
    }

    function initializeTagClickHandlers() {
        const selectableTags = document.querySelectorAll('.tag-selectable');

        // Remove existing handlers to prevent duplicates
        selectableTags.forEach(tagElement => {
            tagElement.replaceWith(tagElement.cloneNode(true));
        });

        // Re-query after replacement
        const freshTags = document.querySelectorAll('.tag-selectable');

        // Add fresh handlers
        freshTags.forEach((tagElement) => {
            const tagId = tagElement.dataset.tagId;
            const tagName = tagElement.dataset.tagName;

            tagElement.addEventListener('click', function() {
                if (window.selectedTagsSet.has(tagId)) {
                    window.selectedTagsSet.delete(tagId);
                    this.classList.remove('tag-selected');
                } else {
                    window.selectedTagsSet.add(tagId);
                    this.classList.add('tag-selected');
                }
                
                // Trigger enterprise unsaved changes
                if (window.triggerEnterpriseUnsavedChanges) {
                    window.triggerEnterpriseUnsavedChanges('tags');
                }
            });

            tagElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    }

    function restoreTagSelections() {

        // Remove all previous visual selections first
        document.querySelectorAll('.tag-selected').forEach(tag => {
            tag.classList.remove('tag-selected');
        });

        // Restore the selected state for previously selected tags
        window.selectedTagsSet.forEach(tagId => {
            // Look for the actual tag element, not the button inside it
            const tagElement = document.querySelector(`.tag-selectable[data-tag-id="${tagId}"]`);
            if (tagElement) {
                tagElement.classList.add('tag-selected');
            } else {
                // Fallback: try any element with the data-tag-id that's not a button
                const fallbackElement = document.querySelector(`[data-tag-id="${tagId}"]:not(button)`);
                if (fallbackElement) {
                    fallbackElement.classList.add('tag-selected');
                }
            }
        });
        
    }


    // Create new tag functionality
    function initializeCreateTagForm() {
        const toggleBtn = document.getElementById('toggle-create-tag');
        const createForm = document.getElementById('create-tag-form');
        const submitBtn = document.getElementById('create-tag-submit');
        const cancelBtn = document.getElementById('create-tag-cancel');
        const nameInput = document.getElementById('new-tag-name');
        const categorySelect = document.getElementById('new-tag-category');
        const colorSelect = document.getElementById('new-tag-color');

        if (!toggleBtn) return;

        // FORCE initial hidden state
        if (createForm) {
            createForm.style.setProperty('display', 'none', 'important');
        }

        // Toggle form visibility
        toggleBtn.addEventListener('click', function() {
            const isCurrentlyHidden = createForm.style.display === 'none' ||
                                     createForm.style.display === 'none !important' ||
                                     !createForm.style.display ||
                                     createForm.style.getPropertyValue('display') === 'none';

            if (isCurrentlyHidden) {
                createForm.style.setProperty('display', 'flex', 'important');
                nameInput.focus();
                toggleBtn.innerHTML = '<i class="fas fa-minus me-1"></i>Cancel';
            } else {
                hideCreateForm();
            }
        });

        // Cancel form
        if (cancelBtn) {
            cancelBtn.addEventListener('click', hideCreateForm);
        }

        // Submit new tag
        if (submitBtn) {
            submitBtn.addEventListener('click', function() {
                const name = nameInput.value.trim();
                const category = categorySelect.value;
                const color = colorSelect.value;

                if (!name) {
                    showError('Please enter a tag name');
                    nameInput.focus();
                    return;
                }

                if (!category) {
                    showError('Please select a category');
                    categorySelect.focus();
                    return;
                }

                if (!color) {
                    showError('Please select a performance impact');
                    colorSelect.focus();
                    return;
                }

                // Disable form during submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                // Create tag via API
                createPersonalTag(name, category, color)
                    .then(response => {
                        if (response.success) {
                            showSuccess(`Tag "${name}" created successfully`);
                            
                            // Auto-select the newly created tag
                            if (response.tag_id && window.selectedTagsSet) {
                                window.selectedTagsSet.add(response.tag_id.toString());
                            }
                            
                            // IMPORTANT: Hide form before refresh
                            hideCreateForm();
                            // Small delay to ensure form is hidden
                            setTimeout(() => {
                                refreshTagsModal();
                            }, 100);
                        } else {
                            showError(response.message || 'Failed to create tag');
                        }
                    })
                    .catch(error => {
                        showError('Error creating tag. Please try again.');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save';
                    });
            });
        }

        // Enter key submission
        if (nameInput) {
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitBtn.click();
                }
            });
        }

        function hideCreateForm() {
            createForm.style.setProperty('display', 'none', 'important');
            nameInput.value = '';
            categorySelect.selectedIndex = 0;
            colorSelect.selectedIndex = 0;
            toggleBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add New Tag';
        }
    }

    // API call to create personal tag
    async function createPersonalTag(name, category, colorCategory) {
        try {
            const response = await fetch('/settings/tags/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    name: name,
                    category: category,
                    color_category: colorCategory,
                    is_active: true
                })
            });

            return await response.json();
        } catch (error) {
            throw error;
        }
    }

    // Add newly created tag to the modal
    function refreshTagsModal() {

        // Fetch updated modal content from server
        fetch('{{ url_for("trades.get_tags_modal_content") }}', {
            method: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Only update the tag categories section, preserve add tag functionality
            const tagsContainer = document.querySelector('#tagsModal .modal-body');
            if (tagsContainer) {
                // Store the current scroll position
                const scrollTop = tagsContainer.scrollTop;

                // Save the add tag button HTML with correct text - ALWAYS reset to hidden state
                const addTagButtonHTML = `
                    <div class="text-right mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="toggle-create-tag-dynamic">
                            <i class="fas fa-plus me-1"></i>Add New Tag
                        </button>
                    </div>
                `;

                // FORCE the form HTML to be in hidden state
                const createTagFormHTML = `
                    <div id="create-tag-form" class="d-flex justify-content-center mb-4" style="display: none !important;">
                        <div class="enterprise-module" style="max-width: 1000px; width: 100%;">
                            <div class="module-header text-center">
                                <div class="module-title">
                                    <i class="fas fa-plus-circle module-icon"></i>
                                    Create New Personal Tag
                                </div>
                                <div class="module-meta">
                                    Add a custom tag for your trading analysis
                                </div>
                            </div>
                            <div class="module-content">
                                <div class="grid grid-cols-10 gap-3 align-items-end">
                                    <div class="col-span-3">
                                        <label for="new-tag-name" class="form-label fw-semibold">Tag Name</label>
                                        <input type="text" class="form-control" id="new-tag-name" placeholder="Enter descriptive tag name..." maxlength="50">
                                    </div>
                                    <div class="col-span-3">
                                        <label for="new-tag-category" class="form-label fw-semibold">Category</label>
                                        <select class="form-select" id="new-tag-category">
                                            <option value="">-- Select Category --</option>
                                            <option value="SETUP_STRATEGY">Setup & Strategy</option>
                                            <option value="MARKET_CONDITIONS">Market Conditions</option>
                                            <option value="EXECUTION_MANAGEMENT">Execution & Management</option>
                                            <option value="PSYCHOLOGICAL_EMOTIONAL">Psychological & Emotional Factors</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label for="new-tag-color" class="form-label fw-semibold">Impact</label>
                                        <select class="form-select" id="new-tag-color">
                                            <option value="">-- Select Impact --</option>
                                            <option value="neutral">Neutral</option>
                                            <option value="good">Positive</option>
                                            <option value="bad">Negative</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-success" id="create-tag-submit">
                                                <i class="fas fa-save me-1"></i>Save
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="create-tag-cancel">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Create temporary container to parse new HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Extract only the tag-category-section elements from the new HTML
                const newTagSections = tempDiv.querySelectorAll('.tag-category-section');
                let newTagSectionsHTML = '';
                newTagSections.forEach(section => {
                    newTagSectionsHTML += section.outerHTML;
                });

                // Reconstruct the modal body with preserved add tag functionality and new categories
                tagsContainer.innerHTML = addTagButtonHTML + createTagFormHTML + newTagSectionsHTML;

                // Restore scroll position
                tagsContainer.scrollTop = scrollTop;

                // Reinitialize tag selection event handlers
                reinitializeTagSelection();

            }
        })
        .catch(error => {
            showError('Failed to refresh tag list. Please close and reopen the modal.');
        });
    }

    function reinitializeTagSelection() {

        // Reinitialize tag click handlers
        initializeTagClickHandlers();

        // Restore previously selected tags visual state
        restoreTagSelections();

        // Reinitialize create tag form functionality
        reinitializeCreateTagForm();
        
        // Trigger enterprise unsaved changes in case new tags were added
        if (window.triggerEnterpriseUnsavedChanges) {
            window.triggerEnterpriseUnsavedChanges('tags');
        }

    }

    function reinitializeCreateTagForm() {
        const toggleBtn = document.getElementById('toggle-create-tag-dynamic');
        const createForm = document.getElementById('create-tag-form');
        const submitBtn = document.getElementById('create-tag-submit');
        const cancelBtn = document.getElementById('create-tag-cancel');
        const nameInput = document.getElementById('new-tag-name');
        const categorySelect = document.getElementById('new-tag-category');
        const colorSelect = document.getElementById('new-tag-color');


        if (!toggleBtn || !createForm || !submitBtn || !cancelBtn) {
            console.log('Missing elements for reinitializeCreateTagForm');
            return;
        }

        // FORCE form to hidden state immediately
        createForm.style.setProperty('display', 'none', 'important');
        toggleBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add New Tag';

        // Clear all form fields
        if (nameInput) nameInput.value = '';
        if (categorySelect) categorySelect.selectedIndex = 0;
        if (colorSelect) colorSelect.selectedIndex = 0;

        // Remove existing event listeners by cloning and replacing elements
        const newToggleBtn = toggleBtn.cloneNode(true);
        toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
        
        const newSubmitBtn = submitBtn.cloneNode(true);
        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        // Update references to the new elements
        const updatedToggleBtn = document.getElementById('toggle-create-tag-dynamic');
        const updatedSubmitBtn = document.getElementById('create-tag-submit');
        const updatedCancelBtn = document.getElementById('create-tag-cancel');

        // Local hideCreateForm function for this reinitialize scope
        function hideCreateForm() {
            createForm.style.setProperty('display', 'none', 'important');
            if (nameInput) nameInput.value = '';
            if (categorySelect) categorySelect.selectedIndex = 0;
            if (colorSelect) colorSelect.selectedIndex = 0;
            updatedToggleBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add New Tag';
        }

        // Toggle form visibility
        updatedToggleBtn.addEventListener('click', function() {
            const isCurrentlyHidden = createForm.style.display === 'none' ||
                                     createForm.style.display === 'none !important' ||
                                     !createForm.style.display ||
                                     createForm.style.getPropertyValue('display') === 'none';


            if (isCurrentlyHidden) {
                createForm.style.setProperty('display', 'flex', 'important');
                nameInput.focus();
                updatedToggleBtn.innerHTML = '<i class="fas fa-minus me-1"></i>Cancel';
            } else {
                hideCreateForm();
            }
        });

        // Cancel button
        updatedCancelBtn.addEventListener('click', hideCreateForm);

        // Submit button
        updatedSubmitBtn.addEventListener('click', function() {
            const name = nameInput.value.trim();
            const category = categorySelect.value;
            const color = colorSelect.value;

            if (!name) {
                showError('Please enter a tag name');
                nameInput.focus();
                return;
            }

            if (!category) {
                showError('Please select a category');
                categorySelect.focus();
                return;
            }

            if (!color) {
                showError('Please select a performance impact');
                colorSelect.focus();
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            // Create tag via API
            createPersonalTag(name, category, color)
                .then(response => {
                    if (response.success) {
                        showSuccess(`Tag "${name}" created successfully`);
                        
                        // Auto-select the newly created tag
                        if (response.tag_id && window.selectedTagsSet) {
                            window.selectedTagsSet.add(response.tag_id.toString());
                        }
                        
                        // IMPORTANT: Hide form immediately before refresh
                        hideCreateForm();
                        // Small delay to ensure form is hidden before refresh
                        setTimeout(() => {
                            refreshTagsModal();
                        }, 100);
                    } else {
                        showError(response.message || 'Failed to create tag');
                    }
                })
                .catch(error => {
                    showError('Error creating tag. Please try again.');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save';
                });
        });

        // Enter key submission
        if (nameInput) {
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitBtn.click();
                }
            });
        }

        function hideCreateForm() {
            createForm.style.setProperty('display', 'none', 'important');
            nameInput.value = '';
            categorySelect.selectedIndex = 0;
            colorSelect.selectedIndex = 0;
            toggleBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Add New Tag';
        }

    }

    // Utility functions
    function showSuccess(message) {
        if (typeof showInfo === 'function') {
            showInfo(message, 'Success');
        } else {
            console.log('Success:', message);
        }
    }

    function showError(message) {
        if (typeof showWarning === 'function') {
            showWarning(message, 'Error');
        } else {
            console.error('Error:', message);
        }
    }

    // Initialize everything
    try {
        initializeRatingDots();
        addCalculationListeners();
        calculateStats();
        updateCounts();
        initializeTagsModal();
        setupImagePreviews();
    } catch (e) {
        console.error('Initialization error:', e);
    }


    // Global function to remove tags from the display
    window.removeTag = function(tagId) {
        
        // Remove from both sets
        selectedTagIds.delete(tagId.toString());
        if (window.selectedTagsSet) {
            window.selectedTagsSet.delete(tagId.toString());
        }
        
        // Remove the tag element from the display
        const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
        if (tagElement) {
            tagElement.remove();
        }
        
        // Update hidden inputs using the proper function
        if (window.updateHiddenInput) {
            window.updateHiddenInput();
        }
        
        // Trigger enterprise unsaved changes
        if (window.triggerEnterpriseUnsavedChanges) {
            window.triggerEnterpriseUnsavedChanges('tags');
        }
        
        // Show "No tags selected" message if no tags remain
        const tagsDisplay = document.getElementById('selected-tags-display-add-trade');
        const noTagsMessage = document.getElementById('no-tags-message-add-trade');
        if (tagsDisplay && selectedTagIds.size === 0) {
            if (noTagsMessage) {
                noTagsMessage.style.display = 'inline';
            } else {
                // Create and show "No tags selected" message
                const noTagsSpan = document.createElement('span');
                noTagsSpan.id = 'no-tags-message-add-trade';
                noTagsSpan.className = 'text-muted';
                noTagsSpan.textContent = 'No tags selected';
                tagsDisplay.appendChild(noTagsSpan);
            }
        }
        
        // Update displays if functions exist
        if (window.updateMainPageTagsDisplay) {
            window.updateMainPageTagsDisplay();
        }
        if (window.updateHiddenInput) {
            window.updateHiddenInput();
        }
    };

    // Debug: Confirm functions are defined

    {% if trade and trade.tags %}
    // Pre-populate selected tags for edit mode
    if (!window.selectedTagsSet) {
        window.selectedTagsSet = new Set();
    }
    if (!window.originalTagsSet) {
        window.originalTagsSet = new Set();
    }
    {% for tag in trade.tags %}
        selectedTagIds.add('{{ tag.id }}');
        window.selectedTagsSet.add('{{ tag.id }}');
        window.originalTagsSet.add('{{ tag.id }}');
    {% endfor %}
    {% else %}
    // Initialize empty sets for new trades
    if (!window.selectedTagsSet) {
        window.selectedTagsSet = new Set();
    }
    if (!window.originalTagsSet) {
        window.originalTagsSet = new Set();
    }
    {% endif %}

    // Update displays after initialization is complete
    setTimeout(() => {
        if (window.updateMainPageTagsDisplay) {
            window.updateMainPageTagsDisplay();
        }
        if (window.updateHiddenInput) {
            window.updateHiddenInput();
        }
    }, 100);


    // Add event listeners for tag removal buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.tag-remove-btn')) {
            const button = e.target.closest('.tag-remove-btn');
            const tagId = button.getAttribute('data-tag-id');
            
            if (tagId && window.removeTag) {
                window.removeTag(tagId);
            }
        }
    });

    // Ensure proper initialization
    setTimeout(() => {
        if (window.selectedTagsSet && window.selectedTagsSet.size > 0) {
            window.selectedTagsSet.forEach(tagId => {
                const tagElement = document.querySelector(`[data-tag-id="${tagId}"]`);
                if (tagElement) {
                    tagElement.classList.add('tag-selected');
                }
            });
        }
    }, 500);

});

// Cancel action handler
function handleCancelAction() {
    // Check if enterprise system has unsaved changes
    const hasChanges = window.enterpriseUnsavedChanges && window.enterpriseUnsavedChanges.hasUnsavedChanges;
    
    if (hasChanges) {
        showCustomConfirmation({
            title: 'Confirm Operational Change',
            message: '{% if trade %}Are you sure you want to cancel trade modifications? All changes will be lost.{% else %}Are you sure you want to cancel this strategic configuration? All entered data will be lost.{% endif %}',
            confirmText: '{% if trade %}Cancel Changes{% else %}Cancel Configuration{% endif %}',
            confirmClass: 'btn-warning',
            icon: 'exclamation-triangle',
            onConfirm: function() {
                // Reset enterprise form state to prevent browser popup
                if (window.enterpriseUnsavedChanges) {
                    window.enterpriseUnsavedChanges.markAsSubmitting();
                }
                {% if trade %}
                    window.location.href = '{{ url_for("trades.view_trade_detail", trade_id=trade.id) }}';
                {% else %}
                    window.location.href = '{{ url_for("trades.view_trades_list") }}';
                {% endif %}
            }
        });
    } else {
        // No changes, navigate directly
        {% if trade %}
            window.location.href = '{{ url_for("trades.view_trade_detail", trade_id=trade.id) }}';
        {% else %}
            window.location.href = '{{ url_for("trades.view_trades_list") }}';
        {% endif %}
    }
}

// CSRF token helper
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
           document.querySelector('#js-csrf-token')?.value || '';
}
</script>
{% endblock %}