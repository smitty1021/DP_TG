{% extends "base.html" %}
{% import "macros/_form_helpers.html" as forms %}

{% block title %}
    Add New Trade - Trading Journal
{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
    /* Page-specific styles for add_trade.html only */
    label { display: block; margin-top: 12px; font-weight: bold; }

    .form-section {
        border: 1px solid var(--bs-border-color);
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        background-color: var(--bs-body-bg);
    }
    .form-section h3 {
        margin-top:0;
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 10px;
        margin-bottom: 10px;
        font-size: 1.3em;
    }
    .entry-exit-item {
        border: 1px dashed var(--bs-secondary-bg-subtle);
        padding: 10px;
        margin-top: 5px;
        background-color: var(--bs-tertiary-bg);
    }
    .entry-exit-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr) auto;
        gap: 10px;
        align-items: end;
    }
    .entry-exit-headers {
        display: grid;
        grid-template-columns: repeat(3, 1fr) auto;
        gap: 10px;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 0.9em;
        color: var(--bs-secondary);
    }
    .entry-exit-row .form-group {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }
    .entry-exit-row .form-label {
        display: none; /* Hide labels for subsequent rows */
    }

    /* Quill container specific to this page - made resizable */
    .quill-editor-container {
        height: 250px;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
        border: 1px solid var(--bs-border-color);
        border-radius: .25rem;
        resize: vertical;
        overflow: auto;
        min-height: 150px;
        max-height: 600px;
    }

    .form-buttons-container {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    /* Grid layouts */
    .grid-2-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .grid-4-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .grid-5-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    .grid-9-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }

    /* Stats Dashboard Styling */
    .stat-item {
        text-align: center;
        padding: 0.75rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background-color: var(--bs-light);
        transition: all 0.2s ease;
    }

    [data-bs-theme="dark"] .stat-item {
        background-color: var(--bs-dark);
    }

    .stat-item .form-label {
        margin-bottom: 0.25rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .stat-item .fw-bold {
        font-size: 1.1rem;
    }

    .text-profit {
        color: #198754 !important;
        font-weight: bold;
    }

    .text-loss {
        color: #dc3545 !important;
        font-weight: bold;
    }

    .text-breakeven {
        color: #6c757d !important;
        font-weight: bold;
    }

    /* Tag Colors - Match Default Tags Page */
.tag-good {
    background-color: var(--bs-success-bg-subtle) !important;
    border-color: var(--bs-success-border-subtle) !important;
    color: var(--bs-success-text-emphasis) !important;
}

.tag-bad {
    background-color: var(--bs-danger-bg-subtle) !important;
    border-color: var(--bs-danger-border-subtle) !important;
    color: var(--bs-danger-text-emphasis) !important;
}

.tag-neutral {
    background-color: var(--bs-primary-bg-subtle) !important;
    border-color: var(--bs-primary-border-subtle) !important;
    color: var(--bs-primary-text-emphasis) !important;
}

    /* Hover effects */
    .tag-good:hover {
        background-color: #c3e6cb !important;
    }

    .tag-bad:hover {
        background-color: #f5c6cb !important;
    }

    .tag-neutral:hover {
        background-color: #b8daff !important;
    }

    [data-bs-theme="dark"] .tag-good:hover {
        background-color: #146c43 !important;
    }

    [data-bs-theme="dark"] .tag-bad:hover {
        background-color: #842029 !important;
    }

    [data-bs-theme="dark"] .tag-neutral:hover {
        background-color: #084298 !important;
    }

    /* Selected tags display */
    .selected-tags-display {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background-color: var(--bs-tertiary-bg);
        min-height: 2rem;
    }

    .tag-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.125rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .ts-control .item .remove {
        border-left: none !important;
    }



</style>
{% endblock %}

{% block page_header %}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h1>Log New Trade</h1>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-secondary"><i class="fas fa-list me-1"></i> Back to Trades List</a>
            <a href="{{ url_for('trades.import_trades') }}" class="btn btn-outline-info"><i class="fas fa-upload me-1"></i> Import</a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- NEW: Trade Stats Dashboard (Auto-calculated) -->
    <div id="trade-stats-dashboard" class="card mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Trade Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">Risk:Reward</label>
                        <div id="risk-reward-display" class="fw-bold">--:--</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">Time in Trade</label>
                        <div id="time-in-trade-display" class="fw-bold">--:--</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">Points Risked</label>
                        <div id="points-risked-display" class="fw-bold">--</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">$ Risked</label>
                        <div id="dollar-risk-display" class="fw-bold">$--</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">Gross P&L</label>
                        <div id="gross-pnl-display" class="fw-bold">$--</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-item">
                        <label class="form-label text-muted small">Overall Trade Rating</label>
                        <div id="overall-rating-display" class="fw-bold">--/5</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('trades.add_trade') }}" id="tradeForm" novalidate enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- 1. TRADE DETAILS (Combined with Risk/Reward) -->
        <div class="form-section">
            <h3>Trade Details</h3>
            <div class="grid-9-col">
                {{ forms.render_field(form.trade_date, input_class="form-control", type="date") }}
                {{ forms.render_field(form.instrument, input_class="form-select") }}
                {{ forms.render_field(form.direction, input_class="form-select") }}
                {{ forms.render_field(form.initial_stop_loss, input_class="form-control", type="number", step="any", placeholder="SL Price") }}
                {{ forms.render_field(form.terminus_target, input_class="form-control", type="number", step="any", placeholder="Final TP price level") }}
                {{ forms.render_field(form.trading_model_id, input_class="form-select") }}
                {{ forms.render_field(form.how_closed, input_class="form-select") }}
                <!-- UPDATED: Changed placeholders from Points to Ticks -->
                {{ forms.render_field(form.mae, input_class="form-control", type="number", step="any", placeholder="Ticks Against You") }}
                {{ forms.render_field(form.mfe, input_class="form-control", type="number", step="any", placeholder="Ticks In Your Favor") }}
            </div>
            <!-- 3. ENTRY/EXIT POINTS -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-section">
                    <h3>Trade Entries</h3>
                    <div class="entry-exit-headers">
                        <div>Entry Time</div>
                        <div># of Contracts</div>
                        <div>Price Level</div>

                    </div>
                    <div id="entry-points-container">
                        {% for entry_form_field in form.entries %}
                        <div class="entry-exit-item">
                            <div class="entry-exit-row">
                                {{ forms.render_field(entry_form_field.entry_time, input_class="form-control form-control-sm", type="time") }}
                                {{ forms.render_field(entry_form_field.contracts, input_class="form-control form-control-sm", type="number") }}
                                {{ forms.render_field(entry_form_field.entry_price, input_class="form-control form-control-sm", type="number", step="any") }}
                                <div>
                                {% if loop.index > form.entries.min_entries %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry"><i class="fas fa-trash-alt"></i></button>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-entry-button" title="Add Entry"><i class="fas fa-plus"></i> Add Entry</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-section">
                    <h3>Trade Exits</h3>
                    <div class="entry-exit-headers">
                        <div>Exit Time</div>
                        <div># of Contracts</div>
                        <div>Price Level</div>

                    </div>
                    <div id="exit-points-container">
                        {% for exit_form_field in form.exits %}
                        <div class="entry-exit-item">
                            <div class="entry-exit-row">
                                {{ forms.render_field(exit_form_field.exit_time, input_class="form-control form-control-sm", type="time") }}
                                {{ forms.render_field(exit_form_field.contracts, input_class="form-control form-control-sm", type="number") }}
                                {{ forms.render_field(exit_form_field.exit_price, input_class="form-control form-control-sm", type="number", step="any") }}

                                <div>
                                {% if loop.index > 1 %}
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit"><i class="fas fa-trash-alt"></i></button>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-exit-button" title="Add Exit"><i class="fas fa-plus"></i> Add Exit</button>
                </div>
            </div>
        </div>
            <div class="mt-3">
                {{ forms.render_checkbox(form.is_dca) }}
            </div>
        </div>

        <!-- 2. TRADE ANALYSIS -->
        <div class="form-section">
            <h3>Trade Analysis</h3>
            <div class="form-group mb-3">
                {{ form.trade_notes.label(class="form-label") }}
                <div id="trade_notes_editor" class="quill-editor-container"></div>
                {{ form.trade_notes(class="d-none") }}
                {% if form.trade_notes.errors %}<div class="invalid-feedback d-block">{% for error in form.trade_notes.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                {% if form.trade_notes.description %}<small class="form-text text-muted">{{ form.trade_notes.description }}</small>{% endif %}
            </div>

            <div class="form-group mb-3">
                {{ form.overall_analysis_notes.label(class="form-label") }}
                <div id="overall_analysis_notes_editor" class="quill-editor-container"></div>
                {{ form.overall_analysis_notes(class="d-none") }}
                {% if form.overall_analysis_notes.errors %}<div class="invalid-feedback d-block">{% for error in form.overall_analysis_notes.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}
                {% if form.overall_analysis_notes.description %}<small class="form-text text-muted">{{ form.overall_analysis_notes.description }}</small>{% endif %}
            </div>

            <!-- Three-column layout for management, errors, and improvements -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <h5>Trade Management Notes</h5>
                    {{ forms.render_field(form.trade_management_notes, input_class="form-control", rows="4", placeholder="Trade management decisions, scaling in/out, adjustments, etc.", label_visible=false) }}
                </div>
                <div class="col-md-4">
                    <h5>Errors</h5>
                    {{ forms.render_field(form.errors_notes, input_class="form-control", rows="4", placeholder="Any mistakes made during this trade?", label_visible=false) }}
                </div>
                <div class="col-md-4">
                    <h5>Improvements</h5>
                    {{ forms.render_field(form.improvements_notes, input_class="form-control", rows="4", placeholder="What could be improved for next the next trade?", label_visible=false) }}
                </div>
            </div>
        </div>

        <!-- 5. PSYCHOLOGICAL REVIEW -->
        <div class="form-section">
            <h3>Trade Management Review & Ratings</h3>
            <div class="row">
                <div class="col-lg-8">
                    <h8>Rate this trade using the following headings.  How well did I:</h8>
                    <div class="grid-5-col">
                        {{ forms.render_field(form.preparation_rating, input_class="form-select rating-selector") }}
                        {{ forms.render_field(form.rules_rating, input_class="form-select rating-selector") }}
                        {{ forms.render_field(form.management_rating, input_class="form-select rating-selector") }}
                        {{ forms.render_field(form.entry_rating, input_class="form-select rating-selector") }}
                        {{ forms.render_field(form.target_rating, input_class="form-select rating-selector") }}

                    </div>
                    {{ forms.render_field(form.psych_scored_highest, input_class="form-control", rows="2", placeholder="What did you do well with this trade?") }}
                    {{ forms.render_field(form.psych_scored_lowest, input_class="form-control", rows="2", placeholder="What areas need improvement?") }}
                </div>
                <div class="col-lg-4">
                    <div style="max-width: 350px; margin: auto;">
                        <canvas id="psychRadarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. IMAGES, LINKS, & TAGS -->
        <div class="form-section">
            <h3>Trade Images, Links and Tags</h3>
            <div class="row">
                <div class="col-md-4">
                    {{ forms.render_field(form.trade_images, input_class="form-control") }}
                    <small class="form-text text-muted">Upload screenshots or relevant images for this trade.</small>
                </div>
                <div class="col-md-4">
                    {{ forms.render_field(form.screenshot_link, input_class="form-control", type="url", placeholder="https://www.tradingview.com/chart/...") }}
                    <small class="form-text text-muted">Paste screenshot links from your trading platform here.</small>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="tags-select" class="form-label">{{ form.tags.label.text }}</label>
                        <select multiple class="form-select" id="tags-select" name="{{ form.tags.name }}">
                            {% for category_name, tag_options in form.tags.choices %}
                                <optgroup label="{{ category_name }}">
                                    {% for tag_id, tag_name, tag_color in tag_options %}
                                        <option value="{{ tag_id }}"
                                                data-color="{{ tag_color or 'neutral' }}"
                                                class="tag-{{ tag_color or 'neutral' }}"
                                                {% if tag_id in (form.tags.data or []) %}selected{% endif %}>
                                            {{ tag_name }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        {% if form.tags.errors %}
                            {% for error in form.tags.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <small class="form-text text-muted">Select appropriate tags for this trade.</small>

                    </div>
                </div>
            </div>
        </div>


        <div class="form-buttons-container">
            <button type="submit" class="btn btn-outline-success"><i class="fas fa-plus me-1"></i> Log Trade</button>
            <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-secondary"><i class="fas fa-times me-1"></i> Cancel</a>
        </div>
    </form>
</div>

{# Hidden templates for dynamic entries/exits - use raw HTML #}
<div id="entry-template" style="display: none;">
    <div class="entry-exit-item">
        <div class="entry-exit-row">
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-entry_time" name="entries-INDEX-entry_time" type="time" placeholder="HH:MM">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-contracts" name="entries-INDEX-contracts" type="number" placeholder="Contracts">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="entries-INDEX-entry_price" name="entries-INDEX-entry_price" type="number" step="any" placeholder="Price">
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remove Entry"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="exit-template" style="display: none;">
    <div class="entry-exit-item">
        <div class="entry-exit-row">
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-exit_time" name="exits-INDEX-exit_time" type="time" placeholder="HH:MM">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-contracts" name="exits-INDEX-contracts" type="number" placeholder="Contracts">
            </div>
            <div class="form-group">
                <input class="form-control form-control-sm" id="exits-INDEX-exit_price" name="exits-INDEX-exit_price" type="number" step="any" placeholder="Price">
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-exit-btn" title="Remove Exit"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Add trade page JavaScript initializing...');

    // Create tag color mapping from the backend data
    const tagColors = {};
    {% for category_name, tag_options in form.tags.choices %}
        {% for tag_id, tag_name, tag_color in tag_options %}
            tagColors['{{ tag_id }}'] = '{{ tag_color or "neutral" }}';
        {% endfor %}
    {% endfor %}

    // --- INITIALIZE TAGS SELECT (ONLY ONCE) ---
    const tagsSelect = document.getElementById('tags-select');
    if (tagsSelect) {
        new TomSelect(tagsSelect, {
            plugins: ['remove_button'],
            placeholder: 'Select or search for tags...',
            render: {
                option: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="option ${colorClass}">${escape(data.text)}</div>`;
                },
                item: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="item ${colorClass}">${escape(data.text)}</div>`;
                }
            }
        });
        console.log('TomSelect initialized for tags with colors');
    }

    // --- TRADE STATS DASHBOARD CALCULATIONS ---
    const dashboard = document.getElementById('trade-stats-dashboard');

    // Use the dynamic point values passed from backend
    const instrumentPointValues = {{ instrument_point_values|tojson|safe }};
    console.log('Available instruments and point values:', instrumentPointValues);

    // COMPREHENSIVE field watching for P&L updates
    function addCalculationListeners() {
        console.log('Adding calculation listeners...');

        // Watch all form fields that affect calculations
        const fieldsToWatch = [
            '[name="instrument"]',
            '[name="direction"]',
            '[name="initial_stop_loss"]',
            '[name="terminus_target"]',
            '[name^="entries-"][name$="-entry_time"]',
            '[name^="entries-"][name$="-contracts"]',
            '[name^="entries-"][name$="-entry_price"]',
            '[name^="exits-"][name$="-exit_time"]',
            '[name^="exits-"][name$="-contracts"]',
            '[name^="exits-"][name$="-exit_price"]',
            '[name$="_rating"]'
        ];

        fieldsToWatch.forEach(selector => {
            document.querySelectorAll(selector).forEach(field => {
                // Remove existing listeners to avoid duplicates
                field.removeEventListener('input', calculateStats);
                field.removeEventListener('change', calculateStats);

                // Add listeners
                field.addEventListener('input', calculateStats);
                field.addEventListener('change', calculateStats);
            });
        });
    }

    // Also watch for dynamically added entry/exit fields
    document.addEventListener('input', function(e) {
        if (e.target.name && (e.target.name.includes('entries-') || e.target.name.includes('exits-'))) {
            calculateStats();
        }
    });

    // Also watch for change events on select fields
    document.addEventListener('change', function(e) {
        if (e.target.name && (
            e.target.name === 'instrument' ||
            e.target.name === 'direction' ||
            e.target.name.includes('entries-') ||
            e.target.name.includes('exits-') ||
            e.target.name.includes('_rating')
        )) {
            calculateStats();
        }
    });

    // Fix for the P&L calculation in edit_trade.html and add_trade.html
// Replace the calculateStats function with this corrected version:

function calculateStats() {
    console.log('=== Calculating Stats ===');

    try {
        const instrumentSelectElement = document.querySelector('[name="instrument"]');
        const instrumentId = instrumentSelectElement?.value || '';
        const direction = document.querySelector('[name="direction"]')?.value || '';
        const stopLoss = parseFloat(document.querySelector('[name="initial_stop_loss"]')?.value || '0');
        const target = parseFloat(document.querySelector('[name="terminus_target"]')?.value || '0');

        // FIXED: Get point value by looking up the instrument symbol from the select option text
        let pointValue = 1.0; // Default fallback

        if (instrumentId && instrumentSelectElement) {
            // Find the selected option and extract the symbol from its text
            const selectedOption = instrumentSelectElement.querySelector(`option[value="${instrumentId}"]`);
            if (selectedOption) {
                const optionText = selectedOption.textContent; // e.g., "NQ (E-mini NASDAQ-100)"
                // Extract symbol (everything before the first space or parenthesis)
                const symbolMatch = optionText.match(/^([A-Z]+)/);
                if (symbolMatch) {
                    const symbol = symbolMatch[1];
                    console.log(`Found symbol: ${symbol} for instrument ID: ${instrumentId}`);

                    // Now look up the point value by symbol
                    if (instrumentPointValues[symbol]) {
                        pointValue = instrumentPointValues[symbol];
                        console.log(`Point value for ${symbol}: $${pointValue}`);
                    } else {
                        console.warn(`No point value found for symbol: ${symbol}`);
                        // Fallback to common values
                        const fallbackValues = {
                            'NQ': 20.0, 'ES': 50.0, 'YM': 5.0,
                            'MNQ': 2.0, 'MES': 5.0, 'MYM': 0.5
                        };
                        pointValue = fallbackValues[symbol] || 1.0;
                    }
                }
            }
        }

        console.log(`Using point value: $${pointValue} for calculation`);

        // Get ALL entry data
        const entryFields = document.querySelectorAll('[name^="entries-"][name$="-entry_price"]');
        const entryContractFields = document.querySelectorAll('[name^="entries-"][name$="-contracts"]');
        const entryTimeFields = document.querySelectorAll('[name^="entries-"][name$="-entry_time"]');

        let totalEntryContracts = 0;
        let weightedEntryPrice = 0;
        let firstEntryTime = '';

        // Calculate weighted average entry price
        for (let i = 0; i < entryFields.length; i++) {
            const price = parseFloat(entryFields[i].value || '0');
            const contracts = parseInt(entryContractFields[i]?.value || '0');
            const time = entryTimeFields[i]?.value || '';

            if (price > 0 && contracts > 0) {
                weightedEntryPrice += price * contracts;
                totalEntryContracts += contracts;
                if (!firstEntryTime) firstEntryTime = time;
            }
        }

        const avgEntryPrice = totalEntryContracts > 0 ? weightedEntryPrice / totalEntryContracts : 0;

        // Get ALL exit data
        const exitFields = document.querySelectorAll('[name^="exits-"][name$="-exit_price"]');
        const exitContractFields = document.querySelectorAll('[name^="exits-"][name$="-contracts"]');
        const exitTimeFields = document.querySelectorAll('[name^="exits-"][name$="-exit_time"]');

        let totalExitContracts = 0;
        let weightedExitPrice = 0;
        let lastExitTime = '';

        // Calculate weighted average exit price
        for (let i = 0; i < exitFields.length; i++) {
            const price = parseFloat(exitFields[i].value || '0');
            const contracts = parseInt(exitContractFields[i]?.value || '0');
            const time = exitTimeFields[i]?.value || '';

            if (price > 0 && contracts > 0) {
                weightedExitPrice += price * contracts;
                totalExitContracts += contracts;
                lastExitTime = time;
            }
        }

        const avgExitPrice = totalExitContracts > 0 ? weightedExitPrice / totalExitContracts : 0;

        // Show dashboard - it's always visible in edit mode
        dashboard.style.display = 'block';

        // Calculate Risk:Reward
        let riskRewardText = '--:--';
        if (avgEntryPrice > 0 && stopLoss > 0 && target > 0) {
            let risk, reward;
            if (direction === 'Long') {
                risk = Math.abs(avgEntryPrice - stopLoss);
                reward = Math.abs(target - avgEntryPrice);
            } else if (direction === 'Short') {
                risk = Math.abs(stopLoss - avgEntryPrice);
                reward = Math.abs(avgEntryPrice - target);
            }

            if (risk > 0) {
                const ratio = reward / risk;
                riskRewardText = `1:${ratio.toFixed(2)}`;
            }
        }

        // Calculate Time in Trade
        let timeInTradeText = '--:--';
        if (firstEntryTime && lastExitTime) {
            const [entryHour, entryMin] = firstEntryTime.split(':').map(Number);
            const [exitHour, exitMin] = lastExitTime.split(':').map(Number);

            const entryMinutes = entryHour * 60 + entryMin;
            const exitMinutes = exitHour * 60 + exitMin;

            let diffMinutes = exitMinutes - entryMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60;

            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            timeInTradeText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Calculate Points Risked
        let pointsRiskedText = '--';
        let dollarRiskText = '$--';
        if (avgEntryPrice > 0 && stopLoss > 0 && totalEntryContracts > 0) {
            let pointsRisk;
            if (direction === 'Long') {
                pointsRisk = Math.abs(avgEntryPrice - stopLoss);
            } else if (direction === 'Short') {
                pointsRisk = Math.abs(stopLoss - avgEntryPrice);
            }

            if (pointsRisk > 0) {
                pointsRiskedText = pointsRisk.toFixed(2);
                const dollarRisk = pointsRisk * totalEntryContracts * pointValue;
                dollarRiskText = `${dollarRisk.toFixed(2)}`;
            }
        }

        // Calculate Gross P&L - FIXED WITH CORRECT POINT VALUE
        let grossPnlText = '$--';
        let pnlClass = '';
        if (avgEntryPrice > 0 && avgExitPrice > 0 && totalExitContracts > 0) {
            let pnlPerContract;
            if (direction === 'Long') {
                pnlPerContract = avgExitPrice - avgEntryPrice;
            } else if (direction === 'Short') {
                pnlPerContract = avgEntryPrice - avgExitPrice;
            }

            const grossPnl = pnlPerContract * totalExitContracts * pointValue;
            grossPnlText = `${grossPnl.toFixed(2)}`;

            console.log(`P&L Calculation: ${pnlPerContract} * ${totalExitContracts} * ${pointValue} = ${grossPnl}`);

            if (grossPnl > 0) {
                pnlClass = 'text-profit';
            } else if (grossPnl < 0) {
                pnlClass = 'text-loss';
            } else {
                pnlClass = 'text-breakeven';
            }
        }

        // Calculate Overall Trade Rating
        let overallRatingText = '--/5';
        const ratings = [
            'preparation_rating', 'rules_rating', 'management_rating',
            'target_rating', 'entry_rating'
        ];

        const ratingValues = ratings.map(name => {
            const value = parseInt(document.querySelector(`[name="${name}"]`)?.value || '0');
            return value > 0 ? value : null;
        }).filter(v => v !== null);

        if (ratingValues.length > 0) {
            const avgRating = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
            overallRatingText = `${avgRating.toFixed(1)}/5`;
        }

        // Update display
        document.getElementById('risk-reward-display').textContent = riskRewardText;
        document.getElementById('time-in-trade-display').textContent = timeInTradeText;
        document.getElementById('points-risked-display').textContent = pointsRiskedText;
        document.getElementById('dollar-risk-display').textContent = dollarRiskText;

        const pnlElement = document.getElementById('gross-pnl-display');
        pnlElement.textContent = grossPnlText;
        pnlElement.className = `fw-bold ${pnlClass}`;

        document.getElementById('overall-rating-display').textContent = overallRatingText;

    } catch (error) {
        console.error('Error calculating trade stats:', error);
    }
}

    // --- DEFAULT DATE LOGIC ---
    const tradeDateInput = document.getElementById('{{ form.trade_date.id }}');
    if (tradeDateInput && !tradeDateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = ('0' + (today.getMonth() + 1)).slice(-2);
        const day = ('0' + today.getDate()).slice(-2);
        tradeDateInput.value = `${year}-${month}-${day}`;
    }

    // --- DYNAMIC FIELDS LOGIC ---
    function initializeDynamicFields(containerId, addButtonId, templateId, itemClass, removeButtonClass, fieldListName, minEntries) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const addButton = document.getElementById(addButtonId);
        const templateElement = document.getElementById(templateId);
        if (!templateElement) return;

        const templateHtml = templateElement.innerHTML;

        function addRemoveButtonListeners(scope = document) {
            scope.querySelectorAll('.' + removeButtonClass).forEach(button => {
                button.removeEventListener('click', handleRemoveItem);
                button.addEventListener('click', handleRemoveItem);
            });
        }

        function handleRemoveItem(event) {
            const min = parseInt(minEntries, 10);
            if (container.querySelectorAll('.' + itemClass).length > min) {
                event.target.closest('.' + itemClass).remove();
                addCalculationListeners();
                calculateStats();
            } else {
                alert(`At least ${min} ${fieldListName.slice(0, -1)}(s) must remain.`);
            }
        }

        if (addButton) {
            addButton.addEventListener('click', function() {
                const newIndex = container.querySelectorAll('.' + itemClass).length;
                let newItemHtml = templateHtml.replace(/INDEX/g, newIndex);

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newItemHtml;
                const newItemElement = tempDiv.firstElementChild;

                if (newItemElement) {
                    container.appendChild(newItemElement);
                    addRemoveButtonListeners(newItemElement);
                    addCalculationListeners();
                    calculateStats();
                }
            });
        }
        addRemoveButtonListeners(container);
    }

    // Initialize dynamic fields
    initializeDynamicFields('entry-points-container', 'add-entry-button', 'entry-template', 'entry-exit-item', 'remove-entry-btn', 'entries', parseInt('{{ form.entries.min_entries|default(1) }}', 10));
    initializeDynamicFields('exit-points-container', 'add-exit-button', 'exit-template', 'entry-exit-item', 'remove-exit-btn', 'exits', 1);

    // --- QUILL INITIALIZATION ---
    const quillToolbarOptions = [
        [{ 'header': [1, 2, 3, 4, false] }], ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }], [{ 'direction': 'rtl' }],
        [{ 'color': [] }, { 'background': [] }], [{ 'align': [] }],
        ['link', 'image'], ['clean']
    ];

    let quillInstances = {};

    function initializeQuill(editorDivId, hiddenTextareaId, placeholderText) {
        const editorDiv = document.getElementById(editorDivId);
        const hiddenTextarea = document.getElementById(hiddenTextareaId);
        if (editorDiv && hiddenTextarea) {
            quillInstances[hiddenTextareaId] = new Quill(editorDiv, {
                theme: 'snow',
                modules: { toolbar: quillToolbarOptions },
                placeholder: placeholderText || 'Enter details...'
            });

            const existingContent = hiddenTextarea.value;
            if (existingContent) {
                try {
                    quillInstances[hiddenTextareaId].clipboard.dangerouslyPasteHTML(existingContent);
                } catch (e) {
                    quillInstances[hiddenTextareaId].setText(existingContent);
                }
            }
        }
    }

    // Initialize Quill editors
    initializeQuill('trade_notes_editor', '{{ form.trade_notes.id }}', 'Enter your pre-entry analysis, setup thoughts, reasoning, chart markups...');
    initializeQuill('overall_analysis_notes_editor', '{{ form.overall_analysis_notes.id }}', 'Enter your post-trade analysis, what happened, lessons learned...');

    // Form submission handler for Quill
    const tradeForm = document.getElementById('tradeForm');
    if (tradeForm) {
        tradeForm.addEventListener('submit', function() {
            for (const textareaId in quillInstances) {
                if (quillInstances.hasOwnProperty(textareaId) && document.getElementById(textareaId)) {
                     document.getElementById(textareaId).value = quillInstances[textareaId].root.innerHTML;
                }
            }
        });
    }

    // --- RADAR CHART INITIALIZATION ---
    const ratingSelectors = document.querySelectorAll('.rating-selector');
    const psychRadarCtx = document.getElementById('psychRadarChart');

    if (psychRadarCtx && ratingSelectors.length === 5) {
        console.log('Initializing radar chart...');

        const chartLabels = ['Prep', 'Rules', 'Mgmt', 'Entry', 'Targets'];
        const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
        const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = currentTheme === 'dark' ? '#ced4da' : '#666';
        const pointLabelColor = currentTheme === 'dark' ? '#e9ecef' : '#333';

        const radarChart = new Chart(psychRadarCtx, {
            type: 'radar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Trade Psych Score',
                    data: [0, 0, 0, 0, 0],
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: gridColor },
                        grid: { color: gridColor },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: { color: pointLabelColor, font: { size: 14 } },
                        ticks: { stepSize: 1, color: textColor, backdropColor: 'rgba(0, 0, 0, 0)' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        function updateRadarChart() {
            const newData = [];
            ratingSelectors.forEach(selector => {
                newData.push(parseInt(selector.value) || 0);
            });
            radarChart.data.datasets[0].data = newData;
            radarChart.update();
        }

        ratingSelectors.forEach(selector => {
            selector.addEventListener('change', function() {
                updateRadarChart();
                calculateStats();
            });
        });

        updateRadarChart();
        console.log('Radar chart initialized successfully');
    } else {
        console.log('Radar chart not initialized - missing elements:', {
            psychRadarCtx: !!psychRadarCtx,
            ratingSelectorsCount: ratingSelectors.length
        });
    }



    // --- INITIAL SETUP ---
    console.log('Running initial setup...');
    addCalculationListeners();
    calculateStats();
    console.log('Add trade page JavaScript initialization complete');
});
</script>
{% endblock %}