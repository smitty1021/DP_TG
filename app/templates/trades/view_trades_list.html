{% extends "base.html" %}

{% block title %}Trading Operations Center{% endblock %}

{% block extra_css %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<!-- Optional: Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="enterprise-container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-chart-line executive-icon"></i>
                    Trading Operations Center
                </h1>
                <p class="executive-subtitle">
                    Strategic Trading Activity Management & Performance Analysis</p>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                        title="New Trade Configuration">
                    <i class="fas fa-plus"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <a href="{{ url_for('trades.import_trades') }}" class="btn btn-outline-secondary btn-sm" title="Import Trading Data">
                    <i class="fas fa-upload me-1"></i>
                </a>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                            data-bs-toggle="dropdown" aria-expanded="false" title="Export Trading Data">
                        <i class="fas fa-download me-1"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('trades.export_trades_csv') }}">
                            <i class="fas fa-file-csv me-2"></i>Export as CSV</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('trades.export_trades_excel') }}">
                            <i class="fas fa-file-excel me-2"></i>Export as Excel</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('trades.export_trades_json') }}">
                            <i class="fas fa-file-code me-2"></i>Export as JSON</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('trades.export_tax_report') }}">
                            <i class="fas fa-file-invoice me-2"></i>Tax Report Export</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('trades.export_performance_report') }}">
                            <i class="fas fa-chart-bar me-2"></i>Performance Analysis</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid mt-3">
    <!-- Performance KPI Section -->
    {% if trades %}
    <div class="kpi-section">
        <div class="grid grid-cols-6 gap-0">
            <!-- Total Trades -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-chart-line kpi-icon me-2"></i>
                            <span class="kpi-label">Total Trades</span>
                        </div>
                        <div class="kpi-value">{{ kpi_data.total_trades if kpi_data else (pagination.total if pagination else trades|length) }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                <i class="fas fa-arrow-up"></i> Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Win/Loss Distribution -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-chart-pie kpi-icon me-2"></i>
                            <span class="kpi-label">Win/Loss Distribution</span>
                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                W: {{ kpi_data.profitable_trades }} | L: {{ kpi_data.losing_trades }}{% if kpi_data.breakeven_trades > 0 %} | BE: {{ kpi_data.breakeven_trades }}{% endif %}
                            {% else %}
                                {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                                {% set losing = trades|selectattr('pnl', 'lessthan', 0)|list|length %}
                                {% set breakeven = trades|selectattr('pnl', 'equalto', 0)|list|length %}
                                W: {{ profitable }} | L: {{ losing }}{% if breakeven > 0 %} | BE: {{ breakeven }}{% endif %}
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Trade Outcomes
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strike Rate -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-percentage kpi-icon me-2"></i>
                            <span class="kpi-label">Strike Rate</span>
                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                {% set strike_rate = kpi_data.strike_rate %}
                            {% else %}
                                {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                                {% set total_with_pnl = trades|selectattr('pnl', 'number')|list|length %}
                                {% set strike_rate = (profitable / total_with_pnl * 100) if total_with_pnl > 0 else 0 %}
                            {% endif %}
                            {{ "%.1f"|format(strike_rate) }}%
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Win Percentage
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumulative P&L -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-dollar-sign kpi-icon me-2"></i>
                            <span class="kpi-label">Cumulative P&L</span>

                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                {% set total_pnl = kpi_data.cumulative_pnl %}
                            {% else %}
                                {% set total_pnl = 0 %}
                                {% for trade in trades %}
                                    {% if trade.pnl %}
                                        {% set total_pnl = total_pnl + trade.pnl %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            ${{ "{:,.2f}".format(total_pnl) }}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Total Profit/Loss
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Average Trade Duration -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-clock kpi-icon me-2"></i>
                            <span class="kpi-label">Avg Duration</span>
                        </div>
                        <div class="kpi-value">
                            {% if kpi_data and kpi_data.avg_duration %}
                                {{ kpi_data.avg_duration }}
                            {% else %}
                                {% set total_minutes = 0 %}
                                {% set duration_count = 0 %}
                                {% for trade in trades %}
                                    {% if trade.time_in_trade and trade.time_in_trade != 'N/A' %}
                                        {% set duration_count = duration_count + 1 %}
                                        {% if 'h' in trade.time_in_trade and 'm' in trade.time_in_trade %}
                                            {% set parts = trade.time_in_trade.replace('h', '').replace('m', '').split() %}
                                            {% if parts|length >= 2 %}
                                                {% set hours = parts[0]|int %}
                                                {% set minutes = parts[1]|int %}
                                                {% set total_minutes = total_minutes + (hours * 60) + minutes %}
                                            {% endif %}
                                        {% elif 'm' in trade.time_in_trade %}
                                            {% set minutes = trade.time_in_trade.replace('m', '')|int %}
                                            {% set total_minutes = total_minutes + minutes %}
                                        {% elif 'h' in trade.time_in_trade %}
                                            {% set hours = trade.time_in_trade.replace('h', '')|int %}
                                            {% set total_minutes = total_minutes + (hours * 60) %}
                                        {% endif %}
                                    {% elif trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                                        {% set duration_count = duration_count + 1 %}
                                        {% set entry_total_mins = trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute %}
                                        {% set exit_total_mins = trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute %}
                                        {% set time_diff = exit_total_mins - entry_total_mins %}
                                        {% if time_diff < 0 %}
                                            {% set time_diff = time_diff + (24 * 60) %}
                                        {% endif %}
                                        {% set total_minutes = total_minutes + time_diff %}
                                    {% endif %}
                                {% endfor %}
                                {% if duration_count > 0 %}
                                    {% set avg_mins = (total_minutes / duration_count)|round|int %}
                                    {% if avg_mins >= 60 %}
                                        {{ "%dh %dm"|format(avg_mins // 60, avg_mins % 60) }}
                                    {% else %}
                                        {{ "%dm"|format(avg_mins) }}
                                    {% endif %}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Time in Market
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Best Performing Model -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-trophy kpi-icon me-2"></i>
                            <span class="kpi-label">Top Strategy</span>

                        </div>
                        <div class="kpi-value">
                            {% if kpi_data and kpi_data.best_model %}
                                {{ kpi_data.best_model }}
                            {% else %}
                                {% set model_performance = {} %}
                                {% for trade in trades %}
                                    {% if trade.trading_model and trade.pnl is not none %}
                                        {% set model_name = trade.trading_model.name %}
                                        {% if model_name not in model_performance %}
                                            {% set _ = model_performance.update({model_name: 0}) %}
                                        {% endif %}
                                        {% set _ = model_performance.update({model_name: model_performance[model_name] + trade.pnl}) %}
                                    {% endif %}
                                {% endfor %}
                                {% if model_performance %}
                                    {% set best_model = model_performance.keys()|list|first %}
                                    {% set best_pnl = model_performance[best_model] %}
                                    {% for model, pnl in model_performance.items() %}
                                        {% if pnl > best_pnl %}
                                            {% set best_model = model %}
                                            {% set best_pnl = pnl %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ best_model[:12] + '...' if best_model|length > 15 else best_model }}
                                {% else %}
                                    N/A
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Best Performer
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Compact Filter Notification Bar -->
    {% set active_filters = [] %}
    {% if request.args.get('start_date') %}
        {% set _ = active_filters.append('Start Date: ' + request.args.get('start_date')) %}
    {% endif %}
    {% if request.args.get('end_date') %}
        {% set _ = active_filters.append('End Date: ' + request.args.get('end_date')) %}
    {% endif %}
    {% if request.args.get('instrument') and request.args.get('instrument') != '' %}
        {% set instrument_id = request.args.get('instrument') %}
        {% set instrument_dict = dict(filter_form.instrument.choices) %}
        {% set instrument_label = instrument_dict.get(instrument_id, instrument_id) %}
        {% set _ = active_filters.append('Instrument: ' + instrument_label) %}
    {% endif %}
    {% if request.args.get('direction') %}
        {% set _ = active_filters.append('Direction: ' + request.args.get('direction')) %}
    {% endif %}
    {% if request.args.get('trading_model_id') and request.args.get('trading_model_id') != '0' %}
        {% set model_id = request.args.get('trading_model_id') %}
        {% set model_dict = dict(filter_form.trading_model_id.choices) %}
        {% set model_label = model_dict.get(model_id|int, model_id) %}
        {% set _ = active_filters.append('Model: ' + model_label) %}
    {% endif %}
    {% if request.args.get('how_closed') %}
        {% set _ = active_filters.append('How Closed: ' + request.args.get('how_closed')) %}
    {% endif %}
    {% if request.args.get('pnl_filter') %}
        {% if request.args.get('pnl_filter') == 'winners' %}
            {% set _ = active_filters.append('P&L: Winners Only') %}
        {% elif request.args.get('pnl_filter') == 'losers' %}
            {% set _ = active_filters.append('P&L: Losers Only') %}
        {% elif request.args.get('pnl_filter') == 'breakeven' %}
            {% set _ = active_filters.append('P&L: Breakeven') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('is_dca') %}
        {% if request.args.get('is_dca') == 'true' %}
            {% set _ = active_filters.append('DCA: Yes') %}
        {% elif request.args.get('is_dca') == 'false' %}
            {% set _ = active_filters.append('DCA: No') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('min_contracts') %}
        {% set _ = active_filters.append('Min Contracts: ' + request.args.get('min_contracts')) %}
    {% endif %}
    {% if request.args.get('max_contracts') %}
        {% set _ = active_filters.append('Max Contracts: ' + request.args.get('max_contracts')) %}
    {% endif %}
    {% if request.args.get('min_rating') %}
        {% set _ = active_filters.append('Min Rating: ' + request.args.get('min_rating') + '+') %}
    {% endif %}
    {% if request.args.get('min_pnl') %}
        {% set _ = active_filters.append('Min P&L: $' + request.args.get('min_pnl')) %}
    {% endif %}
    {% if request.args.get('max_pnl') %}
        {% set _ = active_filters.append('Max P&L: $' + request.args.get('max_pnl')) %}
    {% endif %}

    {% if request.args.get('tags') or request.args.getlist('tags') %}
        {% set selected_tag_ids = request.args.getlist('tags') if request.args.getlist('tags') else [request.args.get('tags')] %}
        {% for tag_id in selected_tag_ids %}
            {% if tag_id and tag_id.strip() %}
                {% set ns = namespace(tag_label=tag_id, tag_color='neutral') %}

                {% if categorized_tags %}
                    {% for category_name, tag_options in categorized_tags %}
                        {% for tag_option_id, tag_option_name, tag_option_color in tag_options %}
                            {% if tag_option_id == tag_id %}
                                {% set ns.tag_label = tag_option_name %}
                                {% set ns.tag_color = tag_option_color or 'neutral' %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
                {% set _ = active_filters.append(('Tag', ns.tag_label, ns.tag_color)) %}
            {% endif %}
        {% endfor %}
    {% endif %}


    <!-- Compact Single-Line Filter Notification -->
    {% if active_filters %}
    <div class="d-flex align-items-center justify-content-between py-2 px-3 mt-2 mb-1" style="background-color: var(--bs-info-bg-subtle); border: 1px solid var(--bs-info-border-subtle); border-radius: 0.375rem; font-size: 0.875rem;">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <i class="fas fa-filter text-info"></i>
            <span class="fw-semibold text-info">Filtered by:</span>
            {% for filter in active_filters %}
                {% if filter is sequence and filter|length == 3 and filter[0] == 'Tag' %}
                    <!-- Tag with color coding -->
                    <span class="badge tag-{{ filter[2] }}" style="
                        background-color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-bg-subtle) !important;
                        border-color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-border-subtle) !important;
                        color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-text-emphasis) !important;
                        border: 1px solid;
                        font-size: 0.75rem;
                    ">
                        {{ filter[0] }}: {{ filter[1] }}
                    </span>
                {% else %}
                    <!-- Regular filter badge -->
                    <span class="badge bg-light" style="font-size: 0.75rem;">{{ filter }}</span>
                {% endif %}
            {% endfor %}
        </div>
        <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-info btn-sm" title="Clear all filters" style="font-size: 0.75rem;">
            <i class="fas fa-times me-1"></i>Clear
        </a>
    </div>
    {% endif %}

    <!-- Trade Operations Data Table -->
    {% if trades %}
    <div class="enterprise-module mt-3">
        <div class="module-header" style="position: relative; display: flex; align-items: center; padding: 1rem;">
            <!-- Left: Title with inline summary -->
            <div style="flex: 1;">
                <div class="module-title">
                    <i class="fas fa-database module-icon"></i>
                    Trading Operations Data Repository
                    <span style="font-weight: 400; color: var(--enterprise-text-muted); margin-left: 1rem; font-size: 0.875rem;">
                        {{ ((pagination.page - 1) * pagination.per_page + 1) }} - {{ (pagination.page * pagination.per_page if pagination.page < pagination.pages else pagination.total) }} of {{ pagination.total }} Recorded Trades
                    </span>
                </div>
            </div>
            
            <!-- Center: Pagination Controls (Absolutely Centered) -->
            {% if pagination and pagination.pages > 1 %}
            <div class="btn-group" style="position: absolute; left: 50%; transform: translateX(-50%);">
                <!-- First Page -->
                {% if pagination.page > 1 %}
                    {% set first_args = request.args.copy() %}
                    {% set _ = first_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=1, **first_args) }}'"
                            title="First Page">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                {% endif %}

                <!-- Previous Page -->
                {% if pagination.has_prev %}
                    {% set prev_args = request.args.copy() %}
                    {% set _ = prev_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.prev_num, **prev_args) }}'"
                            title="Previous Page">
                        <i class="fas fa-angle-left"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-left"></i>
                    </button>
                {% endif %}

                <!-- Page Information -->
                <span class="pagination-controls">
                    Page {{ pagination.page }} of {{ pagination.pages }}
                </span>

                <!-- Next Page -->
                {% if pagination.has_next %}
                    {% set next_args = request.args.copy() %}
                    {% set _ = next_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.next_num, **next_args) }}'"
                            title="Next Page">
                        <i class="fas fa-angle-right"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-right"></i>
                    </button>
                {% endif %}

                <!-- Last Page -->
                {% if pagination.page < pagination.pages %}
                    {% set last_args = request.args.copy() %}
                    {% set _ = last_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.pages, **last_args) }}'"
                            title="Last Page">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Right: Records per Page + Action Buttons -->
            <div class="d-flex align-items-center gap-3" style="flex: 1; justify-content: flex-end;">
                <div class="d-flex align-items-center gap-2">
                    <span style="font-size: 0.875rem;">Trades per Page:</span>
                    <select id="pageSizeDropdown" class="form-select form-select-sm" style="width: auto;"
                            title="Trades per page">
                        <option value="25" {{ 'selected' if request.args.get('per_page', '25')|string == '25' else '' }}>25</option>
                        <option value="50" {{ 'selected' if request.args.get('per_page', '25')|string == '50' else '' }}>50</option>
                        <option value="100" {{ 'selected' if request.args.get('per_page', '25')|string == '100' else '' }}>100</option>
                        <option value="250" {{ 'selected' if request.args.get('per_page', '25')|string == '250' else '' }}>250</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal"
                            data-bs-target="#filterModal" title="Filter Trades">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            onclick="exportTradesCSV()" title="Export to CSV">
                        <i class="fas fa-file-csv"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="module-content">
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;" role="region" aria-label="Trades List">
                <table class="table table-striped table-hover table-sm mb-0" role="table">
                    <thead class="table-dark sticky-top">
                    <tr role="row">
                        <th width="1" class="text-center" role="columnheader"></th>

                        <th scope="col" class="sortable text-center" data-sort="date" role="columnheader" tabindex="0" aria-label="Sort by Date">
                            Date
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="instrument" role="columnheader" tabindex="0"
                            aria-label="Sort by Instrument">Inst
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="model" role="columnheader" tabindex="0"
                            aria-label="Sort by Trading Model">Model
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="direction" role="columnheader" tabindex="0"
                            aria-label="Sort by Direction">Dir
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="contracts" role="columnheader" tabindex="0"
                            aria-label="Sort by Contracts">POS
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="entry_time" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Time">Time
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="entry" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Price">Entry
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="exit" role="columnheader" tabindex="0"
                            aria-label="Sort by Exit Price">Exit
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="time_in_trade" role="columnheader" tabindex="0"
                            aria-label="Sort by Time in Trade">Duration
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="how_closed" role="columnheader" tabindex="0"
                            aria-label="Sort by How Closed">Closed
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="avg_rating" role="columnheader" tabindex="0"
                            aria-label="Sort by Trade Rating">Rating
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="pnl" role="columnheader" tabindex="0"
                            aria-label="Sort by P&L">P&L
                        </th>
                        <th scope="col" class="text-center" role="columnheader"></th>
                    </tr>
                </thead>
                <tbody>
                {% for trade in trades %}
                <!-- Enhanced Trade Row with clean styling -->
                <tr class="trade-row
                    {% if trade.pnl and trade.pnl > 0 %}table-success-subtle
                    {% elif trade.pnl and trade.pnl < 0 %}table-danger-subtle
                    {% endif %}"
                    data-trade-id="{{ trade.id }}" role="row" tabindex="0"
                    aria-label="Trade {{ trade.trade_date.strftime('%m/%d/%Y') }} {{ trade.instrument }} {{ trade.direction }}">

                    <!-- Enhanced Dropdown Arrow -->
                    <td class="text-center" role="gridcell">
                        <i class="fas fa-chevron-right chevron-icon" id="chevron-{{ trade.id }}"
                           aria-hidden="true"></i>
                    </td>

                    <!-- Date -->
                    <td role="gridcell">{{ trade.trade_date.strftime('%d %b %y') }}</td>

                    <!-- Instrument -->
                    <td role="gridcell">{{ trade.instrument or 'N/A' }}</td>

                    <!-- Enhanced Model with tooltip -->
                    <td role="gridcell" title="{% if trade.trading_model %}{{ trade.trading_model.name }}{% else %}No model specified{% endif %}">
                        {% if trade.trading_model %}
                            {{ trade.trading_model.name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Enhanced Direction -->
                    <td role="gridcell">
                        {% if trade.direction == 'Long' %}
                            <span class="badge-transparent text-success fw-bold"
                                  aria-label="Long position">{{ trade.direction }}</span>
                        {% elif trade.direction == 'Short' %}
                            <span class="badge-transparent text-danger fw-bold"
                                  aria-label="Short position">{{ trade.direction }}</span>
                        {% else %}
                            <span class="badge-transparent text-muted" {{ trade.direction or 'N/A' }}</span>
                        {% endif %}
                    </td>

                    <!-- Contracts -->
                    <td role="gridcell">{{ trade.total_contracts_entered or 0 }}</td>

                    <!-- Entry Time -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.entries.first().entry_time %}
                            {{ trade.entries.first().entry_time.strftime('%H:%M') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Entry Price -->
                    <td role="gridcell">
                        {% if trade.average_entry_price %}
                            {{ "{:.2f}".format(trade.average_entry_price) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Exit Price -->
                    <td role="gridcell">
                        {% if trade.average_exit_price %}
                            {{ "{:.2f}".format(trade.average_exit_price) }}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted" aria-label="Position still open">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>
                    <!-- Enhanced Time in Trade -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                            {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                            {% if time_diff >= 0 %}
                                <span>{{ trade.time_in_trade }}</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- How Closed -->
                    <td role="gridcell">
                        {% if trade.how_closed %}
                            <span class="how-closed-text">{{ trade.how_closed }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Enhanced Trade Rating with accessibility -->
                    <td role="gridcell">
                        {% set ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                        {% set valid_ratings = ratings|select('ne', none)|list %}
                        {% if valid_ratings %}
                            {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                            {% if avg_rating >= 4.0 %}
                                <span class="badge-transparent text-success fw-bold" aria-label="High rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% elif avg_rating >= 2.5 %}
                                <span class="badge-transparent text-warning fw-bold" aria-label="Medium rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% else %}
                                <span class="badge-transparent text-danger fw-bold" aria-label="Low rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>

                            {% endif %}
                        {% else %}
                            <span aria-label="No rating available">N/A</span>
                        {% endif %}
                    </td>
                    <!-- Enhanced P&L with no + sign for winners -->
                    <td role="gridcell">
                        {% if trade.pnl is not none %}
                            {% if trade.pnl > 0 %}
                                <span class="badge-transparent text-success fw-bold" aria-label="Profit: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% elif trade.pnl < 0 %}
                                <span class="badge-transparent text-danger fw-bold" aria-label="Loss: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% else %}
                                <span class="badge-transparent text-muted fw-bold" aria-label="Break even: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% endif %}
                        {% else %}
                            <span aria-label="P&L not available">N/A</span>
                        {% endif %}
                    </td>

                    <!-- Enhanced Actions with better accessibility -->
                    <td class="text-end" onclick="event.stopPropagation();" role="gridcell">
                        <div class="btn-group" role="group" aria-label="Trade actions">
                            <a href="{{ url_for('journal.manage_daily_journal', date_str=trade.trade_date.strftime('%Y-%m-%d')) }}"
                               class="btn btn-outline-secondary btn-sm" title="Daily Journal for {{ trade.trade_date.strftime('%m/%d/%Y') }}"
                               aria-label="View daily journal">
                                <i class="fas fa-journal-whills" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="View trade details"
                               aria-label="View details">
                                <i class="fas fa-eye" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="Edit trade"
                               aria-label="Edit trade">
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </a>
                        </div>
                    </td>
                </tr>

                <!-- Enterprise Trade Details Row - Single Row Layout -->
                <tr id="details-{{ trade.id }}" class="trade-details-row" style="display: none;" role="row">
                    <td colspan="12" class="p-0" role="gridcell">
                        <div class="trade-details-container" style="padding: 1rem;">
                            <div class="row g-3" style="margin: 0; display: flex; flex-wrap: nowrap;">
                                <!-- Entries & Exits Card -->
                                <div class="col-3" style="flex: 0 0 20%; max-width: 20%;">
                                    <div class="enterprise-module" style="height: 250px; margin-right: 12px;">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-exchange-alt module-icon"></i>
                                                Entries & Exits
                                            </div>
                                        </div>
                                        <div class="module-content">
                                            <!-- Entry Operations Section -->
                                            <div class="mb-4">
                                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Entry Operations</div>
                                                <div class="small text-muted mb-2">({{ trade.total_contracts_entered or 0 }} contracts @ avg {{ "{:.2f}".format(trade.average_entry_price) if trade.average_entry_price else 'N/A' }})</div>
                                                <div class="d-flex flex-column gap-1">
                                                    {% for entry in trade.entries %}
                                                    <div class="d-flex justify-content-between align-items-center small">
                                                        <span class="text-muted">#{{ loop.index }}:</span>
                                                        <span class="fw-500">{{ entry.contracts or 0 }} @ {{ "{:.2f}".format(entry.entry_price) if entry.entry_price else 'N/A' }}</span>
                                                        <span class="text-muted" style="font-size: 0.7rem;">{{ entry.entry_time.strftime('%H:%M') if entry.entry_time else 'N/A' }}</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>

                                            <!-- Exit Operations Section -->
                                            <div>
                                                <div class="fw-semibold text-danger mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Exit Operations</div>
                                                <div class="small text-muted mb-2">({{ trade.total_contracts_exited or 0 }} contracts @ avg {{ "{:.2f}".format(trade.average_exit_price) if trade.average_exit_price else 'N/A' }})</div>
                                                <div class="d-flex flex-column gap-1">
                                                    {% for exit in trade.exits %}
                                                    <div class="d-flex justify-content-between align-items-center small">
                                                        <span class="text-muted">#{{ loop.index }}:</span>
                                                        <span class="fw-500">{{ exit.contracts or 0 }} @ {{ "{:.2f}".format(exit.exit_price) if exit.exit_price else 'N/A' }}</span>
                                                        <span class="text-muted" style="font-size: 0.7rem;">{{ exit.exit_time.strftime('%H:%M') if exit.exit_time else 'N/A' }}</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Key Details Card -->
                                <div class="col-3" style="flex: 0 0 20%; max-width: 20%;">
                                    <div class="enterprise-module" style="height: 250px; margin-right: 12px;">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-info-circle module-icon"></i>
                                                Trade Metadata
                                            </div>
                                        </div>
                                        <div class="module-content">
                                            <div class="d-flex flex-column gap-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Date</div>
                                                    <div class="fw-600 small">{{ trade.trade_date.strftime('%m/%d/%Y') }}</div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Instrument</div>
                                                    <div class="fw-600 small">{{ trade.instrument or 'N/A' }}</div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Direction</div>
                                                    <div class="fw-600 small">
                                                        <span class="badge {% if trade.direction == 'Long' %}bg-success{% elif trade.direction == 'Short' %}bg-danger{% else %}bg-secondary{% endif %} badge-sm">
                                                            {{ trade.direction or 'N/A' }}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Strategy</div>
                                                    <div class="fw-600 small">{{ trade.trading_model.name if trade.trading_model else 'N/A' }}</div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Closure</div>
                                                    <div class="fw-600 small">{{ trade.how_closed or 'N/A' }}</div>
                                                </div>
                                                {% if trade.tags %}
                                                <div class="border-top pt-3">
                                                    <div class="fw-semibold text-muted mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Classification Tags</div>
                                                    <div class="d-flex flex-wrap gap-1">
                                                        {% for tag in trade.tags %}
                                                            <span class="status-badge me-1 mb-1 tag-{{ tag.color_category or 'neutral' }}">
                                                                {{ tag.name }}
                                                            </span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if trade.screenshot_link %}
                                                <div class="border-top pt-3">
                                                    <div class="fw-500 text-muted small mb-2">Documentation</div>
                                                    <a href="{{ trade.screenshot_link }}" target="_blank" class="btn btn-outline-primary btn-sm w-100">
                                                        <i class="fas fa-external-link-alt me-1"></i>View Screenshot
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Card -->
                                <div class="col-3" style="flex: 0 0 20%; max-width: 20%;">
                                    <div class="enterprise-module" style="height: 250px; margin-right: 12px;">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-chart-bar module-icon"></i>
                                                Performance Metrics
                                            </div>
                                        </div>
                                        <div class="module-content">
                                            <div class="d-flex flex-column gap-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Gross P&L</div>
                                                    <div class="fw-600 small {% if trade.pnl %}{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% endif %}{% endif %}">
                                                        {% if trade.pnl is not none %}
                                                            ${{ "{:,.2f}".format(trade.pnl) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">R-Multiple</div>
                                                    <div class="fw-600 small {% if trade.pnl_in_r %}{% if trade.pnl_in_r > 0 %}text-success{% elif trade.pnl_in_r < 0 %}text-danger{% endif %}{% endif %}">
                                                        {% if trade.pnl_in_r is not none %}
                                                            {{ "{:+.2f}".format(trade.pnl_in_r) }}R
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Initial SL</div>
                                                    <div class="fw-600 small">
                                                        {% if trade.initial_stop_loss is not none %}
                                                            {{ "{:.1f}".format(trade.initial_stop_loss) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Target Level</div>
                                                    <div class="fw-600 small">
                                                        {% if trade.terminus_target is not none %}
                                                            {{ "{:.1f}".format(trade.terminus_target) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">MAE</div>
                                                    <div class="fw-600 small text-danger">
                                                        {% if trade.mae is not none %}
                                                            {% set mae_dollars = trade.mae * (trade.instrument_multiplier or 25) %}
                                                            {% set mae_ticks = (trade.mae * 4)|round|int %}
                                                            <div>${{ "{:,.0f}".format(mae_dollars|abs) }}</div>
                                                            <div style="font-size: 0.65rem; opacity: 0.8;">{{ mae_ticks }} ticks | {{ "{:.1f}".format(trade.mae) }}pts</div>
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">MFE</div>
                                                    <div class="fw-600 small text-success">
                                                        {% if trade.mfe is not none %}
                                                            {% set mfe_dollars = trade.mfe * (trade.instrument_multiplier or 25) %}
                                                            {% set mfe_ticks = (trade.mfe * 4)|round|int %}
                                                            <div>${{ "{:,.0f}".format(mfe_dollars) }}</div>
                                                            <div style="font-size: 0.65rem; opacity: 0.8;">{{ mfe_ticks }} ticks | {{ "{:.1f}".format(trade.mfe) }}pts</div>
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="fw-500 text-muted small">Duration</div>
                                                    <div class="fw-600 small">
                                                        {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                                                            {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                                                            {% if time_diff >= 0 %}
                                                                {{ "%02dh %02dm"|format(time_diff // 60, time_diff % 60) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trade Ratings Card -->
                                <div class="col-3" style="flex: 0 0 40%; max-width: 40%;">
                                    <div class="enterprise-module" style="height: 250px;">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-star module-icon"></i>
                                                Execution Quality Assessment
                                            </div>
                                            <div class="module-meta">Performance Evaluation</div>
                                        </div>
                                        <div class="module-content">
                                            <div class="row h-100">
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column gap-2">
                                                        {% for rating_name, rating_value in [
                                                            ('Preparation', trade.preparation_rating),
                                                            ('Rules Adherence', trade.rules_rating),
                                                            ('Risk Management', trade.management_rating),
                                                            ('Target Achievement', trade.target_rating),
                                                            ('Entry Execution', trade.entry_rating)
                                                        ] %}
                                                        <div class="d-flex justify-content-between align-items-center" data-rating-category="{{ rating_name.lower().replace(' ', '_') }}" data-rating-value="{{ rating_value or 0 }}">
                                                            <div class="fw-500 text-muted small">{{ rating_name }}</div>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <div class="rating-dots">
                                                                    {% for i in range(1, 6) %}
                                                                        <div class="rating-dot {% if rating_value and i <= rating_value %}filled-{{ rating_value }}{% endif %}"></div>
                                                                    {% endfor %}
                                                                </div>
                                                                <span class="fw-600 small" style="min-width: 20px;">{{ rating_value or 0 }}/5</span>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6 d-flex align-items-center justify-content-center">
                                                    <div class="radar-chart-container-large">
                                                        <canvas id="radarChart-{{ trade.id }}" class="radar-chart-canvas-large" width="180" height="180"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="enterprise-module text-center">
        <div class="module-content py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Trading Operations Found</h4>
            <p class="text-muted mb-4">Begin by creating your first trade configuration to establish operational data.</p>
            <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Trade Configuration
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filter Trades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{{ url_for('trades.view_trades_list') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                       value="{{ request.args.get('start_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                       value="{{ request.args.get('end_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="instrument_filter" class="form-label">Instrument</label>
                                <select class="form-select" id="instrument_filter" name="instrument">
                                    <option value="">All Instruments</option>
                                    {% if filter_form and filter_form.instrument %}
                                        {% for value, label in filter_form.instrument.choices %}
                                            {% if value %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('instrument') == value else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="direction_filter" class="form-label">Direction</label>
                                <select class="form-select" id="direction_filter" name="direction">
                                    <option value="">All Directions</option>
                                    <option value="Long" {{ 'selected' if request.args.get('direction') == 'Long' else '' }}>Long</option>
                                    <option value="Short" {{ 'selected' if request.args.get('direction') == 'Short' else '' }}>Short</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="trading_model_filter" class="form-label">Trading Model</label>
                                <select class="form-select" id="trading_model_filter" name="trading_model_id">
                                    <option value="">All Models</option>
                                    {% if filter_form and filter_form.trading_model_id %}
                                        {% for value, label in filter_form.trading_model_id.choices %}
                                            {% if value and value != 0 %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('trading_model_id') == value|string else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="how_closed_filter" class="form-label">How Closed</label>
                                <select class="form-select" id="how_closed_filter" name="how_closed">
                                    <option value="">All</option>
                                    <option value="Target Hit" {{ 'selected' if request.args.get('how_closed') == 'Target Hit' else '' }}>Target Hit</option>
                                    <option value="Stop Loss" {{ 'selected' if request.args.get('how_closed') == 'Stop Loss' else '' }}>Stop Loss</option>
                                    <option value="Closed Manually" {{ 'selected' if request.args.get('how_closed') == 'Closed Manually' else '' }}>Closed Manually</option>
                                    <option value="Still Open" {{ 'selected' if request.args.get('how_closed') == 'Still Open' else '' }}>Still Open</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="is_dca_filter" class="form-label">DCA Trades</label>
                                <select class="form-select" id="is_dca_filter" name="is_dca">
                                    <option value="">All</option>
                                    <option value="true" {{ 'selected' if request.args.get('is_dca') == 'true' else '' }}>DCA Only</option>
                                    <option value="false" {{ 'selected' if request.args.get('is_dca') == 'false' else '' }}>Non-DCA Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="pnl_filter" class="form-label">P&L Filter</label>
                                <select class="form-select" id="pnl_filter" name="pnl_filter">
                                    <option value="">All Trades</option>
                                    <option value="winners" {{ 'selected' if request.args.get('pnl_filter') == 'winners' else '' }}>Winners Only</option>
                                    <option value="losers" {{ 'selected' if request.args.get('pnl_filter') == 'losers' else '' }}>Losers Only</option>
                                    <option value="breakeven" {{ 'selected' if request.args.get('pnl_filter') == 'breakeven' else '' }}>Breakeven</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_contracts_filter" class="form-label">Min Contracts</label>
                                <input type="number" class="form-control" id="min_contracts_filter" name="min_contracts"
                                       value="{{ request.args.get('min_contracts', '') }}" placeholder="e.g., 5">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="max_contracts_filter" class="form-label">Max Contracts</label>
                                <input type="number" class="form-control" id="max_contracts_filter" name="max_contracts"
                                       value="{{ request.args.get('max_contracts', '') }}" placeholder="e.g., 20">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_rating_filter" class="form-label">Min Rating</label>
                                <select class="form-select" id="min_rating_filter" name="min_rating">
                                    <option value="">Any Rating</option>
                                    <option value="1" {{ 'selected' if request.args.get('min_rating') == '1' else '' }}>1+</option>
                                    <option value="2" {{ 'selected' if request.args.get('min_rating') == '2' else '' }}>2+</option>
                                    <option value="3" {{ 'selected' if request.args.get('min_rating') == '3' else '' }}>3+</option>
                                    <option value="4" {{ 'selected' if request.args.get('min_rating') == '4' else '' }}>4+</option>
                                    <option value="5" {{ 'selected' if request.args.get('min_rating') == '5' else '' }}>5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_pnl_filter" class="form-label">Min P&L ($)</label>
                                <input type="number" class="form-control" id="min_pnl_filter" name="min_pnl" step="0.01"
                                       value="{{ request.args.get('min_pnl', '') }}" placeholder="e.g., -500">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_pnl_filter" class="form-label">Max P&L ($)</label>
                                <input type="number" class="form-control" id="max_pnl_filter" name="max_pnl" step="0.01"
                                       value="{{ request.args.get('max_pnl', '') }}" placeholder="e.g., 1000">
                            </div>
                        </div>
                    </div>

                    {% if categorized_tags %}
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="tags_filter" class="form-label">Tags</label>
                                <select multiple class="form-select" id="tags-filter-select" name="tags">
                                    {% for category_name, tag_options in categorized_tags %}
                                        <optgroup label="{{ category_name }}">
                                            {% for tag_id, tag_name, tag_color in tag_options %}
                                                <option value="{{ tag_id }}"
                                                        data-color="{{ tag_color or 'neutral' }}"
                                                        class="tag-{{ tag_color or 'neutral' }}"
                                                        {{ 'selected' if tag_id in request.args.getlist('tags') else '' }}>
                                                    {{ tag_name }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select multiple tags to filter by</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-warning">Clear All</a>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkOperationsModal" tabindex="-1" aria-labelledby="bulkOperationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkOperationsModalLabel">
                    <i class="fas fa-cogs me-2"></i>Bulk Configuration Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('trades.bulk_delete_trades') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Bulk Operation Warning:</strong> Selected configurations will be permanently removed from the system.
                    </div>
                    <div id="selectedTradesList" class="operation-list">
                        <!-- Selected trades will be populated here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancel Operation
                </button>
                <button type="button" class="btn btn-danger">
                    <i class="fas fa-trash-alt me-1"></i>Remove Selected Configurations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/enterprise-trades-list.js') }}"></script>
<script>
// =====================================
// TABLE SORTING
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortTable(sortKey);
        });
    });
});

function sortTable(field) {
    console.log('🔄 Sorting by field:', field);
    const currentUrl = new URL(window.location);
    const currentSort = currentUrl.searchParams.get('sort');
    const currentOrder = currentUrl.searchParams.get('order') || 'asc';

    let newOrder = 'asc';
    if (currentSort === field && currentOrder === 'asc') {
        newOrder = 'desc';
    }

    currentUrl.searchParams.set('sort', field);
    currentUrl.searchParams.set('order', newOrder);
    currentUrl.searchParams.set('page', '1');

    window.location.href = currentUrl.toString();
}

// =====================================
// PAGE SIZE DROPDOWN & PAGINATION
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    // Page size dropdown functionality
    const pageSizeDropdown = document.getElementById('pageSizeDropdown');
    if (pageSizeDropdown) {
        pageSizeDropdown.addEventListener('change', function() {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('per_page', this.value);
            currentUrl.searchParams.delete('page'); // Reset to first page
            window.location.href = currentUrl.toString();
        });
    }
    
    // Pagination arrow clicks functionality
    const paginationArrows = document.querySelectorAll('.pagination-arrow-borderless:not(.disabled)');
    paginationArrows.forEach(arrow => {
        if (arrow.href) {
            arrow.addEventListener('click', function(e) {
                // Allow normal navigation
                console.log('Navigating to:', this.href);
            });
        }
    });
    
    console.log('Pagination system initialized');
});

// =====================================
// EXPORT FUNCTIONS
// =====================================
function exportTradesCSV() {
    const exportBtn = document.querySelector('button[onclick="exportTradesCSV()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;
    
    fetch('/trades/export-csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('CSV export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Trading_Operations_Export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        if (typeof showSuccess === 'function') {
            showSuccess('Trading data exported to CSV successfully.', 'CSV Export Complete');
        } else {
            alert('CSV export completed successfully.');
        }
    })
    .catch(error => {
        console.error('CSV Export error:', error);
        if (typeof showErrorMessage === 'function') {
            showErrorMessage('CSV export failed. Please try again.');
        } else {
            alert('CSV export failed. Please try again.');
        }
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

// =====================================
// UTILITY FUNCTIONS
// =====================================
function getCSRFToken() {
    let csrfToken = null;
    
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.getAttribute('content')) {
        csrfToken = metaTag.getAttribute('content');
    }
    
    if (!csrfToken) {
        const hiddenInput = document.querySelector('input[name="csrf_token"]');
        if (hiddenInput && hiddenInput.value) {
            csrfToken = hiddenInput.value;
        }
    }
    
    return csrfToken;
}
</script>
{% endblock %}