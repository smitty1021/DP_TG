{% extends "base.html" %}

{% block title %}Trading Operations Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="executive-title">
                <i class="fas fa-chart-line executive-icon"></i>
                Trading Operations Center
            </h1>
            <p class="executive-subtitle">Strategic Trading Activity Management & Performance Analysis</p>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('main.index') }}'"
                    title="Go to Main Dashboard">
                <i class="fas fa-home"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                    title="New Trade Configuration">
                <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="location.reload()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="history.back();"
                    title="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <a href="{{ url_for('trades.import_trades') }}" class="btn btn-outline-secondary btn-sm" title="Import Trades">
                    <i class="fas fa-upload me-1"></i>
                </a>
            <a href="{{ url_for('trades.export_trades_csv') }}" class="btn btn-outline-secondary btn-sm" title="Export Trades">
                <i class="fas fa-download me-1"></i>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid mt-4">
    <!-- Performance KPI Section -->
    {% if trades %}
    <div class="kpi-section mb-4">
        <div class="grid grid-cols-4 gap-3">
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-primary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Total Trades</div>
                        <div class="kpi-value">{{ pagination.total if pagination else trades|length }}</div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-success position-relative">
                        <canvas id="winLossChart" width="40" height="40" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></canvas>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Win/Loss Distribution</div>
                        <div class="kpi-value">
                            {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                            {% set losing = trades|selectattr('pnl', 'lessthan', 0)|list|length %}
                            {% set breakeven = trades|selectattr('pnl', 'equalto', 0)|list|length %}
                            <small>W: {{ profitable }} | L: {{ losing }} | BE: {{ breakeven }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-warning">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Strike Rate</div>
                        <div class="kpi-value">
                            {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                            {% set total_with_pnl = trades|selectattr('pnl', 'number')|list|length %}
                            {{ "%.1f"|format((profitable / total_with_pnl * 100) if total_with_pnl > 0 else 0) }}%
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-info">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Cumulative P&L</div>
                        <div class="kpi-value">
                            {% set total_pnl = 0 %}
                            {% for trade in trades %}
                                {% if trade.pnl %}
                                    {% set total_pnl = total_pnl + trade.pnl %}
                                {% endif %}
                            {% endfor %}
                            {% if total_pnl > 0 %}
                                <span class="text-success">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% elif total_pnl < 0 %}
                                <span class="text-danger">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% else %}
                                <span class="text-muted">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Compact Filter Notification Bar (Single Line) -->
    {% set active_filters = [] %}
    {% if request.args.get('start_date') %}
        {% set _ = active_filters.append('Start Date: ' + request.args.get('start_date')) %}
    {% endif %}
    {% if request.args.get('end_date') %}
        {% set _ = active_filters.append('End Date: ' + request.args.get('end_date')) %}
    {% endif %}
    {% if request.args.get('instrument') and request.args.get('instrument') != '' %}
        {% set instrument_id = request.args.get('instrument') %}
        {% set instrument_dict = dict(filter_form.instrument.choices) %}
        {% set instrument_label = instrument_dict.get(instrument_id, instrument_id) %}
        {% set _ = active_filters.append('Instrument: ' + instrument_label) %}
    {% endif %}
    {% if request.args.get('direction') %}
        {% set _ = active_filters.append('Direction: ' + request.args.get('direction')) %}
    {% endif %}
    {% if request.args.get('trading_model_id') and request.args.get('trading_model_id') != '0' %}
        {% set model_id = request.args.get('trading_model_id') %}
        {% set model_dict = dict(filter_form.trading_model_id.choices) %}
        {% set model_label = model_dict.get(model_id|int, model_id) %}
        {% set _ = active_filters.append('Model: ' + model_label) %}
    {% endif %}
    {% if request.args.get('how_closed') %}
        {% set _ = active_filters.append('How Closed: ' + request.args.get('how_closed')) %}
    {% endif %}
    {% if request.args.get('pnl_filter') %}
        {% if request.args.get('pnl_filter') == 'winners' %}
            {% set _ = active_filters.append('P&L: Winners Only') %}
        {% elif request.args.get('pnl_filter') == 'losers' %}
            {% set _ = active_filters.append('P&L: Losers Only') %}
        {% elif request.args.get('pnl_filter') == 'breakeven' %}
            {% set _ = active_filters.append('P&L: Breakeven') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('is_dca') %}
        {% if request.args.get('is_dca') == 'true' %}
            {% set _ = active_filters.append('DCA: Yes') %}
        {% elif request.args.get('is_dca') == 'false' %}
            {% set _ = active_filters.append('DCA: No') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('min_contracts') %}
        {% set _ = active_filters.append('Min Contracts: ' + request.args.get('min_contracts')) %}
    {% endif %}
    {% if request.args.get('max_contracts') %}
        {% set _ = active_filters.append('Max Contracts: ' + request.args.get('max_contracts')) %}
    {% endif %}
    {% if request.args.get('min_rating') %}
        {% set _ = active_filters.append('Min Rating: ' + request.args.get('min_rating') + '+') %}
    {% endif %}
    {% if request.args.get('min_pnl') %}
        {% set _ = active_filters.append('Min P&L: $' + request.args.get('min_pnl')) %}
    {% endif %}
    {% if request.args.get('max_pnl') %}
        {% set _ = active_filters.append('Max P&L: $' + request.args.get('max_pnl')) %}
    {% endif %}

    {% if request.args.get('tags') or request.args.getlist('tags') %}
        {% set selected_tag_ids = request.args.getlist('tags') if request.args.getlist('tags') else [request.args.get('tags')] %}
        {% for tag_id in selected_tag_ids %}
            {% if tag_id and tag_id.strip() %}
                {% set ns = namespace(tag_label=tag_id, tag_color='neutral') %}

                {% if categorized_tags %}
                    {% for category_name, tag_options in categorized_tags %}
                        {% for tag_option_id, tag_option_name, tag_option_color in tag_options %}
                            {% if tag_option_id == tag_id %}
                                {% set ns.tag_label = tag_option_name %}
                                {% set ns.tag_color = tag_option_color or 'neutral' %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
                {% set _ = active_filters.append(('Tag', ns.tag_label, ns.tag_color)) %}
            {% endif %}
        {% endfor %}
    {% endif %}
</div>
<div class="enterprise-container.p-0">
    <!-- Pagination and Action Buttons Row -->
    <div class="d-flex justify-content-center align-items-center position-relative">
        <div class="d-flex align-items-center">
            {% if pagination.page > 1 %}
            {% set args_without_page = request.args.copy() %}
            {% set _ = args_without_page.pop('page', None) %}
            <a href="{{ url_for('trades.view_trades_list', page=1, **args_without_page) }}"
               class="pagination-arrow-borderless" title="First Page">
                <i class="fas fa-angle-double-left"></i>
            </a>
            {% else %}
            <span class="pagination-arrow-borderless disabled" title="First Page">
                <i class="fas fa-angle-double-left"></i>
            </span>
            {% endif %}

            {% if pagination.has_prev %}
            {% set args_without_page = request.args.copy() %}
            {% set _ = args_without_page.pop('page', None) %}
            <a href="{{ url_for('trades.view_trades_list', page=pagination.prev_num, **args_without_page) }}"
               class="pagination-arrow-borderless" title="Previous Page">
                <i class="fas fa-angle-left"></i>
            </a>
            {% else %}
            <span class="pagination-arrow-borderless disabled" title="Previous Page">
                <i class="fas fa-angle-left"></i>
            </span>
            {% endif %}

            <span class="pagination-info">
                Page {{ pagination.page }} of {{ pagination.pages }}
            </span>

            {% if pagination.has_next %}
            {% set args_without_page = request.args.copy() %}
            {% set _ = args_without_page.pop('page', None) %}
            <a href="{{ url_for('trades.view_trades_list', page=pagination.next_num, **args_without_page) }}"
               class="pagination-arrow-borderless" title="Next Page">
                <i class="fas fa-angle-right"></i>
            </a>
            {% else %}
            <span class="pagination-arrow-borderless disabled" title="Next Page">
                <i class="fas fa-angle-right"></i>
            </span>
            {% endif %}

            {% if pagination.page < pagination.pages %}
            {% set args_without_page = request.args.copy() %}
            {% set _ = args_without_page.pop('page', None) %}
            <a href="{{ url_for('trades.view_trades_list', page=pagination.pages, **args_without_page) }}"
               class="pagination-arrow-borderless" title="Last Page">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% else %}
            <span class="pagination-arrow-borderless disabled" title="Last Page">
                <i class="fas fa-angle-double-right"></i>
            </span>
            {% endif %}
        </div>
        <div class="position-absolute start-0 d-flex align-items-center">
            <span class="text-secondary me-2">Table Size:</span>
            <select id="pageSizeDropdown" class="pagination-page-size"
                    onchange="changePageSize(this.value)" title="Trades per page">
                <option value="25" {{ 'selected' if request.args.get('per_page', '25')|string == '25' else '' }}>25</option>
                <option value="50" {{ 'selected' if request.args.get('per_page', '25')|string == '50' else '' }}>50</option>
                <option value="100" {{ 'selected' if request.args.get('per_page', '25')|string == '100' else '' }}>100</option>
                <option value="250" {{ 'selected' if request.args.get('per_page', '25')|string == '250' else '' }}>250</option>
            </select>
        </div>
        <div class="position-absolute end-0">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-primary-borderonly btn-sm" type="button" data-bs-toggle="modal"
                        data-bs-target="#filterModal" title="Filter Trades (Ctrl+F)">
                    <i class="fas fa-filter me-1"></i> Filter Trades
                </button>
            </div>
        </div>
    </div>
    <!-- Compact Single-Line Filter Notification -->
    {% if active_filters %}
    <div class="d-flex align-items-center justify-content-between py-2 px-3 mt-2 mb-1" style="background-color: var(--bs-info-bg-subtle); border: 1px solid var(--bs-info-border-subtle); border-radius: 0.375rem; font-size: 0.875rem;">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <i class="fas fa-filter text-info"></i>
            <span class="fw-semibold text-info">Filtered by:</span>
            {% for filter in active_filters %}
                {% if filter is sequence and filter|length == 3 and filter[0] == 'Tag' %}
                    <!-- Tag with color coding -->
                    <span class="badge tag-{{ filter[2] }}" style="
                        background-color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-bg-subtle) !important;
                        border-color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-border-subtle) !important;
                        color: var(--bs-{{
                            'success' if filter[2] == 'good' else
                            'danger' if filter[2] == 'bad' else
                            'primary'
                        }}-text-emphasis) !important;
                        border: 1px solid;
                        font-size: 0.75rem;
                    ">
                        {{ filter[0] }}: {{ filter[1] }}
                    </span>
                {% else %}
                    <!-- Regular filter badge -->
                    <span class="badge bg-light" style="font-size: 0.75rem;">{{ filter }}</span>
                {% endif %}
            {% endfor %}
        </div>
        <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-info btn-sm" title="Clear all filters" style="font-size: 0.75rem;">
            <i class="fas fa-times me-1"></i>Clear
        </a>
    </div>
    {% endif %}
    <!-- Trade Operations Data Table -->
    {% if trades %}
    <div class="enterprise-module mb-4 mt-1">
        <div class="module-header">
            <span class="module-title">
                <i class="fas fa-database module-icon"></i>
                Trading Operations Data Repository
            </span>
            <span class="module-meta">Trades {{ pagination.per_page * (pagination.page - 1) + 1 }} - {{ pagination.per_page * (pagination.page - 1) + trades|length }} of {{ pagination.total }} Displayed</span>
        </div>
        <div class="module-content.p-0">
            <div class="table-container" role="region" aria-label="Trades List">
            <table class="table table-hover table-striped mb-0 table-fixed" role="table">
                <thead class="sticky-header">
                    <tr role="row">
                        <th width="1" class="text-center table-header-clean" role="columnheader"></th>
                        <th width="65" class="sortable" data-sort="date" role="columnheader" tabindex="0"
                            aria-label="Sort by Date">
                            Date <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="35" class="sortable" data-sort="instrument" role="columnheader" tabindex="0"
                            aria-label="Sort by Instrument">
                            Sym <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="85" class="sortable" data-sort="model" role="columnheader" tabindex="0"
                            aria-label="Sort by Trading Model">
                            Model <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="45" class="sortable" data-sort="direction" role="columnheader" tabindex="0"
                            aria-label="Sort by Direction">
                            Dir <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="35" class="sortable" data-sort="contracts" role="columnheader" tabindex="0"
                            aria-label="Sort by Contracts">
                            Qty <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="45" class="sortable" data-sort="entry_time" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Time">
                            Time <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="55" class="sortable" data-sort="entry" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Price">
                            Entry <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="55" class="sortable" data-sort="exit" role="columnheader" tabindex="0"
                            aria-label="Sort by Exit Price">
                            Exit <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="65" class="sortable" data-sort="time_in_trade" role="columnheader" tabindex="0"
                            aria-label="Sort by Time in Trade">
                            Duration <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="75" class="sortable" data-sort="how_closed" role="columnheader" tabindex="0"
                            aria-label="Sort by How Closed">
                            Closed <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="50" class="sortable" data-sort="avg_rating" role="columnheader" tabindex="0"
                            aria-label="Sort by Trade Rating">
                            Rating <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="65" class="sortable" data-sort="pnl" role="columnheader" tabindex="0"
                            aria-label="Sort by P&L">
                            P&L <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th width="85" role="columnheader"></th>
                    </tr>
                </thead>
                <tbody>

<!-- Section 16 -- HTML CONTENT: Trade Rows (Part 1) -->

                {% for trade in trades %}
                <!-- Enhanced Trade Row with clean styling -->
                <tr class="trade-row
                    {% if trade.pnl and trade.pnl > 0 %}table-success-subtle
                    {% elif trade.pnl and trade.pnl < 0 %}table-danger-subtle
                    {% endif %}"
                    data-trade-id="{{ trade.id }}" role="row" tabindex="0"
                    aria-label="Trade {{ trade.trade_date.strftime('%m/%d/%Y') }} {{ trade.instrument }} {{ trade.direction }}">

                    <!-- Enhanced Dropdown Arrow -->
                    <td class="text-center" role="gridcell">
                        <i class="fas fa-chevron-right chevron-icon" id="chevron-{{ trade.id }}"
                           aria-hidden="true"></i>
                    </td>

                    <!-- Date -->
                    <td role="gridcell">{{ trade.trade_date.strftime('%d %b %y') }}</td>

                    <!-- Instrument -->
                    <td role="gridcell">{{ trade.instrument or 'N/A' }}</td>

                    <!-- Enhanced Model with tooltip -->
                    <td role="gridcell" title="{% if trade.trading_model %}{{ trade.trading_model.name }}{% else %}No model specified{% endif %}">
                        {% if trade.trading_model %}
                            {{ trade.trading_model.name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Enhanced Direction -->
                    <td role="gridcell">
                        {% if trade.direction == 'Long' %}
                            <span class="badge-transparent" style="color: #198754 !important; font-weight: bold;"
                                  aria-label="Long position">{{ trade.direction }}</span>
                        {% elif trade.direction == 'Short' %}
                            <span class="badge-transparent" style="color: #dc3545 !important; font-weight: bold;"
                                  aria-label="Short position">{{ trade.direction }}</span>
                        {% else %}
                            <span class="badge-transparent" style="color: #6c757d !important; font-weight: bold;">{{ trade.direction or 'N/A' }}</span>
                        {% endif %}
                    </td>

                    <!-- Contracts -->
                    <td role="gridcell">{{ trade.total_contracts_entered or 0 }}</td>

                    <!-- Entry Time -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.entries.first().entry_time %}
                            {{ trade.entries.first().entry_time.strftime('%H:%M') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Entry Price -->
                    <td role="gridcell">
                        {% if trade.average_entry_price %}
                            {{ "{:.2f}".format(trade.average_entry_price) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Exit Price -->
                    <td role="gridcell">
                        {% if trade.average_exit_price %}
                            {{ "{:.2f}".format(trade.average_exit_price) }}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted" aria-label="Position still open">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>

<!-- Section 17 -- HTML CONTENT: Trade Rows (Part 2) -->

                    <!-- Enhanced Time in Trade -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                            {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                            {% if time_diff >= 0 %}
                                <span>{{ trade.time_in_trade }}</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- How Closed -->
                    <td role="gridcell">
                        {% if trade.how_closed %}
                            <span class="how-closed-text">{{ trade.how_closed }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Enhanced Trade Rating with accessibility -->
                    <td role="gridcell">
                        {% set ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                        {% set valid_ratings = ratings|select('ne', none)|list %}
                        {% if valid_ratings %}
                            {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                            {% if avg_rating >= 4.0 %}
                                <span style="color: #198754; font-weight: bold;" aria-label="High rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% elif avg_rating >= 2.5 %}
                                <span style="color: #ffc107; font-weight: bold;" aria-label="Medium rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% else %}
                                <span style="color: #dc3545; font-weight: bold;" aria-label="Low rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% endif %}
                        {% else %}
                            <span aria-label="No rating available">N/A</span>
                        {% endif %}
                    </td>

                    <!-- Enhanced P&L with no + sign for winners -->
                    <td role="gridcell">
                        {% if trade.pnl is not none %}
                            {% if trade.pnl > 0 %}
                                <span style="color: #198754; font-weight: bold;" aria-label="Profit: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% elif trade.pnl < 0 %}
                                <span style="color: #dc3545; font-weight: bold;" aria-label="Loss: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% else %}
                                <span style="color: #6c757d; font-weight: bold;" aria-label="Break even: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% endif %}
                        {% else %}
                            <span aria-label="P&L not available">N/A</span>
                        {% endif %}
                    </td>

                    <!-- Enhanced Actions with better accessibility -->
                    <td class="text-end" onclick="event.stopPropagation();" role="gridcell">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Trade actions">
                            <a href="{{ url_for('journal.manage_daily_journal', date_str=trade.trade_date.strftime('%Y-%m-%d')) }}"
                               class="btn btn-outline-secondary btn-sm" title="Daily Journal for {{ trade.trade_date.strftime('%m/%d/%Y') }}"
                               aria-label="View daily journal">
                                <i class="fas fa-journal-whills" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="View trade details"
                               aria-label="View details">
                                <i class="fas fa-eye" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="Edit trade"
                               aria-label="Edit trade">
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </a>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                    title="Delete trade"
                                    aria-label="Delete trade"
                                    onclick="confirmSingleDelete({{ trade.id }}, '{{ trade.trade_date.strftime('%m/%d/%Y') }}', '{{ trade.instrument }}', '{{ trade.direction }}')">
                                <i class="fas fa-trash-alt" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                </tr>

<!-- Section 18 -- HTML CONTENT: Trade Details Container -->

                <!-- Enhanced Trade Details Row with card-based layout -->
                <tr id="details-{{ trade.id }}" class="trade-details-row" style="display: none;" role="row">
                    <td colspan="14" class="p-0" role="gridcell">
                        <div class="trade-details-container">
                            <div class="details-cards-row">
                                <!-- Entries & Exits Card -->
                                <div class="details-card entries-exits-card">
                                    <div class="card-header">Entries & Exits</div>
                                    <div class="card-content">
                                        <!-- Entry Points Section -->
                                        <div class="entry-points-section">
                                            <div class="section-header-line">
                                                <span class="section-label">Entries</span>
                                                <span class="section-summary">({{ trade.total_contracts_entered or 0 }} total contracts @ avg {{ "{:.2f}".format(trade.average_entry_price) if trade.average_entry_price else 'N/A' }})</span>
                                            </div>
                                            <div class="transactions-list">
                                                {% for entry in trade.entries %}
                                                <div class="transaction-line">
                                                    #{{ loop.index }}: {{ entry.contracts or 0 }} contracts @ {{ "{:.2f}".format(entry.entry_price) if entry.entry_price else 'N/A' }} (Time: {{ entry.entry_time.strftime('%H:%M') if entry.entry_time else 'N/A' }})
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <!-- Exit Points Section -->
                                        <div class="exit-points-section">
                                            <div class="section-header-line">
                                                <span class="section-label">Exits</span>
                                                <span class="section-summary">({{ trade.total_contracts_exited or 0 }} total contracts @ avg {{ "{:.2f}".format(trade.average_exit_price) if trade.average_exit_price else 'N/A' }})</span>
                                            </div>
                                            <div class="transactions-list">
                                                {% for exit in trade.exits %}
                                                <div class="transaction-line">
                                                    #{{ loop.index }}: {{ exit.contracts or 0 }} contracts @ {{ "{:.2f}".format(exit.exit_price) if exit.exit_price else 'N/A' }} (Time: {{ exit.exit_time.strftime('%H:%M') if exit.exit_time else 'N/A' }})
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Key Details Card -->
                                <div class="details-card key-details-card">
                                    <div class="card-header">Key Details</div>
                                    <div class="card-content">
                                        <div class="details-list">
                                            <div class="detail-item">
                                                <span class="label">Date:</span>
                                                <span class="value">{{ trade.trade_date.strftime('%d-%b-%Y') }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Instrument:</span>
                                                <span class="value">{{ trade.instrument or 'N/A' }}</span>
                                            </div>

                                            <div class="detail-item">
                                                <span class="label">Direction:</span>
                                                <span class="value">
                                                    <span class="direction-badge {% if trade.direction == 'Long' %}long{% elif trade.direction == 'Short' %}short{% endif %}">
                                                        {{ trade.direction or 'N/A' }}
                                                    </span>
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Trading Model:</span>
                                                <span class="value">{{ trade.trading_model.name if trade.trading_model else 'N/A' }}</span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">How Closed:</span>
                                                <span class="value">{{ trade.how_closed or 'N/A' }}</span>
                                            </div>
                                            <div class="detail-item tags-item">
                                                <span class="label">Tags:</span>
                                                <div class="value tags-container">
                                                    {% if trade.tags %}
                                                        {% for tag in trade.tags %}
                                                            <span class="tag-badge tag-{{ tag.color_category or 'neutral' }}">{{ tag.name }}</span>
                                                        {% endfor %}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </div>
                                            </div>


                                            <div class="detail-item">
                                                <span class="label">Screenshot:</span>
                                                <span class="value">
                                                    {% if trade.screenshot_link %}
                                                        <a href="{{ trade.screenshot_link }}" target="_blank" class="screenshot-link">View Screenshot</a>
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>


                                    </div>
                                </div>

                                <!-- Performance Card -->
                                <div class="details-card performance-card">
                                    <div class="card-header">Performance</div>
                                    <div class="card-content">
                                        <div class="details-list">
                                            <div class="detail-item">
                                                <span class="label">Gross P&L:</span>
                                                <span class="value {% if trade.pnl %}{% if trade.pnl > 0 %}profit{% elif trade.pnl < 0 %}loss{% endif %}{% endif %}">
                                                    {% if trade.pnl is not none %}
                                                        ${{ "{:,.2f}".format(trade.pnl) }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">R-Value:</span>
                                                <span class="value {% if trade.pnl_in_r %}{% if trade.pnl_in_r > 0 %}profit{% elif trade.pnl_in_r < 0 %}loss{% endif %}{% endif %}">
                                                    {% if trade.pnl_in_r is not none %}
                                                        {{ "{:+.2f}".format(trade.pnl_in_r) }}R
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Initial SL:</span>
                                                <span class="value">
                                                    {% if trade.initial_stop_loss is not none %}
                                                        {{ "{:.1f}".format(trade.initial_stop_loss) }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Terminus Target:</span>
                                                <span class="value">
                                                    {% if trade.terminus_target is not none %}
                                                        {{ "{:.1f}".format(trade.terminus_target) }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">MAE:</span>
                                                <span class="value loss">
                                                    {% if trade.mae is not none and trade.average_entry_price %}
                                                        {% set mae_percent = ((trade.mae / trade.average_entry_price) * 100) %}
                                                        {% set mae_dollar = (trade.mae * (trade.total_contracts_entered or 0)) %}
                                                        {{ "{:.1f}".format(trade.mae) }} pts / {{ "{:.2f}".format(mae_percent) }}% / ${{ "{:.0f}".format(mae_dollar) }}
                                                    {% elif trade.mae is not none %}
                                                        {{ "{:.1f}".format(trade.mae) }} pts
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">MFE:</span>
                                                <span class="value profit">
                                                    {% if trade.mfe is not none and trade.average_entry_price %}
                                                        {% set mfe_percent = ((trade.mfe / trade.average_entry_price) * 100) %}
                                                        {% set mfe_dollar = (trade.mfe * (trade.total_contracts_entered or 0)) %}
                                                        {{ "{:.1f}".format(trade.mfe) }} pts / {{ "{:.2f}".format(mfe_percent) }}% / ${{ "{:.0f}".format(mfe_dollar) }}
                                                    {% elif trade.mfe is not none %}
                                                        {{ "{:.1f}".format(trade.mfe) }} pts
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="detail-item">
                                                <span class="label">Time in Trade:</span>
                                                <span class="value">
                                                    {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                                                        {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                                                        {% if time_diff >= 0 %}
                                                            {{ "%02dh %02dm"|format(time_diff // 60, time_diff % 60) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trade Ratings Card -->
                                <div class="details-card ratings-card">
                                    <div class="card-header">Trade Ratings</div>
                                    <div class="card-content">
                                        <div class="ratings-layout">
                                            <div class="ratings-left">
                                                {% for rating_name, rating_value in [
                                                    ('Preparation', trade.preparation_rating),
                                                    ('Rules', trade.rules_rating),
                                                    ('Management', trade.management_rating),
                                                    ('Target', trade.target_rating),
                                                    ('Entry', trade.entry_rating)
                                                ] %}
                                                <div class="rating-item" data-rating-category="{{ rating_name.lower() }}" data-rating-value="{{ rating_value or 0 }}">
                                                    <span class="rating-name">{{ rating_name }}</span>
                                                    <div class="rating-dots">
                                                        {% for i in range(1, 6) %}
                                                            <div class="rating-dot {% if rating_value and i <= rating_value %}filled-{{ rating_value }}{% endif %}"></div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>

                                            <div class="ratings-right">
                                                <canvas id="radarChart-{{ trade.id }}" class="radar-chart-canvas" width="240" height="240"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="enterprise-module text-center">
        <div class="module-content py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Trading Operations Found</h4>
            <p class="text-muted mb-4">Begin by creating your first trade configuration to establish operational data.</p>
            <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Trade Configuration
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Advanced Filter Modal -->
<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filter Trades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{{ url_for('trades.view_trades_list') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                       value="{{ request.args.get('start_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                       value="{{ request.args.get('end_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="instrument_filter" class="form-label">Instrument</label>
                                <select class="form-select" id="instrument_filter" name="instrument">
                                    <option value="">All Instruments</option>
                                    {% if filter_form and filter_form.instrument %}
                                        {% for value, label in filter_form.instrument.choices %}
                                            {% if value %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('instrument') == value else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="direction_filter" class="form-label">Direction</label>
                                <select class="form-select" id="direction_filter" name="direction">
                                    <option value="">All Directions</option>
                                    <option value="Long" {{ 'selected' if request.args.get('direction') == 'Long' else '' }}>Long</option>
                                    <option value="Short" {{ 'selected' if request.args.get('direction') == 'Short' else '' }}>Short</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="trading_model_filter" class="form-label">Trading Model</label>
                                <select class="form-select" id="trading_model_filter" name="trading_model_id">
                                    <option value="">All Models</option>
                                    {% if filter_form and filter_form.trading_model_id %}
                                        {% for value, label in filter_form.trading_model_id.choices %}
                                            {% if value and value != 0 %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('trading_model_id') == value|string else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="how_closed_filter" class="form-label">How Closed</label>
                                <select class="form-select" id="how_closed_filter" name="how_closed">
                                    <option value="">All</option>
                                    <option value="Target Hit" {{ 'selected' if request.args.get('how_closed') == 'Target Hit' else '' }}>Target Hit</option>
                                    <option value="Stop Loss" {{ 'selected' if request.args.get('how_closed') == 'Stop Loss' else '' }}>Stop Loss</option>
                                    <option value="Closed Manually" {{ 'selected' if request.args.get('how_closed') == 'Closed Manually' else '' }}>Closed Manually</option>
                                    <option value="Still Open" {{ 'selected' if request.args.get('how_closed') == 'Still Open' else '' }}>Still Open</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="is_dca_filter" class="form-label">DCA Trades</label>
                                <select class="form-select" id="is_dca_filter" name="is_dca">
                                    <option value="">All</option>
                                    <option value="true" {{ 'selected' if request.args.get('is_dca') == 'true' else '' }}>DCA Only</option>
                                    <option value="false" {{ 'selected' if request.args.get('is_dca') == 'false' else '' }}>Non-DCA Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="pnl_filter" class="form-label">P&L Filter</label>
                                <select class="form-select" id="pnl_filter" name="pnl_filter">
                                    <option value="">All Trades</option>
                                    <option value="winners" {{ 'selected' if request.args.get('pnl_filter') == 'winners' else '' }}>Winners Only</option>
                                    <option value="losers" {{ 'selected' if request.args.get('pnl_filter') == 'losers' else '' }}>Losers Only</option>
                                    <option value="breakeven" {{ 'selected' if request.args.get('pnl_filter') == 'breakeven' else '' }}>Breakeven</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_contracts_filter" class="form-label">Min Contracts</label>
                                <input type="number" class="form-control" id="min_contracts_filter" name="min_contracts"
                                       value="{{ request.args.get('min_contracts', '') }}" placeholder="e.g., 5">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="max_contracts_filter" class="form-label">Max Contracts</label>
                                <input type="number" class="form-control" id="max_contracts_filter" name="max_contracts"
                                       value="{{ request.args.get('max_contracts', '') }}" placeholder="e.g., 20">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_rating_filter" class="form-label">Min Rating</label>
                                <select class="form-select" id="min_rating_filter" name="min_rating">
                                    <option value="">Any Rating</option>
                                    <option value="1" {{ 'selected' if request.args.get('min_rating') == '1' else '' }}>1+</option>
                                    <option value="2" {{ 'selected' if request.args.get('min_rating') == '2' else '' }}>2+</option>
                                    <option value="3" {{ 'selected' if request.args.get('min_rating') == '3' else '' }}>3+</option>
                                    <option value="4" {{ 'selected' if request.args.get('min_rating') == '4' else '' }}>4+</option>
                                    <option value="5" {{ 'selected' if request.args.get('min_rating') == '5' else '' }}>5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_pnl_filter" class="form-label">Min P&L ($)</label>
                                <input type="number" class="form-control" id="min_pnl_filter" name="min_pnl" step="0.01"
                                       value="{{ request.args.get('min_pnl', '') }}" placeholder="e.g., -500">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_pnl_filter" class="form-label">Max P&L ($)</label>
                                <input type="number" class="form-control" id="max_pnl_filter" name="max_pnl" step="0.01"
                                       value="{{ request.args.get('max_pnl', '') }}" placeholder="e.g., 1000">
                            </div>
                        </div>
                    </div>

                    {% if categorized_tags %}
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="tags_filter" class="form-label">Tags</label>
                                <select multiple class="form-select" id="tags-filter-select" name="tags">
                                    {% for category_name, tag_options in categorized_tags %}
                                        <optgroup label="{{ category_name }}">
                                            {% for tag_id, tag_name, tag_color in tag_options %}
                                                <option value="{{ tag_id }}"
                                                        data-color="{{ tag_color or 'neutral' }}"
                                                        class="tag-{{ tag_color or 'neutral' }}"
                                                        {{ 'selected' if tag_id in request.args.getlist('tags') else '' }}>
                                                    {{ tag_name }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select multiple tags to filter by</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-warning">Clear All</a>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkOperationsModal" tabindex="-1" aria-labelledby="bulkOperationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkOperationsModalLabel">
                    <i class="fas fa-cogs me-2"></i>Bulk Configuration Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('trades.bulk_delete_trades') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Bulk Operation Warning:</strong> Selected configurations will be permanently removed from the system.
                    </div>
                    <div id="selectedTradesList" class="operation-list">
                        <!-- Selected trades will be populated here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancel Operation
                </button>
                <button type="button" class="btn btn-danger" onclick="executeBulkDelete()">
                    <i class="fas fa-trash-alt me-1"></i>Remove Selected Configurations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/enterprise-trades-list.js') }}"></script>

<!-- Clean JavaScript implementation -->
<script>
/**
 * Clean Enterprise Trading Operations JavaScript
 * Simple, working implementation focused on dropdown functionality and charts
 */

console.log(' Loading clean enterprise trades script...');

// Simple dropdown toggle function
function toggleTradeDetails(tradeId) {
    console.log(' Attempting to toggle trade details for ID:', tradeId);

    const detailsRow = document.getElementById(`details-${tradeId}`);
    const chevron = document.getElementById(`chevron-${tradeId}`);

    console.log('Details row found:', detailsRow);
    console.log('Chevron found:', chevron);

    if (detailsRow) {
        const isHidden = detailsRow.classList.contains('d-none');
        console.log('Currently hidden:', isHidden);

        if (isHidden) {
            detailsRow.classList.remove('d-none');
            if (chevron) {
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            }
            // Initialize radar chart when expanding
            setTimeout(() => {
                initializeRadarChart(tradeId);
            }, 100);
            console.log(' Expanded trade details');
        } else {
            detailsRow.classList.add('d-none');
            if (chevron) {
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
            console.log(' Collapsed trade details');
        }
    } else {
        console.error(' Details row not found for trade ID:', tradeId);
    }
}

// Radar Chart Implementation
function initializeRadarChart(tradeId) {
    const canvas = document.getElementById(`radarChart-${tradeId}`);
    if (!canvas || canvas.hasAttribute('data-chart-initialized')) {
        return;
    }

    console.log(' Initializing radar chart for trade:', tradeId);

    try {
        const ratings = extractTradeRatings(tradeId);
        if (ratings && Object.keys(ratings).length > 0) {
            renderRadarChart(canvas, ratings);
            canvas.setAttribute('data-chart-initialized', 'true');
        } else {
            console.log(' No ratings found for trade:', tradeId);
        }
    } catch (error) {
        console.error(' Chart initialization error:', error);
    }
}

// Extract ratings from the details panel
function extractTradeRatings(tradeId) {
    const detailsRow = document.getElementById(`details-${tradeId}`);
    if (!detailsRow) return null;

    const ratings = {};

    // Look for rating text in the card body
    const cardBody = detailsRow.querySelector('.card-body .text-start');
    if (cardBody) {
        const ratingElements = cardBody.querySelectorAll('div');
        ratingElements.forEach(element => {
            const text = element.textContent;
            if (text.includes('/5')) {
                const parts = text.split(':');
                if (parts.length === 2) {
                    const name = parts[0].trim();
                    const rating = parseInt(parts[1].split('/')[0].trim());
                    if (!isNaN(rating) && rating >= 1 && rating <= 5) {
                        ratings[name] = rating;
                    }
                }
            }
        });
    }

    return Object.keys(ratings).length > 0 ? ratings : null;
}

// Render the radar chart
function renderRadarChart(canvas, ratings) {
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 30;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const categories = Object.keys(ratings);
    const values = Object.values(ratings);
    const maxValue = 5;

    if (categories.length === 0) {
        // Draw "No Data" message
        ctx.fillStyle = '#6c757d';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No Ratings', centerX, centerY);
        return;
    }

    // Colors
    const gridColor = '#dee2e6';
    const dataColor = '#0d6efd';
    const fillColor = 'rgba(13, 110, 253, 0.2)';

    // Draw grid circles
    for (let i = 1; i <= maxValue; i++) {
        const gridRadius = (radius * i) / maxValue;
        ctx.beginPath();
        ctx.arc(centerX, centerY, gridRadius, 0, 2 * Math.PI);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    // Draw grid lines and labels
    const angleStep = (2 * Math.PI) / categories.length;
    categories.forEach((category, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;

        // Grid line
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.stroke();

        // Label
        ctx.fillStyle = dataColor;
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const labelX = centerX + Math.cos(angle) * (radius + 20);
        const labelY = centerY + Math.sin(angle) * (radius + 20);

        ctx.fillText(category.substring(0, 6), labelX, labelY);
    });

    // Draw data polygon
    if (values.length > 0) {
        const points = values.map((value, index) => {
            const angle = index * angleStep - Math.PI / 2;
            const distance = (radius * value) / maxValue;
            return {
                x: centerX + Math.cos(angle) * distance,
                y: centerY + Math.sin(angle) * distance
            };
        });

        // Fill area
        ctx.fillStyle = fillColor;
        ctx.beginPath();
        points.forEach((point, i) => {
            if (i === 0) ctx.moveTo(point.x, point.y);
            else ctx.lineTo(point.x, point.y);
        });
        ctx.closePath();
        ctx.fill();

        // Draw outline
        ctx.strokeStyle = dataColor;
        ctx.lineWidth = 2;
        ctx.stroke();

        // Draw data points
        ctx.fillStyle = dataColor;
        points.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
            ctx.fill();
        });
    }
}

// Win/Loss Chart for KPI
function initializeWinLossChart() {
    const canvas = document.getElementById('winLossChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 2;

    // Get data from the template
    const kpiText = canvas.closest('.kpi-card').querySelector('.kpi-value small').textContent;
    const matches = kpiText.match(/W: (\d+) \| L: (\d+) \| BE: (\d+)/);

    if (matches) {
        const wins = parseInt(matches[1]);
        const losses = parseInt(matches[2]);
        const breakeven = parseInt(matches[3]);
        const total = wins + losses + breakeven;

        if (total > 0) {
            const colors = ['#28a745', '#dc3545', '#ffc107']; // Green, Red, Yellow
            const data = [wins, losses, breakeven];

            let currentAngle = -Math.PI / 2;

            data.forEach((value, index) => {
                if (value > 0) {
                    const sliceAngle = (value / total) * 2 * Math.PI;

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[index];
                    ctx.fill();

                    currentAngle += sliceAngle;
                }
            });
        }
    }
}

// Simple delete confirmation
function confirmSingleDelete(tradeId, date, instrument, direction) {
    const message = `Remove trade: ${date} - ${instrument} (${direction})?\n\nThis action cannot be undone.`;
    if (confirm(message)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/trades/${tradeId}/delete`;
        form.style.display = 'none';

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// Simple sorting function
function sortTable(field) {
    console.log(' Sorting by field:', field);
    const currentUrl = new URL(window.location);
    const currentSort = currentUrl.searchParams.get('sort');
    const currentOrder = currentUrl.searchParams.get('order') || 'asc';

    let newOrder = 'asc';
    if (currentSort === field && currentOrder === 'asc') {
        newOrder = 'desc';
    }

    currentUrl.searchParams.set('sort', field);
    currentUrl.searchParams.set('order', newOrder);
    currentUrl.searchParams.set('page', '1');

    window.location.href = currentUrl.toString();
}

// Setup event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log(' Setting up enterprise trades event listeners...');

    // Initialize win/loss chart
    initializeWinLossChart();

    // Setup trade row click handlers
    document.addEventListener('click', function(e) {
        console.log(' Click detected on:', e.target);

        // Handle chevron clicks directly
        if (e.target.classList.contains('chevron-icon')) {
            console.log(' Chevron clicked directly');
            e.preventDefault();
            e.stopPropagation();

            const tradeId = e.target.id.replace('chevron-', '');
            console.log(' Trade ID from chevron:', tradeId);

            if (tradeId) {
                toggleTradeDetails(tradeId);
            }
            return;
        }

        // Handle trade row clicks (but not buttons)
        const tradeRow = e.target.closest('.trade-row');
        if (tradeRow && !e.target.closest('.btn-group') && !e.target.closest('.btn')) {
            console.log(' Trade row clicked');
            e.preventDefault();
            e.stopPropagation();

            const tradeId = tradeRow.getAttribute('data-trade-id');
            console.log(' Trade ID from row:', tradeId);

            if (tradeId) {
                toggleTradeDetails(tradeId);
            }
        }

        // Handle sortable header clicks
        const sortable = e.target.closest('.sortable');
        if (sortable) {
            console.log(' Sortable header clicked');
            const field = sortable.getAttribute('data-sort');
            if (field) {
                sortTable(field);
            }
        }
    });

    console.log(' Event listeners setup complete');
});

// Placeholder functions to prevent errors
function updateUrlAndRedirect(params) {
    const url = new URL(window.location);
    Object.keys(params).forEach(key => {
        url.searchParams.set(key, params[key]);
    });
    window.location.href = url.toString();
}

function changePageSize(newSize) {
    updateUrlAndRedirect({
        per_page: newSize,
        page: 1
    });
}

function executeBulkDelete() {
    console.log('Bulk delete function called');
}

console.log(' Clean enterprise trades script loaded successfully');

</script>


{% endblock %}