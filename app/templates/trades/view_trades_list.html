{% extends "base.html" %}

{% block title %}Trading Management Center{% endblock %}

{% block extra_css %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<!-- Optional: Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="enterprise-container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-chart-line executive-icon"></i>
                    Trading Management Center
                </h1>
                <p class="executive-subtitle">
                    Trading Activity Management & Performance Analysis</p>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary"
                        onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                        title="Log New Trade">
                    <i class="fas fa-plus"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <a href="{{ url_for('trades.import_trades') }}" class="btn btn-outline-secondary" title="Import Trading Data">
                    <i class="fas fa-upload me-1"></i>
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportWithProgress('csv')">
                        <i class="fas fa-file-csv me-2"></i>Export as CSV</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('trades.export_trades_excel') }}">
                        <i class="fas fa-file-excel me-2"></i>Export as Excel</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('trades.export_trades_json') }}">
                        <i class="fas fa-file-code me-2"></i>Export as JSON</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('trades.export_tax_report') }}">
                        <i class="fas fa-file-invoice me-2"></i>Tax Report Export</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('trades.export_performance_report') }}">
                        <i class="fas fa-file-csv me-2"></i>Performance Analysis (CSV)</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportWithProgress('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>Performance Analysis (PDF)</a></li>
                </ul>
                <button type="button" class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown" aria-expanded="false" title="Export Trading Data">
                    <i class="fas fa-download me-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="enterprise-container-fluid mt-3">
    <!-- Performance KPI Section -->
    {% if trades %}
    <div class="kpi-section">
        <div class="grid grid-cols-6 gap-0">
            <!-- Total Trades -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-chart-line kpi-icon me-2"></i>
                            <span class="kpi-label">Total Trades</span>
                        </div>
                        <div class="kpi-value">{{ kpi_data.total_trades if kpi_data else (pagination.total if pagination else trades|length) }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                <i class="fas fa-arrow-up"></i> Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Win/Loss Distribution -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-chart-pie kpi-icon me-2"></i>
                            <span class="kpi-label">Win/Loss Distribution</span>
                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                W: {{ kpi_data.profitable_trades }} | L: {{ kpi_data.losing_trades }}{% if kpi_data.breakeven_trades > 0 %} | BE: {{ kpi_data.breakeven_trades }}{% endif %}
                            {% else %}
                                {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                                {% set losing = trades|selectattr('pnl', 'lessthan', 0)|list|length %}
                                {% set breakeven = trades|selectattr('pnl', 'equalto', 0)|list|length %}
                                W: {{ profitable }} | L: {{ losing }}{% if breakeven > 0 %} | BE: {{ breakeven }}{% endif %}
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Trade Outcomes
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strike Rate -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-percentage kpi-icon me-2"></i>
                            <span class="kpi-label">Strike Rate</span>
                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                {% set strike_rate = kpi_data.strike_rate %}
                            {% else %}
                                {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                                {% set total_with_pnl = trades|selectattr('pnl', 'number')|list|length %}
                                {% set strike_rate = (profitable / total_with_pnl * 100) if total_with_pnl > 0 else 0 %}
                            {% endif %}
                            {{ "%.2f"|format(strike_rate) }}%
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Win Percentage
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumulative P&L -->
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-dollar-sign kpi-icon me-2"></i>
                            <span class="kpi-label">Cumulative P&L</span>

                        </div>
                        <div class="kpi-value">
                            {% if kpi_data %}
                                {% set total_pnl = kpi_data.cumulative_pnl %}
                            {% else %}
                                {% set total_pnl = 0 %}
                                {% for trade in trades %}
                                    {% if trade.pnl %}
                                        {% set total_pnl = total_pnl + trade.pnl %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            ${{ "{:,.2f}".format(total_pnl) }}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Total Profit/Loss
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Best Performing Model -->
            <div class="col-span-2">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <i class="fas fa-trophy kpi-icon me-2"></i>
                            <span class="kpi-label">Top Strategy</span>

                        </div>
                        <div class="kpi-value">
                            {% if kpi_data and kpi_data.best_model %}
                                {{ kpi_data.best_model }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                Best Performer by Strike Rate
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Compact Filter Notification Bar -->
    {% set active_filters = [] %}
    {% if request.args.get('start_date') %}
        {% set _ = active_filters.append('Start Date: ' + request.args.get('start_date')) %}
    {% endif %}
    {% if request.args.get('end_date') %}
        {% set _ = active_filters.append('End Date: ' + request.args.get('end_date')) %}
    {% endif %}
    {% if request.args.get('instrument') and request.args.get('instrument') != '' %}
        {% set instrument_id = request.args.get('instrument') %}
        {% set instrument_dict = dict(filter_form.instrument.choices) %}
        {% set instrument_label = instrument_dict.get(instrument_id, instrument_id) %}
        {% set _ = active_filters.append('Instrument: ' + instrument_label) %}
    {% endif %}
    {% if request.args.get('direction') %}
        {% set _ = active_filters.append('Direction: ' + request.args.get('direction')) %}
    {% endif %}
    {% if request.args.get('trading_model_id') and request.args.get('trading_model_id') != '0' %}
        {% set model_id = request.args.get('trading_model_id') %}
        {% set model_dict = dict(filter_form.trading_model_id.choices) %}
        {% set model_label = model_dict.get(model_id|int, model_id) %}
        {% set _ = active_filters.append('Model: ' + model_label) %}
    {% endif %}
    {% if request.args.get('how_closed') %}
        {% set _ = active_filters.append('How Closed: ' + request.args.get('how_closed')) %}
    {% endif %}
    {% if request.args.get('pnl_filter') %}
        {% if request.args.get('pnl_filter') == 'winners' %}
            {% set _ = active_filters.append('P&L: Winners Only') %}
        {% elif request.args.get('pnl_filter') == 'losers' %}
            {% set _ = active_filters.append('P&L: Losers Only') %}
        {% elif request.args.get('pnl_filter') == 'breakeven' %}
            {% set _ = active_filters.append('P&L: Breakeven') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('is_dca') %}
        {% if request.args.get('is_dca') == 'true' %}
            {% set _ = active_filters.append('DCA: Yes') %}
        {% elif request.args.get('is_dca') == 'false' %}
            {% set _ = active_filters.append('DCA: No') %}
        {% endif %}
    {% endif %}
    {% if request.args.get('min_contracts') %}
        {% set _ = active_filters.append('Min Contracts: ' + request.args.get('min_contracts')) %}
    {% endif %}
    {% if request.args.get('max_contracts') %}
        {% set _ = active_filters.append('Max Contracts: ' + request.args.get('max_contracts')) %}
    {% endif %}
    {% if request.args.get('min_rating') %}
        {% set _ = active_filters.append('Min Rating: ' + request.args.get('min_rating') + '+') %}
    {% endif %}
    {% if request.args.get('min_pnl') %}
        {% set _ = active_filters.append('Min P&L: $' + request.args.get('min_pnl')) %}
    {% endif %}
    {% if request.args.get('max_pnl') %}
        {% set _ = active_filters.append('Max P&L: $' + request.args.get('max_pnl')) %}
    {% endif %}

    {% if request.args.get('tags') or request.args.getlist('tags') %}
        {% set selected_tag_ids = request.args.getlist('tags') if request.args.getlist('tags') else [request.args.get('tags')] %}
        {% for tag_param in selected_tag_ids %}
            {% if tag_param and tag_param.strip() %}
                {% set tag_ids_list = tag_param.split(',') if ',' in tag_param else [tag_param] %}
                {% for tag_id in tag_ids_list %}
                    {% if tag_id and tag_id.strip() %}
                        {% set ns = namespace(tag_label=tag_id.strip(), tag_color='neutral') %}

                        {% if categorized_tags %}
                            {% for category_name, tag_options in categorized_tags %}
                                {% for tag_option_id, tag_option_name, tag_option_color in tag_options %}
                                    {% if tag_option_id|string == tag_id.strip() %}
                                        {% set ns.tag_label = tag_option_name %}
                                        {% set ns.tag_color = tag_option_color or 'neutral' %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% endif %}
                        {% set _ = active_filters.append(('Tag', ns.tag_label, ns.tag_color)) %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endif %}


    <!-- Compact Single-Line Filter Notification -->
    {% if active_filters %}
    <div class="alert alert-info d-flex align-items-center justify-content-between py-2 px-3 mt-3" role="alert" style="background-color: var(--enterprise-bg-primary); border: 2px solid var(--enterprise-info); border-radius: 0.375rem; font-size: 0.875rem; margin-bottom: 0.5rem;">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <i class="fas fa-info-circle text-info"></i>
            <span class="fw-semibold text-info">Trade Database Filtered by:</span>
            {% for filter in active_filters %}
                {% if filter is sequence and filter|length == 3 and filter[0] == 'Tag' %}
                    <!-- Tag with enterprise styling and remove button -->
                    <div class="tag-item tag-{{ filter[2] }}" style="position: relative;">
                        <span class="tag-name">{{ filter[1] }}</span>
                        <button type="button" class="btn btn-sm" onclick="removeTagByName('{{ filter[1] }}')" 
                                style="background: none; border: none; color: inherit; padding: 0 0 0 0.5rem; font-size: 0.75rem; opacity: 0.8;"
                                title="Remove this tag filter">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% else %}
                    <!-- Regular filter badge with remove button -->
                    <span class="badge bg-primary text-white d-inline-flex align-items-center" style="font-size: 0.75rem;">
                        {{ filter }}
                        <button type="button" class="btn btn-sm ms-1" onclick="removeFilter('{{ filter|urlencode }}')" 
                                style="background: none; border: none; color: inherit; padding: 0; font-size: 0.7rem;"
                                title="Remove this filter">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                {% endif %}
            {% endfor %}
        </div>
        <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-info btn-sm" title="Clear all filters" style="font-size: 0.75rem;">
            <i class="fas fa-times me-1"></i>Clear Filters
        </a>
    </div>
    {% endif %}

    <!-- Trade Operations Data Table -->
    {% if trades %}
    <div class="enterprise-module mt-3">
        <div class="module-header" style="position: relative; display: flex; align-items: center; padding: 1rem;">
            <!-- Left: Title with inline summary -->
            <div style="flex: 1;">
                <div class="module-title">
                    <i class="fas fa-database module-icon"></i>
                    Trading Operations Data Repository
                    <span style="font-weight: 400; color: var(--enterprise-text-muted); margin-left: 1rem; font-size: 0.875rem;">
                        {{ ((pagination.page - 1) * pagination.per_page + 1) }} - {{ (pagination.page * pagination.per_page if pagination.page < pagination.pages else pagination.total) }} of {{ pagination.total }} Recorded Trades
                    </span>
                </div>
            </div>
            
            <!-- Center: Pagination Controls (Absolutely Centered) -->
            {% if pagination and pagination.pages > 1 %}
            <div class="btn-group" style="position: absolute; left: 50%; transform: translateX(-50%);">
                <!-- First Page -->
                {% if pagination.page > 1 %}
                    {% set first_args = request.args.copy() %}
                    {% set _ = first_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=1, **first_args) }}'"
                            title="First Page">
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                {% endif %}

                <!-- Previous Page -->
                {% if pagination.has_prev %}
                    {% set prev_args = request.args.copy() %}
                    {% set _ = prev_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.prev_num, **prev_args) }}'"
                            title="Previous Page">
                        <i class="fas fa-angle-left"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-left"></i>
                    </button>
                {% endif %}

                <!-- Page Information -->
                <span class="pagination-controls">
                    Page {{ pagination.page }} of {{ pagination.pages }}
                </span>

                <!-- Next Page -->
                {% if pagination.has_next %}
                    {% set next_args = request.args.copy() %}
                    {% set _ = next_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.next_num, **next_args) }}'"
                            title="Next Page">
                        <i class="fas fa-angle-right"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-right"></i>
                    </button>
                {% endif %}

                <!-- Last Page -->
                {% if pagination.page < pagination.pages %}
                    {% set last_args = request.args.copy() %}
                    {% set _ = last_args.pop('page', None) %}
                    <button type="button" class="pagination-arrow-borderless"
                            onclick="window.location.href='{{ url_for('trades.view_trades_list', page=pagination.pages, **last_args) }}'"
                            title="Last Page">
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                {% else %}
                    <button type="button" class="pagination-arrow-borderless" disabled>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Right: Records per Page + Action Buttons -->
            <div class="d-flex align-items-center gap-3" style="flex: 1; justify-content: flex-end;">
                <div class="d-flex align-items-center gap-2">
                    <span style="font-size: 0.875rem;">Trades per Page:</span>
                    <select id="pageSizeDropdown" class="form-select form-select-sm" style="width: auto;"
                            title="Trades per page">
                        <option value="25" {{ 'selected' if request.args.get('per_page', '25')|string == '25' else '' }}>25</option>
                        <option value="50" {{ 'selected' if request.args.get('per_page', '25')|string == '50' else '' }}>50</option>
                        <option value="100" {{ 'selected' if request.args.get('per_page', '25')|string == '100' else '' }}>100</option>
                        <option value="250" {{ 'selected' if request.args.get('per_page', '25')|string == '250' else '' }}>250</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal"
                            data-bs-target="#filterModal" title="Filter Trades">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="module-content">
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;" role="region" aria-label="Trades List">
                <table class="table table-striped table-hover table-sm mb-0" role="table">
                    <thead class="table-dark sticky-top">
                    <tr role="row">
                        <th width="1" class="text-center" role="columnheader"></th>

                        <th scope="col" class="sortable text-center" data-sort="date" role="columnheader" tabindex="0" aria-label="Sort by Date">
                            Date
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="instrument" role="columnheader" tabindex="0"
                            aria-label="Sort by Instrument">Inst
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="model" role="columnheader" tabindex="0"
                            aria-label="Sort by Trading Model">Model
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="direction" role="columnheader" tabindex="0"
                            aria-label="Sort by Direction">Dir
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="contracts" role="columnheader" tabindex="0"
                            aria-label="Sort by Contracts">POS
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="entry_time" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Time">Time
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="entry" role="columnheader" tabindex="0"
                            aria-label="Sort by Entry Price">Entry
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="exit" role="columnheader" tabindex="0"
                            aria-label="Sort by Exit Price">Exit
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="time_in_trade" role="columnheader" tabindex="0"
                            aria-label="Sort by Time in Trade">Duration
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="how_closed" role="columnheader" tabindex="0"
                            aria-label="Sort by How Closed">Closed
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="avg_rating" role="columnheader" tabindex="0"
                            aria-label="Sort by Trade Rating">Rating
                        </th>
                        <th scope="col" class="sortable text-center" data-sort="pnl" role="columnheader" tabindex="0"
                            aria-label="Sort by P&L">P&L
                        </th>
                        <th scope="col" class="text-center" role="columnheader"></th>
                    </tr>
                </thead>
                <tbody>
                {% for trade in trades %}
                <!-- Enhanced Trade Row with clean styling -->
                <tr class="trade-row
                    {% if trade.pnl and trade.pnl > 0 %}table-success-subtle
                    {% elif trade.pnl and trade.pnl < 0 %}table-danger-subtle
                    {% endif %}"
                    data-trade-id="{{ trade.id }}" role="row" tabindex="0"
                    aria-label="Trade {{ trade.trade_date.strftime('%m/%d/%Y') }} {{ trade.instrument }} {{ trade.direction }}">

                    <!-- Enhanced Dropdown Arrow -->
                    <td class="text-center" role="gridcell" style="padding: 2px">
                        <i class="fas fa-chevron-right chevron-icon" id="chevron-{{ trade.id }}"
                           aria-hidden="true" ></i>
                    </td>

                    <!-- Date -->
                    <td role="gridcell" style="padding: 2px">{{ trade.trade_date.strftime('%d %b %y') }}</td>

                    <!-- Instrument -->
                    <td role="gridcell" style="padding: 2px">{{ trade.instrument or 'N/A' }}</td>

                    <!-- Model -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.trading_model %}
                            {{ trade.trading_model.name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Enhanced Direction -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.direction == 'Long' %}
                            <span class="badge-transparent text-success"
                                  aria-label="Long position">{{ trade.direction }}</span>
                        {% elif trade.direction == 'Short' %}
                            <span class="badge-transparent text-danger"
                                  aria-label="Short position">{{ trade.direction }}</span>
                        {% else %}
                            <span class="badge-transparent text-muted" {{ trade.direction or 'N/A' }}</span>
                        {% endif %}
                    </td>

                    <!-- Contracts -->
                    <td role="gridcell" style="padding: 2px">{{ trade.total_contracts_entered or 0 }}</td>

                    <!-- Entry Time -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.entries.first() and trade.entries.first().entry_time %}
                            {{ trade.entries.first().entry_time.strftime('%H:%M') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <!-- Entry Price -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.average_entry_price %}
                            {{ "{:.2f}".format(trade.average_entry_price) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <!-- Exit Price -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.average_exit_price %}
                            {{ "{:.2f}".format(trade.average_exit_price) }}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted" aria-label="Position still open">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>
                    <!-- Enhanced Time in Trade -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                            {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                            {% if time_diff >= 0 %}
                                <span>{{ trade.time_in_trade }}</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>
                    <!-- How Closed -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.how_closed %}
                            <span class="how-closed-text">{{ trade.how_closed }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <!-- Enhanced Trade Rating with accessibility -->
                    <td role="gridcell" style="padding: 2px">
                        {% set ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                        {% set valid_ratings = ratings|select('ne', none)|list %}
                        {% if valid_ratings %}
                            {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                            {% if avg_rating >= 4.0 %}
                                <span class="badge-transparent text-success" aria-label="High rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% elif avg_rating >= 2.5 %}
                                <span class="badge-transparent text-warning" aria-label="Medium rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>
                            {% else %}
                                <span class="badge-transparent text-danger" aria-label="Low rating: {{ '%.1f'|format(avg_rating) }} out of 5">{{ "%.1f"|format(avg_rating) }}</span>

                            {% endif %}
                        {% else %}
                            <span aria-label="No rating available">N/A</span>
                        {% endif %}
                    </td>
                    <!-- Enhanced P&L with no + sign for winners -->
                    <td role="gridcell" style="padding: 2px">
                        {% if trade.pnl is not none %}
                            {% if trade.pnl > 0 %}
                                <span class="badge-transparent text-success" aria-label="Profit: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% elif trade.pnl < 0 %}
                                <span class="badge-transparent text-danger" aria-label="Loss: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% else %}
                                <span class="badge-transparent text-muted" aria-label="Break even: ${{ '{:,.2f}'.format(trade.pnl) }}">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% endif %}
                        {% else %}
                            <span aria-label="P&L not available">N/A</span>
                        {% endif %}
                    </td>
                    <!-- Enhanced Actions with better accessibility -->
                    <td class="text-end" onclick="event.stopPropagation();" role="gridcell" style="padding: 2px">
                        <div class="btn-group" role="group" aria-label="Trade actions">
                            <a href="{{ url_for('journal.manage_daily_journal', date_str=trade.trade_date.strftime('%Y-%m-%d')) }}"
                               class="btn btn-outline-secondary btn-sm" title="Daily Journal for {{ trade.trade_date.strftime('%m/%d/%Y') }}"
                               aria-label="View daily journal">
                                <i class="fas fa-journal-whills" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="View trade details"
                               aria-label="View details">
                                <i class="fas fa-eye" aria-hidden="true"></i>
                            </a>
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
                               class="btn btn-outline-secondary btn-sm" title="Edit trade"
                               aria-label="Edit trade">
                                <i class="fas fa-edit" aria-hidden="true"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                <!-- Enterprise Trade Details Row - Simple colspan approach -->
                <tr id="details-{{ trade.id }}" class="trade-details-row" style="display: none;" role="row">
                    <td colspan="14" class="p-0">
                        <div class="trade-details-container">
                            <div class="grid grid-cols-9 gap-3">
                                <!-- Entries & Exits Card -->
                                <div class="col-span-2">
                                    <div class="enterprise-module">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-exchange-alt module-icon"></i>
                                                Execution Details
                                            </div>
                                        </div>
                                    <div class="module-content">
                                        {% if trade.entries %}
                                        <div class="mb-3">
                                            <h6 class="text-success fw-semibold mb-2">
                                                Entry Points
                                                <span class="text-muted fw-normal">
                                                    ({{ trade.total_contracts_entered or 0 }} total positions @ avg {{ "{:.2f}".format(trade.average_entry_price) if trade.average_entry_price else 'N/A' }})
                                                </span>
                                            </h6>
                                            {% for entry in trade.entries %}
                                            <div class="mb-1 pt-1 pb-1 px-3" style="background-color: var(--enterprise-bg-primary); border-radius: 6px;">
                                                <span class="fw-normal">
                                                    #{{ loop.index }}: {{ entry.contracts or 0 }} positions @ {{ "{:.2f}".format(entry.entry_price) if entry.entry_price else 'N/A' }} ({{ entry.entry_time.strftime('%H:%M') if entry.entry_time else 'N/A' }})
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        <!-- Exit Points -->
                                        {% if trade.exits %}
                                        <div>
                                            <div class="mb-3">
                                                <h6 class="text-danger fw-semibold mb-2">
                                                    Exit Points
                                                    <span class="text-muted fw-normal mb-2">
                                                        ({{ trade.total_contracts_exited or 0 }} total positions @ avg {{ "{:.2f}".format(trade.average_exit_price) if trade.average_exit_price else 'N/A' }})
                                                    </span>
                                                </h6>
                                                {% for exit in trade.exits %}
                                                <div class="mb-1 pt-1 pb-1 px-3" style="background-color: var(--enterprise-bg-primary); border-radius: 6px;">
                                                    <span class="fw-normal">
                                                        #{{ loop.index }}: {{ exit.contracts or 0 }} positions @ {{ "{:.2f}".format(exit.exit_price) if exit.exit_price else 'N/A' }} ({{ exit.exit_time.strftime('%H:%M') if exit.exit_time else 'N/A' }})
                                                    </span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    </div>
                                </div>
                                <!-- Trade Configuration Card -->
                                <div class="col-span-2">
                                    <div class="enterprise-module">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-info-circle module-icon"></i>
                                                Trade Configuration
                                            </div>
                                        </div>
                                        <div class="module-content">
                                            <div class="row g-3">
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Instrument</div>
                                                        {{ trade.instrument }}
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Execution Date</div>
                                                        {{ trade.trade_date.strftime('%d %b %Y') }}
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Direction</div>
                                                        <div>
                                                            <span class="badge-transparent text-success {% if trade.direction == 'Long' %}operational{% elif trade.direction == 'Short' %}suspended{% else %}neutral{% endif %}">
                                                                {{ trade.direction }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Trading Model</div>
                                                        {{ trade.trading_model.name if trade.trading_model else 'N/A' }}
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Exit Method</div>
                                                        {{ trade.how_closed if trade.how_closed else 'N/A' }}
                                                    </div>
                                                </div>
                                                {% if trade.tags %}
                                                <div class="col-12">
                                                    <div class="border-top pt-2">
                                                        <div class="fw-semibold text-muted mb-2 text-uppercase">Tags</div>
                                                        <div class="d-flex flex-wrap gap-1">
                                                            {% for tag in trade.tags %}
                                                                <span class="tag-item
                                                                    {% if tag.color_category == 'good' %} tag-good
                                                                    {% elif tag.color_category == 'bad' %} tag-bad
                                                                    {% else %}tag-neutral{% endif %}"
                                                                    style="font-size: 0.7rem; white-space: nowrap;">
                                                                    {{ tag.name }}
                                                                </span>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if trade.screenshot_link %}
                                                <div class="mt-2">
                                                    <a href="{{ trade.screenshot_link }}" target="_blank" class="btn btn-outline-primary btn-sm w-100">
                                                        <i class="fas fa-camera me-1"></i>View Chart
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Performance Metrics Card -->
                                <div class="col-span-2">
                                    <div class="enterprise-module">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-chart-line module-icon"></i>
                                                Performance Metrics
                                            </div>
                                        </div>
                                        <div class="module-content">
                                            <div class="row g-3">
                                                <!-- Gross P&L -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Gross P&L</div>
                                                        <span class="{% if trade.pnl %}{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% endif %}{% endif %}">
                                                            {% if trade.pnl is not none %}
                                                                ${{ "{:,.2f}".format(trade.pnl) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </div>

                                                <!-- Initial Stop -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Initial Stop</div>
                                                        <div class="text-end">
                                                            {% if trade.initial_stop_loss and trade.average_entry_price %}
                                                                {% set stop_diff = (trade.average_entry_price - trade.initial_stop_loss)|abs %}
                                                                {% set multiplier = trade.instrument_multiplier or 25 %}
                                                                {% set tick_size = trade.instrument_tick_size or 0.25 %}
                                                                {% set ticks = (stop_diff / tick_size)|round|int if tick_size > 0 else 0 %}
                                                                {% set price_pct = ((stop_diff / trade.average_entry_price) * 100) if trade.average_entry_price > 0 else 0 %}
                                                                <div>{{ "{:.2f}".format(trade.initial_stop_loss) }}</div>
                                                                <small class="text-muted">({{ "{:.1f}".format(stop_diff) }} pts, {{ ticks }} tks, ${{ "{:,.0f}".format(stop_diff * multiplier) }}, {{ "{:.2f}".format(price_pct) }}%)</small>
                                                            {% elif trade.initial_stop_loss %}
                                                                {{ "{:.2f}".format(trade.initial_stop_loss) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Target -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Target</div>
                                                        <div class="text-end">
                                                            {% if trade.terminus_target and trade.average_entry_price %}
                                                                {% set target_diff = (trade.terminus_target - trade.average_entry_price)|abs %}
                                                                {% set multiplier = trade.instrument_multiplier or 25 %}
                                                                {% set tick_size = trade.instrument_tick_size or 0.25 %}
                                                                {% set ticks = (target_diff / tick_size)|round|int if tick_size > 0 else 0 %}
                                                                {% set price_pct = ((target_diff / trade.average_entry_price) * 100) if trade.average_entry_price > 0 else 0 %}
                                                                <div>{{ "{:.2f}".format(trade.terminus_target) }}</div>
                                                                <small class="text-muted">({{ "{:.1f}".format(target_diff) }} pts, {{ ticks }} tks, ${{ "{:,.0f}".format(target_diff * multiplier) }}, {{ "{:.2f}".format(price_pct) }}%)</small>
                                                            {% elif trade.terminus_target %}
                                                                {{ "{:.2f}".format(trade.terminus_target) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- MAE (Maximum Adverse Excursion) -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">MAE</div>
                                                        <div class="text-end">
                                                            {% if trade.mae_price is not none and trade.average_entry_price %}
                                                                {% set mae_points = (trade.mae_price - trade.average_entry_price)|abs %}
                                                                {% set multiplier = trade.instrument_multiplier or 25 %}
                                                                {% set tick_size = trade.instrument_tick_size or 0.25 %}
                                                                {% set ticks = (mae_points / tick_size)|round|int if tick_size > 0 else 0 %}
                                                                {% set price_pct = ((mae_points / trade.average_entry_price) * 100) if trade.average_entry_price > 0 else 0 %}
                                                                <div class="text-danger fw-semibold">{{ "{:.2f}".format(trade.mae_price) }}</div>
                                                                <small class="text-muted">({{ "{:.1f}".format(mae_points) }} pts, {{ ticks }} tks, ${{ "{:,.0f}".format(mae_points * multiplier) }}, {{ "{:.2f}".format(price_pct) }}%)</small>
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- MFE (Maximum Favorable Excursion) -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">MFE</div>
                                                        <div class="text-end">
                                                            {% if trade.mfe_price is not none and trade.average_entry_price %}
                                                                {% set mfe_points = (trade.mfe_price - trade.average_entry_price)|abs %}
                                                                {% set multiplier = trade.instrument_multiplier or 25 %}
                                                                {% set tick_size = trade.instrument_tick_size or 0.25 %}
                                                                {% set ticks = (mfe_points / tick_size)|round|int if tick_size > 0 else 0 %}
                                                                {% set price_pct = ((mfe_points / trade.average_entry_price) * 100) if trade.average_entry_price > 0 else 0 %}
                                                                <div class="text-success fw-semibold">{{ "{:.2f}".format(trade.mfe_price) }}</div>
                                                                <small class="text-muted">({{ "{:.1f}".format(mfe_points) }} pts, {{ ticks }} tks, ${{ "{:,.0f}".format(mfe_points * multiplier) }}, {{ "{:.2f}".format(price_pct) }}%)</small>
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Time in Trade -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Time in Trade</div>
                                                        {{ trade.time_in_trade if trade.time_in_trade and trade.time_in_trade != 'N/A' else 'N/A' }}
                                                    </div>
                                                </div>
                                                <!-- Risk-Reward Ratio -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Risk:Reward</div>
                                                        {% if trade.initial_stop_loss and trade.terminus_target and trade.average_entry_price %}
                                                            {% if trade.direction == 'Long' %}
                                                                {% set risk = trade.average_entry_price - trade.initial_stop_loss %}
                                                                {% set reward = trade.terminus_target - trade.average_entry_price %}
                                                            {% else %}
                                                                {% set risk = trade.initial_stop_loss - trade.average_entry_price %}
                                                                {% set reward = trade.average_entry_price - trade.terminus_target %}
                                                            {% endif %}
                                                            {% if risk > 0 %}
                                                                1:{{ "{:.2f}".format(reward / risk) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <!-- Efficiency Ratio -->
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center border-bottom pt-1 pb-1">
                                                        <div class="fw-semibold text-muted">Efficiency</div>
                                                        {% if trade.pnl is not none and trade.mfe_price is not none and trade.average_entry_price %}
                                                            {% set mfe_points = (trade.mfe_price - trade.average_entry_price)|abs %}
                                                            {% set efficiency = (trade.pnl / (mfe_points * (trade.instrument_multiplier or 25))) * 100 if mfe_points != 0 else 0 %}
                                                            <span class="{% if efficiency >= 50 %}text-success{% elif efficiency >= 25 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ "{:.1f}".format(efficiency) }}%
                                                            </span>
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quality Assessment Card -->
                                <div class="col-span-3">
                                    <div class="enterprise-module">
                                        <div class="module-header">
                                            <div class="module-title">
                                                <i class="fas fa-star module-icon"></i>
                                                Execution Quality Assessment
                                            </div>
                                        </div>
                                    <div class="module-content">
                                        <div class="d-flex gap-4">
                                            <!-- Rating List -->
                                            <div style="flex: 0 0 50%;">
                                                <div class="d-flex flex-column gap-1" style="text-align: left">
                                                    {% set ratings = [
                                                        ('Preparation', trade.preparation_rating, 'clipboard-check'),
                                                        ('Rules Adherence', trade.rules_rating, 'gavel'),
                                                        ('Risk Management', trade.management_rating, 'shield-alt'),
                                                        ('Target Placement', trade.target_rating, 'bullseye'),
                                                        ('Entry Execution', trade.entry_rating, 'crosshairs')
                                                    ] %}

                                                    {% for rating_name, rating_value, icon in ratings %}
                                                    <div class="d-flex align-items-center gap-1 p-1 rounded hover-highlight"
                                                         data-rating-category="{{ rating_name.lower().replace(' ', '_') }}"
                                                         data-rating-value="{{ rating_value or 0 }}">
                                                        <div class="flex-grow-1">
                                                            <div class="fw-semibold text-muted" >{{ rating_name }}</div>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-1">
                                                            <div class="d-flex gap-1">
                                                                {% for i in range(1, 6) %}
                                                                <div class="rating-dot" style="
                                                                    width: 10px;
                                                                    height: 10px;
                                                                    border-radius: 50%;
                                                                    border: 1px solid var(--enterprise-gray-300);
                                                                    {% if rating_value and i <= rating_value %}
                                                                        {% if rating_value >= 4 %}
                                                                            background-color: var(--enterprise-success);
                                                                            border-color: var(--enterprise-success);
                                                                        {% elif rating_value >= 3 %}
                                                                            background-color: var(--enterprise-warning);
                                                                            border-color: var(--enterprise-warning);
                                                                        {% else %}
                                                                            background-color: var(--enterprise-danger);
                                                                            border-color: var(--enterprise-danger);
                                                                        {% endif %}
                                                                    {% else %}
                                                                        background-color: var(--enterprise-gray-100);
                                                                    {% endif %}
                                                                "></div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    <!-- Average Rating -->
                                                    {% set all_ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                                                    {% set valid_ratings = all_ratings|select('ne', none)|list %}
                                                    {% if valid_ratings %}
                                                        {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                                                        <div class="border-top mt-2 pt-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="fw-semibold text-primary">Overall Score:</span>
                                                                <span class="badge {% if avg_rating >= 4 %}bg-success{% elif avg_rating >= 2.5 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                                                    {{ "%.1f"|format(avg_rating) }}/5.0
                                                                </span>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Radar Chart -->
                                            <div class="d-flex align-items-center justify-content-center">
                                                <div class="position-relative" style="width: 200px; height: 200px;">
                                                    <canvas id="radarChart-{{ trade.id }}" width="200" height="200"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="enterprise-module text-center mt-3">
        <div class="module-content py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4 class="text-muted mb-4">No Trades Found</h4>
            <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add A Trade
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Filter Trades Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="fas fa-filter me-2"></i>Filter Trades
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{{ url_for('trades.view_trades_list') }}">
                <div class="modal-body">

                    <!-- Date Range & Core Characteristics -->
                    <div class="mb-3">
                        <h6 class="fw-bold border-bottom pb-2 mb-3">Core Filters</h6>
                        <div class="d-flex align-items-end gap-3">
                            <!-- Start Date -->
                            <div class="w-auto">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
                            </div>
                            <!-- End Date -->
                            <div class="w-auto">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
                            </div>
                            <!-- Instrument -->
                            <div class="w-auto">
                                <label for="instrument_filter" class="form-label">Instrument</label>
                                <select class="form-select" id="instrument_filter" name="instrument">
                                    <option value="">All</option>
                                    {% if filter_form and filter_form.instrument %}
                                        {% for value, label in filter_form.instrument.choices %}
                                            {% if value %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('instrument') == value else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <!-- Direction -->
                            <div class="w-auto">
                                <label for="direction_filter" class="form-label">Direction</label>
                                <select class="form-select" id="direction_filter" name="direction">
                                    <option value="">All</option>
                                    <option value="Long" {{ 'selected' if request.args.get('direction') == 'Long' else '' }}>Long</option>
                                    <option value="Short" {{ 'selected' if request.args.get('direction') == 'Short' else '' }}>Short</option>
                                </select>
                            </div>
                             <!-- Trading Model -->
                            <div class="flex-grow-1">
                                <label for="trading_model_filter" class="form-label">Trading Model</label>
                                <select class="form-select" id="trading_model_filter" name="trading_model_id">
                                    <option value="">All Models</option>
                                     {% if filter_form and filter_form.trading_model_id %}
                                        {% for value, label in filter_form.trading_model_id.choices %}
                                            {% if value and value != 0 %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('trading_model_id') == value|string else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Performance & Size -->
                    <div class="mb-3 mt-5">
                        <h6 class="fw-bold border-bottom pb-2 mb-3">Performance &amp; Position Size</h6>
                        <div class="d-flex align-items-end gap-3">
                            <div class="w-auto">
                                <label for="pnl_filter" class="form-label">P&L Type</label>
                                <select class="form-select" id="pnl_filter" name="pnl_filter">
                                    <option value="">All</option>
                                    <option value="winners" {{ 'selected' if request.args.get('pnl_filter') == 'winners' else '' }}>Winners</option>
                                    <option value="losers" {{ 'selected' if request.args.get('pnl_filter') == 'losers' else '' }}>Losers</option>
                                    <option value="breakeven" {{ 'selected' if request.args.get('pnl_filter') == 'breakeven' else '' }}>Breakeven</option>
                                </select>
                            </div>
                            <div style="width: 120px;">
                                <label for="min_pnl_filter" class="form-label">Min P&L ($)</label>
                                <input type="number" class="form-control" id="min_pnl_filter" name="min_pnl" step="0.01" value="{{ request.args.get('min_pnl', '') }}" placeholder="-500">
                            </div>
                            <div style="width: 120px;">
                                <label for="max_pnl_filter" class="form-label">Max P&L ($)</label>
                                <input type="number" class="form-control" id="max_pnl_filter" name="max_pnl" step="0.01" value="{{ request.args.get('max_pnl', '') }}" placeholder="1000">
                            </div>
                            <div style="width: 100px;">
                                <label for="min_contracts_filter" class="form-label">Min Size</label>
                                <input type="number" class="form-control" id="min_contracts_filter" name="min_contracts" value="{{ request.args.get('min_contracts', '') }}" placeholder="1">
                            </div>
                            <div style="width: 100px;">
                                <label for="max_contracts_filter" class="form-label">Max Size</label>
                                <input type="number" class="form-control" id="max_contracts_filter" name="max_contracts" value="{{ request.args.get('max_contracts', '') }}" placeholder="20">
                            </div>
                        </div>
                    </div>

                    <!-- Special Filters -->
                    <div>
                        <h6 class="fw-bold border-bottom pb-2 mb-3 mt-5">Special Filters</h6>
                        <div class="d-flex align-items-start gap-3">
                            <div class="w-auto">
                                <label for="how_closed_filter" class="form-label">Exit Method</label>
                                <select class="form-select" id="how_closed_filter" name="how_closed">
                                    <option value="">All</option>
                                    <option value="Target Hit" {{ 'selected' if request.args.get('how_closed') == 'Target Hit' else '' }}>Target Hit</option>
                                    <option value="Stop Loss" {{ 'selected' if request.args.get('how_closed') == 'Stop Loss' else '' }}>Stop Loss</option>
                                    <option value="Closed Manually" {{ 'selected' if request.args.get('how_closed') == 'Closed Manually' else '' }}>Manual Close</option>
                                    <option value="Still Open" {{ 'selected' if request.args.get('how_closed') == 'Still Open' else '' }}>Still Open</option>
                                </select>
                            </div>
                            <div class="w-auto">
                                <label for="min_rating_filter" class="form-label">Min Rating</label>
                                <select class="form-select" id="min_rating_filter" name="min_rating">
                                    <option value="">Any</option>
                                    <option value="1" {{ 'selected' if request.args.get('min_rating') == '1' else '' }}>1+</option>
                                    <option value="2" {{ 'selected' if request.args.get('min_rating') == '2' else '' }}>2+</option>
                                    <option value="3" {{ 'selected' if request.args.get('min_rating') == '3' else '' }}>3+</option>
                                    <option value="4" {{ 'selected' if request.args.get('min_rating') == '4' else '' }}>4+</option>
                                    <option value="5" {{ 'selected' if request.args.get('min_rating') == '5' else '' }}>5</option>
                                </select>
                            </div>
                            <div class="w-auto">
                                <label for="is_dca_filter" class="form-label">DCA Trades</label>
                                <select class="form-select" id="is_dca_filter" name="is_dca">
                                    <option value="">All</option>
                                    <option value="true" {{ 'selected' if request.args.get('is_dca') == 'true' else '' }}>DCA Only</option>
                                    <option value="false" {{ 'selected' if request.args.get('is_dca') == 'false' else '' }}>Non-DCA Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tags Section - Full Width -->
                    {% if categorized_tags %}
                    <div class="mb-3 mt-5">
                        <h6 class="fw-bold border-bottom pb-2 mb-2">Tag Selection</h6>
                        <!-- Tags Dropdown -->
                        <div>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="tagsDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                    <i class="fas fa-tags me-2"></i>Select Tags
                                </button>
                                <div class="dropdown-menu w-100 p-3" aria-labelledby="tagsDropdown" style="min-width: 100%; max-height: 400px; overflow-y: auto;">
                                    {% for category_name, tag_options in categorized_tags %}
                                    <div class="mb-3">
                                        <h6 class="dropdown-header fw-bold text-muted border-bottom pb-1 mb-2" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            {{ category_name }}
                                        </h6>
                                        <div class="d-flex flex-wrap gap-1 px-2">
                                            {% for tag_id, tag_name, tag_color in tag_options %}
                                            <div class="tag-item tag-{{ tag_color or 'neutral' }} tag-selectable"
                                                 data-tag-id="{{ tag_id }}"
                                                 data-tag-name="{{ tag_name }}"
                                                 data-tag-color="{{ tag_color or 'neutral' }}"
                                                 role="button"
                                                 tabindex="0"
                                                 style="cursor: pointer; user-select: none;">
                                                <span class="tag-name">{{ tag_name }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Hidden input to store tag values for form submission -->
                        <input type="hidden" name="tags" id="tags-hidden-input">
                        <!-- Selected Tags Display -->
                        <div class="mb-2">
                            <label class="form-label mb-1">Selected Tags</label>
                            <div id="selected-tags-container" style="min-height: 40px; background: var(--enterprise-gray-50); border: 1px solid var(--enterprise-border); border-radius: var(--enterprise-radius); padding: 0.5rem;">
                                <div id="selected-tags-display" class="d-flex flex-wrap gap-1">
                                    <span class="text-muted small" id="no-tags-message">No tags selected</span>
                                </div>
                            </div>
                        </div>

                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-warning me-2">
                        <i class="fas fa-eraser me-1"></i>Clear All
                    </a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search me-1"></i>Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterModal = document.getElementById('filterModal');
    if (!filterModal) return;

    const selectedTagsDisplay = filterModal.querySelector('#selected-tags-display');
    const noTagsMessage = filterModal.querySelector('#no-tags-message');
    const hiddenInput = filterModal.querySelector('#tags-hidden-input');
    const tagItems = filterModal.querySelectorAll('.tag-selectable');
    const selectedTagIds = new Set();

    // Function to update the hidden input value
    function updateHiddenInput() {
        hiddenInput.value = Array.from(selectedTagIds).join(',');
    }

    // Function to create a selected tag display element
    function createSelectedTag(id, name, color) {
        const selectedTag = document.createElement('div');
        selectedTag.className = `tag-item tag-${color} selected-tag`;
        selectedTag.dataset.tagId = id;
        selectedTag.style.cssText = 'cursor: pointer; user-select: none; opacity: 0.8; position: relative;';
        
        selectedTag.innerHTML = `
            <span class="tag-name">${name}</span>
            <i class="fas fa-times ms-2" style="font-size: 0.75rem; opacity: 0.7;"></i>
        `;

        selectedTag.addEventListener('click', function() {
            toggleTagSelection(id, name, color);
        });

        return selectedTag;
    }

    // Function to update the selected tags display
    function updateSelectedTagsDisplay() {
        selectedTagsDisplay.innerHTML = '';
        
        if (selectedTagIds.size === 0) {
            selectedTagsDisplay.appendChild(noTagsMessage);
        } else {
            selectedTagIds.forEach(tagId => {
                const tagItem = Array.from(tagItems).find(item => item.dataset.tagId === tagId);
                if (tagItem) {
                    const selectedTag = createSelectedTag(
                        tagId, 
                        tagItem.dataset.tagName, 
                        tagItem.dataset.tagColor
                    );
                    selectedTagsDisplay.appendChild(selectedTag);
                }
            });
        }
    }

    // Function to update visual state of tag items
    function updateTagItemsState() {
        tagItems.forEach(item => {
            const tagId = item.dataset.tagId;
            if (selectedTagIds.has(tagId)) {
                item.style.opacity = '0.5';
                item.style.transform = 'scale(0.95)';
                item.classList.add('selected');
            } else {
                item.style.opacity = '1';
                item.style.transform = 'scale(1)';
                item.classList.remove('selected');
            }
        });
    }

    // Function to handle tag selection/deselection
    function toggleTagSelection(id, name, color) {
        if (selectedTagIds.has(id)) {
            selectedTagIds.delete(id);
        } else {
            selectedTagIds.add(id);
        }
        
        updateSelectedTagsDisplay();
        updateTagItemsState();
        updateHiddenInput();
    }

    // Add click listeners to tag items
    tagItems.forEach(item => {
        item.addEventListener('click', function() {
            const { tagId, tagName, tagColor } = this.dataset;
            toggleTagSelection(tagId, tagName, tagColor);
        });

        // Add keyboard support
        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const { tagId, tagName, tagColor } = this.dataset;
                toggleTagSelection(tagId, tagName, tagColor);
            }
        });

        // Add hover effects
        item.addEventListener('mouseenter', function() {
            if (!selectedTagIds.has(this.dataset.tagId)) {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.15)';
            }
        });

        item.addEventListener('mouseleave', function() {
            if (!selectedTagIds.has(this.dataset.tagId)) {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            }
        });
    });

    // Initialize state from URL parameters on modal open
    filterModal.addEventListener('show.bs.modal', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tagsFromUrl = urlParams.getAll('tags');

        // Clear previous state
        selectedTagIds.clear();

        if (tagsFromUrl.length > 0 && tagsFromUrl[0]) {
            // Handle both comma-separated and multiple 'tags' params
            const allTags = tagsFromUrl.flatMap(t => t.split(','));
            allTags.forEach(tagId => {
                if (tagId && tagId.trim()) {
                    const tagItem = Array.from(tagItems).find(item => item.dataset.tagId === tagId.trim());
                    if (tagItem) {
                        selectedTagIds.add(tagId.trim());
                    }
                }
            });
        }
        
        updateSelectedTagsDisplay();
        updateTagItemsState();
        updateHiddenInput();
    });
});
</script>






<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/enterprise-trades-list.js') }}"></script>

<!-- Prevent unsaved changes auto-initialization on this page -->
<script>
// IMMEDIATE execution to block before any other scripts run
(function() {
    // Set blocking flag
    window.__blockUnsavedChangesInit = true;
    
    // Override the auto-initialization part of the unsaved-changes.js
    // This needs to run before DOMContentLoaded
    const originalAddEventListener = document.addEventListener;
    document.addEventListener = function(type, listener, options) {
        // Block the DOMContentLoaded listener from unsaved-changes.js that would auto-initialize
        if (type === 'DOMContentLoaded' && listener.toString().includes('enterpriseUnsavedChanges')) {
            console.log('Blocked unsaved changes DOMContentLoaded listener');
            return;
        }
        return originalAddEventListener.call(this, type, listener, options);
    };
    
    // Add our own DOMContentLoaded to clean up after other scripts load
    originalAddEventListener.call(document, 'DOMContentLoaded', function() {
        // Restore original addEventListener
        document.addEventListener = originalAddEventListener;
        
        // Destroy any instance that might have been created despite our blocking
        if (window.enterpriseUnsavedChanges) {
            console.log('Force destroying unsaved changes instance');
            try {
                window.enterpriseUnsavedChanges.hasUnsavedChanges = false;
                window.enterpriseUnsavedChanges.isSubmitting = true;
                window.enterpriseUnsavedChanges.destroy();
            } catch (e) {
                console.warn('Error destroying unsaved changes:', e);
            }
            window.enterpriseUnsavedChanges = null;
        }
        
        // Override initialization functions
        if (window.initEnterpriseUnsavedChanges) {
            window.initEnterpriseUnsavedChanges = function() {
                console.log('Blocked unsaved changes initialization on trades list page');
                return null;
            };
        }
        
        // Clean up any existing beforeunload listeners
        window.onbeforeunload = null;
        
        console.log(' Unsaved changes completely disabled for trades list page');
    }, { once: true });
})();
</script>
<script>
// =====================================
// TABLE SORTING
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortTable(sortKey);
        });
    });
});

function sortTable(field) {
    console.log(' Sorting by field:', field);
    const currentUrl = new URL(window.location);
    const currentSort = currentUrl.searchParams.get('sort');
    const currentOrder = currentUrl.searchParams.get('order') || 'asc';

    let newOrder = 'asc';
    if (currentSort === field && currentOrder === 'asc') {
        newOrder = 'desc';
    }

    currentUrl.searchParams.set('sort', field);
    currentUrl.searchParams.set('order', newOrder);
    currentUrl.searchParams.set('page', '1');

    window.location.href = currentUrl.toString();
}

// =====================================
// PAGE SIZE DROPDOWN & PAGINATION
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    // Page size dropdown functionality
    const pageSizeDropdown = document.getElementById('pageSizeDropdown');
    if (pageSizeDropdown) {
        pageSizeDropdown.addEventListener('change', function() {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('per_page', this.value);
            currentUrl.searchParams.delete('page'); // Reset to first page
            window.location.href = currentUrl.toString();
        });
    }

    // Pagination arrow clicks functionality
    const paginationArrows = document.querySelectorAll('.pagination-arrow-borderless:not(.disabled)');
    paginationArrows.forEach(arrow => {
        if (arrow.href) {
            arrow.addEventListener('click', function(e) {
                // Allow normal navigation
                console.log('Navigating to:', this.href);
            });
        }
    });

    console.log('Pagination system initialized');
});

// =====================================
// EXPORT FUNCTIONS
// =====================================
function exportTradesCSV() {
    const exportBtn = document.querySelector('button[onclick="exportTradesCSV()"]');
    const originalHtml = exportBtn.innerHTML;

    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;

    fetch('/trades/export-csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('CSV export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Trading_Operations_Export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        if (typeof showSuccess === 'function') {
            showSuccess('Trading data exported to CSV successfully.', 'CSV Export Complete');
        } else {
            alert('CSV export completed successfully.');
        }
    })
    .catch(error => {
        console.error('CSV Export error:', error);
        if (typeof showErrorMessage === 'function') {
            showErrorMessage('CSV export failed. Please try again.');
        } else {
            alert('CSV export failed. Please try again.');
        }
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

// =====================================
// UTILITY FUNCTIONS
// =====================================
function getCSRFToken() {
    let csrfToken = null;

    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.getAttribute('content')) {
        csrfToken = metaTag.getAttribute('content');
    }

    if (!csrfToken) {
        const hiddenInput = document.querySelector('input[name="csrf_token"]');
        if (hiddenInput && hiddenInput.value) {
            csrfToken = hiddenInput.value;
        }
    }

    return csrfToken;
}

// =====================================
// INDIVIDUAL FILTER REMOVAL
// =====================================
function removeFilter(encodedFilterType) {
    const filterType = decodeURIComponent(encodedFilterType);
    const currentUrl = new URL(window.location);
    
    // Map filter display names to URL parameters
    const filterMappings = {
        'Start Date': 'start_date',
        'End Date': 'end_date', 
        'Instrument': 'instrument',
        'Direction': 'direction',
        'Model': 'trading_model_id',
        'How Closed': 'how_closed',
        'P&L': 'pnl_filter',
        'DCA': 'is_dca',
        'Min Contracts': 'min_contracts',
        'Max Contracts': 'max_contracts',
        'Min Rating': 'min_rating',
        'Min P&L': 'min_pnl',
        'Max P&L': 'max_pnl'
    };

    // Extract the filter key from the display text (e.g., "Start Date: 2024-01-01" -> "Start Date")
    let filterKey = filterType.split(':')[0].trim();
    
    // Handle special cases for P&L filter variations
    if (filterType.includes('P&L: Winners Only') || filterType.includes('P&L: Losers Only') || filterType.includes('P&L: Breakeven')) {
        filterKey = 'P&L';
    }
    
    // Handle Min Rating format (e.g., "Min Rating: 3+" -> "Min Rating")
    if (filterType.includes('Min Rating:')) {
        filterKey = 'Min Rating';
    }
    
    const paramName = filterMappings[filterKey];
    
    console.log('Filter Type:', filterType);
    console.log('Filter Key:', filterKey);
    console.log('Param Name:', paramName);
    
    if (paramName) {
        currentUrl.searchParams.delete(paramName);
        currentUrl.searchParams.set('page', '1'); // Reset to first page
        window.location.href = currentUrl.toString();
    } else {
        console.warn('No mapping found for filter:', filterType);
    }
}

function removeTagByName(tagName) {
    const currentUrl = new URL(window.location);
    const currentTags = currentUrl.searchParams.get('tags');
    
    if (currentTags) {
        // Get the mapping of tag names to IDs from the categorized_tags data
        let tagNameToIdMap = {};
        {% if categorized_tags %}
        {% for category_name, tag_options in categorized_tags %}
        {% for tag_id, tag_name, tag_color in tag_options %}
        tagNameToIdMap['{{ tag_name }}'] = '{{ tag_id }}';
        {% endfor %}
        {% endfor %}
        {% endif %}
        
        const tagIdToRemove = tagNameToIdMap[tagName];
        if (tagIdToRemove) {
            // Split comma-separated tags and remove the specific tag ID
            const tagArray = currentTags.split(',').filter(t => t.trim() && t.trim() !== tagIdToRemove);
            
            if (tagArray.length > 0) {
                currentUrl.searchParams.set('tags', tagArray.join(','));
            } else {
                currentUrl.searchParams.delete('tags');
            }
            
            currentUrl.searchParams.set('page', '1'); // Reset to first page
            window.location.href = currentUrl.toString();
        }
    }
}

// Export with progress indicator
function exportWithProgress(type) {
    let title, message, url;
    
    if (type === 'csv') {
        title = 'Exporting CSV Data';
        message = 'Preparing your trading data for CSV export...';
        url = '{{ url_for("trades.export_trades_csv") }}';
    } else if (type === 'pdf') {
        title = 'Generating Performance Report';
        message = 'Creating comprehensive performance analysis with charts and analytics...';
        url = '{{ url_for("trades.export_performance_report_pdf") }}';
    } else {
        return;
    }
    
    // Show progress indicator
    const progressIndicator = showProgressIndicator(title, message, true);
    
    // Simulate progress updates for better UX
    let progress = 0;
    const progressSteps = type === 'pdf' ? [
        { percent: 10, text: 'Querying trade data...' },
        { percent: 25, text: 'Applying filters...' },
        { percent: 40, text: 'Generating charts...' },
        { percent: 60, text: 'Creating visualizations...' },
        { percent: 80, text: 'Formatting report...' },
        { percent: 95, text: 'Finalizing document...' }
    ] : [
        { percent: 20, text: 'Querying trade data...' },
        { percent: 50, text: 'Applying filters...' },
        { percent: 80, text: 'Formatting CSV data...' }
    ];
    
    let stepIndex = 0;
    const progressInterval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            progressIndicator.updateProgress(step.percent, step.text);
            stepIndex++;
        }
    }, type === 'pdf' ? 800 : 500);
    
    // Build URL with current filters
    const currentUrl = new URL(window.location);
    const filterParams = new URLSearchParams();
    
    // Copy all filter parameters from current URL
    for (const [key, value] of currentUrl.searchParams) {
        if (key !== 'page' && key !== 'per_page') {
            filterParams.set(key, value);
        }
    }
    
    const exportUrl = filterParams.toString() ? `${url}?${filterParams.toString()}` : url;
    
    // Debug: Log the constructed URL
    console.log('Export URL:', exportUrl);
    console.log('Filter Params:', filterParams.toString());
    
    // Let progress run for realistic timing, then trigger download
    setTimeout(() => {
        clearInterval(progressInterval);
        progressIndicator.updateProgress(100, 'Starting download...');
        
        // Create a temporary link to trigger download without navigation
        const link = document.createElement('a');
        link.href = exportUrl;
        link.target = '_blank';  // Open in new tab/window for download
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Hide progress indicator after download triggers
        setTimeout(() => {
            progressIndicator.hide();
        }, 1000);
        
    }, type === 'pdf' ? 4000 : 2000);
}
</script>
{% endblock %}

