{% extends "base.html" %}

{% block title %}Trading Operations Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block page_header %}
<div class="executive-header">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
            <h1 class="executive-title">
                <i class="fas fa-chart-line me-2"></i>
                Trading Operations Center
            </h1>
            <p class="executive-subtitle">Strategic Trading Activity Management & Performance Analysis</p>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('main.index') }}'"
                    title="Go to Main Dashboard">
                <i class="fas fa-home"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                    title="New Trade Configuration">
                <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="location.reload()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="history.back();"
                    title="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="enterprise-container mt-4">
    <!-- Performance KPI Section -->
    {% if trades %}
    <div class="kpi-section mb-4">
        <div class="grid grid-cols-4 gap-3">
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-primary">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Total Trades</div>
                        <div class="kpi-value">{{ pagination.total if pagination else trades|length }}</div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-success position-relative">
                        <canvas id="winLossChart" width="40" height="40" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></canvas>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Win/Loss Distribution</div>
                        <div class="kpi-value">
                            {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                            {% set losing = trades|selectattr('pnl', 'lessthan', 0)|list|length %}
                            {% set breakeven = trades|selectattr('pnl', 'equalto', 0)|list|length %}
                            <small>W: {{ profitable }} | L: {{ losing }} | BE: {{ breakeven }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-warning">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Strike Rate</div>
                        <div class="kpi-value">
                            {% set profitable = trades|selectattr('pnl', 'greaterthan', 0)|list|length %}
                            {% set total_with_pnl = trades|selectattr('pnl', 'number')|list|length %}
                            {{ "%.1f"|format((profitable / total_with_pnl * 100) if total_with_pnl > 0 else 0) }}%
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="d-flex align-items-center">
                    <div class="performance-indicator bg-info">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="ms-3">
                        <div class="kpi-label">Cumulative P&L</div>
                        <div class="kpi-value">
                            {% set total_pnl = 0 %}
                            {% for trade in trades %}
                                {% if trade.pnl %}
                                    {% set total_pnl = total_pnl + trade.pnl %}
                                {% endif %}
                            {% endfor %}
                            {% if total_pnl > 0 %}
                                <span class="text-success">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% elif total_pnl < 0 %}
                                <span class="text-danger">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% else %}
                                <span class="text-muted">${{ "{:,.2f}".format(total_pnl) }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Configuration Filters Section -->
    <div class="enterprise-module mb-4">
        <div class="module-header">
            <span class="module-title">
                <i class="fas fa-filter module-icon"></i>
                Configuration Filters & Operations
            </span>
            <div class="metrics-bar">
                <button type="button" class="btn btn-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#filterModal"
                        title="Configure Data Filters">
                    <i class="fas fa-sliders-h me-1"></i>Advanced Filters
                </button>
                <a href="{{ url_for('trades.add_trade') }}"
                   class="btn btn-success btn-sm" title="Create New Trade Configuration">
                    <i class="fas fa-plus me-1"></i>New Configuration
                </a>
                <a href="{{ url_for('trades.import_trades') }}"
                   class="btn btn-outline-secondary btn-sm" title="Import Trade Data">
                    <i class="fas fa-upload me-1"></i>Import Data
                </a>
                <a href="{{ url_for('trades.export_trades_csv') }}"
                   class="btn btn-outline-secondary btn-sm" title="Export Trade Data">
                    <i class="fas fa-download me-1"></i>Export Data
                </a>
            </div>
        </div>

        {% if active_filters %}
        <div class="module-content">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="fw-bold text-primary">Active Configuration Filters:</span>
                {% for filter in active_filters %}
                    {% if filter is sequence and filter|length == 3 and filter[0] == 'Tag' %}
                        <span class="status-badge tag-{{ filter[2] }}">
                            {{ filter[0] }}: {{ filter[1] }}
                        </span>
                    {% else %}
                        <span class="status-badge">{{ filter }}</span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('trades.view_trades_list') }}"
                   class="btn btn-outline-warning btn-sm" title="Clear All Filters">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Pagination Block (moved above table) -->
    {% if pagination %}
    <div class="enterprise-module mb-3">
        <div class="module-content">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} - {{ pagination.per_page * (pagination.page - 1) + trades|length }} of {{ pagination.total }} trades
                </div>
                <nav aria-label="Trading Operations Pagination">
                    <ul class="pagination mb-0">
                        <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                            <a class="page-link" href="{{ url_for('trades.view_trades_list', page=pagination.prev_num) if pagination.has_prev }}">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>

                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('trades.view_trades_list', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                            <a class="page-link" href="{{ url_for('trades.view_trades_list', page=pagination.next_num) if pagination.has_next }}">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Trade Operations Data Table -->
    {% if trades %}
    <div class="enterprise-module">
        <div class="module-header">
            <span class="module-title">
                <i class="fas fa-database module-icon"></i>
                Trading Operations Data Repository
            </span>
            <span class="module-meta">{{ trades|length }} Trades Displayed</span>
        </div>
        <div class="module-content p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" role="table">
                    <thead class="table-dark">
                        <tr role="row">
                            <th class="text-center" style="width: 40px;" role="columnheader">
                                <i class="fas fa-angle-down"></i>
                            </th>
                            <th class="sortable text-center" data-sort="date" style="width: 100px;" role="columnheader" tabindex="0">
                                Date <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="instrument" style="width: 80px;" role="columnheader" tabindex="0">
                                SYM <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="model" style="width: 140px;" role="columnheader" tabindex="0">
                                Model <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="direction" style="width: 90px;" role="columnheader" tabindex="0">
                                Dir <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="contracts" style="width: 80px;" role="columnheader" tabindex="0">
                                Contracts <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="entry" style="width: 90px;" role="columnheader" tabindex="0">
                                Avg Entry <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="exit" style="width: 90px;" role="columnheader" tabindex="0">
                                Avg Exit <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="duration" style="width: 90px;" role="columnheader" tabindex="0">
                                Duration <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="closure" style="width: 110px;" role="columnheader" tabindex="0">
                                Closure Method <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="rating" style="width: 80px;" role="columnheader" tabindex="0">
                                Performance <i class="fas fa-sort"></i>
                            </th>
                            <th class="sortable text-center" data-sort="pnl" style="width: 100px;" role="columnheader" tabindex="0">
                                P&L <i class="fas fa-sort"></i>
                            </th>
                            <th class="text-center" style="width: 140px;" role="columnheader">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="operation-list">
                        {% for trade in trades %}
                        <!-- Main Trade Row -->
                        <tr class="operation-item trade-row"
                            data-trade-id="{{ trade.id }}" role="row" tabindex="0">

                            <!-- Expandable Indicator -->
                            <td class="text-center" role="gridcell">
                                <i class="fas fa-chevron-right chevron-icon"
                                   id="chevron-{{ trade.id }}"
                                   title="Expand Configuration Details"
                                   style="cursor: pointer;"></i>
                            </td>

                            <!-- Execution Date -->
                            <td class="text-center" role="gridcell">
                                <span class="fw-medium">{{ trade.trade_date.strftime('%d %b %Y') }}</span>
                            </td>

                            <!-- Asset Symbol -->
                            <td class="text-center" role="gridcell">
                                <span class="text-primary fw-bold">{{ trade.instrument or 'N/A' }}</span>
                            </td>

                            <!-- Strategic Framework -->
                            <td class="text-center" role="gridcell" title="Strategic Trading Model Configuration">
                                {% if trade.trading_model %}
                                    {{ trade.trading_model.name }}
                                {% else %}
                                    <span class="text-muted">No Framework</span>
                                {% endif %}
                            </td>

                            <!-- Position Type -->
                            <td class="text-center" role="gridcell">
                                {% if trade.direction == 'Long' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-arrow-up me-1"></i>Long
                                    </span>
                                {% elif trade.direction == 'Short' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-arrow-down me-1"></i>Short
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {{ trade.direction or 'N/A' }}
                                    </span>
                                {% endif %}
                            </td>

                            <!-- Volume -->
                            <td class="text-center" role="gridcell">
                                <span class="fw-medium">{{ trade.total_contracts_entered or '0' }}</span>
                            </td>

                            <!-- Entry Price (no leading $) -->
                            <td class="text-center" role="gridcell">
                                {% if trade.average_entry_price %}
                                    <span class="fw-medium">{{ "%.2f"|format(trade.average_entry_price) }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>

                            <!-- Exit Price (no leading $) -->
                            <td class="text-center" role="gridcell">
                                {% if trade.average_exit_price %}
                                    <span class="fw-medium">{{ "%.2f"|format(trade.average_exit_price) }}</span>
                                {% else %}
                                    <span class="text-muted">Open</span>
                                {% endif %}
                            </td>

                            <!-- Duration -->
                            <td class="text-center" role="gridcell">
                                {% if trade.time_in_trade %}
                                    <span>{{ trade.time_in_trade }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>

                            <!-- Closure Method -->
                            <td class="text-center" role="gridcell">
                                {% if trade.how_closed %}
                                    {{ trade.how_closed }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>

                            <!-- Performance Rating (with color coding) -->
                            <td class="text-center" role="gridcell">
                                {% set rating_fields = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                                {% set valid_ratings = rating_fields|select('number')|list %}
                                {% if valid_ratings %}
                                    {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                                    <div class="rating-display" title="Average Performance Rating">
                                        {% if avg_rating >= 4 %}
                                            <span class="text-success fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                                        {% elif avg_rating >= 3 %}
                                            <span class="text-warning fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                                        {% else %}
                                            <span class="text-danger fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Not Rated</span>
                                {% endif %}
                            </td>

                            <!-- P&L Performance (no leading +) -->
                            <td class="text-center" role="gridcell">
                                {% if trade.pnl %}
                                    {% if trade.pnl > 0 %}
                                        <span class="text-success fw-bold">${{ "%.2f"|format(trade.pnl) }}</span>
                                    {% elif trade.pnl < 0 %}
                                        <span class="text-danger fw-bold">-${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                    {% else %}
                                        <span class="text-muted fw-bold">$0.00</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Pending</span>
                                {% endif %}
                            </td>

                            <!-- Configuration Actions -->
                            <td class="text-center" role="gridcell">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}"
                                       class="btn btn-outline-primary btn-sm"
                                       title="View Configuration Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
                                       class="btn btn-outline-warning btn-sm"
                                       title="Update Configuration">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-outline-danger btn-sm"
                                            title="Remove Configuration"
                                            onclick="confirmSingleDelete({{ trade.id }}, '{{ trade.trade_date.strftime('%m/%d/%Y') }}', '{{ trade.instrument }}', '{{ trade.direction }}')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- Expandable Details Row - Updated Format -->
                        <tr id="details-{{ trade.id }}" class="trade-details-row d-none" role="row">
                            <td colspan="13" class="p-3" role="gridcell">
                                <div class="row g-4">
                                    <!-- Left Column - Trade Details -->
                                    <div class="col-md-8">
                                        <div class="row g-3">
                                            <!-- Basic Trade Info -->
                                            <div class="col-md-6">
                                                <div class="card h-100">
                                                    <div class="card-header bg-primary text-white">
                                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Trade Details</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-2">
                                                            <div class="col-6"><strong>Date:</strong></div>
                                                            <div class="col-6">{{ trade.trade_date.strftime('%d-%b-%Y') }}</div>
                                                            <div class="col-6"><strong>Symbol:</strong></div>
                                                            <div class="col-6">{{ trade.instrument or 'N/A' }}</div>
                                                            <div class="col-6"><strong>Direction:</strong></div>
                                                            <div class="col-6">{{ trade.direction or 'N/A' }}</div>
                                                            <div class="col-6"><strong>Model:</strong></div>
                                                            <div class="col-6">{{ trade.trading_model.name if trade.trading_model else 'None' }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Execution Data -->
                                            <div class="col-md-6">
                                                <div class="card h-100">
                                                    <div class="card-header bg-success text-white">
                                                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Execution</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-2">
                                                            <div class="col-6"><strong>Entry Contracts:</strong></div>
                                                            <div class="col-6">{{ trade.total_contracts_entered or '0' }}</div>
                                                            <div class="col-6"><strong>Avg Entry:</strong></div>
                                                            <div class="col-6">${{ "%.2f"|format(trade.average_entry_price) if trade.average_entry_price else 'N/A' }}</div>
                                                            <div class="col-6"><strong>Exit Contracts:</strong></div>
                                                            <div class="col-6">{{ trade.total_contracts_exited or '0' }}</div>
                                                            <div class="col-6"><strong>Avg Exit:</strong></div>
                                                            <div class="col-6">${{ "%.2f"|format(trade.average_exit_price) if trade.average_exit_price else 'Open' }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Risk Management -->
                                            <div class="col-md-6">
                                                <div class="card h-100">
                                                    <div class="card-header bg-warning text-dark">
                                                        <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Risk Management</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-2">
                                                            <div class="col-6"><strong>Initial Stop:</strong></div>
                                                            <div class="col-6">${{ "%.2f"|format(trade.initial_stop_loss) if trade.initial_stop_loss else 'N/A' }}</div>
                                                            <div class="col-6"><strong>Target:</strong></div>
                                                            <div class="col-6">${{ "%.2f"|format(trade.terminus_target) if trade.terminus_target else 'N/A' }}</div>
                                                            <div class="col-6"><strong>Risk Capital:</strong></div>
                                                            <div class="col-6">${{ "%.2f"|format(trade.dollar_risk) if trade.dollar_risk else 'N/A' }}</div>
                                                            <div class="col-6"><strong>R-Multiple:</strong></div>
                                                            <div class="col-6">{{ "%.2f"|format(trade.pnl_in_r) if trade.pnl_in_r else 'N/A' }}R</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Performance Results -->
                                            <div class="col-md-6">
                                                <div class="card h-100">
                                                    <div class="card-header bg-info text-white">
                                                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Performance</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row g-2">
                                                            <div class="col-6"><strong>Duration:</strong></div>
                                                            <div class="col-6">{{ trade.time_in_trade or 'N/A' }}</div>
                                                            <div class="col-6"><strong>How Closed:</strong></div>
                                                            <div class="col-6">{{ trade.how_closed or 'N/A' }}</div>
                                                            <div class="col-6"><strong>P&L:</strong></div>
                                                            <div class="col-6">
                                                                {% if trade.pnl %}
                                                                    {% if trade.pnl > 0 %}
                                                                        <span class="text-success fw-bold">${{ "%.2f"|format(trade.pnl) }}</span>
                                                                    {% elif trade.pnl < 0 %}
                                                                        <span class="text-danger fw-bold">-${{ "%.2f"|format(trade.pnl|abs) }}</span>
                                                                    {% else %}
                                                                        <span class="text-muted">$0.00</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">Pending</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="col-6"><strong>Overall Rating:</strong></div>
                                                            <div class="col-6">
                                                                {% set rating_fields = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                                                                {% set valid_ratings = rating_fields|select('number')|list %}
                                                                {% if valid_ratings %}
                                                                    {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                                                                    {{ "%.1f"|format(avg_rating) }}/5
                                                                {% else %}
                                                                    Not Rated
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column - Radar Chart -->
                                    <div class="col-md-4">
                                        {% set rating_fields = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                                        {% set valid_ratings = rating_fields|select('number')|list %}
                                        {% if valid_ratings %}
                                        <div class="card h-100">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0"><i class="fas fa-chart-radar me-2"></i>Performance Analysis</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <canvas id="radarChart-{{ trade.id }}" width="200" height="200" class="mb-3"></canvas>
                                                <div class="text-start">
                                                    {% if trade.preparation_rating %}
                                                    <div><strong>Preparation:</strong> {{ trade.preparation_rating }}/5</div>
                                                    {% endif %}
                                                    {% if trade.rules_rating %}
                                                    <div><strong>Rules:</strong> {{ trade.rules_rating }}/5</div>
                                                    {% endif %}
                                                    {% if trade.management_rating %}
                                                    <div><strong>Management:</strong> {{ trade.management_rating }}/5</div>
                                                    {% endif %}
                                                    {% if trade.target_rating %}
                                                    <div><strong>Target:</strong> {{ trade.target_rating }}/5</div>
                                                    {% endif %}
                                                    {% if trade.entry_rating %}
                                                    <div><strong>Entry:</strong> {{ trade.entry_rating }}/5</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="card h-100">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0"><i class="fas fa-chart-radar me-2"></i>Performance Analysis</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="text-muted">
                                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                    <p>No performance ratings available for this trade.</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Trade Tags (if any) -->
                                {% if trade.tags %}
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Configuration Tags</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for tag in trade.tags %}
                                                        <span class="badge bg-{{ tag.color_category or 'info' }}">{{ tag.name }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="enterprise-module text-center">
        <div class="module-content py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No Trading Operations Found</h4>
            <p class="text-muted mb-4">Begin by creating your first trade configuration to establish operational data.</p>
            <a href="{{ url_for('trades.add_trade') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Trade Configuration
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="GET" action="{{ url_for('trades.view_trades_list') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">
                        <i class="fas fa-filter me-2"></i>Advanced Configuration Filters
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-2 gap-3">
                        {% if filter_form %}
                        <!-- Date Range -->
                        <div class="form-group">
                            {{ filter_form.start_date.label(class="form-label") }}
                            {{ filter_form.start_date(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ filter_form.end_date.label(class="form-label") }}
                            {{ filter_form.end_date(class="form-control") }}
                        </div>

                        <!-- Asset Symbol -->
                        <div class="form-group">
                            {{ filter_form.instrument.label(class="form-label") }}
                            {{ filter_form.instrument(class="form-select") }}
                        </div>

                        <!-- Position Direction -->
                        <div class="form-group">
                            {{ filter_form.direction.label(class="form-label") }}
                            {{ filter_form.direction(class="form-select") }}
                        </div>

                        <!-- Strategic Model -->
                        <div class="form-group">
                            {{ filter_form.trading_model_id.label(class="form-label") }}
                            {{ filter_form.trading_model_id(class="form-select") }}
                        </div>

                        <!-- Configuration Tags -->
                        <div class="form-group">
                            {{ filter_form.tags.label(class="form-label") }}
                            {{ filter_form.tags(class="form-control", placeholder="Enter configuration tags") }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Cancel Operation
                    </button>
                    <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-warning">
                        Clear All Filters
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Apply Configuration Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Operations Modal -->
<div class="modal fade" id="bulkOperationsModal" tabindex="-1" aria-labelledby="bulkOperationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkOperationsModalLabel">
                    <i class="fas fa-cogs me-2"></i>Bulk Configuration Operations
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkDeleteForm" method="POST" action="{{ url_for('trades.bulk_delete_trades') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Bulk Operation Warning:</strong> Selected configurations will be permanently removed from the system.
                    </div>
                    <div id="selectedTradesList" class="operation-list">
                        <!-- Selected trades will be populated here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancel Operation
                </button>
                <button type="button" class="btn btn-danger" onclick="executeBulkDelete()">
                    <i class="fas fa-trash-alt me-1"></i>Remove Selected Configurations
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>

<!-- Clean JavaScript implementation -->
<script>
/**
 * Clean Enterprise Trading Operations JavaScript
 * Simple, working implementation focused on dropdown functionality and charts
 */

console.log('🚀 Loading clean enterprise trades script...');

// Simple dropdown toggle function
function toggleTradeDetails(tradeId) {
    console.log('🔧 Attempting to toggle trade details for ID:', tradeId);

    const detailsRow = document.getElementById(`details-${tradeId}`);
    const chevron = document.getElementById(`chevron-${tradeId}`);

    console.log('Details row found:', detailsRow);
    console.log('Chevron found:', chevron);

    if (detailsRow) {
        const isHidden = detailsRow.classList.contains('d-none');
        console.log('Currently hidden:', isHidden);

        if (isHidden) {
            detailsRow.classList.remove('d-none');
            if (chevron) {
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            }
            // Initialize radar chart when expanding
            setTimeout(() => {
                initializeRadarChart(tradeId);
            }, 100);
            console.log('✅ Expanded trade details');
        } else {
            detailsRow.classList.add('d-none');
            if (chevron) {
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
            console.log('✅ Collapsed trade details');
        }
    } else {
        console.error('❌ Details row not found for trade ID:', tradeId);
    }
}

// Radar Chart Implementation
function initializeRadarChart(tradeId) {
    const canvas = document.getElementById(`radarChart-${tradeId}`);
    if (!canvas || canvas.hasAttribute('data-chart-initialized')) {
        return;
    }

    console.log('📊 Initializing radar chart for trade:', tradeId);

    try {
        const ratings = extractTradeRatings(tradeId);
        if (ratings && Object.keys(ratings).length > 0) {
            renderRadarChart(canvas, ratings);
            canvas.setAttribute('data-chart-initialized', 'true');
        } else {
            console.log('📊 No ratings found for trade:', tradeId);
        }
    } catch (error) {
        console.error('❌ Chart initialization error:', error);
    }
}

// Extract ratings from the details panel
function extractTradeRatings(tradeId) {
    const detailsRow = document.getElementById(`details-${tradeId}`);
    if (!detailsRow) return null;

    const ratings = {};

    // Look for rating text in the card body
    const cardBody = detailsRow.querySelector('.card-body .text-start');
    if (cardBody) {
        const ratingElements = cardBody.querySelectorAll('div');
        ratingElements.forEach(element => {
            const text = element.textContent;
            if (text.includes('/5')) {
                const parts = text.split(':');
                if (parts.length === 2) {
                    const name = parts[0].trim();
                    const rating = parseInt(parts[1].split('/')[0].trim());
                    if (!isNaN(rating) && rating >= 1 && rating <= 5) {
                        ratings[name] = rating;
                    }
                }
            }
        });
    }

    return Object.keys(ratings).length > 0 ? ratings : null;
}

// Render the radar chart
function renderRadarChart(canvas, ratings) {
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 30;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const categories = Object.keys(ratings);
    const values = Object.values(ratings);
    const maxValue = 5;

    if (categories.length === 0) {
        // Draw "No Data" message
        ctx.fillStyle = '#6c757d';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No Ratings', centerX, centerY);
        return;
    }

    // Colors
    const gridColor = '#dee2e6';
    const dataColor = '#0d6efd';
    const fillColor = 'rgba(13, 110, 253, 0.2)';

    // Draw grid circles
    for (let i = 1; i <= maxValue; i++) {
        const gridRadius = (radius * i) / maxValue;
        ctx.beginPath();
        ctx.arc(centerX, centerY, gridRadius, 0, 2 * Math.PI);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    // Draw grid lines and labels
    const angleStep = (2 * Math.PI) / categories.length;
    categories.forEach((category, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;

        // Grid line
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        ctx.stroke();

        // Label
        ctx.fillStyle = dataColor;
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const labelX = centerX + Math.cos(angle) * (radius + 20);
        const labelY = centerY + Math.sin(angle) * (radius + 20);

        ctx.fillText(category.substring(0, 6), labelX, labelY);
    });

    // Draw data polygon
    if (values.length > 0) {
        const points = values.map((value, index) => {
            const angle = index * angleStep - Math.PI / 2;
            const distance = (radius * value) / maxValue;
            return {
                x: centerX + Math.cos(angle) * distance,
                y: centerY + Math.sin(angle) * distance
            };
        });

        // Fill area
        ctx.fillStyle = fillColor;
        ctx.beginPath();
        points.forEach((point, i) => {
            if (i === 0) ctx.moveTo(point.x, point.y);
            else ctx.lineTo(point.x, point.y);
        });
        ctx.closePath();
        ctx.fill();

        // Draw outline
        ctx.strokeStyle = dataColor;
        ctx.lineWidth = 2;
        ctx.stroke();

        // Draw data points
        ctx.fillStyle = dataColor;
        points.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
            ctx.fill();
        });
    }
}

// Win/Loss Chart for KPI
function initializeWinLossChart() {
    const canvas = document.getElementById('winLossChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 2;

    // Get data from the template
    const kpiText = canvas.closest('.kpi-card').querySelector('.kpi-value small').textContent;
    const matches = kpiText.match(/W: (\d+) \| L: (\d+) \| BE: (\d+)/);

    if (matches) {
        const wins = parseInt(matches[1]);
        const losses = parseInt(matches[2]);
        const breakeven = parseInt(matches[3]);
        const total = wins + losses + breakeven;

        if (total > 0) {
            const colors = ['#28a745', '#dc3545', '#ffc107']; // Green, Red, Yellow
            const data = [wins, losses, breakeven];

            let currentAngle = -Math.PI / 2;

            data.forEach((value, index) => {
                if (value > 0) {
                    const sliceAngle = (value / total) * 2 * Math.PI;

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[index];
                    ctx.fill();

                    currentAngle += sliceAngle;
                }
            });
        }
    }
}

// Simple delete confirmation
function confirmSingleDelete(tradeId, date, instrument, direction) {
    const message = `Remove trade: ${date} - ${instrument} (${direction})?\n\nThis action cannot be undone.`;
    if (confirm(message)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/trades/${tradeId}/delete`;
        form.style.display = 'none';

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// Simple sorting function
function sortTable(field) {
    console.log('🔄 Sorting by field:', field);
    const currentUrl = new URL(window.location);
    const currentSort = currentUrl.searchParams.get('sort');
    const currentOrder = currentUrl.searchParams.get('order') || 'asc';

    let newOrder = 'asc';
    if (currentSort === field && currentOrder === 'asc') {
        newOrder = 'desc';
    }

    currentUrl.searchParams.set('sort', field);
    currentUrl.searchParams.set('order', newOrder);
    currentUrl.searchParams.set('page', '1');

    window.location.href = currentUrl.toString();
}

// Setup event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Setting up enterprise trades event listeners...');

    // Initialize win/loss chart
    initializeWinLossChart();

    // Setup trade row click handlers
    document.addEventListener('click', function(e) {
        console.log('👆 Click detected on:', e.target);

        // Handle chevron clicks directly
        if (e.target.classList.contains('chevron-icon')) {
            console.log('🎯 Chevron clicked directly');
            e.preventDefault();
            e.stopPropagation();

            const tradeId = e.target.id.replace('chevron-', '');
            console.log('📊 Trade ID from chevron:', tradeId);

            if (tradeId) {
                toggleTradeDetails(tradeId);
            }
            return;
        }

        // Handle trade row clicks (but not buttons)
        const tradeRow = e.target.closest('.trade-row');
        if (tradeRow && !e.target.closest('.btn-group') && !e.target.closest('.btn')) {
            console.log('📋 Trade row clicked');
            e.preventDefault();
            e.stopPropagation();

            const tradeId = tradeRow.getAttribute('data-trade-id');
            console.log('📊 Trade ID from row:', tradeId);

            if (tradeId) {
                toggleTradeDetails(tradeId);
            }
        }

        // Handle sortable header clicks
        const sortable = e.target.closest('.sortable');
        if (sortable) {
            console.log('📊 Sortable header clicked');
            const field = sortable.getAttribute('data-sort');
            if (field) {
                sortTable(field);
            }
        }
    });

    console.log('✅ Event listeners setup complete');
});

// Placeholder functions to prevent errors
function updateUrlAndRedirect(params) {
    const url = new URL(window.location);
    Object.keys(params).forEach(key => {
        url.searchParams.set(key, params[key]);
    });
    window.location.href = url.toString();
}

function changePageSize(newSize) {
    updateUrlAndRedirect({
        per_page: newSize,
        page: 1
    });
}

function executeBulkDelete() {
    console.log('Bulk delete function called');
}

console.log('✅ Clean enterprise trades script loaded successfully');

</script>


{% endblock %}