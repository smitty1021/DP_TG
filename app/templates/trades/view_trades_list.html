<!-- Enterprise Trading Operations View Template -->
{% extends "base.html" %}
{% import "macros/_pagination_helpers.html" as pagi %}
{% import "macros/_form_helpers.html" as forms %}

{% block title %}
    {{ title }} - Trading Journal
{% endblock %}

{% block head_extra %}
<!-- CSRF Token for JavaScript -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- TomSelect for enhanced select styling -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<!-- Load enterprise scripts -->
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/enterprise-trades-list.js') }}"></script>
{% endblock %}

{% block content %}

<div class="enterprise-container-fluid mt-4 mb-0">
<!-- Executive Header -->
<div class="executive-header">
    <div class="d-flex justify-content-between align-items-center">
        <div class="header-content">
            <h1 class="executive-title">
                <i class="fas fa-chart-line executive-icon"></i>{{ title }}
            </h1>
            <div class="executive-subtitle">
                Strategic Trading Operations Overview & Performance Analysis
            </div>
        </div>
        
        <!-- Standard Action Buttons -->
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('main.index') }}'"
                    title="Go to Main Dashboard">
                <i class="fas fa-home"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('trades.add_trade') }}'"
                    title="New Trade Configuration">
                <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="location.reload()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="window.location.href='{{ url_for('admin.show_admin_dashboard') }}'"
                    title="Back to Administration Center">
                <i class="fas fa-tachometer-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    onclick="history.back();"
                    title="Go Back">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </div>
</div>

<!-- Filter Calculation Logic -->
{% set active_filters = [] %}
{% if request.args.get('start_date') %}
    {% set _ = active_filters.append('Start Date: ' + request.args.get('start_date')) %}
{% endif %}
{% if request.args.get('end_date') %}
    {% set _ = active_filters.append('End Date: ' + request.args.get('end_date')) %}
{% endif %}
{% if request.args.get('instrument') and request.args.get('instrument') != '' %}
    {% set instrument_id = request.args.get('instrument') %}
    {% set instrument_dict = dict(filter_form.instrument.choices) %}
    {% set instrument_label = instrument_dict.get(instrument_id, instrument_id) %}
    {% set _ = active_filters.append('Instrument: ' + instrument_label) %}
{% endif %}
{% if request.args.get('direction') %}
    {% set _ = active_filters.append('Direction: ' + request.args.get('direction')) %}
{% endif %}
{% if request.args.get('trading_model_id') and request.args.get('trading_model_id') != '0' %}
    {% set model_id = request.args.get('trading_model_id') %}
    {% set model_dict = dict(filter_form.trading_model_id.choices) %}
    {% set model_label = model_dict.get(model_id|int, model_id) %}
    {% set _ = active_filters.append('Model: ' + model_label) %}
{% endif %}
{% if request.args.get('how_closed') %}
    {% set _ = active_filters.append('How Closed: ' + request.args.get('how_closed')) %}
{% endif %}
{% if request.args.get('pnl_filter') %}
    {% if request.args.get('pnl_filter') == 'winners' %}
        {% set _ = active_filters.append('P&L: Winners Only') %}
    {% elif request.args.get('pnl_filter') == 'losers' %}
        {% set _ = active_filters.append('P&L: Losers Only') %}
    {% elif request.args.get('pnl_filter') == 'breakeven' %}
        {% set _ = active_filters.append('P&L: Breakeven') %}
    {% endif %}
{% endif %}
{% if request.args.get('is_dca') %}
    {% if request.args.get('is_dca') == 'true' %}
        {% set _ = active_filters.append('DCA: Yes') %}
    {% elif request.args.get('is_dca') == 'false' %}
        {% set _ = active_filters.append('DCA: No') %}
    {% endif %}
{% endif %}
{% if request.args.get('min_contracts') %}
    {% set _ = active_filters.append('Min Contracts: ' + request.args.get('min_contracts')) %}
{% endif %}
{% if request.args.get('max_contracts') %}
    {% set _ = active_filters.append('Max Contracts: ' + request.args.get('max_contracts')) %}
{% endif %}
{% if request.args.get('min_rating') %}
    {% set _ = active_filters.append('Min Rating: ' + request.args.get('min_rating') + '+') %}
{% endif %}
{% if request.args.get('min_pnl') %}
    {% set _ = active_filters.append('Min P&L: $' + request.args.get('min_pnl')) %}
{% endif %}
{% if request.args.get('max_pnl') %}
    {% set _ = active_filters.append('Max P&L: $' + request.args.get('max_pnl')) %}
{% endif %}

{% if request.args.get('tags') or request.args.getlist('tags') %}
    {% set selected_tag_ids = request.args.getlist('tags') if request.args.getlist('tags') else [request.args.get('tags')] %}
    {% for tag_id in selected_tag_ids %}
        {% if tag_id and tag_id.strip() %}
            {% set ns = namespace(tag_label=tag_id, tag_color='neutral') %}
            {% if categorized_tags %}
                {% for category_name, tag_options in categorized_tags %}
                    {% for tag_option_id, tag_option_name, tag_option_color in tag_options %}
                        {% if tag_option_id == tag_id %}
                            {% set ns.tag_label = tag_option_name %}
                            {% set ns.tag_color = tag_option_color or 'neutral' %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            {% set _ = active_filters.append(('Tag', ns.tag_label, ns.tag_color)) %}
        {% endif %}
    {% endfor %}
{% endif %}

<!-- Pagination and Action Buttons Row -->
            <div class="d-flex justify-content-between align-items-center">
                <!-- Enhanced Pagination Controls -->
                <div class="d-flex align-items-center gap-2">
                    <!-- Results Summary with better formatting -->
                    <div class="text-muted small">
                        Trades {{ pagination.per_page * (pagination.page - 1) + 1 }} - {{ pagination.per_page * (pagination.page - 1) + trades|length }} of {{ pagination.total }}
                    </div>

                    <!-- Enhanced Page Size Dropdown -->
                    <span class="text-muted small me-2">Page Size:</span>
                    <select id="pageSizeDropdown" class="form-select form-select-sm" style="width: 70px;"
                            onchange="changePageSize(this.value)" title="Items per page">
                        <option value="25" {{ 'selected' if request.args.get('per_page', '25')|string == '25' else '' }}>25</option>
                        <option value="50" {{ 'selected' if request.args.get('per_page', '25')|string == '50' else '' }}>50</option>
                        <option value="100" {{ 'selected' if request.args.get('per_page', '25')|string == '100' else '' }}>100</option>
                        <option value="250" {{ 'selected' if request.args.get('per_page', '25')|string == '250' else '' }}>250</option>
                    </select>

                    <!-- Enhanced Navigation Arrows with no borders -->
                    <div class="d-flex align-items-center gap-1">
                        <!-- First Page Arrow -->
                        {% if pagination.page > 1 %}
                        {% set args_without_page = request.args.copy() %}
                        {% set _ = args_without_page.pop('page', None) %}
                        <a href="{{ url_for('trades.view_trades_list', page=1, **args_without_page) }}"
                           class="pagination-arrow-borderless" title="First Page (Ctrl+Home)">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        {% else %}
                        <span class="pagination-arrow-borderless disabled" title="First Page">
                            <i class="fas fa-angle-double-left"></i>
                        </span>
                        {% endif %}

                        <!-- Previous Page Arrow -->
                        {% if pagination.has_prev %}
                        {% set args_without_page = request.args.copy() %}
                        {% set _ = args_without_page.pop('page', None) %}
                        <a href="{{ url_for('trades.view_trades_list', page=pagination.prev_num, **args_without_page) }}"
                           class="pagination-arrow-borderless" title="Previous Page (Ctrl+Left)">
                            <i class="fas fa-angle-left"></i>
                        </a>
                        {% else %}
                        <span class="pagination-arrow-borderless disabled" title="Previous Page">
                            <i class="fas fa-angle-left"></i>
                        </span>
                        {% endif %}

                        <!-- Enhanced Page Info -->
                        <span class="pagination-info small">
                            Page {{ pagination.page }} of {{ pagination.pages }}
                        </span>

                        <!-- Next Page Arrow -->
                        {% if pagination.has_next %}
                        {% set args_without_page = request.args.copy() %}
                        {% set _ = args_without_page.pop('page', None) %}
                        <a href="{{ url_for('trades.view_trades_list', page=pagination.next_num, **args_without_page) }}"
                           class="pagination-arrow-borderless" title="Next Page (Ctrl+Right)">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        {% else %}
                        <span class="pagination-arrow-borderless disabled" title="Next Page">
                            <i class="fas fa-angle-right"></i>
                        </span>
                        {% endif %}

                        <!-- Last Page Arrow -->
                        {% if pagination.page < pagination.pages %}
                        {% set args_without_page = request.args.copy() %}
                        {% set _ = args_without_page.pop('page', None) %}
                        <a href="{{ url_for('trades.view_trades_list', page=pagination.pages, **args_without_page) }}"
                           class="pagination-arrow-borderless" title="Last Page (Ctrl+End)">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                        {% else %}
                        <span class="pagination-arrow-borderless disabled" title="Last Page">
                            <i class="fas fa-angle-double-right"></i>
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Enhanced Action Buttons with proper spacing -->
                <div class="d-flex align-items-center gap-2">
                        <!-- Clear Filters Button - Only show when filters are active -->
                        {% if active_filters %}
                        <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-warning btn-sm" title="Clear all active filters">
                            <i class="fas fa-times-circle me-1"></i> Clear Filters
                        </a>
                        {% endif %}

                        <a href="{{ url_for('trades.add_trade') }}" class="btn btn-success-borderonly btn-sm" title="Log New Trade (Ctrl+N)">
                            <i class="fas fa-plus me-1"></i> Log New Trade
                        </a>
                        <button class="btn btn-primary-borderonly btn-sm" type="button" data-bs-toggle="modal"
                                data-bs-target="#filterModal" title="Filter Trades (Ctrl+F)">
                            <i class="fas fa-filter me-1"></i> Filter Trades
                        </button>
                        <a href="{{ url_for('trades.import_trades') }}" class="btn btn-outline-secondary btn-sm" title="Import Trades">
                            <i class="fas fa-upload me-1"></i> Import
                        </a>
                        <a href="{{ url_for('trades.export_trades_csv') }}" class="btn btn-outline-secondary btn-sm" title="Export Trades">
                            <i class="fas fa-download me-1"></i> Export
                        </a>
                    </div>
                </div>

<!-- Active Filters Notification -->
{% if active_filters %}
<div class="enterprise-module mb-3">
    <div class="module-header">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <i class="fas fa-filter text-info module-icon"></i>
            <span class="module-title">Active Configuration Filters:</span>
            {% for filter in active_filters %}
                {% if filter is sequence and filter|length == 3 and filter[0] == 'Tag' %}
                    <span class="status-badge tag-{{ filter[2] }}">
                        {{ filter[0] }}: {{ filter[1] }}
                    </span>
                {% else %}
                    <span class="status-badge">{{ filter }}</span>
                {% endif %}
            {% endfor %}
        </div>
        <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-secondary btn-sm" title="Clear all filters">
            <i class="fas fa-times me-1"></i>Clear All
        </a>
    </div>
</div>
{% endif %}

<!-- Enhanced Trades Table -->
{% if trades %}
<div class="enterprise-module">
    <div class="module-header">
        <span class="module-title">
            <i class="fas fa-chart-line module-icon"></i>
            Trading Operations Data
        </span>
        <span class="module-meta">{{ trades|length }} records displayed</span>
    </div>
    <div class="module-content p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" role="table">
                <thead class="table-dark">
                    <tr role="row">
                        <th class="text-center" style="width: 40px;" role="columnheader"></th>
                        <th class="sortable" data-sort="date" style="width: 80px;" role="columnheader" tabindex="0">
                            Date <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="instrument" style="width: 60px;" role="columnheader" tabindex="0">
                            Symbol <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="model" style="width: 120px;" role="columnheader" tabindex="0">
                            Strategic Model <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="direction" style="width: 80px;" role="columnheader" tabindex="0">
                            Direction <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="contracts" style="width: 70px;" role="columnheader" tabindex="0">
                            Quantity <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="entry_time" style="width: 80px;" role="columnheader" tabindex="0">
                            Exec Time <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="entry" style="width: 80px;" role="columnheader" tabindex="0">
                            Entry Price <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="exit" style="width: 80px;" role="columnheader" tabindex="0">
                            Exit Price <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="time_in_trade" style="width: 80px;" role="columnheader" tabindex="0">
                            Duration <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="how_closed" style="width: 100px;" role="columnheader" tabindex="0">
                            Closure Method <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="avg_rating" style="width: 80px;" role="columnheader" tabindex="0">
                            Rating <i class="fas fa-sort"></i>
                        </th>
                        <th class="sortable" data-sort="pnl" style="width: 90px;" role="columnheader" tabindex="0">
                            P&L <i class="fas fa-sort"></i>
                        </th>
                        <th style="width: 140px;" role="columnheader">Actions</th>
                    </tr>
                </thead>
                <tbody class="operation-list">

                {% for trade in trades %}
                <!-- Enhanced Trade Row -->
                <tr class="operation-item trade-row
                    {% if trade.pnl and trade.pnl > 0 %}table-success
                    {% elif trade.pnl and trade.pnl < 0 %}table-danger
                    {% endif %}"
                    data-trade-id="{{ trade.id }}" role="row" tabindex="0">

                    <!-- Dropdown Arrow -->
                    <td class="text-center" role="gridcell">
                        <i class="fas fa-chevron-right chevron-icon" id="chevron-{{ trade.id }}"></i>
                    </td>

                    <!-- Date -->
                    <td role="gridcell">{{ trade.trade_date.strftime('%d %b %y') }}</td>

                    <!-- Instrument -->
                    <td role="gridcell">{{ trade.instrument or 'N/A' }}</td>

                    <!-- Strategic Model -->
                    <td role="gridcell" title="{% if trade.trading_model %}{{ trade.trading_model.name }}{% else %}No model specified{% endif %}">
                        {% if trade.trading_model %}
                            {{ trade.trading_model.name }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Direction -->
                    <td role="gridcell">
                        {% if trade.direction == 'Long' %}
                            <span class="status-badge system-status" style="background-color: var(--enterprise-success); color: white;">{{ trade.direction }}</span>
                        {% elif trade.direction == 'Short' %}
                            <span class="status-badge system-status" style="background-color: var(--enterprise-danger); color: white;">{{ trade.direction }}</span>
                        {% else %}
                            <span class="status-badge system-status">{{ trade.direction or 'N/A' }}</span>
                        {% endif %}
                    </td>

                    <!-- Contracts -->
                    <td role="gridcell">{{ trade.total_contracts_entered or 0 }}</td>

                    <!-- Entry Time -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.entries.first().entry_time %}
                            {{ trade.entries.first().entry_time.strftime('%H:%M') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Entry Price -->
                    <td role="gridcell">
                        {% if trade.average_entry_price %}
                            {{ "{:.2f}".format(trade.average_entry_price) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Exit Price -->
                    <td role="gridcell">
                        {% if trade.average_exit_price %}
                            {{ "{:.2f}".format(trade.average_exit_price) }}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Time in Trade -->
                    <td role="gridcell">
                        {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                            {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                            {% if time_diff >= 0 %}
                                {{ "%d:%02d"|format(time_diff // 60, time_diff % 60) }}
                            {% else %}
                                N/A
                            {% endif %}
                        {% else %}
                            {% if trade.how_closed in ['Still Open', None, ''] %}
                                <span class="text-muted">Open</span>
                            {% else %}
                                N/A
                            {% endif %}
                        {% endif %}
                    </td>

                    <!-- Closure Method -->
                    <td role="gridcell">
                        {% if trade.how_closed %}
                            <span class="operation-status">{{ trade.how_closed }}</span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>

                    <!-- Performance Rating -->
                    <td role="gridcell">
                        {% set ratings = [trade.preparation_rating, trade.rules_rating, trade.management_rating, trade.target_rating, trade.entry_rating] %}
                        {% set valid_ratings = ratings|select('ne', none)|list %}
                        {% if valid_ratings %}
                            {% set avg_rating = (valid_ratings|sum / valid_ratings|length) %}
                            {% if avg_rating >= 4.0 %}
                                <span class="performance-indicator text-success fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                            {% elif avg_rating >= 2.5 %}
                                <span class="performance-indicator text-warning fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                            {% else %}
                                <span class="performance-indicator text-danger fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                            {% endif %}
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                    </td>

                    <!-- P&L Performance -->
                    <td role="gridcell">
                        {% if trade.pnl is not none %}
                            {% if trade.pnl > 0 %}
                                <span class="performance-indicator text-success fw-bold">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% elif trade.pnl < 0 %}
                                <span class="performance-indicator text-danger fw-bold">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% else %}
                                <span class="performance-indicator text-muted fw-bold">${{ "{:,.2f}".format(trade.pnl) }}</span>
                            {% endif %}
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                    </td>

                    <!-- Operational Actions -->
                    <td class="text-end" onclick="event.stopPropagation();" role="gridcell">
                        <div class="action-grid" role="group">
                            <a href="{{ url_for('journal.manage_daily_journal', date_str=trade.trade_date.strftime('%Y-%m-%d')) }}"
                               class="btn btn-outline-info btn-sm" title="Daily Journal">
                                <i class="fas fa-journal-whills"></i>
                            </a>
                            <a href="{{ url_for('trades.view_trade_detail', trade_id=trade.id) }}"
                               class="btn btn-outline-primary btn-sm" title="View Configuration Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}"
                               class="btn btn-outline-warning btn-sm" title="Update Configuration">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger btn-sm"
                                    title="Remove Configuration"
                                    onclick="confirmSingleDelete({{ trade.id }}, '{{ trade.trade_date.strftime('%m/%d/%Y') }}', '{{ trade.instrument }}', '{{ trade.direction }}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Enhanced Trade Details Row -->
                <tr id="details-{{ trade.id }}" class="trade-details-row" style="display: none;" role="row">
                    <td colspan="14" class="p-0" role="gridcell">
                        <div class="enterprise-module m-3">
                            <div class="module-header">
                                <span class="module-title">
                                    <i class="fas fa-chart-area module-icon"></i>
                                    Trade Configuration Analysis
                                </span>
                                <span class="module-meta">Detailed Performance Metrics</span>
                            </div>
                            <div class="module-content">
                                <div class="row g-4">
                                    <!-- Execution Criteria Card -->
                                    <div class="col-lg-4">
                                        <div class="enterprise-module">
                                            <div class="module-header">
                                                <span class="module-title">Strategic Overview</span>
                                            </div>
                                            <div class="module-content">
                                                <div class="operation-list">
                                                    <div class="operation-item">
                                                        <span class="operation-name">Trade Date:</span>
                                                        <span class="operation-status">{{ trade.trade_date.strftime('%d-%b-%Y') }}</span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Instrument:</span>
                                                        <span class="operation-status">{{ trade.instrument or 'N/A' }}</span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Direction:</span>
                                                        <span class="operation-status">
                                                            {% if trade.direction == 'Long' %}
                                                                <span class="status-badge" style="background-color: var(--enterprise-success); color: white;">{{ trade.direction }}</span>
                                                            {% elif trade.direction == 'Short' %}
                                                                <span class="status-badge" style="background-color: var(--enterprise-danger); color: white;">{{ trade.direction }}</span>
                                                            {% else %}
                                                                <span class="status-badge">{{ trade.direction or 'N/A' }}</span>
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Strategic Model:</span>
                                                        <span class="operation-status">{{ trade.trading_model.name if trade.trading_model else 'N/A' }}</span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Closure Method:</span>
                                                        <span class="operation-status">{{ trade.how_closed or 'N/A' }}</span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Resource Tags:</span>
                                                        <div class="operation-status">
                                                            {% if trade.tags %}
                                                                {% for tag in trade.tags %}
                                                                    <span class="status-badge me-1 mb-1">{{ tag.name }}</span>
                                                                {% endfor %}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Documentation:</span>
                                                        <span class="operation-status">
                                                            {% if trade.screenshot_link %}
                                                                <a href="{{ trade.screenshot_link }}" target="_blank" class="btn btn-outline-primary btn-sm">View Asset</a>
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resource Utilization Card -->
                                    <div class="col-lg-4">
                                        <div class="enterprise-module">
                                            <div class="module-header">
                                                <span class="module-title">Resource Utilization</span>
                                            </div>
                                            <div class="module-content">
                                                <div class="operation-list">
                                                    <div class="operation-item">
                                                        <span class="operation-name">Gross P&L:</span>
                                                        <span class="operation-status {% if trade.pnl %}{% if trade.pnl > 0 %}text-success{% elif trade.pnl < 0 %}text-danger{% endif %}{% endif %}">
                                                            {% if trade.pnl is not none %}
                                                                ${{ "{:,.2f}".format(trade.pnl) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">R-Value:</span>
                                                        <span class="operation-status {% if trade.pnl_in_r %}{% if trade.pnl_in_r > 0 %}text-success{% elif trade.pnl_in_r < 0 %}text-danger{% endif %}{% endif %}">
                                                            {% if trade.pnl_in_r is not none %}
                                                                {{ "{:+.2f}".format(trade.pnl_in_r) }}R
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Initial Stop Loss:</span>
                                                        <span class="operation-status">
                                                            {% if trade.initial_stop_loss is not none %}
                                                                {{ "{:.1f}".format(trade.initial_stop_loss) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Target Configuration:</span>
                                                        <span class="operation-status">
                                                            {% if trade.terminus_target is not none %}
                                                                {{ "{:.1f}".format(trade.terminus_target) }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">MAE:</span>
                                                        <span class="operation-status text-danger">
                                                            {% if trade.mae is not none and trade.average_entry_price %}
                                                                {% set mae_percent = ((trade.mae / trade.average_entry_price) * 100) %}
                                                                {% set mae_dollar = (trade.mae * (trade.total_contracts_entered or 0)) %}
                                                                {{ "{:.1f}".format(trade.mae) }} pts / {{ "{:.2f}".format(mae_percent) }}% / ${{ "{:.0f}".format(mae_dollar) }}
                                                            {% elif trade.mae is not none %}
                                                                {{ "{:.1f}".format(trade.mae) }} pts
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">MFE:</span>
                                                        <span class="operation-status text-success">
                                                            {% if trade.mfe is not none and trade.average_entry_price %}
                                                                {% set mfe_percent = ((trade.mfe / trade.average_entry_price) * 100) %}
                                                                {% set mfe_dollar = (trade.mfe * (trade.total_contracts_entered or 0)) %}
                                                                {{ "{:.1f}".format(trade.mfe) }} pts / {{ "{:.2f}".format(mfe_percent) }}% / ${{ "{:.0f}".format(mfe_dollar) }}
                                                            {% elif trade.mfe is not none %}
                                                                {{ "{:.1f}".format(trade.mfe) }} pts
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                    <div class="operation-item">
                                                        <span class="operation-name">Time in Trade:</span>
                                                        <span class="operation-status">
                                                            {% if trade.entries.first() and trade.exits.first() and trade.entries.first().entry_time and trade.exits.first().exit_time %}
                                                                {% set time_diff = (trade.exits.first().exit_time.hour * 60 + trade.exits.first().exit_time.minute) - (trade.entries.first().entry_time.hour * 60 + trade.entries.first().entry_time.minute) %}
                                                                {% if time_diff >= 0 %}
                                                                    {{ "%02dh %02dm"|format(time_diff // 60, time_diff % 60) }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Rating Analysis -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="enterprise-module">
                                            <div class="module-header">
                                                <span class="module-title">
                                                    <i class="fas fa-star module-icon"></i>
                                                    Performance Rating Analysis
                                                </span>
                                            </div>
                                            <div class="module-content">
                                                <div class="row">
                                                    <div class="col-lg-8">
                                                        <div class="operation-list">
                                                            {% for rating_name, rating_value in [
                                                                ('Preparation', trade.preparation_rating),
                                                                ('Rules Adherence', trade.rules_rating),
                                                                ('Risk Management', trade.management_rating),
                                                                ('Target Achievement', trade.target_rating),
                                                                ('Entry Execution', trade.entry_rating)
                                                            ] %}
                                                            <div class="operation-item" data-rating-category="{{ rating_name.lower().replace(' ', '_') }}" data-rating-value="{{ rating_value or 0 }}">
                                                                <span class="operation-name">{{ rating_name }}</span>
                                                                <div class="operation-status d-flex align-items-center">
                                                                    {% for i in range(1, 6) %}
                                                                        <div class="rating-dot me-1 {% if rating_value and i <= rating_value %}filled-{{ rating_value }}{% endif %}"
                                                                             style="width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ccc;
                                                                             {% if rating_value and i <= rating_value %}background-color: var(--enterprise-success);{% else %}background-color: transparent;{% endif %}"></div>
                                                                    {% endfor %}
                                                                    <span class="ms-2 small text-muted">
                                                                        {% if rating_value %}{{ rating_value }}/5{% else %}N/A{% endif %}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-4">
                                                        <div class="d-flex justify-content-center">
                                                            <canvas id="radarChart-{{ trade.id }}" class="radar-chart-canvas" width="240" height="240"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="enterprise-module text-center py-5">
    <div class="module-content">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Trading Operations Found</h4>
        <p class="text-muted">Start by <a href="{{ url_for('trades.add_trade') }}">configuring your first trade operation</a></p>
    </div>
</div>
{% endif %}
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="fas fa-filter me-2"></i>Trade Configuration Filters
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{{ url_for('trades.view_trades_list') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date"
                                       value="{{ request.args.get('start_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date"
                                       value="{{ request.args.get('end_date', '') }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="instrument_filter" class="form-label">Instrument</label>
                                <select class="form-select" id="instrument_filter" name="instrument">
                                    <option value="">All Instruments</option>
                                    {% if filter_form and filter_form.instrument %}
                                        {% for value, label in filter_form.instrument.choices %}
                                            {% if value %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('instrument') == value else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="direction_filter" class="form-label">Direction</label>
                                <select class="form-select" id="direction_filter" name="direction">
                                    <option value="">All Directions</option>
                                    <option value="Long" {{ 'selected' if request.args.get('direction') == 'Long' else '' }}>Long</option>
                                    <option value="Short" {{ 'selected' if request.args.get('direction') == 'Short' else '' }}>Short</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="trading_model_filter" class="form-label">Strategic Model</label>
                                <select class="form-select" id="trading_model_filter" name="trading_model_id">
                                    <option value="">All Models</option>
                                    {% if filter_form and filter_form.trading_model_id %}
                                        {% for value, label in filter_form.trading_model_id.choices %}
                                            {% if value and value != 0 %}
                                                <option value="{{ value }}" {{ 'selected' if request.args.get('trading_model_id') == value|string else '' }}>
                                                    {{ label }}
                                                </option>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="how_closed_filter" class="form-label">Closure Method</label>
                                <select class="form-select" id="how_closed_filter" name="how_closed">
                                    <option value="">All</option>
                                    <option value="Target Hit" {{ 'selected' if request.args.get('how_closed') == 'Target Hit' else '' }}>Target Hit</option>
                                    <option value="Stop Loss" {{ 'selected' if request.args.get('how_closed') == 'Stop Loss' else '' }}>Stop Loss</option>
                                    <option value="Closed Manually" {{ 'selected' if request.args.get('how_closed') == 'Closed Manually' else '' }}>Closed Manually</option>
                                    <option value="Still Open" {{ 'selected' if request.args.get('how_closed') == 'Still Open' else '' }}>Still Open</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="is_dca_filter" class="form-label">DCA Operations</label>
                                <select class="form-select" id="is_dca_filter" name="is_dca">
                                    <option value="">All</option>
                                    <option value="true" {{ 'selected' if request.args.get('is_dca') == 'true' else '' }}>DCA Only</option>
                                    <option value="false" {{ 'selected' if request.args.get('is_dca') == 'false' else '' }}>Non-DCA Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="pnl_filter" class="form-label">P&L Filter</label>
                                <select class="form-select" id="pnl_filter" name="pnl_filter">
                                    <option value="">All Operations</option>
                                    <option value="winners" {{ 'selected' if request.args.get('pnl_filter') == 'winners' else '' }}>Profitable Only</option>
                                    <option value="losers" {{ 'selected' if request.args.get('pnl_filter') == 'losers' else '' }}>Loss Only</option>
                                    <option value="breakeven" {{ 'selected' if request.args.get('pnl_filter') == 'breakeven' else '' }}>Breakeven</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_contracts_filter" class="form-label">Min Contracts</label>
                                <input type="number" class="form-control" id="min_contracts_filter" name="min_contracts"
                                       value="{{ request.args.get('min_contracts', '') }}" placeholder="e.g., 5">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="max_contracts_filter" class="form-label">Max Contracts</label>
                                <input type="number" class="form-control" id="max_contracts_filter" name="max_contracts"
                                       value="{{ request.args.get('max_contracts', '') }}" placeholder="e.g., 20">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="min_rating_filter" class="form-label">Min Performance Rating</label>
                                <select class="form-select" id="min_rating_filter" name="min_rating">
                                    <option value="">Any Rating</option>
                                    <option value="1" {{ 'selected' if request.args.get('min_rating') == '1' else '' }}>1+</option>
                                    <option value="2" {{ 'selected' if request.args.get('min_rating') == '2' else '' }}>2+</option>
                                    <option value="3" {{ 'selected' if request.args.get('min_rating') == '3' else '' }}>3+</option>
                                    <option value="4" {{ 'selected' if request.args.get('min_rating') == '4' else '' }}>4+</option>
                                    <option value="5" {{ 'selected' if request.args.get('min_rating') == '5' else '' }}>5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="min_pnl_filter" class="form-label">Min P&L ($)</label>
                                <input type="number" class="form-control" id="min_pnl_filter" name="min_pnl" step="0.01"
                                       value="{{ request.args.get('min_pnl', '') }}" placeholder="e.g., -500">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_pnl_filter" class="form-label">Max P&L ($)</label>
                                <input type="number" class="form-control" id="max_pnl_filter" name="max_pnl" step="0.01"
                                       value="{{ request.args.get('max_pnl', '') }}" placeholder="e.g., 1000">
                            </div>
                        </div>
                    </div>

                    {% if categorized_tags %}
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="tags_filter" class="form-label">Resource Tags</label>
                                <select multiple class="form-select" id="tags-filter-select" name="tags">
                                    {% for category_name, tag_options in categorized_tags %}
                                        <optgroup label="{{ category_name }}">
                                            {% for tag_id, tag_name, tag_color in tag_options %}
                                                <option value="{{ tag_id }}"
                                                        data-color="{{ tag_color or 'neutral' }}"
                                                        class="tag-{{ tag_color or 'neutral' }}"
                                                        {{ 'selected' if tag_id in request.args.getlist('tags') else '' }}>
                                                    {{ tag_name }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select multiple tags to filter by</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel Operation</button>
                    <a href="{{ url_for('trades.view_trades_list') }}" class="btn btn-outline-warning">Clear All Filters</a>
                    <button type="submit" class="btn btn-primary">Apply Configuration</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customConfirmModalLabel">Confirm Operational Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="customConfirmModalBody">
                Are you sure you want to continue?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="customConfirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Initialize TomSelect for Tags Filter -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize TomSelect for tags filter with proper color classes
    const tagsFilterSelect = document.getElementById('tags-filter-select');
    if (tagsFilterSelect) {
        // Create tag color mapping
        const tagColors = {};
        {% if categorized_tags %}
            {% for category_name, tag_options in categorized_tags %}
                {% for tag_id, tag_name, tag_color in tag_options %}
                    tagColors['{{ tag_id }}'] = '{{ tag_color or "neutral" }}';
                {% endfor %}
            {% endfor %}
        {% endif %}

        new TomSelect(tagsFilterSelect, {
            plugins: ['remove_button'],
            placeholder: 'Select or search for resource tags...',
            render: {
                option: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="option ${colorClass}">${escape(data.text)}</div>`;
                },
                item: function(data, escape) {
                    const tagId = data.value;
                    const colorClass = tagColors[tagId] ? `tag-${tagColors[tagId]}` : 'tag-neutral';
                    return `<div class="item ${colorClass}">${escape(data.text)}</div>`;
                }
            }
        });
        console.log('TomSelect initialized for filter tags with enterprise styling');
    }
});
</script>

{% endblock %}