{% extends "base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block title %}
    {{ title or "User Administration Console" }} - Administration Center
{% endblock %}

{% block head_extra %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-users-cog executive-icon"></i>
                    {{ title or "User Administration Console" }}
                </h1>
                <div class="executive-subtitle">
                    Strategic User Resource Management & Access Control Framework
                </div>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('admin.admin_create_user') }}"
                   class="btn btn-primary btn-sm" title="New User Provisioning">
                    <i class="fas fa-user-plus"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-info btn-sm"
                        onclick="toggleBulkOperations()" title="Bulk Operations" id="bulk-ops-toggle">
                    <i class="fas fa-tasks"></i>
                </button>
                <a href="{{ url_for('admin.show_admin_dashboard') }}"
                   class="btn btn-outline-secondary btn-sm" title="Back to Administration Center">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="container-fluid" style="background: var(--enterprise-gray-50); padding: 1.5rem; min-height: calc(100vh - 300px);">
        <div class="row g-4">
            <!-- Executive KPI Section -->
            <div class="col-12">
                <div class="kpi-section">
                    <div class="row g-0">
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Total Resource Pool</span>
                                        <i class="fas fa-users kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ total_users_count if total_users_count is not none and total_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">User Accounts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Active Operations</span>
                                        <i class="fas fa-check-circle kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ active_users_count if active_users_count is not none and active_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator positive">
                                            <i class="fas fa-arrow-up"></i> Operational
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Administrative Access</span>
                                        <i class="fas fa-shield-alt kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ admin_users_count if admin_users_count is not none and admin_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">Privileged Accounts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Verified Accounts</span>
                                        <i class="fas fa-check-double kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">
                                        {% if verified_users_count is defined and verified_users_count is not none and verified_users_count != "Error" %}
                                            {{ verified_users_count }}
                                        {% elif users %}
                                            {% set verified_count = users|selectattr('is_email_verified')|list|length %}
                                            {{ verified_count }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">Email Verified</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="col-12">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-search module-icon"></i>
                            Search & Filter Operations
                        </div>
                        <div class="module-meta">
                            Resource Discovery Framework
                        </div>
                    </div>
                    <div class="module-content">
                        <form method="GET" action="{{ url_for('admin.admin_users_list') }}" id="search-filter-form">
                            <div class="row align-items-end g-3">
                                <div class="col-md-4">
                                    <label for="search" class="form-label">Global Search</label>
                                    <div class="search-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input form-control" id="search" name="search"
                                               placeholder="Search users, emails, names..."
                                               value="{{ request.args.get('search', '') }}">
                                        {% if request.args.get('search') %}
                                        <button type="button" class="search-clear" onclick="clearSearch()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label for="role_filter" class="form-label">Access Level</label>
                                    <select class="form-select" id="role_filter" name="role">
                                        <option value="">All Roles</option>
                                        <option value="admin" {{ 'selected' if request.args.get('role') == 'admin' else '' }}>Administrator</option>
                                        <option value="editor" {{ 'selected' if request.args.get('role') == 'editor' else '' }}>Editor</option>
                                        <option value="user" {{ 'selected' if request.args.get('role') == 'user' else '' }}>User</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="status_filter" class="form-label">Status</label>
                                    <select class="form-select" id="status_filter" name="status">
                                        <option value="">All Status</option>
                                        <option value="active" {{ 'selected' if request.args.get('status') == 'active' else '' }}>Active</option>
                                        <option value="inactive" {{ 'selected' if request.args.get('status') == 'inactive' else '' }}>Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="verified_filter" class="form-label">Verification</label>
                                    <select class="form-select" id="verified_filter" name="verified">
                                        <option value="">All</option>
                                        <option value="verified" {{ 'selected' if request.args.get('verified') == 'verified' else '' }}>Verified</option>
                                        <option value="unverified" {{ 'selected' if request.args.get('verified') == 'unverified' else '' }}>Unverified</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-search me-1"></i> Apply Filters
                                    </button>
                                    <a href="{{ url_for('admin.admin_users_list') }}" class="btn btn-outline-secondary btn-sm w-100 mt-1">
                                        <i class="fas fa-times me-1"></i> Clear
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Bulk Operations Module (Hidden by default) -->
            <div class="col-12" id="bulk-operations-module" style="display: none;">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-tasks module-icon"></i>
                            Bulk Operations Management
                        </div>
                        <div class="module-meta">
                            Execution Criteria
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="row align-items-center g-3">
                            <div class="col-md-auto">
                                <button class="btn btn-outline-warning btn-sm" onclick="bulkResetPasswords()">
                                    <i class="fas fa-key me-1"></i>Reset Passwords
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-success btn-sm" onclick="bulkActivateUsers()">
                                    <i class="fas fa-user-check me-1"></i>Activate Users
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="bulkDeactivateUsers()">
                                    <i class="fas fa-user-times me-1"></i>Deactivate Users
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-info btn-sm" onclick="bulkVerifyEmails()">
                                    <i class="fas fa-envelope-circle-check me-1"></i>Verify Emails
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteUsers()">
                                    <i class="fas fa-trash-alt me-1"></i>Delete Users
                                </button>
                            </div>
                            <div class="col-md-auto ms-auto">
                                <span id="selected-count" class="badge bg-primary">0 selected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Resource Management Module -->
            <div class="col-12">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-database module-icon"></i>
                            User Resource Database
                        </div>
                        <div class="module-meta">
                            Strategic Resource Utilization Overview
                        </div>
                    </div>
                    <div class="module-content">
                        {% if users %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle enterprise-table" id="users-table">
                                <thead class="table-header">
                                    <tr>
                                        <th scope="col" style="width: 40px; text-align: center;">
                                            <input class="form-check-input" type="checkbox" value="" id="select-all-users-checkbox" title="Select all user resources">
                                        </th>
                                        <th scope="col" class="sortable" data-sort="username" role="columnheader" tabindex="0" aria-label="Sort by Username">
                                            Identity Configuration <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="email" role="columnheader" tabindex="0" aria-label="Sort by Email">
                                            Contact Protocol <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="role" role="columnheader" tabindex="0" aria-label="Sort by Role">
                                            Access Classification <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="is_active" role="columnheader" tabindex="0" aria-label="Sort by Status">
                                            Operational Status <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="is_email_verified" role="columnheader" tabindex="0" aria-label="Sort by Verification">
                                            Verification Status <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="created_at" role="columnheader" tabindex="0" aria-label="Sort by Date Created">
                                            Provisioning Date <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort="last_login" role="columnheader" tabindex="0" aria-label="Sort by Last Login">
                                            Last Access Event <i class="fas fa-sort sort-icon"></i>
                                        </th>
                                        <th scope="col" class="text-end">Administrative Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_item in users %}
                                    <tr class="resource-row">
                                        <td style="text-align: center;">
                                            <input class="form-check-input user-checkbox" type="checkbox" value="{{ user_item.id }}" name="user_ids" aria-label="Select resource {{ user_item.username }}">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if user_item.profile_picture and user_item.profile_picture != 'default.jpg' %}
                                                    <img src="{{ url_for('static', filename=config.get('PROFILE_PICS_FOLDER_REL', 'profile_pics') + '/' + user_item.profile_picture) }}?v={{ range(1,100000)|random }}" alt="{{ user_item.username }}'s Profile" class="user-avatar me-2">
                                                {% else %}
                                                    <img src="{{ url_for('static', filename=config.get('PROFILE_PICS_FOLDER_REL', 'profile_pics') + '/default.jpg') }}" alt="Default Profile" class="user-avatar me-2">
                                                {% endif %}
                                                <div>
                                                    <div class="resource-name">{{ user_item.username }}</div>
                                                    {% if user_item.name %}<small class="resource-display-name">{{ user_item.name }}</small>{% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="contact-protocol">{{ user_item.email }}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge
                                                {% if user_item.role == UserRole.ADMIN %}classification-critical
                                                {% elif user_item.role == UserRole.EDITOR %}classification-elevated
                                                {% else %}classification-standard
                                                {% endif %}">
                                                {{ user_item.role.name.title() if user_item.role else 'Unclassified' }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if user_item.is_active %}
                                                <span class="status-badge operational">Operational</span>
                                            {% else %}
                                                <span class="status-badge suspended">Suspended</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user_item.is_email_verified %}
                                                <span class="status-badge verified">Verified</span>
                                            {% else %}
                                                <span class="status-badge pending">Pending Verification</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="operational-date">{{ user_item.created_at.strftime('%Y-%m-%d') if user_item.created_at else 'N/A' }}</span>
                                        </td>
                                        <td>
                                            <span class="operational-date">{{ user_item.last_login.strftime('%Y-%m-%d %H:%M') if user_item.last_login else 'No Access Events' }}</span>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('admin.admin_edit_user', user_id=user_item.id) }}"
                                                   class="btn btn-outline-warning btn-sm"
                                                   title="Configure Resource: {{ user_item.username }}"
                                                   aria-label="Configure user resource {{ user_item.username }}">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </a>

                                                {% if current_user.id != user_item.id and not (user_item.is_admin() and admin_users_count <= 1) %}
                                                <button type="button"
                                                        class="btn btn-outline-danger btn-sm"
                                                        title="Remove Configuration: {{ user_item.username }}"
                                                        aria-label="Remove user configuration {{ user_item.username }}"
                                                        onclick="confirmDeleteUser({{ user_item.id }}, '{{ user_item.username }}')">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" disabled
                                                        title="Cannot remove this configuration">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="enterprise-alert">
                            <div class="alert-content">
                                <i class="fas fa-info-circle alert-icon"></i>
                                <div class="alert-text">
                                    <strong>No User Resources Found</strong>
                                    <p>No user configurations are currently available in the system. You can <a href="{{ url_for('admin.admin_create_user') }}" class="alert-link">initiate new user provisioning</a> to begin resource allocation.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

<!-- Enhanced Pagination Module -->
            {% if pagination and pagination.pages > 1 %}
            <div class="col-12">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-arrow-circle-right module-icon"></i>
                            Resource Navigation
                        </div>
                        <div class="module-meta">
                            Operational Framework Navigation
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <!-- Page Size Selector -->
                            <div class="d-flex align-items-center">
                                <label for="page-size" class="form-label me-2 mb-0">Page Size:</label>
                                <select class="form-select form-select-sm" id="page-size" onchange="changePageSize(this.value)" style="width: auto;">
                                    <option value="10" {{ 'selected' if request.args.get('per_page', '25')|string == '10' else '' }}>10</option>
                                    <option value="25" {{ 'selected' if request.args.get('per_page', '25')|string == '25' else '' }}>25</option>
                                    <option value="50" {{ 'selected' if request.args.get('per_page', '25')|string == '50' else '' }}>50</option>
                                    <option value="100" {{ 'selected' if request.args.get('per_page', '25')|string == '100' else '' }}>100</option>
                                </select>
                            </div>

                            <!-- Results Info -->
                            <div class="text-muted small">
                                Showing {{ ((pagination.page - 1) * pagination.per_page + 1) }} - {{ (pagination.page * pagination.per_page if pagination.page < pagination.pages else pagination.total) }} of {{ pagination.total }} users
                            </div>
                        </div>

                        <!-- Standard Pagination -->
                        <nav aria-label="User resource pagination">
                            <ul class="pagination justify-content-center">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{% if pagination.has_prev %}{{ url_for('admin.admin_users_list', page=pagination.prev_num, **request.args.to_dict()) }}{% else %}#{% endif %}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if page_num %}
                                        {% if page_num == pagination.page %}
                                            <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
                                        {% else %}
                                            <li class="page-item"><a class="page-link" href="{{ url_for('admin.admin_users_list', page=page_num, **request.args.to_dict()) }}">{{ page_num }}</a></li>
                                        {% endif %}
                                    {% else %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{% if pagination.has_next %}{{ url_for('admin.admin_users_list', page=pagination.next_num, **request.args.to_dict()) }}{% else %}#{% endif %}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
// Enhanced User Administration Console JavaScript
document.addEventListener('DOMContentLoaded', function () {
    // Initialize selection tracking
    let selectedUsers = new Set();
    let isLoading = false;

    // Get DOM elements
    const selectAllCheckbox = document.getElementById('select-all-users-checkbox');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectedCountBadge = document.getElementById('selected-count');

    // Initialize event listeners
    setupEventListeners();
    updateSelectedCount();

    function setupEventListeners() {
        // Master checkbox functionality
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function(e) {
                const isChecked = e.target.checked;
                userCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    toggleUser(checkbox.value, isChecked);
                });
            });
        }

        // Individual user checkboxes
        userCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                toggleUser(e.target.value, e.target.checked);
                updateMasterCheckbox();
            });
        });

        // Search form auto-submit with debouncing
        const searchInput = document.getElementById('search');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (e.target.value.length === 0 || e.target.value.length >= 3) {
                        document.getElementById('search-filter-form').submit();
                    }
                }, 500);
            });
        }

        // Sortable headers
        document.addEventListener('click', function(e) {
            const sortable = e.target.closest('.sortable');
            if (sortable && !sortable.classList.contains('sorting')) {
                const field = sortable.getAttribute('data-sort');
                if (field) {
                    sortTable(field);
                }
            }
        });
    }

    function toggleUser(userId, checked) {
        if (checked) {
            selectedUsers.add(userId);
        } else {
            selectedUsers.delete(userId);
        }
        updateSelectedCount();
    }

    function updateMasterCheckbox() {
        if (!selectAllCheckbox) return;

        const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
        const totalBoxes = document.querySelectorAll('.user-checkbox');

        if (checkedBoxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length === totalBoxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    function updateSelectedCount() {
        if (selectedCountBadge) {
            const count = selectedUsers.size;
            selectedCountBadge.textContent = `${count} selected`;
            selectedCountBadge.className = count > 0 ? 'badge bg-primary' : 'badge bg-secondary';
        }
    }

    function sortTable(field) {
        if (isLoading) return;

        const params = new URLSearchParams(window.location.search);
        const currentSort = params.get('sort');
        const currentOrder = params.get('order');

        let newOrder = 'asc';
        if (currentSort === field && currentOrder === 'asc') {
            newOrder = 'desc';
        }

        params.set('sort', field);
        params.set('order', newOrder);
        params.set('page', '1'); // Reset to first page

        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    function getSelectedUserIds() {
        return Array.from(selectedUsers);
    }

    function performBulkAction(action, userIds) {
        if (!userIds || userIds.length === 0) {
            showCustomConfirmation({
                title: 'No Users Selected',
                message: 'Please select at least one user to perform this action.',
                confirmText: 'OK',
                confirmClass: 'btn-primary',
                icon: 'info-circle',
                onConfirm: () => {}
            });
            return;
        }

        const csrfToken = document.querySelector('meta[name=csrf-token]')?.content;

        // Use the existing bulk delete endpoint pattern
        let endpoint;
        switch(action) {
            case 'delete':
                endpoint = "{{ url_for('admin.admin_bulk_delete_users') }}";
                break;
            case 'activate':
            case 'deactivate':
            case 'reset-passwords':
            case 'verify-emails':
                // These endpoints don't exist yet, so show a message
                showCustomConfirmation({
                    title: 'Feature Not Implemented',
                    message: `The ${action} bulk operation is not yet implemented in the backend. Please contact your administrator.`,
                    confirmText: 'OK',
                    confirmClass: 'btn-info',
                    icon: 'info-circle'
                });
                return;
            default:
                endpoint = "{{ url_for('admin.admin_bulk_delete_users') }}";
        }

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ user_ids: userIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showCustomConfirmation({
                    title: 'Operation Completed',
                    message: data.message || `${action} operation completed successfully.`,
                    confirmText: 'OK',
                    confirmClass: 'btn-success',
                    icon: 'check-circle',
                    onConfirm: () => location.reload()
                });
            } else {
                showCustomConfirmation({
                    title: 'Operation Failed',
                    message: data.message || `Failed to perform ${action} operation.`,
                    confirmText: 'OK',
                    confirmClass: 'btn-danger',
                    icon: 'exclamation-triangle'
                });
            }
        })
        .catch(error => {
            console.error('Bulk operation error:', error);
            showCustomConfirmation({
                title: 'System Error',
                message: 'An unexpected error occurred during the operation.',
                confirmText: 'OK',
                confirmClass: 'btn-danger',
                icon: 'exclamation-triangle'
            });
        });
    }

    // Expose functions globally for button onclick events
    window.userAdminConsole = {
        getSelectedUserIds: getSelectedUserIds,
        performBulkAction: performBulkAction
    };
});

// Global functions for UI interactions
function toggleBulkOperations() {
    const module = document.getElementById('bulk-operations-module');
    const toggle = document.getElementById('bulk-ops-toggle');

    if (module.style.display === 'none') {
        module.style.display = 'block';
        toggle.classList.remove('btn-outline-info');
        toggle.classList.add('btn-info');
    } else {
        module.style.display = 'none';
        toggle.classList.remove('btn-info');
        toggle.classList.add('btn-outline-info');
    }
}

function clearSearch() {
    document.getElementById('search').value = '';
    document.getElementById('search-filter-form').submit();
}

function changePageSize(size) {
    const params = new URLSearchParams(window.location.search);
    params.set('per_page', size);
    params.set('page', '1'); // Reset to first page
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

// Bulk operation functions
function bulkResetPasswords() {
    const selectedIds = window.userAdminConsole.getSelectedUserIds();
    if (selectedIds.length === 0) {
        showCustomConfirmation({
            title: 'No Users Selected',
            message: 'Please select users to reset passwords for.',
            confirmText: 'OK',
            confirmClass: 'btn-primary',
            icon: 'info-circle'
        });
        return;
    }

    showCustomConfirmation({
        title: 'Reset Passwords',
        message: `Reset passwords for ${selectedIds.length} selected user(s)? New passwords will be generated and sent via email.`,
        confirmText: 'Reset Passwords',
        cancelText: 'Cancel',
        confirmClass: 'btn-warning',
        icon: 'key',
        onConfirm: () => window.userAdminConsole.performBulkAction('reset-passwords', selectedIds)
    });
}

function bulkActivateUsers() {
    const selectedIds = window.userAdminConsole.getSelectedUserIds();
    if (selectedIds.length === 0) {
        showCustomConfirmation({
            title: 'No Users Selected',
            message: 'Please select users to activate.',
            confirmText: 'OK',
            confirmClass: 'btn-primary',
            icon: 'info-circle'
        });
        return;
    }

    showCustomConfirmation({
        title: 'Activate Users',
        message: `Activate ${selectedIds.length} selected user(s)? They will be able to access the system.`,
        confirmText: 'Activate',
        cancelText: 'Cancel',
        confirmClass: 'btn-success',
        icon: 'user-check',
        onConfirm: () => window.userAdminConsole.performBulkAction('activate', selectedIds)
    });
}

function bulkDeactivateUsers() {
    const selectedIds = window.userAdminConsole.getSelectedUserIds();
    if (selectedIds.length === 0) {
        showCustomConfirmation({
            title: 'No Users Selected',
            message: 'Please select users to deactivate.',
            confirmText: 'OK',
            confirmClass: 'btn-primary',
            icon: 'info-circle'
        });
        return;
    }

    showCustomConfirmation({
        title: 'Deactivate Users',
        message: `Deactivate ${selectedIds.length} selected user(s)? They will not be able to access the system until reactivated.`,
        confirmText: 'Deactivate',
        cancelText: 'Cancel',
        confirmClass: 'btn-secondary',
        icon: 'user-times',
        onConfirm: () => window.userAdminConsole.performBulkAction('deactivate', selectedIds)
    });
}

function bulkVerifyEmails() {
    const selectedIds = window.userAdminConsole.getSelectedUserIds();
    if (selectedIds.length === 0) {
        showCustomConfirmation({
            title: 'No Users Selected',
            message: 'Please select users to verify emails for.',
            confirmText: 'OK',
            confirmClass: 'btn-primary',
            icon: 'info-circle'
        });
        return;
    }

    showCustomConfirmation({
        title: 'Verify Email Addresses',
        message: `Mark email addresses as verified for ${selectedIds.length} selected user(s)? This will bypass email verification requirements.`,
        confirmText: 'Verify Emails',
        cancelText: 'Cancel',
        confirmClass: 'btn-info',
        icon: 'envelope-circle-check',
        onConfirm: () => window.userAdminConsole.performBulkAction('verify-emails', selectedIds)
    });
}

function bulkDeleteUsers() {
    const selectedIds = window.userAdminConsole.getSelectedUserIds();
    if (selectedIds.length === 0) {
        showCustomConfirmation({
            title: 'No Users Selected',
            message: 'Please select users to delete.',
            confirmText: 'OK',
            confirmClass: 'btn-primary',
            icon: 'info-circle'
        });
        return;
    }

    showCustomConfirmation({
        title: 'CRITICAL OPERATION: Delete Users',
        message: `PERMANENTLY DELETE ${selectedIds.length} selected user(s)? This action cannot be reversed and will remove all associated data including trades, configurations, and access credentials.`,
        confirmText: 'DELETE USERS',
        cancelText: 'Cancel',
        confirmClass: 'btn-danger',
        icon: 'exclamation-triangle',
        onConfirm: () => window.userAdminConsole.performBulkAction('delete', selectedIds)
    });
}

function confirmDeleteUser(userId, username) {
    showCustomConfirmation({
        title: 'Delete User Configuration',
        message: `CRITICAL OPERATION: Permanently remove user configuration for "${username}"? This action cannot be reversed and will remove all associated operational data.`,
        confirmText: 'DELETE USER',
        cancelText: 'Cancel',
        confirmClass: 'btn-danger',
        icon: 'trash-alt',
        onConfirm: () => {
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.content;

            // Use a form submission instead of fetch since the endpoint expects form data
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.admin_delete_user', user_id='USER_ID') }}".replace('USER_ID', userId);

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}