{% extends "base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block title %}
    {{ title or "User Administration Console" }} - Administration Center
{% endblock %}

{% block head_extra %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/enterprise-search.js') }}"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Executive Header -->
    <div class="executive-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-users-cog executive-icon"></i>
                    {{ title or "User Administration Console" }}
                </h1>
                <div class="executive-subtitle">
                    User Resource Management & Access Control Framework
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.admin_create_user') }}'"
                        title="New User Provisioning">
                    <i class="fas fa-user-plus"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.show_admin_dashboard') }}'"
                        title="Back to Administration Center">
                    <i class="fas fa-tachometer-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="container-fluid" style="background: var(--enterprise-gray-50); padding: 1.5rem; min-height: calc(100vh - 300px);">
        <div class="row g-0">
            <!-- Executive KPI Section -->
            <div class="col-12">
                <div class="kpi-section">
                    <div class="row g-0">
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Total Account Pool</span>
                                        <i class="fas fa-users kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ total_users_count if total_users_count is not none and total_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">User Accounts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Active Accounts</span>
                                        <i class="fas fa-check-circle kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ active_users_count if active_users_count is not none and active_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator positive">
                                            <i class="fas fa-arrow-up"></i> Operational
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Administrative Access</span>
                                        <i class="fas fa-shield-alt kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">{{ admin_users_count if admin_users_count is not none and admin_users_count != "Error" else 'N/A' }}</div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">Privileged Accounts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="kpi-card">
                                <div class="kpi-content">
                                    <div class="kpi-header">
                                        <span class="kpi-label">Verified Accounts</span>
                                        <i class="fas fa-check-double kpi-icon"></i>
                                    </div>
                                    <div class="kpi-value">
                                        {% if verified_users_count is defined and verified_users_count is not none and verified_users_count != "Error" %}
                                            {{ verified_users_count }}
                                        {% elif users %}
                                            {% set verified_count = users|selectattr('is_email_verified')|list|length %}
                                            {{ verified_count }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <div class="kpi-trend">
                                        <span class="trend-indicator">Email Verified</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Pagination and Controls Bar -->
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center p-3">
                    <!-- Left Side: Page Size, Summary, and Navigation -->
                    <div class="d-flex align-items-center gap-4">
                        <!-- Page Size Selector -->
                        <div class="d-flex align-items-center gap-2">
                            <span class="pagination-label">Table Size:</span>
                            <select class="pagination-page-size"
                                    id="page-size"
                                    onchange="changePageSize(this.value)">
                                <option value="10" {{ 'selected' if request.args.get('per_page', '10')|string == '10' else '' }}>10</option>
                                <option value="25" {{ 'selected' if request.args.get('per_page', '10')|string == '25' else '' }}>25</option>
                                <option value="50" {{ 'selected' if request.args.get('per_page', '10')|string == '50' else '' }}>50</option>
                                <option value="100" {{ 'selected' if request.args.get('per_page', '10')|string == '100' else '' }}>100</option>
                            </select>
                        </div>

                        <!-- Results Summary -->
                        <strong>{{ ((pagination.page - 1) * pagination.per_page + 1) }} - {{ (pagination.page * pagination.per_page if pagination.page < pagination.pages else pagination.total) }} of {{ pagination.total }}</strong>

                        <!-- Navigation Controls -->
                        {% if pagination and pagination.pages > 1 %}
                        <div class="d-flex align-items-center gap-1">
                            <!-- First Page -->
                            {% if pagination.page > 1 %}
                                {% set first_args = request.args.copy() %}
                                {% set _ = first_args.pop('page', None) %}
                                <a href="{{ url_for('admin.admin_users_list', page=1, **first_args) }}"
                                   class="pagination-nav-btn"
                                   title="First Page">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            {% else %}
                                <span class="pagination-nav-btn disabled">
                                    <i class="fas fa-angle-double-left"></i>
                                </span>
                            {% endif %}

                            <!-- Previous Page -->
                            {% if pagination.has_prev %}
                                {% set prev_args = request.args.copy() %}
                                {% set _ = prev_args.pop('page', None) %}
                                <a href="{{ url_for('admin.admin_users_list', page=pagination.prev_num, **prev_args) }}"
                                   class="pagination-nav-btn"
                                   title="Previous Page">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            {% else %}
                                <span class="pagination-nav-btn disabled">
                                    <i class="fas fa-angle-left"></i>
                                </span>
                            {% endif %}

                            <!-- Page Information -->
                            <span class="pagination-info">
                                <strong>Page {{ pagination.page }} of {{ pagination.pages }}</strong>
                            </span>

                            <!-- Next Page -->
                            {% if pagination.has_next %}
                                {% set next_args = request.args.copy() %}
                                {% set _ = next_args.pop('page', None) %}
                                <a href="{{ url_for('admin.admin_users_list', page=pagination.next_num, **next_args) }}"
                                   class="pagination-nav-btn"
                                   title="Next Page">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            {% else %}
                                <span class="pagination-nav-btn disabled">
                                    <i class="fas fa-angle-right"></i>
                                </span>
                            {% endif %}

                            <!-- Last Page -->
                            {% if pagination.page < pagination.pages %}
                                {% set last_args = request.args.copy() %}
                                {% set _ = last_args.pop('page', None) %}
                                <a href="{{ url_for('admin.admin_users_list', page=pagination.pages, **last_args) }}"
                                   class="pagination-nav-btn"
                                   title="Last Page">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            {% else %}
                                <span class="pagination-nav-btn disabled">
                                    <i class="fas fa-angle-double-right"></i>
                                </span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right Side: Action Button Group -->
                    <div class="btn-group" role="group" aria-label="User actions">
                        <!-- Search & Filter Toggle Button -->
                        <button type="button"
                                id="search-filter-toggle"
                                class="btn btn-outline-secondary btn-sm action-btn"
                                onclick="toggleSearchFilters()"
                                title="Toggle Search & Filter Options">
                            <i class="fas fa-search"></i>
                        </button>

                        <!-- Bulk Operations Toggle Button -->
                        <button type="button"
                                id="bulk-ops-toggle"
                                class="btn btn-outline-secondary btn-sm action-btn"
                                onclick="toggleBulkOperations()"
                                title="Toggle Bulk Operations">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Bulk Operations Module (Hidden by default) -->
            <div class="col-12" id="bulk-operations-module" style="display: none;">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-tasks module-icon"></i>
                            Bulk Operations Management
                        </div>
                        <div class="module-meta">
                            Execution Criteria
                        </div>
                    </div>
                    <div class="module-content">
                        <div class="row align-items-center g-3">
                            <div class="col-md-auto">
                                <button class="btn btn-outline-warning btn-sm" onclick="bulkResetPasswords()">
                                    <i class="fas fa-key me-1"></i>Reset Passwords
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-success btn-sm" onclick="bulkActivateUsers()">
                                    <i class="fas fa-user-check me-1"></i>Activate Users
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="bulkDeactivateUsers()">
                                    <i class="fas fa-user-times me-1"></i>Deactivate Users
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-info btn-sm" onclick="bulkVerifyEmails()">
                                    <i class="fas fa-envelope-circle-check me-1"></i>Verify Emails
                                </button>
                            </div>
                            <div class="col-md-auto">
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteUsers()">
                                    <i class="fas fa-trash-alt me-1"></i>Remove Configurations
                                </button>
                            </div>
                            <div class="col-md-auto ms-auto">
                                <span id="selected-count" class="badge bg-primary">0 selected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Module (Hidden by default) -->
            <div class="col-12" id="search-filter-module" style="display: none;">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-filter module-icon"></i>
                            Search & Filter Operations
                        </div>
                        <div class="module-meta">
                            Resource Query Interface
                        </div>
                    </div>
                    <div class="module-content">
                        <form method="GET" action="{{ url_for('admin.admin_users_list') }}" id="search-filter-form">
                            <div class="d-flex justify-content-center align-items-start gap-3 flex-wrap">
                                <!-- Search Input -->
                                <div style="min-width: 750px;">
                                    <label for="search" class="form-label">Search Users</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="search" name="search"
                                               value="{{ request.args.get('search', '') }}"
                                               placeholder="Search by username, name, or email..."
                                               title="Press Enter to search">
                                    </div>
                                    <small class="text-muted">Press Enter to search</small>
                                </div>

                                <!-- Access Level -->
                                <div style="min-width: 140px;">
                                    <label for="role_filter" class="form-label">Access Level</label>
                                    <select class="form-select" id="role_filter" name="role">
                                        <option value="">All Roles</option>
                                        <option value="admin" {{ 'selected' if request.args.get('role') == 'admin' else '' }}>Administrator</option>
                                        <option value="user" {{ 'selected' if request.args.get('role') == 'user' else '' }}>Standard User</option>
                                    </select>
                                </div>

                                <!-- Status -->
                                <div style="min-width: 120px;">
                                    <label for="status_filter" class="form-label">Status</label>
                                    <select class="form-select" id="status_filter" name="status">
                                        <option value="">All</option>
                                        <option value="active" {{ 'selected' if request.args.get('status') == 'active' else '' }}>Active</option>
                                        <option value="inactive" {{ 'selected' if request.args.get('status') == 'inactive' else '' }}>Inactive</option>
                                    </select>
                                </div>

                                <!-- Verification -->
                                <div style="min-width: 120px;">
                                    <label for="verified_filter" class="form-label">Verification</label>
                                    <select class="form-select" id="verified_filter" name="verified">
                                        <option value="">All</option>
                                        <option value="verified" {{ 'selected' if request.args.get('verified') == 'verified' else '' }}>Verified</option>
                                        <option value="unverified" {{ 'selected' if request.args.get('verified') == 'unverified' else '' }}>Unverified</option>
                                    </select>
                                </div>
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2 mt-5">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search me-1"></i> Apply Filters
                                    </button>
                                    <a href="{{ url_for('admin.admin_users_list') }}" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-times me-1"></i> Clear All
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Active Filters Indicator (Outside Module) -->
            {% set has_search = request.args.get('search', '') %}
            {% set has_role_filter = request.args.get('role', '') %}
            {% set has_status_filter = request.args.get('status', '') %}
            {% set has_verified_filter = request.args.get('verified', '') %}
            {% set active_filters = [] %}

            {% if has_search %}
                {% set _ = active_filters.append('Search: "' + has_search + '"') %}
            {% endif %}
            {% if has_role_filter %}
                {% set role_name = 'Administrator' if has_role_filter == 'admin' else 'Standard User' %}
                {% set _ = active_filters.append('Role: ' + role_name) %}
            {% endif %}
            {% if has_status_filter %}
                {% set status_name = 'Active' if has_status_filter == 'active' else 'Inactive' %}
                {% set _ = active_filters.append('Status: ' + status_name) %}
            {% endif %}
            {% if has_verified_filter %}
                {% set verified_name = 'Verified' if has_verified_filter == 'verified' else 'Unverified' %}
                {% set _ = active_filters.append('Verification: ' + verified_name) %}
            {% endif %}

            {% if active_filters %}
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between py-2 px-3 mb-2" style="background-color: rgba(13, 110, 253, 0.08); border: 1px solid rgba(13, 110, 253, 0.2); border-radius: 0.375rem; font-size: 0.875rem;">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <i class="fas fa-filter text-primary"></i>
                        <span class="fw-semibold text-primary">Resource Database Filtered by:</span>
                        {% for filter in active_filters %}
                            <span class="badge bg-primary text-white" style="font-size: 0.75rem;">{{ filter }}</span>
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('admin.admin_users_list') }}" class="btn btn-outline-primary btn-sm py-1 px-2" title="Clear all filters" style="font-size: 0.75rem;">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- User Resource Management Module -->
            <div class="col-12">
                <div class="enterprise-module">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-database module-icon"></i>
                            User Resource Database
                        </div>
                        <div class="module-meta">
                            User Resource Management Overview
                        </div>
                    </div>
                    <div class="module-content">
                        {% if users %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="data-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col" style="width: 40px; text-align: center;">
                                            <input class="form-check-input" type="checkbox" value="" id="select-all-users-checkbox" title="Select all user resources">
                                        </th>
                                        <th scope="col" class="sortable" data-sort="username" role="columnheader" tabindex="0" aria-label="Sort by Username">
                                            Identity Configuration
                                        </th>
                                        <th scope="col" class="sortable" data-sort="email" role="columnheader" tabindex="0" aria-label="Sort by Email">
                                            Contact Protocol
                                        </th>
                                        <th scope="col" class="sortable" data-sort="role" role="columnheader" tabindex="0" aria-label="Sort by Role">
                                            Access Classification
                                        </th>
                                        <th scope="col" class="sortable" data-sort="is_active" role="columnheader" tabindex="0" aria-label="Sort by Status">
                                            Operational Status
                                        </th>
                                        <th scope="col" class="sortable" data-sort="is_email_verified" role="columnheader" tabindex="0" aria-label="Sort by Verification">
                                            Verification Status
                                        </th>
                                        <th scope="col" class="sortable" data-sort="created_at" role="columnheader" tabindex="0" aria-label="Sort by Date Created">
                                            Provisioning Date
                                        </th>
                                        <th scope="col" class="sortable" data-sort="last_login" role="columnheader" tabindex="0" aria-label="Sort by Last Login">
                                            Last Access Event
                                        </th>
                                        <th scope="col" class="text-end"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_item in users %}
                                    <tr class="resource-row">
                                        <td style="text-align: center;">
                                            <input class="form-check-input user-checkbox" type="checkbox"
                                                   value="{{ user_item.id }}" name="user_ids"
                                                   aria-label="Select resource {{ user_item.username }}">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <!-- Use Discord avatar if available, otherwise show user icon -->
                                                {% if user_item.discord_linked and user_item.discord_avatar %}
                                                    <img src="https://cdn.discordapp.com/avatars/{{ user_item.discord_id }}/{{ user_item.discord_avatar }}.webp?size=64"
                                                         alt="{{ user_item.username }}'s Discord Avatar"
                                                         class="user-avatar me-2"
                                                         style="width: 40px; height: 40px; object-fit: cover;"
                                                         onerror="this.src='https://cdn.discordapp.com/avatars/{{ user_item.discord_id }}/{{ user_item.discord_avatar }}.png';">
                                                {% else %}
                                                    <div class="user-avatar-placeholder me-2">
                                                        <i class="fas fa-user-circle fa-2x text-muted"></i>
                                                    </div>
                                                {% endif %}

                                                <div>
                                                    <div class="resource-name">{{ user_item.username }}</div>
                                                    {% if user_item.name %}
                                                        <small class="resource-display-name">{{ user_item.name }}</small>
                                                    {% endif %}

                                                    <!-- Integration Status Indicators -->
                                                    <div class="integration-indicators mt-1">
                                                        {% if user_item.discord_linked %}
                                                            <span class="badge bg-primary" title="Discord Connected">
                                                                <i class="fab fa-discord"></i>
                                                            </span>
                                                        {% endif %}
                                                        {% if user_item.is_email_verified %}
                                                            <span class="badge bg-success" title="Email Verified">
                                                                <i class="fas fa-envelope-circle-check"></i>
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="contact-protocol">{{ user_item.email }}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge
                                                {% if user_item.role == UserRole.ADMIN %}classification-critical
                                                {% elif user_item.role == UserRole.EDITOR %}classification-elevated
                                                {% else %}classification-standard
                                                {% endif %}">
                                                {{ user_item.role.name.title() if user_item.role else 'Unclassified' }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if user_item.is_active %}
                                                <span class="status-badge operational">Enabled</span>
                                            {% else %}
                                                <span class="status-badge suspended">Suspended</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user_item.is_email_verified %}
                                                <span class="status-badge verified">Verified</span>
                                            {% else %}
                                                <span class="status-badge pending">Pending Verification</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="operational-date">{{ user_item.created_at.strftime('%Y-%m-%d') if user_item.created_at else 'N/A' }}</span>
                                        </td>
                                        <td>
                                            <span class="operational-date">{{ user_item.last_login.strftime('%Y-%m-%d %H:%M') if user_item.last_login else 'No Access Events' }}</span>
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('admin.admin_edit_user', user_id=user_item.id) }}"
                                                   class="btn btn-outline-secondary btn-sm"
                                                   title="Configure Resource: {{ user_item.username }}"
                                                   aria-label="Configure user resource {{ user_item.username }}">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </a>

                                                {% if current_user.id != user_item.id and not (user_item.is_admin() and admin_users_count <= 1) %}
                                                <button type="button"
                                                        class="btn btn-outline-secondary btn-sm"
                                                        title="Remove Configuration: {{ user_item.username }}"
                                                        aria-label="Remove user configuration {{ user_item.username }}"
                                                        onclick="confirmDeleteUser({{ user_item.id }}, '{{ user_item.username }}')">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                                        title="Cannot remove this configuration">
                                                    <i class="fas fa-trash-alt" aria-hidden="true"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="enterprise-alert">
                            <div class="alert-content">
                                <i class="fas fa-info-circle alert-icon"></i>
                                <div class="alert-text">
                                    <strong>No User Resources Found</strong>
                                    <p>No user configurations are currently available in the system. You can <a href="{{ url_for('admin.admin_create_user') }}" class="alert-link">initiate new user provisioning</a> to begin resource allocation.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
// =============================================================================
// GLOBAL VARIABLES AND STATE MANAGEMENT
// =============================================================================
let selectedUsers = new Set();

// =============================================================================
// GLOBAL FUNCTIONS - AVAILABLE IMMEDIATELY FOR ONCLICK HANDLERS
// =============================================================================

function toggleBulkOperations() {
    try {
        const module = document.getElementById('bulk-operations-module');
        const toggle = document.getElementById('bulk-ops-toggle');

        if (module && toggle) {
            if (module.style.display === 'none' || module.style.display === '') {
                module.style.display = 'block';
                toggle.classList.remove('btn-outline-info');
                toggle.classList.add('btn-info');
            } else {
                module.style.display = 'none';
                toggle.classList.remove('btn-info');
                toggle.classList.add('btn-outline-info');
            }
        }
    } catch (error) {
        console.error('Error in toggleBulkOperations:', error);
    }
}

function confirmDeleteUser(userId, username) {
    try {
        if (typeof showCustomConfirmation === 'function') {
            showCustomConfirmation({
                title: 'Remove User Configuration',
                message: 'CRITICAL OPERATION: Permanently remove user configuration for "' + username + '"? This action cannot be reversed and will remove all associated operational data.',
                confirmText: 'REMOVE CONFIGURATION',
                cancelText: 'Cancel',
                confirmClass: 'btn-danger',
                icon: 'trash-alt',
                onConfirm: function() {
                    performSingleUserDelete(userId);
                }
            });
        } else {
            if (confirm('Permanently remove user configuration for "' + username + '"? This action cannot be reversed.')) {
                performSingleUserDelete(userId);
            }
        }
    } catch (error) {
        console.error('Error in confirmDeleteUser:', error);
        alert('Error: Could not delete user. Please refresh the page and try again.');
    }
}

function performSingleUserDelete(userId) {
    try {
        const deleteUrl = "{{ url_for('admin.admin_delete_user', user_id=999999) }}".replace('999999', userId);
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteUrl;

        // Get CSRF token
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            console.error('âŒ No CSRF token found for single user delete!');
            if (typeof showCustomConfirmation === 'function') {
                showCustomConfirmation({
                    title: 'Security Error',
                    message: 'Security token not found. Please refresh the page and try again.',
                    confirmText: 'Refresh Page',
                    confirmClass: 'btn-warning',
                    icon: 'exclamation-triangle',
                    onConfirm: function() { location.reload(); }
                });
            } else {
                alert('Security token not found. Please refresh the page and try again.');
            }
            return;
        }

        // Add CSRF token to form
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        console.log('ðŸ—‘ï¸ Submitting single user delete form with CSRF token');
        document.body.appendChild(form);
        form.submit();
    } catch (error) {
        console.error('Error in performSingleUserDelete:', error);
        alert('Error: Could not delete user. Please refresh the page and try again.');
    }
}

function clearSearch() {
    try {
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.value = '';
            const form = searchInput.closest('form');
            if (form) {
                form.submit();
            }
        }
    } catch (error) {
        console.error('Error in clearSearch:', error);
    }
}

function changePageSize(size) {
    try {
        const params = new URLSearchParams(window.location.search);
        params.set('per_page', size);
        params.set('page', '1');
        window.location.href = window.location.pathname + '?' + params.toString();
    } catch (error) {
        console.error('Error in changePageSize:', error);
    }
}

// Bulk operation functions
function bulkResetPasswords() {
    checkAndExecuteBulkAction('reset-passwords', 'Reset Passwords', 'Reset passwords for selected users? New passwords will be generated and sent via email.', 'btn-warning', 'key');
}

function bulkActivateUsers() {
    checkAndExecuteBulkAction('activate', 'Activate Users', 'Activate selected users? They will be able to access the system.', 'btn-success', 'user-check');
}

function bulkDeactivateUsers() {
    checkAndExecuteBulkAction('deactivate', 'Deactivate Users', 'Deactivate selected users? They will not be able to access the system until reactivated.', 'btn-secondary', 'user-times');
}

function bulkVerifyEmails() {
    checkAndExecuteBulkAction('verify-emails', 'Verify Email Addresses', 'Mark email addresses as verified for selected users? This will bypass email verification requirements.', 'btn-info', 'envelope-circle-check');
}

function bulkDeleteUsers() {
    checkAndExecuteBulkAction('delete', 'CRITICAL OPERATION: Remove User Configurations', 'PERMANENTLY REMOVE selected user configurations? This action cannot be reversed and will remove all associated data including trades, configurations, and access credentials.', 'btn-danger', 'exclamation-triangle');
}

function checkAndExecuteBulkAction(action, title, message, buttonClass, icon) {
    try {
        // UPDATED: Use the selectedUsers Set instead of querying DOM directly
        const selectedIds = Array.from(selectedUsers);

        console.log(`ðŸŽ¯ Bulk action '${action}' requested`);
        console.log(`ðŸ“‹ Selected IDs from Set:`, selectedIds);

        if (selectedIds.length === 0) {
            if (typeof showCustomConfirmation === 'function') {
                showCustomConfirmation({
                    title: 'No Users Selected',
                    message: 'Please select users to perform this action.',
                    confirmText: 'OK',
                    confirmClass: 'btn-primary',
                    icon: 'info-circle'
                });
            } else {
                alert('Please select users to perform this action.');
            }
            return;
        }

        const finalMessage = message.replace('selected users', selectedIds.length + ' selected user(s)').replace('selected user configurations', selectedIds.length + ' selected user configuration(s)');

        if (typeof showCustomConfirmation === 'function') {
            showCustomConfirmation({
                title: title,
                message: finalMessage,
                confirmText: title.includes('CRITICAL') ? 'REMOVE CONFIGURATIONS' : 'Confirm (' + selectedIds.length + ')',
                cancelText: 'Cancel',
                confirmClass: buttonClass,
                icon: icon,
                onConfirm: function() {
                    executeBulkAction(action, selectedIds);
                }
            });
        } else {
            if (confirm(title + '\n\n' + finalMessage)) {
                executeBulkAction(action, selectedIds);
            }
        }
    } catch (error) {
        console.error('Error in checkAndExecuteBulkAction:', error);
        alert('Error: Could not perform bulk action. Please refresh the page and try again.');
    }
}

// =====================================
// CSRF TOKEN UTILITY FUNCTION
// =====================================
function getCSRFToken() {
    let csrfToken = null;

    // Try to get from direct input
    const directInput = document.getElementById('js-csrf-token');
    if (directInput && directInput.value) {
        csrfToken = directInput.value;
    }

    // Try to get from meta tag
    if (!csrfToken) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag && metaTag.getAttribute('content')) {
            csrfToken = metaTag.getAttribute('content');
        }
    }

    // Try to get from hidden input
    if (!csrfToken) {
        const hiddenInput = document.querySelector('input[name="csrf_token"]');
        if (hiddenInput && hiddenInput.value) {
            csrfToken = hiddenInput.value;
        }
    }

    console.log('ðŸ” CSRF Token retrieved:', csrfToken ? 'Yes' : 'No');
    return csrfToken;
}

// =====================================
// FIXED BULK ACTION FUNCTION
// =====================================
function executeBulkAction(action, userIds) {
    try {
        console.log('ðŸš€ Executing bulk action:', action);
        console.log('User IDs:', userIds);

        let endpoint;
        switch(action) {
            case 'delete':
                endpoint = "/admin/users/bulk_delete";
                break;
            case 'activate':
                endpoint = "/admin/users/bulk_activate";
                break;
            case 'deactivate':
                endpoint = "/admin/users/bulk_deactivate";
                break;
            case 'reset-passwords':
                endpoint = "/admin/users/bulk_reset_passwords";
                break;
            case 'verify-emails':
                endpoint = "/admin/users/bulk_verify_emails";
                break;
            default:
                if (typeof showCustomConfirmation === 'function') {
                    showCustomConfirmation({
                        title: 'Unknown Action',
                        message: 'Unknown bulk action: ' + action,
                        confirmText: 'OK',
                        confirmClass: 'btn-danger',
                        icon: 'exclamation-triangle'
                    });
                } else {
                    alert('Unknown bulk action: ' + action);
                }
                return;
        }

        console.log('Making request to:', endpoint);

        // Get CSRF token
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            console.error('âŒ No CSRF token found!');
            if (typeof showCustomConfirmation === 'function') {
                showCustomConfirmation({
                    title: 'Security Error',
                    message: 'Security token not found. Please refresh the page and try again.',
                    confirmText: 'Refresh Page',
                    confirmClass: 'btn-warning',
                    icon: 'exclamation-triangle',
                    onConfirm: function() { location.reload(); }
                });
            } else {
                alert('Security token not found. Please refresh the page and try again.');
            }
            return;
        }

        // Make the request with CSRF token
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken  // Add CSRF token header
            },
            body: JSON.stringify({ user_ids: userIds })
        })
        .then(function(response) {
            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }

            return response.json();
        })
        .then(function(data) {
            console.log('ðŸ” Full response data:', data);

            if (data.status === 'success') {
                let message = data.message;

                // Add specific information for different actions
                if (action === 'reset-passwords' && data.reset_count) {
                    message += '\n\nNew passwords have been sent via email.';
                }

                if (action === 'delete' && data.deleted_count !== undefined) {
                    message = `Successfully deleted ${data.deleted_count} user(s).`;
                    if (data.skipped_count > 0) {
                        message += `\nSkipped ${data.skipped_count} user(s): ${data.skipped_info.join(', ')}`;
                    }
                    console.log(`âœ… Bulk delete completed: ${data.deleted_count} deleted, ${data.skipped_count} skipped`);
                }

                if (data.skipped_count && data.skipped_count > 0 && action !== 'delete') {
                    message += '\n\nSkipped users: ' + data.skipped_info.join(', ');
                }

                if (typeof showCustomConfirmation === 'function') {
                    showCustomConfirmation({
                        title: 'Operation Completed Successfully',
                        message: message,
                        confirmText: 'OK',
                        confirmClass: 'btn-success',
                        icon: 'check-circle',
                        onConfirm: function() {
                            console.log('ðŸ”„ Reloading page after successful operation');
                            location.reload();
                        }
                    });
                } else {
                    alert('Operation completed successfully.\n\n' + message);
                    location.reload();
                }
            } else {
                console.error('âŒ Operation failed:', data);
                if (typeof showCustomConfirmation === 'function') {
                    showCustomConfirmation({
                        title: 'Operation Failed',
                        message: data.message || 'Failed to perform ' + action + ' operation.',
                        confirmText: 'OK',
                        confirmClass: 'btn-danger',
                        icon: 'exclamation-triangle'
                    });
                } else {
                    alert('Operation failed: ' + (data.message || 'Unknown error'));
                }
            }
        })
        .catch(function(error) {
            console.error('ðŸ’¥ Bulk operation error:', error);
            if (typeof showCustomConfirmation === 'function') {
                showCustomConfirmation({
                    title: 'System Error',
                    message: 'An unexpected error occurred during the operation. Please check the console for details.\n\nError: ' + error.message,
                    confirmText: 'OK',
                    confirmClass: 'btn-danger',
                    icon: 'exclamation-triangle'
                });
            } else {
                alert('System error occurred during the operation.\n\nError: ' + error.message);
            }
        });
    } catch (error) {
        console.error('Error in executeBulkAction:', error);
        alert('Error: Could not execute bulk action. Please refresh the page and try again.');
    }
}

// =============================================================================
// SELECTION MANAGEMENT FUNCTIONS (ADDED)
// =============================================================================

function updateSelectedCount() {
    const selectedCountBadge = document.getElementById('selected-count');
    if (selectedCountBadge) {
        const count = selectedUsers.size;
        selectedCountBadge.textContent = count + ' selected';
        selectedCountBadge.className = count > 0 ?
            'badge bg-primary' : 'badge bg-secondary';

        console.log(`ðŸ“Š Selection count updated: ${count} users selected`);
    }
}

function toggleUser(userId, checked) {
    if (checked) {
        selectedUsers.add(userId);
        console.log(`âœ… Added user ${userId} to selection`);
    } else {
        selectedUsers.delete(userId);
        console.log(`âŒ Removed user ${userId} from selection`);
    }
    updateSelectedCount();
    updateMasterCheckbox();
}

function updateMasterCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all-users-checkbox');
    if (!selectAllCheckbox) return;

    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    const totalBoxes = document.querySelectorAll('.user-checkbox');

    if (checkedBoxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === totalBoxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

function setupUserSelectionListeners() {
    const selectAllCheckbox = document.getElementById('select-all-users-checkbox');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');

    console.log(`ðŸ”§ Setting up selection listeners for ${userCheckboxes.length} user checkboxes`);

    // Master checkbox functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            console.log(`ðŸ”„ Master checkbox ${isChecked ? 'checked' : 'unchecked'}`);

            userCheckboxes.forEach(function(checkbox) {
                checkbox.checked = isChecked;
                toggleUser(checkbox.value, isChecked);
            });
        });
        console.log('âœ… Master checkbox listener set up');
    }

    // Individual user checkboxes
    userCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function(e) {
            console.log(`ðŸ”„ User checkbox ${e.target.value} ${e.target.checked ? 'checked' : 'unchecked'}`);
            toggleUser(e.target.value, e.target.checked);
        });
    });

    console.log('âœ… Individual checkbox listeners set up');
}

function toggleSearchFilters() {
    try {
        const module = document.getElementById('search-filter-module');
        const toggle = document.getElementById('search-filter-toggle');

        if (module && toggle) {
            if (module.style.display === 'none' || module.style.display === '') {
                module.style.display = 'block';
                toggle.classList.remove('btn-outline-secondary');
                toggle.classList.add('btn-secondary');
            } else {
                module.style.display = 'none';
                toggle.classList.remove('btn-secondary');
                toggle.classList.add('btn-outline-secondary');
            }
        }
    } catch (error) {
        console.error('Error in toggleSearchFilters:', error);
    }
}

function overrideAutoSubmitBehavior() {
    // Override the auto-submit behavior from enterprise-search.js
    console.log('ðŸ”§ Overriding auto-submit behavior for manual control');

    // Remove auto-submit from search input
    const searchInput = document.getElementById('search');
    if (searchInput) {
        // Clone the input to remove all existing event listeners
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);

        // Add only Enter key submit
        newSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const form = newSearchInput.closest('form');
                if (form) {
                    console.log('ðŸ” Manual search submitted via Enter key');
                    form.submit();
                }
            }
        });
        console.log('âœ… Search input configured for Enter-only submission');
    }

    // Remove auto-submit from filter dropdowns
    const filterSelects = ['role_filter', 'status_filter', 'verified_filter'];
    filterSelects.forEach(filterId => {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            // Clone to remove existing event listeners
            const newFilterElement = filterElement.cloneNode(true);
            filterElement.parentNode.replaceChild(newFilterElement, filterElement);
            console.log(`âœ… Removed auto-submit from ${filterId}`);
        }
    });
}

function initializeKPIAnimations() {
    console.log('ðŸŽ¨ Initializing KPI animations');

    // Animate KPI cards with staggered entrance
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });

    // Animate KPI values with count-up effect
    const kpiValues = document.querySelectorAll('.kpi-value');
    kpiValues.forEach(kpiElement => {
        const text = kpiElement.textContent.trim();

        // Only animate if it's a number and not 'N/A'
        if (text !== 'N/A' && !isNaN(text) && text !== '') {
            const finalValue = parseInt(text);
            if (finalValue > 0) {
                let currentValue = 0;
                const increment = Math.max(1, Math.ceil(finalValue / 30));

                // Start from 0
                kpiElement.textContent = '0';

                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        kpiElement.textContent = finalValue;
                        clearInterval(timer);
                    } else {
                        kpiElement.textContent = currentValue;
                    }
                }, 50);
            }
        }
    });

    console.log('âœ… KPI animations initialized');
}

// =====================================
// PAGE INITIALIZATION
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ¢ User Administration Console: Enterprise Search handling search/filter/sort automatically');

    // Clear any existing selections
    selectedUsers.clear();

    // Set up selection event listeners
    setupUserSelectionListeners();

    // Initialize the count display
    updateSelectedCount();

    // === NEW: Override enterprise-search.js auto-submit behavior ===
    overrideAutoSubmitBehavior();

    // === NEW: Add KPI animations ===
    initializeKPIAnimations();

    // Check for CSRF token on page load
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        console.warn('âš ï¸ No CSRF token found on page load - bulk operations may fail');
    } else {
        console.log('âœ… CSRF token found and ready for all operations');
    }

    // Add CSRF token to meta tag if not already present (for consistency)
    if (!document.querySelector('meta[name=csrf-token]')) {
        const csrfInput = document.querySelector('input[name=csrf_token]');
        if (csrfInput) {
            const metaTag = document.createElement('meta');
            metaTag.name = 'csrf-token';
            metaTag.content = csrfInput.value;
            document.head.appendChild(metaTag);
            console.log('âœ… Added CSRF meta tag for consistency');
        }
    }

    console.log('âœ… User Administration Console initialized successfully');
});

</script>
{% endblock %}