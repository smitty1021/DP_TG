{% extends "base.html" %}
{% block title %}{{ backtest.trading_model.name }} Backtest - {{ backtest.description[:50] }}{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
<!-- Chart.js for Analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Executive Header -->
<div class="executive-header">
    <div class="enterprise-container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-chart-line executive-icon"></i>
                    <span class="badge bg-primary text-black me-3">{{ backtest.trading_model.name }}</span>
                    Backtest Analysis
                </h1>
                <div class="executive-subtitle">
                    Performance Analysis
                    {% if backtest.status.name == 'RUNNING' %}
                        <span class="status-indicator active">
                            <i class="fas fa-play-circle"></i> Running
                        </span>
                    {% elif backtest.status.name == 'COMPLETED' %}
                        <span class="status-indicator completed">
                            <i class="fas fa-check-circle"></i> Analysis Complete
                        </span>
                    {% elif backtest.status.name == 'DRAFT' %}
                        <span class="status-indicator paused">
                            <i class="fas fa-edit"></i> Draft
                        </span>
                    {% elif backtest.status.name == 'FAILED' %}
                        <span class="status-indicator failed">
                            <i class="fas fa-exclamation-triangle"></i> Failed
                        </span>
                    {% elif backtest.status.name == 'CANCELLED' %}
                        <span class="status-indicator cancelled">
                            <i class="fas fa-times-circle"></i> Cancelled
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="exportBacktestPDF()" title="Export to PDF">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="exportBacktestCSV()" title="Export to CSV">
                    <i class="fas fa-file-csv"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="{{ url_for('admin.create_default_model_backtest', backtest_id=backtest.id) }}"
                   class="btn btn-outline-secondary btn-sm"
                   title="Edit Backtest">
                    <i class="fas fa-edit"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.manage_default_model_backtests') }}'"
                        title="Back to All Backtests">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="enterprise-container-fluid" style="width: 100%; max-width: none; padding-left: 2rem; padding-right: 2rem;">
    
    <!-- Key Performance Metrics -->
    <div class="kpi-section">
        <div class="grid grid-cols-6 gap-4">
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Total Trades</span>
                            <i class="fas fa-chart-bar kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ backtest.total_trades or 0 }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator positive">Trade Count</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Win Rate</span>
                            <i class="fas fa-percentage kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if backtest.win_percentage is not none %}
                                {{ (backtest.win_percentage * 10)|round|int / 10 }}%
                            {% else %}
                                —
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator {{ 'positive' if backtest.win_percentage and backtest.win_percentage >= 50 else 'negative' }}">
                                {{ 'Strong' if backtest.win_percentage and backtest.win_percentage >= 60 else ('Good' if backtest.win_percentage and backtest.win_percentage >= 50 else 'Needs Work') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Profit Factor</span>
                            <i class="fas fa-chart-line kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if backtest.profit_factor is not none %}
                                {{ (backtest.profit_factor * 100)|round|int / 100 }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator {{ 'positive' if backtest.profit_factor and backtest.profit_factor >= 1.0 else 'negative' }}">
                                {{ 'Profitable' if backtest.profit_factor and backtest.profit_factor >= 1.0 else 'Unprofitable' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Total P&L</span>
                            <i class="fas fa-dollar-sign kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if backtest.total_pnl is not none %}
                                {% if backtest.total_pnl >= 0 %}
                                    ${{ backtest.total_pnl|round|int }}
                                {% else %}
                                    -${{ (backtest.total_pnl|abs)|round|int }}
                                {% endif %}
                            {% else %}
                                $0
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator {{ 'positive' if backtest.total_pnl and backtest.total_pnl > 0 else 'negative' }}">
                                {{ 'Profitable' if backtest.total_pnl and backtest.total_pnl > 0 else 'Loss' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Max Drawdown</span>
                            <i class="fas fa-arrow-down kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if backtest.max_drawdown is not none %}
                                ${{ (backtest.max_drawdown|abs)|round|int }}
                            {% else %}
                                $0
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator warning">Risk Metric</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Avg P&L/Trade</span>
                            <i class="fas fa-calculator kpi-icon"></i>
                        </div>
                        <div class="kpi-value">
                            {% if backtest.avg_trade_pnl is not none %}
                                {% if backtest.avg_trade_pnl >= 0 %}
                                    ${{ backtest.avg_trade_pnl|round|int }}
                                {% else %}
                                    -${{ (backtest.avg_trade_pnl|abs)|round|int }}
                                {% endif %}
                            {% else %}
                                $0
                            {% endif %}
                        </div>
                        <div class="kpi-trend">
                            <span class="trend-indicator {{ 'positive' if backtest.avg_trade_pnl and backtest.avg_trade_pnl > 0 else 'negative' }}">
                                {{ 'Positive' if backtest.avg_trade_pnl and backtest.avg_trade_pnl > 0 else 'Negative' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-4 align-items-start mt-4">
        <!-- Left Column: Backtest Details & Configuration -->
        <div class="col-span-2">
            <!-- Backtest Overview -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-info-circle module-icon"></i>
                        Backtest Configuration
                    </div>
                    <div class="module-meta">Testing Parameters & Setup</div>
                </div>
                <div class="module-content mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Trading Model</div>
                                <div class="text-muted">{{ backtest.trading_model.name }}</div>
                            </div>
                            {% if backtest.start_date and backtest.end_date %}
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Test Period</div>
                                <div class="text-muted">{{ backtest.start_date.strftime('%m/%d/%Y') }} - {{ backtest.end_date.strftime('%m/%d/%Y') }}</div>
                            </div>
                            {% endif %}
                            {% if backtest.initial_capital %}
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Initial Capital</div>
                                <div class="text-muted">${{ (backtest.initial_capital * 100)|round|int / 100 }}</div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if backtest.primary_instrument %}
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Primary Instrument</div>
                                <div class="text-muted">{{ backtest.primary_instrument }}</div>
                            </div>
                            {% endif %}
                            {% if backtest.position_sizing %}
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Position Sizing</div>
                                <div class="text-muted">{{ backtest.position_sizing }}</div>
                            </div>
                            {% endif %}
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Status</div>
                                {% if backtest.status.name == 'RUNNING' %}
                                    <span class="badge bg-success">Running</span>
                                {% elif backtest.status.name == 'COMPLETED' %}
                                    <span class="badge bg-primary">Completed</span>
                                {% elif backtest.status.name == 'DRAFT' %}
                                    <span class="badge bg-warning">Draft</span>
                                {% elif backtest.status.name == 'FAILED' %}
                                    <span class="badge bg-danger">Failed</span>
                                {% elif backtest.status.name == 'CANCELLED' %}
                                    <span class="badge bg-secondary">Cancelled</span>
                                {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if backtest.description %}
                    <div class="mb-3">
                        <div class="fw-semibold text-primary mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Description</div>
                        <div class="text-muted">{{ backtest.description }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trading Rules & Strategy -->
            {% if backtest.entry_rules or backtest.exit_rules or backtest.trade_management_applied or backtest.trade_management %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cogs module-icon"></i>
                        Trading Rules & Strategy
                    </div>
                </div>
                <div class="module-content mb-3">
                    <div class="row">
                        {% if backtest.entry_rules %}
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="fw-semibold text-success mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Entry Rules</div>
                                <div class="text-muted small">{{ backtest.entry_rules }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if backtest.exit_rules %}
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="fw-semibold text-danger mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Exit Rules</div>
                                <div class="text-muted small">{{ backtest.exit_rules }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if backtest.trade_management_applied or backtest.trade_management %}
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="fw-semibold text-warning mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Trade Management</div>
                                <div class="text-muted small">{{ backtest.trade_management_applied or backtest.trade_management }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Performance Analytics Charts -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-area module-icon"></i>
                        Performance Analytics
                    </div>
                    <div class="module-meta">Statistical Analysis & Visualization</div>
                </div>
                <div class="module-content mb-3">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                <canvas id="pnlChart" style="max-height: 300px;"></canvas>
                            </div>
                            <div class="text-center text-muted small mt-2">
                                <i class="fas fa-chart-line me-1"></i>Cumulative P&L Over Time
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                <canvas id="winLossChart" style="max-height: 300px;"></canvas>
                            </div>
                            <div class="text-center text-muted small mt-2">
                                <i class="fas fa-chart-pie me-1"></i>Win/Loss Distribution
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade History -->
            {% if trades %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-list module-icon"></i>
                        Trade History
                    </div>
                    <div class="module-meta">{{ trades|length }} Trades</div>
                </div>
                <div class="module-content mb-3">
                    <div class="table-responsive" style="max-height: 450px; overflow-y: auto; border: 1px solid var(--enterprise-border-color); border-radius: 0.375rem;">
                        <table class="table table-sm table-striped table-hover mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 18%;">
                                        <i class="fas fa-calendar me-1"></i>Date
                                    </th>
                                    <th style="width: 15%;">
                                        <i class="fas fa-chart-bar me-1"></i>Instrument
                                    </th>
                                    <th style="width: 15%;">
                                        <i class="fas fa-arrow-up me-1"></i>Direction
                                    </th>
                                    <th class="text-end" style="width: 17%;">
                                        <i class="fas fa-sign-in-alt me-1"></i>Entry Price
                                    </th>
                                    <th class="text-end" style="width: 17%;">
                                        <i class="fas fa-sign-out-alt me-1"></i>Exit Price
                                    </th>
                                    <th class="text-end" style="width: 18%;">
                                        <i class="fas fa-dollar-sign me-1"></i>P&L
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                <tr>
                                    <td>{{ trade.trade_date.strftime('%m/%d/%Y') if trade.trade_date }}</td>
                                    <td>{{ trade.instrument or '-' }}</td>
                                    <td>
                                        {% if trade.direction == 'long' %}
                                            <span class="badge bg-success">Long</span>
                                        {% elif trade.direction == 'short' %}
                                            <span class="badge bg-danger">Short</span>
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ trade.avg_entry_price or '-' }}</td>
                                    <td class="text-end">{{ trade.avg_exit_price or '-' }}</td>
                                    <td class="text-end">
                                        {% if trade.total_pnl is not none %}
                                            <span class="fw-semibold {% if trade.total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {% if trade.total_pnl >= 0 %}
                                                    ${{ (trade.total_pnl * 100)|round|int / 100 }}
                                                {% else %}
                                                    -${{ ((trade.total_pnl|abs) * 100)|round|int / 100 }}
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">$0.00</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Risk Analysis & Quick Actions -->
        <div class="col-span-1">
            <!-- Backtest Summary Card -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-tachometer-alt module-icon"></i>
                        Performance Summary
                    </div>
                </div>
                <div class="module-content mb-3">
                    <div class="d-flex align-items-center justify-content-between py-2 px-3 mb-3" 
                         style="background-color: {{ 'rgba(40, 167, 69, 0.1)' if backtest.total_pnl and backtest.total_pnl > 0 else 'rgba(220, 53, 69, 0.1)' }}; 
                                border: 1px solid {{ 'rgba(40, 167, 69, 0.2)' if backtest.total_pnl and backtest.total_pnl > 0 else 'rgba(220, 53, 69, 0.2)' }}; 
                                border-radius: 0.375rem;">
                        <div>
                            <div class="fw-semibold {{ 'text-success' if backtest.total_pnl and backtest.total_pnl > 0 else 'text-danger' }}">
                                Overall Result
                            </div>
                            <div class="text-muted small">
                                {% if backtest.total_trades and backtest.total_trades > 0 %}
                                    Based on {{ backtest.total_trades }} trades
                                {% else %}
                                    No trades recorded
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-{{ 'arrow-up text-success' if backtest.total_pnl and backtest.total_pnl > 0 else 'arrow-down text-danger' }} fa-2x"></i>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-6 text-center">
                            <div class="fw-semibold text-muted small">Duration</div>
                            <div class="text-primary">
                                {% if backtest.start_date and backtest.end_date %}
                                    {{ ((backtest.end_date - backtest.start_date).days) }} days
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="fw-semibold text-muted small">Status</div>
                            <div>
                                {% if backtest.status.name == 'COMPLETED' %}
                                    <span class="badge bg-success">Complete</span>
                                {% elif backtest.status.name == 'RUNNING' %}
                                    <span class="badge bg-primary">Running</span>
                                {% else %}
                                    <span class="badge bg-warning">{{ backtest.status.name.title() }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Risk Analysis -->
            {% if backtest.risk_settings or backtest.max_drawdown or backtest.avg_mae or backtest.avg_mfe %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-shield-alt module-icon"></i>
                        Risk Analysis
                    </div>
                </div>
                <div class="module-content mb-3">
                    {% if backtest.risk_settings %}
                    <div class="mb-3">
                        <div class="fw-semibold text-danger mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Risk Settings</div>
                        <div class="text-muted small">{{ backtest.risk_settings }}</div>
                    </div>
                    {% endif %}
                    {% if backtest.avg_mae %}
                    <div class="mb-3">
                        <div class="fw-semibold text-warning mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Avg MAE</div>
                        <div class="text-muted">${{ ((backtest.avg_mae|abs) * 100)|round|int / 100 }}</div>
                    </div>
                    {% endif %}
                    {% if backtest.avg_mfe %}
                    <div class="mb-3">
                        <div class="fw-semibold text-success mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Avg MFE</div>
                        <div class="text-muted">${{ (backtest.avg_mfe * 100)|round|int / 100 }}</div>
                    </div>
                    {% endif %}
                    {% if backtest.largest_loss %}
                    <div class="mb-3">
                        <div class="fw-semibold text-danger mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Largest Loss</div>
                        <div class="text-muted">${{ ((backtest.largest_loss|abs) * 100)|round|int / 100 }}</div>
                    </div>
                    {% endif %}
                    {% if backtest.largest_win %}
                    <div class="mb-3">
                        <div class="fw-semibold text-success mb-2 text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Largest Win</div>
                        <div class="text-muted">${{ (backtest.largest_win * 100)|round|int / 100 }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Screenshots/Images -->
            {% if screenshots %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-images module-icon"></i>
                        Screenshots
                    </div>
                    <div class="module-meta">{{ screenshots|length }} Images</div>
                </div>
                <div class="module-content mb-3">
                    {% for image in screenshots %}
                    <div class="text-center mb-3">
                        {% if image.caption %}
                        <div class="text-muted small mb-2" style="font-style: italic;">{{ image.caption }}</div>
                        {% endif %}
                        <div class="mb-3">
                            <img src="{{ url_for('images.serve_image', image_id=image.id) }}"
                                 alt="Backtest Screenshot {{ loop.index }}"
                                 class="img-fluid rounded"
                                 style="max-height: 200px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease;"
                                 onclick="showImageModal('{{ url_for('images.serve_image', image_id=image.id) }}', 'Backtest Screenshot {{ loop.index }}')"
                                 onmouseover="this.style.border='2px solid var(--enterprise-primary)'; this.style.transform='scale(1.02)'"
                                 onmouseout="this.style.border='2px solid transparent'; this.style.transform='scale(1)'">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-bolt module-icon"></i>
                        Quick Actions
                    </div>
                </div>
                <div class="module-content mb-3">
                    <div class="operation-list">
                        <a href="{{ url_for('admin.add_backtest_trade', backtest_id=backtest.id) }}"
                           class="operation-item">
                            <div class="operation-icon">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Add Trade</div>
                                <div class="text-muted" style="font-size: 0.8rem;">Record new trade result</div>
                            </div>
                        </a>

                        <a href="{{ url_for('admin.create_default_model_backtest', backtest_id=backtest.id) }}"
                           class="operation-item">
                            <div class="operation-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">Edit Backtest</div>
                                <div class="text-muted" style="font-size: 0.8rem;">Modify configuration</div>
                            </div>
                        </a>

                        <div class="operation-item" style="cursor: pointer;"
                             onclick="confirmDeleteBacktest({{ backtest.id }}, '{{ backtest.trading_model.name }} - {{ backtest.description[:30] }}...')">
                            <div class="operation-icon" style="background: rgba(209, 52, 56, 0.1);">
                                <i class="fas fa-trash-alt" style="color: var(--enterprise-danger);"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold small text-danger">Delete Backtest</div>
                                <div class="text-muted" style="font-size: 0.8rem;">Remove permanently</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            {% if backtest.notes %}
            <div class="enterprise-module mb-3">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-sticky-note module-icon"></i>
                        Notes & Observations
                    </div>
                </div>
                <div class="module-content mb-3">
                    <div class="text-muted small">{{ backtest.notes }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// =====================================
// CHARTS INITIALIZATION
// =====================================
document.addEventListener('DOMContentLoaded', function() {
    initializePnLChart();
    initializeWinLossChart();
});

function initializePnLChart() {
    const ctx = document.getElementById('pnlChart');
    if (!ctx) return;

    // Trade data for charts
    const tradeData = [
        {% if trades %}
        {% for trade in trades %}
        {
            total_pnl: {{ trade.total_pnl or 0 }},
            trade_date: '{{ trade.trade_date.strftime('%Y-%m-%d') if trade.trade_date }}',
            instrument: '{{ trade.instrument or "" }}',
            direction: '{{ trade.direction or "" }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
    ];
    
    const cumulativePnL = [];
    let runningTotal = 0;
    const labels = [];

    tradeData.forEach((trade, index) => {
        runningTotal += trade.total_pnl || 0;
        cumulativePnL.push(runningTotal);
        labels.push(`Trade ${index + 1}`);
    });

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative P&L',
                data: cumulativePnL,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        },
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    },
                    ticks: {
                        font: {
                            size: 12
                        },
                        maxTicksLimit: 10
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    callbacks: {
                        label: function(context) {
                            return 'P&L: $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            elements: {
                point: {
                    radius: 3,
                    hoverRadius: 6
                }
            }
        }
    });
}

function initializeWinLossChart() {
    const ctx = document.getElementById('winLossChart');
    if (!ctx) return;

    // Reuse the trade data from the P&L chart
    const tradeData = [
        {% if trades %}
        {% for trade in trades %}
        {
            total_pnl: {{ trade.total_pnl or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
    ];
    
    let wins = 0;
    let losses = 0;

    tradeData.forEach(trade => {
        if (trade.total_pnl > 0) wins++;
        else if (trade.total_pnl < 0) losses++;
    });

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Wins', 'Losses'],
            datasets: [{
                data: [wins, losses],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    callbacks: {
                        label: function(context) {
                            const total = wins + losses;
                            const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            cutout: '40%'
        }
    });
}

// =====================================
// EXPORT FUNCTIONS
// =====================================
function exportBacktestPDF() {
    const exportBtn = document.querySelector('button[onclick="exportBacktestPDF()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;
    
    fetch('/admin/backtests/{{ backtest.id }}/export-pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('PDF export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Backtest_{{ backtest.trading_model.name|replace(' ', '_') }}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showSuccess('Backtest exported to PDF successfully.', 'PDF Export Complete');
    })
    .catch(error => {
        console.error('PDF Export error:', error);
        showErrorMessage('PDF export failed. Please try again.');
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

function exportBacktestCSV() {
    const exportBtn = document.querySelector('button[onclick="exportBacktestCSV()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;
    
    fetch('/admin/backtests/{{ backtest.id }}/export-csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('CSV export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Backtest_{{ backtest.trading_model.name|replace(' ', '_') }}_Export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showSuccess('Backtest exported to CSV successfully.', 'CSV Export Complete');
    })
    .catch(error => {
        console.error('CSV Export error:', error);
        showErrorMessage('CSV export failed. Please try again.');
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

// =====================================
// DELETE FUNCTIONS
// =====================================
function confirmDeleteBacktest(backtestId, backtestName) {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation({
            title: 'Delete Backtest',
            message: `Confirm deletion of backtest:<br><br><strong>"${backtestName}"</strong><br><br><div class="alert alert-danger mt-2"><i class="fas fa-exclamation-triangle me-2"></i><strong>Warning:</strong> This action cannot be undone. All associated trades and data will be permanently deleted.</div>`,
            confirmText: 'Delete Backtest',
            cancelText: 'Cancel',
            confirmClass: 'btn-danger',
            icon: 'exclamation-triangle',
            onConfirm: function() {
                performDeleteBacktest(backtestId);
            }
        });
    } else {
        if (confirm(`Confirm deletion of backtest: "${backtestName}"?\n\nThis action cannot be undone.`)) {
            performDeleteBacktest(backtestId);
        }
    }
}

function performDeleteBacktest(backtestId) {
    fetch('/admin/backtests/' + backtestId + '/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/admin/default-models/backtest';
        } else {
            throw new Error('Delete failed');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showErrorMessage('Failed to delete backtest. Please try again.');
    });
}

// =====================================
// IMAGE MODAL FUNCTION
// =====================================
function showImageModal(imageUrl, title) {
    const modalHtml = `
        <div class="modal fade" id="imageViewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" alt="${title}" class="img-fluid">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="${imageUrl}" download class="btn btn-primary">
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('imageViewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
    modal.show();
}

// =====================================
// UTILITY FUNCTIONS
// =====================================
function getCSRFToken() {
    let csrfToken = null;

    const directInput = document.getElementById('js-csrf-token');
    if (directInput && directInput.value) {
        csrfToken = directInput.value;
    }

    if (!csrfToken) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag && metaTag.getAttribute('content')) {
            csrfToken = metaTag.getAttribute('content');
        }
    }

    return csrfToken;
}

function showErrorMessage(message) {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation({
            title: 'Error',
            message: message,
            confirmText: 'OK',
            confirmClass: 'btn-danger',
            icon: 'exclamation-triangle',
            showCancel: false,
            onConfirm: function() {}
        });
    } else {
        alert(message);
    }
}

function showSuccess(message, title = 'Success') {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation({
            title: title,
            message: message,
            confirmText: 'OK',
            confirmClass: 'btn-success',
            icon: 'check-circle',
            showCancel: false,
            onConfirm: function() {}
        });
    } else {
        alert(message);
    }
}
</script>

{% endblock %}