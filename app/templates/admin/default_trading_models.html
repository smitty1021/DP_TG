{% extends "base.html" %}
{% block title %}Strategic Model Administration - Trading Models{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Executive Header -->
<div class="executive-header">
    <div class="enterprise-container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-chart-line executive-icon"></i>
                    Strategic Trading Model Administration
                </h1>
                <div class="executive-subtitle">
                    Configure and manage default trading models for organizational trading analysis
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.create_default_trading_model') }}'"
                        title="Create New Trading Model">
                    <i class="fas fa-plus"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="exportModelsPDF()" title="Export to PDF">
                    <i class="fas fa-file-pdf"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="exportModelsCSV()" title="Export to CSV">
                    <i class="fas fa-file-csv"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.show_admin_dashboard') }}'"
                        title="Back to Administration Center">
                    <i class="fas fa-tachometer-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Wrapper -->
<div class="enterprise-container-fluid" style="width: 100%; max-width: none; padding-left: 2rem; padding-right: 2rem;">
    <!-- KPI Cards Section -->
    <div class="kpi-section mt-3">
        <div class="grid grid-cols-3 gap-4">
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Total Models</span>
                            <i class="fas fa-chart-line kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ models|length }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator">
                                <i class="fas fa-cogs"></i> Configured
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Active Models</span>
                            <i class="fas fa-check-circle kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ models|selectattr('is_active')|list|length }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator operational">
                                <i class="fas fa-play"></i> Operational
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-span-1">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <span class="kpi-label">Default Models</span>
                            <i class="fas fa-star kpi-icon"></i>
                        </div>
                        <div class="kpi-value">{{ models|selectattr('is_default')|list|length }}</div>
                        <div class="kpi-trend">
                            <span class="trend-indicator neutral">
                                <i class="fas fa-layer-group"></i> System
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden CSRF Token for JavaScript -->
    <input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">

    <!-- Enterprise Grid Layout for Trading Models -->
    <div class="grid grid-cols-3 gap-4 align-items-start mt-3">
        <!-- Trading Models Table -->
        <div class="col-span-2">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cogs module-icon"></i>
                        Strategic Trading Models
                    </div>
                    <div class="module-meta">Active Configurations</div>
                </div>
                <div class="module-content mb-3">
                    {% if models %}
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th width="60" class="text-center">Type</th>
                                    <th>Trading Model</th>
                                    <th width="100" class="text-center">Version</th>
                                    <th width="120" class="text-center">Status</th>
                                    <th width="100" class="text-center">Creator</th>
                                    <th width="200" class="text-center"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in models %}
                                <tr class="fade-in {% if not model.is_active %}opacity-50{% endif %}">
                                    <td class="text-center">
                                        {% if model.is_default %}
                                            <span class="badge bg-success text-white fw-semibold">SYS</span>
                                        {% else %}
                                            <span class="badge bg-primary text-white fw-semibold">USR</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-semibold">
                                        {{ model.name }}
                                        {% if model.short_description %}
                                            <div class="text-muted small">{{ model.short_description[:50] }}{% if model.short_description|length > 50 %}...{% endif %}</div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="version-badge">
                                            {{ model.version or 'v1.0' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="status-badge {{ 'operational' if model.is_active else 'inactive' }}">
                                            <i class="fas {{ 'fa-check-circle' if model.is_active else 'fa-times-circle' }} me-1"></i>
                                            {{ 'OPERATIONAL' if model.is_active else 'STANDBY' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="text-muted small">
                                            <i class="fas fa-user-circle me-1"></i>
                                            {{ model.user.username if model.user else 'System' }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    onclick="window.location.href='{{ url_for('admin.view_default_trading_model', model_id=model.id) }}'"
                                                    title="View Model">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    onclick="window.location.href='{{ url_for('admin.edit_default_trading_model', model_id=model.id) }}'"
                                                    title="Edit Model">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                    onclick="window.location.href='{{ url_for('admin.manage_default_model_backtests') }}';"
                                                    title="Backtesting Analytics">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-outline-secondary btn-sm toggle-status-btn"
                                                    title="{{ 'Suspend Operations' if model.is_active else 'Activate Operations' }}"
                                                    data-model-id="{{ model.id }}"
                                                    data-model-name="{{ model.name }}"
                                                    data-csrf-token="{{ csrf_token() }}">
                                                <i class="fas {{ 'fa-pause' if model.is_active else 'fa-play' }}"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-outline-danger btn-sm delete-btn"
                                                    title="Remove Configuration"
                                                    data-model-id="{{ model.id }}"
                                                    data-model-name="{{ model.name }}"
                                                    data-csrf-token="{{ csrf_token() }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            </table>
                        </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-3" style="opacity: 0.3;"></i>
                        <p class="text-muted fst-italic">No Strategic Trading Models found matching your criteria.</p>
                        <a href="{{ url_for('admin.create_default_trading_model') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-2"></i>Create First Trading Model
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Trading Models Overview -->
        <div class="col-span-1">
            <div class="enterprise-module">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-bar module-icon"></i>
                        Model Analytics
                    </div>
                    <div class="module-meta">Performance Overview</div>
                </div>
                <div class="module-content mb-3">
                    <div class="operation-list">
                        <div class="operation-item">
                            <div class="operation-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                                    Backtesting Analytics
                                </div>
                                <div class="text-muted" style="font-size: 0.8rem;">
                                    View comprehensive backtesting results and performance metrics for all trading models
                                </div>
                                <div class="mt-2">
                                    <a href="{{ url_for('admin.manage_default_model_backtests') }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-chart-line me-1"></i>View Analytics
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="operation-item">
                            <div class="operation-icon">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                                    Create New Model
                                </div>
                                <div class="text-muted" style="font-size: 0.8rem;">
                                    Design and configure a new strategic trading model
                                </div>
                                <div class="mt-2">
                                    <a href="{{ url_for('admin.create_default_trading_model') }}" class="btn btn-success btn-sm">
                                        <i class="fas fa-plus me-1"></i>Create Model
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="operation-item">
                            <div class="operation-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold text-primary text-uppercase" style="font-size: 0.85rem; letter-spacing: 0.5px;">
                                    Export Configuration
                                </div>
                                <div class="text-muted" style="font-size: 0.8rem;">
                                    Export trading model configurations to PDF or CSV format
                                </div>
                                <div class="mt-2">
                                    <div class="btn-group btn-group-sm">
                                        <button onclick="exportModelsPDF()" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-file-pdf me-1"></i>PDF
                                        </button>
                                        <button onclick="exportModelsCSV()" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-file-csv me-1"></i>CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
// =====================================
// IMAGE MODAL FUNCTION
// =====================================
function showImageModal(imageUrl, title) {
    const modalHtml = `
        <div class="modal fade" id="imageViewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imageUrl}" alt="${title}" class="img-fluid">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="${imageUrl}" download class="btn btn-primary">
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('imageViewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
    modal.show();
}

// =====================================
// UTILITY FUNCTIONS
// =====================================
function getCSRFToken() {
    let csrfToken = null;

    const directInput = document.getElementById('js-csrf-token');
    if (directInput && directInput.value) {
        csrfToken = directInput.value;
    }

    if (!csrfToken) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag && metaTag.getAttribute('content')) {
            csrfToken = metaTag.getAttribute('content');
        }
    }

    if (!csrfToken) {
        const hiddenInput = document.querySelector('input[name="csrf_token"]');
        if (hiddenInput && hiddenInput.value) {
            csrfToken = hiddenInput.value;
        }
    }

    return csrfToken;
}

// =====================================
// EXPORT FUNCTIONS
// =====================================
function exportModelsPDF() {
    const exportBtn = document.querySelector('button[onclick="exportModelsPDF()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;
    
    fetch('/admin/default-trading-models/export-pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('PDF export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `All_Trading_Models_Export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('All trading models exported to PDF successfully.', 'success', 'PDF Export Complete');
    })
    .catch(error => {
        console.error('PDF Export error:', error);
        showNotification('PDF export failed. Please try again.', 'error', 'Export Error');
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

function exportModelsCSV() {
    const exportBtn = document.querySelector('button[onclick="exportModelsCSV()"]');
    const originalHtml = exportBtn.innerHTML;
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    exportBtn.disabled = true;
    
    fetch('/admin/default-trading-models/export-csv', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('CSV export failed');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `All_Trading_Models_Export_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('All trading models exported to CSV successfully.', 'success', 'CSV Export Complete');
    })
    .catch(error => {
        console.error('CSV Export error:', error);
        showNotification('CSV export failed. Please try again.', 'error', 'Export Error');
    })
    .finally(() => {
        exportBtn.innerHTML = originalHtml;
        exportBtn.disabled = false;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize enterprise animations
    const modules = document.querySelectorAll('.enterprise-module');
    modules.forEach((module, index) => {
        module.style.animationDelay = `${index * 0.1}s`;
    });

    // Handle toggle status button clicks
    document.querySelectorAll('.toggle-status-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const modelId = this.dataset.modelId;
            const modelName = this.dataset.modelName;
            const csrfToken = this.dataset.csrfToken;

            showCustomConfirmation({
                title: 'Confirm Operational Status Change',
                message: `Are you sure you want to modify the operational status for strategic Model "<strong>${modelName}</strong>"?`,
                confirmText: 'Confirm Execution',
                confirmClass: 'btn-warning',
                icon: 'question-circle',
                onConfirm: () => {
                    executeStatusToggle(modelId, modelName, csrfToken);
                }
            });
        });
    });

    // Handle delete button clicks
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const modelId = this.dataset.modelId;
            const modelName = this.dataset.modelName;

            confirmRemoveConfiguration(modelId, modelName);
        });
    });
});

// Function to execute status toggle
function executeStatusToggle(modelId, modelName, csrfToken) {
    showNotification('Processing status change...', 'info', 'System Operation');

    const url = `/admin/default-trading-models/${modelId}/toggle-status`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return { success: true, message: 'Status updated successfully' };
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .then(data => {
        if (data.success !== false) {
            showSuccess(`Strategic Model "${modelName}" operational status has been updated successfully.`, 'Configuration Updated');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showErrorMessage(data.message || 'Failed to update operational status.');
        }
    })
    .catch(error => {
        console.error('Status toggle error:', error);
        showErrorMessage('An unexpected system error occurred during status update.');
    });
}

// Enterprise confirmation for removing configurations
function confirmRemoveConfiguration(modelId, modelName) {
    showCustomConfirmation({
        title: 'Confirm Operational Change',
        message: `Are you sure you want to remove the strategic Model configuration "<strong>${modelName}</strong>"? This operational change cannot be undone.`,
        confirmText: 'Remove Configuration',
        cancelText: 'Cancel',
        confirmClass: 'btn-danger',
        icon: 'exclamation-triangle',
        onConfirm: () => {
            executeRemoveConfiguration(modelId, modelName);
        }
    });
}

// Execute configuration removal
function executeRemoveConfiguration(modelId, modelName) {
    // Show loading state
    showNotification('Processing configuration removal...', 'info', 'System Operation');

    // Create proper delete URL - note this endpoint needs to be created in admin_bp.py
    const url = `/admin/default-trading-models/${modelId}/delete`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => {
        if (response.ok) {
            // Check if response is JSON or HTML redirect
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // Flask flash message and redirect - treat as success
                return { success: true, message: 'Configuration removed successfully' };
            }
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    })
    .then(data => {
        if (data.success !== false) {
            showSuccess(`Strategic Model "${modelName}" configuration has been removed successfully.`, 'Configuration Updated');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showErrorMessage(data.message || 'Failed to remove configuration.');
        }
    })
    .catch(error => {
        console.error('Configuration removal error:', error);
        showErrorMessage('An unexpected system error occurred during configuration removal.');
    });
}

// =====================================
// UTILITY FUNCTIONS
// =====================================
function showErrorMessage(message) {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation({
            title: 'Error',
            message: message,
            confirmText: 'OK',
            confirmClass: 'btn-danger',
            icon: 'exclamation-triangle',
            showCancel: false,
            onConfirm: function() {}
        });
    } else {
        alert(message);
    }
}

function showSuccess(message, title = 'Success') {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation({
            title: title,
            message: message,
            confirmText: 'OK',
            confirmClass: 'btn-success',
            icon: 'check-circle',
            showCancel: false,
            onConfirm: function() {}
        });
    } else {
        alert(message);
    }
}
</script>
{% endblock %}