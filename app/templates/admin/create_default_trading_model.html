{% extends "base.html" %}

{% block title %}Strategic Framework Configuration{% if model %} - {{ model.name }}{% endif %}{% endblock %}

{% block head_extra %}
<!-- Fortune 500 Enterprise CSS Framework -->
<link rel="stylesheet" href="/static/css/enterprise-all.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<meta name="csrf-token" content="{{ csrf_token() }}">
<input type="hidden" id="js-csrf-token" value="{{ csrf_token() }}">
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
<script src="{{ url_for('static', filename='js/custom-modals.js') }}"></script>
{% endblock %}

{% block scripts_extra %}
<script>
// Global variables for unsaved changes tracking
let hasUnsavedChanges = false;
let originalFormData = {};
let isSubmitting = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize comprehensive unsaved changes detection
    initializeUnsavedChangesDetection();

    // Initialize image preview functionality
    initializeImagePreview();

    // Initialize auto-resizing textareas
    initializeAutoResizeTextareas();

    // Add form submission debugging
    const form = document.getElementById('create-trading-model-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submission detected');
            console.log('Form data:', new FormData(form));
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            
            // Only validate required fields for create mode (not edit mode)
            {% if not model %}
            let hasErrors = false;
            const requiredFields = [
                { element: form.querySelector('#name'), label: 'Model Name' },
                { element: form.querySelector('#entry_trigger_description'), label: 'Entry Trigger Specifications' },
                { element: form.querySelector('#stop_loss_strategy'), label: 'Stop Loss Protocol' },
                { element: form.querySelector('#take_profit_strategy'), label: 'Profit Target Strategy' }
            ];
            
            requiredFields.forEach(field => {
                if (field.element && !field.element.value.trim()) {
                    field.element.classList.add('is-invalid');
                    hasErrors = true;
                    console.log(`Missing required field: ${field.label}`);
                } else if (field.element) {
                    field.element.classList.remove('is-invalid');
                }
            });

            if (hasErrors) {
                e.preventDefault();
                showCustomConfirmation(
                    'Required Fields Missing',
                    'Please fill in all required fields:\n• Model Name\n• Entry Trigger Specifications\n• Stop Loss Protocol\n• Profit Target Strategy',
                    'btn-warning',
                    'exclamation-triangle'
                ).then(result => {
                    // Just acknowledge the error, don't proceed with form submission
                });
                return false;
            }
            {% endif %}
            
            // Mark as submitting to prevent unsaved changes warnings
            isSubmitting = true;
            hasUnsavedChanges = false;
            hideUnsavedIndicator();
            
            // Allow form to submit normally
            console.log('Form validation passed, submitting...');
        });
    }

    console.log('Page initialized');
});

function initializeImagePreview() {
    const fileInput = document.getElementById('chart_examples');
    const previewContainer = document.getElementById('image-preview-container');
    const defaultState = document.getElementById('default-chart-state');

    if (fileInput && previewContainer) {
        fileInput.addEventListener('change', function(e) {
            previewContainer.innerHTML = '';

            if (this.files && this.files.length > 0) {
                previewContainer.style.display = 'block';
                if (defaultState) defaultState.style.display = 'none';
                
                // Mark as changed for unsaved changes
                if (window.enterpriseUnsavedChanges) {
                    window.enterpriseUnsavedChanges.hasUnsavedChanges = true;
                    window.enterpriseUnsavedChanges.updateVisualIndicators();
                }

                Array.from(this.files).forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'text-center mb-3';
                            previewDiv.innerHTML = `
                                <div class="mb-3">
                                    <img src="${e.target.result}"
                                         alt="Trading Model Chart Example ${index + 1}"
                                         class="img-fluid rounded"
                                         style="max-height: 250px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease;"
                                         onmouseover="this.style.border='2px solid #0066cc'; this.style.transform='scale(1.02)'"
                                         onmouseout="this.style.border='2px solid transparent'; this.style.transform='scale(1)'">
                                </div>
                                <div class="text-muted small mb-2" style="font-style: italic;">${file.name}</div>
                            `;
                            previewContainer.appendChild(previewDiv);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                previewContainer.style.display = 'none';
                if (defaultState) defaultState.style.display = 'block';
            }
        });
    }
}

function initializeAutoResizeTextareas() {
    const textareas = document.querySelectorAll('textarea');

    textareas.forEach(textarea => {
        textarea.style.resize = 'vertical';
        textarea.style.overflow = 'hidden';
        textarea.style.boxSizing = 'border-box';

        autoResize(textarea);

        textarea.addEventListener('input', function() {
            autoResize(this);
        });

        textarea.addEventListener('change', function() {
            autoResize(this);
        });

        textarea.addEventListener('paste', function() {
            setTimeout(() => autoResize(this), 10);
        });

        window.addEventListener('resize', function() {
            autoResize(textarea);
        });
    });
}

function autoResize(textarea) {
    const originalOverflow = textarea.style.overflow;
    const originalHeight = textarea.style.height;

    textarea.style.overflow = 'hidden';
    textarea.style.height = 'auto';

    const rows = parseInt(textarea.getAttribute('rows')) || 3;
    const lineHeight = parseInt(window.getComputedStyle(textarea).lineHeight) || 20;
    const minHeight = rows * lineHeight + 20;

    const scrollHeight = textarea.scrollHeight;
    const newHeight = Math.max(scrollHeight + 2, minHeight);
    textarea.style.height = newHeight + 'px';

    if (originalOverflow !== 'hidden') {
        textarea.style.overflow = originalOverflow || 'hidden';
    }
}

function initializeUnsavedChangesDetection() {
    const form = document.getElementById('create-trading-model-form');
    if (!form) return;

    // Get all form elements including those associated via form attribute
    const formInputs = form.querySelectorAll('input, select, textarea, [contenteditable]');
    const associatedInputs = document.querySelectorAll('[form="create-trading-model-form"]');
    
    // Combine both sets of inputs
    const inputs = [...formInputs, ...associatedInputs];
    
    console.log(`Found ${inputs.length} form elements for unsaved changes detection`);
    
    // Debug: List all form fields found
    inputs.forEach((input, index) => {
        console.log(`Field ${index + 1}: name="${input.name}", id="${input.id}", type="${input.type}", tagName="${input.tagName}"`);
    });
    
    // Store original form data
    inputs.forEach(input => {
        const fieldKey = input.name || input.id || input.type;
        if (input.type === 'checkbox') {
            originalFormData[fieldKey] = input.checked;
        } else if (input.type === 'file') {
            originalFormData[fieldKey] = ''; // Files start empty
        } else {
            originalFormData[fieldKey] = input.value || '';
        }
    });

    // Add change listeners to all form elements
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            console.log(`Change detected in field: name="${this.name}", id="${this.id}", type="${this.type}"`);
            checkForChanges();
        });
        input.addEventListener('input', function() {
            console.log(`Input detected in field: name="${this.name}", id="${this.id}", type="${this.type}"`);
            checkForChanges();
        });
        
        // Special handling for file inputs
        if (input.type === 'file') {
            input.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    hasUnsavedChanges = true;
                    showUnsavedIndicator();
                    console.log('File input changed, marking as unsaved');
                }
            });
        }
    });

    function checkForChanges() {
        hasUnsavedChanges = false;
        let changedFields = [];
        
        inputs.forEach(input => {
            const fieldKey = input.name || input.id || input.type;
            let currentValue, originalValue;
            
            if (input.type === 'checkbox') {
                currentValue = input.checked;
                originalValue = originalFormData[fieldKey];
            } else if (input.type === 'file') {
                // File inputs are considered changed if they have files
                if (input.files && input.files.length > 0) {
                    hasUnsavedChanges = true;
                    changedFields.push(fieldKey);
                }
                return;
            } else {
                currentValue = input.value || '';
                originalValue = originalFormData[fieldKey] || '';
            }
            
            if (currentValue !== originalValue) {
                hasUnsavedChanges = true;
                changedFields.push(fieldKey);
            }
        });

        if (changedFields.length > 0) {
            console.log('Changed fields detected:', changedFields);
        }

        // Show/hide unsaved changes indicator
        if (hasUnsavedChanges && !isSubmitting) {
            showUnsavedIndicator();
        } else {
            hideUnsavedIndicator();
        }
    }
}

function showUnsavedIndicator() {
    const indicator = document.getElementById('unsaved-indicator');
    if (indicator) {
        indicator.style.display = 'block';
        console.log('Showing unsaved changes indicator');
    }
}

function hideUnsavedIndicator() {
    const indicator = document.getElementById('unsaved-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

function confirmCancel() {
    {% if model %}
    const message = 'Configuration changes are pending. Are you sure you want to discard these modifications and return to the Strategic Framework Administration?';
    {% else %}
    const message = 'Discard configuration changes and return to model administration?';
    {% endif %}
    
    if (confirm(message)) {
        // Reset unsaved changes to prevent beforeunload warning
        hasUnsavedChanges = false;
        window.location.href = '{{ url_for("admin.manage_default_trading_models") }}';
    }
}

// Delete existing image function
function deleteExistingImage(imageId, filename) {
    showCustomConfirmation(
        'Delete Chart Example',
        `Are you sure you want to delete "${filename}"?<br><br>This action cannot be undone.`,
        'btn-danger',
        'trash-alt'
    ).then(result => {
        if (result) {
            // Make AJAX request to delete image
            const formData = new FormData();
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            fetch(`/admin/delete-image/${imageId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the image from display
                    const imageContainer = document.getElementById(`existing-image-${imageId}`);
                    if (imageContainer) {
                        imageContainer.remove();
                    }
                    
                    // Update the count or show default state if no images left
                    const existingImagesContainer = document.getElementById('existing-images-container');
                    const remainingImages = existingImagesContainer.querySelectorAll('[id^="existing-image-"]');
                    
                    if (remainingImages.length === 0) {
                        existingImagesContainer.style.display = 'none';
                        // Show default state if it exists
                        const defaultState = document.getElementById('default-chart-state');
                        if (defaultState) {
                            defaultState.style.display = 'block';
                        }
                    } else {
                        // Update count in header
                        const header = existingImagesContainer.querySelector('h6');
                        if (header) {
                            header.textContent = `Current Chart Examples (${remainingImages.length})`;
                        }
                    }
                    
                    // Mark as changed for unsaved changes detection
                    if (window.enterpriseUnsavedChanges) {
                        window.enterpriseUnsavedChanges.hasUnsavedChanges = true;
                        window.enterpriseUnsavedChanges.updateVisualIndicators();
                    }
                    
                    if (typeof showNotification === 'function') {
                        showNotification('Image deleted successfully', 'success');
                    }
                } else {
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'Error deleting image', 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Error deleting image', 'error');
                }
            });
        }
    });
}

// Show image modal function
function showImageModal(imageSrc, title) {
    if (typeof showCustomConfirmation === 'function') {
        showCustomConfirmation(
            title || 'Chart Example',
            `<div class="text-center"><img src="${imageSrc}" class="img-fluid" style="max-width: 100%; max-height: 70vh;"></div>`,
            'btn-primary',
            'eye'
        );
    } else {
        // Fallback - open in new window
        window.open(imageSrc, '_blank');
    }
}
</script>
{% endblock %}

{% block content %}
<!-- Executive Header -->
<div class="executive-header">
    <div class="enterprise-container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div class="header-content">
                <h1 class="executive-title">
                    <i class="fas fa-cogs executive-icon"></i>
                    Strategic Framework Configuration
                </h1>
                <div class="executive-subtitle">
                    {% if model %}
                        Modify Strategic Trading Framework: {{ model.name }}
                    {% else %}
                        Trading Model Development & Implementation
                    {% endif %}
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('main.index') }}'"
                        title="Go to Main Dashboard">
                    <i class="fas fa-home"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="location.reload()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="window.location.href='{{ url_for('admin.manage_default_trading_models') }}'"
                        title="Back to Model Administration">
                    <i class="fas fa-tachometer-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="history.back();"
                        title="Go Back">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Wrapper -->
<div class="enterprise-container-fluid mt-3">
    <!-- Unsaved Changes Indicator -->
    <div id="unsaved-indicator" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Unsaved Changes:</strong> You have made changes that have not been saved yet.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="grid grid-cols-3 gap-4 align-items-start">
        <!-- Primary Configuration Panel (2/3 width) -->
        <div class="col-span-2">
            <form method="POST" enctype="multipart/form-data" novalidate id="create-trading-model-form"
                  {% if model %}action="{{ url_for('admin.edit_default_trading_model', model_id=model.id) }}"{% endif %}>
                {{ form.hidden_tag() }}

                <!-- Required Fields Notice -->
                {% if not model %}
                <div class="alert alert-info mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle me-2 mt-1"></i>
                        <div>
                            <h6 class="alert-heading mb-2">Required Fields</h6>
                            <p class="mb-2">The following fields are required to create a trading model:</p>
                            <ul class="mb-0 small">
                                <li><strong>Model Name</strong> - Unique identifier for your trading framework</li>
                                <li><strong>Entry Trigger Specifications</strong> - Precise conditions for trade initiation</li>
                                <li><strong>Stop Loss Protocol</strong> - Risk management strategy</li>
                                <li><strong>Profit Target Strategy</strong> - Exit strategy for profitable trades</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                        <div>
                            <h6 class="alert-heading mb-2">Enterprise Configuration Update</h6>
                            <p class="mb-0">This strategic framework configuration affects all system users. Changes will be immediately available across the enterprise platform.</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Strategic Framework Overview -->
                <div class="enterprise-module mb-4">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-info-circle module-icon"></i>
                            Strategic Framework Overview
                        </div>
                        <div class="module-meta">Trading Model Configuration</div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-8 gap-3 mb-3">
                            <div class="col-span-6">
                                <label for="{{ form.name.id }}" class="form-label fw-semibold">{{ form.name.label.text }}</label>
                                {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback">{{ form.name.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-2">
                                <label for="{{ form.version.id }}" class="form-label fw-semibold">{{ form.version.label.text }}</label>
                                {{ form.version(class="form-control" + (" is-invalid" if form.version.errors else "")) }}
                                {% if form.version.errors %}
                                    <div class="invalid-feedback">{{ form.version.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid grid-cols-7 gap-3 mb-3">
                            <div class="col-span-5">
                                <label for="{{ form.overview_logic.id }}" class="form-label fw-semibold">Strategic Approach and Fundamental Reasoning</label>
                                {{ form.overview_logic(class="form-control textarea-8") }}
                                {% if form.overview_logic.errors %}
                                    <div class="invalid-feedback">{{ form.overview_logic.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <div class="col-span-2">
                                <div class="module-title">Operational Timeframes</div>
                                <label for="{{ form.primary_chart_tf.id }}" class="text-muted">Analysis Timeframe</label>
                                {{ form.primary_chart_tf(class="form-control" + (" is-invalid" if form.primary_chart_tf.errors else "")) }}
                                {% if form.primary_chart_tf.errors %}
                                    <div class="invalid-feedback">{{ form.primary_chart_tf.errors[0] }}</div>
                                {% endif %}

                                <label for="{{ form.execution_chart_tf.id }}" class="text-muted">Execution Timeframe</label>
                                {{ form.execution_chart_tf(class="form-control" + (" is-invalid" if form.execution_chart_tf.errors else "")) }}
                                {% if form.execution_chart_tf.errors %}
                                    <div class="invalid-feedback">{{ form.execution_chart_tf.errors[0] }}</div>
                                {% endif %}

                                <label for="{{ form.context_chart_tf.id }}" class="text-muted">Context Analysis</label>
                                {{ form.context_chart_tf(class="form-control" + (" is-invalid" if form.context_chart_tf.errors else "")) }}
                                {% if form.context_chart_tf.errors %}
                                    <div class="invalid-feedback">{{ form.context_chart_tf.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid grid-cols-6 gap-3">
                            <div class="col-span-3">
                                <label for="{{ form.technical_indicators_used.id }}" class="form-label fw-semibold">Technical Indicators and Settings</label>
                                {{ form.technical_indicators_used(class="form-control textarea-8") }}
                                {% if form.technical_indicators_used.errors %}
                                    <div class="invalid-feedback">{{ form.technical_indicators_used.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-3">
                                <label for="{{ form.chart_patterns_used.id }}" class="form-label fw-semibold">Chart Patterns and Formations</label>
                                {{ form.chart_patterns_used(class="form-control textarea-8") }}
                                {% if form.chart_patterns_used.errors %}
                                    <div class="invalid-feedback">{{ form.chart_patterns_used.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-4">
                                <div class="form-check">
                                    {{ form.is_active(class="form-check-input" + (" is-invalid" if form.is_active.errors else "")) }}
                                    <label for="{{ form.is_active.id }}" class="form-check-label fw-semibold">Deploy Model For Global Utilization </label>
                                    {% if form.is_active.errors %}
                                        <div class="invalid-feedback">{{ form.is_active.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                    <!-- Entry & Risk Management Framework -->
                    <div class="enterprise-module mb-4">
                        <div class="module-header">
                            <div class="module-title">
                                <i class="fas fa-shield-alt module-icon"></i>
                                Entry & Execution
                            </div>
                            <div class="module-meta">Trade Execution & Protection Protocols</div>
                        </div>
                        <div class="module-content">
                            <div class="mb-3">
                                <label for="{{ form.entry_trigger_description.id }}" class="form-label fw-semibold">Entry Trigger Specifications <span class="text-danger">*</span></label>
                                {{ form.entry_trigger_description(class="form-control" + (" is-invalid" if form.entry_trigger_description.errors else ""), rows="4") }}
                                {% if form.entry_trigger_description.errors %}
                                    <div class="invalid-feedback">{{ form.entry_trigger_description.errors[0] }}</div>
                                {% endif %}
                                <div class="form-text">Precise conditions required for trade initiation</div>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="col-span-1">
                                    <label for="{{ form.stop_loss_strategy.id }}" class="form-label fw-semibold">Stop Loss Protocol <span class="text-danger">*</span></label>
                                    {{ form.stop_loss_strategy(class="form-control" + (" is-invalid" if form.stop_loss_strategy.errors else ""), rows="3") }}
                                    {% if form.stop_loss_strategy.errors %}
                                        <div class="invalid-feedback">{{ form.stop_loss_strategy.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-span-1">
                                    <label for="{{ form.take_profit_strategy.id }}" class="form-label fw-semibold">Profit Target Strategy <span class="text-danger">*</span></label>
                                    {{ form.take_profit_strategy(class="form-control" + (" is-invalid" if form.take_profit_strategy.errors else ""), rows="3") }}
                                    {% if form.take_profit_strategy.errors %}
                                        <div class="invalid-feedback">{{ form.take_profit_strategy.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-span-1">
                                    <label for="{{ form.min_risk_reward_ratio.id }}" class="form-label fw-semibold">Minimum Risk:Reward</label>
                                    {{ form.min_risk_reward_ratio(class="form-control" + (" is-invalid" if form.min_risk_reward_ratio.errors else "")) }}
                                    {% if form.min_risk_reward_ratio.errors %}
                                        <div class="invalid-feedback">{{ form.min_risk_reward_ratio.errors[0] }}</div>
                                    {% endif %}
                                    <div class="form-text">Required ratio threshold</div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Position Management Operations -->
                <div class="enterprise-module mb-4">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-balance-scale module-icon"></i>
                            Position Management Operations
                        </div>
                        <div class="module-meta">Sizing & Dynamic Trade Management</div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="col-span-1">
                                <label for="{{ form.position_sizing_rules.id }}" class="form-label fw-semibold">Position Sizing Protocol</label>
                                {{ form.position_sizing_rules(class="form-control", rows="3") }}
                                {% if form.position_sizing_rules.errors %}
                                    <div class="invalid-feedback">{{ form.position_sizing_rules.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.scaling_in_out_rules.id }}" class="form-label fw-semibold">Scaling Operations</label>
                                {{ form.scaling_in_out_rules(class="form-control", rows="3") }}
                                {% if form.scaling_in_out_rules.errors %}
                                    <div class="invalid-feedback">{{ form.scaling_in_out_rules.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-1">
                                <label for="{{ form.trade_management_breakeven_rules.id }}" class="form-label fw-semibold">Breakeven Rules</label>
                                {{ form.trade_management_breakeven_rules(class="form-control", rows="2") }}
                                {% if form.trade_management_breakeven_rules.errors %}
                                    <div class="invalid-feedback">{{ form.trade_management_breakeven_rules.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.trade_management_trailing_stop_rules.id }}" class="form-label fw-semibold">Trailing Stop Protocol</label>
                                {{ form.trade_management_trailing_stop_rules(class="form-control", rows="2") }}
                                {% if form.trade_management_trailing_stop_rules.errors %}
                                    <div class="invalid-feedback">{{ form.trade_management_trailing_stop_rules.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.trade_management_partial_profit_rules.id }}" class="form-label fw-semibold">Partial Profit Rules</label>
                                {{ form.trade_management_partial_profit_rules(class="form-control", rows="2") }}
                                {% if form.trade_management_partial_profit_rules.errors %}
                                    <div class="invalid-feedback">{{ form.trade_management_partial_profit_rules.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Limits & Circuit Breakers -->
                <div class="enterprise-module mb-4">
                    <div class="module-header">
                        <div class="module-title">
                            <i class="fas fa-exclamation-triangle module-icon"></i>
                            Risk Limits & Circuit Breakers
                        </div>
                        <div class="module-meta">Maximum Loss Parameters & Safety Protocols</div>
                    </div>
                    <div class="module-content">
                        <div class="grid grid-cols-4 gap-3 mb-3">
                            <div class="col-span-1">
                                <label for="{{ form.model_max_loss_per_trade.id }}" class="form-label fw-semibold">Max Trade Loss</label>
                                {{ form.model_max_loss_per_trade(class="form-control" + (" is-invalid" if form.model_max_loss_per_trade.errors else "")) }}
                                {% if form.model_max_loss_per_trade.errors %}
                                    <div class="invalid-feedback">{{ form.model_max_loss_per_trade.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.model_max_daily_loss.id }}" class="form-label fw-semibold">Max Daily Loss</label>
                                {{ form.model_max_daily_loss(class="form-control" + (" is-invalid" if form.model_max_daily_loss.errors else "")) }}
                                {% if form.model_max_daily_loss.errors %}
                                    <div class="invalid-feedback">{{ form.model_max_daily_loss.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.model_max_weekly_loss.id }}" class="form-label fw-semibold">Max Weekly Loss</label>
                                {{ form.model_max_weekly_loss(class="form-control" + (" is-invalid" if form.model_max_weekly_loss.errors else "")) }}
                                {% if form.model_max_weekly_loss.errors %}
                                    <div class="invalid-feedback">{{ form.model_max_weekly_loss.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-span-1">
                                <label for="{{ form.model_consecutive_loss_limit.id }}" class="form-label fw-semibold">Consecutive Loss Limit</label>
                                {{ form.model_consecutive_loss_limit(class="form-control" + (" is-invalid" if form.model_consecutive_loss_limit.errors else "")) }}
                                {% if form.model_consecutive_loss_limit.errors %}
                                    <div class="invalid-feedback">{{ form.model_consecutive_loss_limit.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.model_action_on_max_drawdown.id }}" class="form-label fw-semibold">Drawdown Response Protocol</label>
                            {{ form.model_action_on_max_drawdown(class="form-control", rows="3") }}
                            {% if form.model_action_on_max_drawdown.errors %}
                                <div class="invalid-feedback">{{ form.model_action_on_max_drawdown.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar Panel (1/3 width) -->
        <div class="col-span-1">
            <!-- Trading Model Illustrations -->
            <div class="enterprise-module mb-4">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-chart-area module-icon"></i>
                        Model Examples
                    </div>
                </div>
                <div class="module-content">
                    <!-- Existing Images Display -->
                    {% if model and existing_images %}
                        <div id="existing-images-container" class="mb-3">
                            <h6 class="text-muted mb-2">Current Chart Examples ({{ existing_images|length }})</h6>
                            <div class="row g-2">
                                {% for image in existing_images %}
                                <div class="col-6" id="existing-image-{{ image.id }}">
                                    <div class="position-relative">
                                        <img src="{{ url_for('images.serve_image', image_id=image.id) }}"
                                             alt="Chart Example"
                                             class="img-fluid rounded"
                                             style="max-height: 120px; width: 100%; object-fit: cover; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease;"
                                             onclick="showImageModal('{{ url_for('images.serve_image', image_id=image.id) }}', '{{ model.name }} - Chart Example')"
                                             onmouseover="this.style.border='2px solid #0066cc'; this.style.transform='scale(1.02)'"
                                             onmouseout="this.style.border='2px solid transparent'; this.style.transform='scale(1)'">
                                        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                                                onclick="deleteExistingImage({{ image.id }}, '{{ image.original_filename }}')"
                                                title="Delete this image">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <p class="text-muted small text-center mt-1 mb-0">{{ image.original_filename }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- New Images Preview -->
                    <div id="image-preview-container" style="display: none;">
                        <h6 class="text-muted mb-2">New Chart Examples</h6>
                        <!-- Dynamic chart preview will be populated here -->
                    </div>

                    <!-- Default state when no images -->
                    {% if not (model and existing_images) %}
                    <div id="default-chart-state" class="text-center py-5">
                        <i class="fas fa-chart-area fa-3x text-muted mb-3" style="opacity: 0.3;"></i>
                        <h6 class="text-muted">No Chart Examples Available</h6>
                        <p class="text-muted small">Upload chart examples to illustrate this trading framework</p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <label for="{{ form.chart_examples.id }}" class="form-label fw-semibold">{% if model and existing_images %}Add More Chart Examples{% else %}Chart Examples{% endif %}</label>
                        {{ form.chart_examples(class="form-control" + (" is-invalid" if form.chart_examples.errors else ""), accept="image/*", multiple=true, form="create-trading-model-form") }}
                        {% if form.chart_examples.errors %}
                            <div class="invalid-feedback">{{ form.chart_examples.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Additional Configuration Parameters -->
            <div class="enterprise-module mb-4">
                <div class="module-header">
                    <div class="module-title">
                        <i class="fas fa-cog module-icon"></i>
                        Additional Configuration
                    </div>
                    <div class="module-meta">Optimization & Quality Controls</div>
                </div>
                <div class="module-content">
                    <div class="mb-3">
                        <label for="{{ form.sub_optimal_market_conditions.id }}" class="form-label fw-semibold">Exclusion Criteria</label>
                        {{ form.sub_optimal_market_conditions(class="form-control", rows="3", form="create-trading-model-form") }}
                        {% if form.sub_optimal_market_conditions.errors %}
                            <div class="invalid-feedback">{{ form.sub_optimal_market_conditions.errors[0] }}</div>
                        {% endif %}
                        <div class="form-text">Market conditions to avoid</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.pre_trade_checklist.id }}" class="form-label fw-semibold">Pre-Trade Verification Protocol</label>
                        {{ form.pre_trade_checklist(class="form-control", rows="4", form="create-trading-model-form") }}
                        {% if form.pre_trade_checklist.errors %}
                            <div class="invalid-feedback">{{ form.pre_trade_checklist.errors[0] }}</div>
                        {% endif %}
                        <div class="form-text">Framework-specific validation checks before trade execution</div>
                    </div>

                    <!-- Price Action & Market Context in Sidebar -->
                    <div class="mb-3">
                        <label for="{{ form.price_action_signals.id }}" class="form-label fw-semibold">Price Action Signals</label>
                        {{ form.price_action_signals(class="form-control", rows="3", form="create-trading-model-form") }}
                        {% if form.price_action_signals.errors %}
                            <div class="invalid-feedback">{{ form.price_action_signals.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.key_levels_identification.id }}" class="form-label fw-semibold">Key Level Identification</label>
                        {{ form.key_levels_identification(class="form-control", rows="3", form="create-trading-model-form") }}
                        {% if form.key_levels_identification.errors %}
                            <div class="invalid-feedback">{{ form.key_levels_identification.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.instrument_applicability.id }}" class="form-label fw-semibold">Instrument Coverage</label>
                        {{ form.instrument_applicability(class="form-control", rows="2", form="create-trading-model-form") }}
                        {% if form.instrument_applicability.errors %}
                            <div class="invalid-feedback">{{ form.instrument_applicability.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.session_applicability.id }}" class="form-label fw-semibold">Session Parameters</label>
                        {{ form.session_applicability(class="form-control", rows="2", form="create-trading-model-form") }}
                        {% if form.session_applicability.errors %}
                            <div class="invalid-feedback">{{ form.session_applicability.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.optimal_market_conditions.id }}" class="form-label fw-semibold">Optimal Conditions</label>
                        {{ form.optimal_market_conditions(class="form-control", rows="2", form="create-trading-model-form") }}
                        {% if form.optimal_market_conditions.errors %}
                            <div class="invalid-feedback">{{ form.optimal_market_conditions.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ensure content doesn't get hidden behind sticky buttons -->
    <div class="sticky-action-buttons-spacer"></div>
</div>

<!-- Sticky Action Buttons -->
<div class="sticky-action-buttons">
    <button type="submit" class="btn btn-primary" form="create-trading-model-form">
        <i class="fas fa-save me-1"></i>{% if model %}Update Configuration{% else %}Save Model{% endif %}
    </button>
    <a href="{{ url_for('admin.manage_default_trading_models') }}" class="btn btn-secondary">
        <i class="fas fa-times me-2"></i>{% if model %}Cancel Changes{% else %}Cancel{% endif %}
    </a>
</div>
{% endblock %}